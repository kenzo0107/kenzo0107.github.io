<div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-03-23T15:00:00.000Z" title="2020-03-23T15:00:00.000Z">2020-03-24</time><span class="level-item">4分 read (About 533 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Serverless Framework の設定値の上書き・追加 方法</h1><div class="content"><p>Serverless Framework での上書き設定について詰まった点をまとめました。</p>
<p>基本的には以下公式ドキュメントを参考にしつつ、いくつか実装パターンを試験しました。</p>
<a id="more"></a>

<p>環境変数を例にとって設定してみます。</p>
<p><a href="https://serverless.com/framework/docs/providers/aws/guide/functions#environment-variables">Environment Variables</a></p>
<h2><span id="stage-共通で設定">stage 共通で設定</span></h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">provider:</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">'hello,world'</span></span><br></pre></td></tr></table></figure>

<p>上記設定の場合、環境変数は以下の様に設定されます。</p>
<ul>
<li>key: hello,world</li>
</ul>
<h2><span id="1つの値を上書きする場合">1つの値を上書きする場合</span></h2><p>参考: <a href="https://serverless.com/framework/docs/providers/openwhisk/guide/variables#overwriting-variables">Overwriting Variables</a></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">provider:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">openwhisk</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">custom:</span></span><br><span class="line">  <span class="attr">myStage:</span> <span class="string">$&#123;opt:stage,</span> <span class="string">self:provider.stage&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">trigger:</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">$&#123;self:custom.myStage&#125;</span></span><br></pre></td></tr></table></figure>

<p>上記設定の場合、デプロイ後の環境変数の設定は以下の様になります。</p>
<ul>
<li><code>sls deploy</code> でデプロイした場合<ul>
<li>key: dev</li>
</ul>
</li>
<li><code>sls deploy --stage hoge</code> でデプロイした場合<ul>
<li>key: hoge</li>
</ul>
</li>
</ul>
<h2><span id="stage-毎に-envorinment-を追加上書き">stage 毎に envorinment を追加・上書き</span></h2><p>デフォルトの設定を provider.environment で指定し、各 stage 毎の設定は <code>self:custom.${self:provider.stage}.environment</code> で追加・上書きできる様にしています。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">provider:</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">project:</span> <span class="string">$&#123;self:custom.$&#123;self:provider.stage&#125;.project&#125;</span></span><br><span class="line">    <span class="attr">slackChannel:</span> <span class="string">$&#123;self:custom.$&#123;self:provider.stage&#125;.slack.channel&#125;</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">'hello,world'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">custom:</span></span><br><span class="line">  <span class="attr">hoge:</span></span><br><span class="line">    <span class="attr">project:</span> <span class="string">hoge</span></span><br><span class="line">    <span class="attr">slack:</span></span><br><span class="line">      <span class="attr">channel:</span> <span class="string">'#hoge'</span></span><br><span class="line">  <span class="attr">moge:</span></span><br><span class="line">    <span class="attr">project:</span> <span class="string">moge</span></span><br><span class="line">    <span class="attr">slack:</span></span><br><span class="line">      <span class="attr">channel:</span> <span class="string">'#moge'</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">'moge-key'</span></span><br><span class="line">      <span class="attr">key2:</span> <span class="string">'moge-key2'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">trigger:</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="string">$&#123;self:custom.$&#123;self:provider.stage&#125;.environment,</span> <span class="string">self:provider.environment&#125;</span></span><br></pre></td></tr></table></figure>

<p>上記設定の場合、デプロイ後の環境変数の設定は以下の様になります。</p>
<ul>
<li><code>sls deploy --stage hoge</code> でデプロイした場合<ul>
<li>project: hogeproject</li>
<li>slackChannel: #hoge</li>
<li>key: hello,world</li>
</ul>
</li>
<li><code>sls deploy --stage moge</code> でデプロイした場合<ul>
<li>project: hogeproject</li>
<li>slackChannel: #hoge</li>
<li>key: moge-key   <code>&lt;-- 更新</code></li>
<li>key2: moge-key2 <code>&lt;-- 追加</code></li>
</ul>
</li>
</ul>
<p>functions.trigger.environment を上書き設定する理由は、以下の様にした場合、</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">trigger:</span></span><br><span class="line">    <span class="comment"># environment: $&#123;self:custom.$&#123;self:provider.stage&#125;.environment, self:provider.environment&#125;</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="string">$&#123;self:custom.$&#123;self:provider.stage&#125;.environment&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>self:custom.hoge.environment</code> の設定がなく、 Warning が発生する為です。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Serverless Warning --------------------------------------</span><br><span class="line"></span><br><span class="line"> A valid service attribute to satisfy the declaration <span class="string">'self:custom.hoge.environment'</span> could not be found.</span><br></pre></td></tr></table></figure>

<p>以上<br>参考になれば幸いです。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/AWS/">AWS</a><a class="link-muted mr-2" rel="tag" href="/tags/Lambda/">Lambda</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/03/30/2020-03-31-go-multierr/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">go.uber.org/multierr で error をまとめる</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/03/06/2020-03-07-vscode-go/"><span class="level-item">vscode で Go Generate Unit Test が便利だった♪</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->