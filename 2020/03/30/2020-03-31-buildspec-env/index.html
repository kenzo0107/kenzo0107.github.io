<div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-03-30T15:00:00.000Z" title="2020-03-30T15:00:00.000Z">2020-03-31</time><span class="level-item">3分 read (About 409 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">CodePipeline で CodeBuild へ環境変数を渡し、上書きすることで CodeBuild を再利用する</h1><div class="content"><p>CodeBuild を再利用し、不要に作成しない様にした話です。</p>
<a id="more"></a>

<h2><span id="terraform-で-buildspec-を管理してみる">terraform で buildspec を管理してみる</span></h2><ul>
<li><p>buildspec.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">FOO:</span> <span class="string">"$&#123;foo&#125;"</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>codebuild.tf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">data &quot;template_file&quot; &quot;buildspec&quot; &#123;</span><br><span class="line">  template &#x3D; file(&quot;buildspec.yml&quot;)</span><br><span class="line"></span><br><span class="line">  vars &#x3D; &#123;</span><br><span class="line">    foo &#x3D; &quot;foo&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_codebuild_project&quot; &quot;foo&quot; &#123;</span><br><span class="line">  source &#123;</span><br><span class="line">    type      &#x3D; &quot;CODEPIPELINE&quot;</span><br><span class="line">    buildspec &#x3D; data.template_file.buildspec.rendered</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><code>terraform apply</code> 実行し CodeBuild を作成すると、環境変数 <code>FOO=foo</code> が設定されます。</p>
<h2><span id="codepipeline-で-codebuild-の環境変数を上書き">CodePipeline で CodeBuild の環境変数を上書き</span></h2><p>CodeBuild の処理内容は同じだが、環境変数だけ変えたい場合に有効です</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_codepipeline&quot; &quot;moge&quot; &#123;</span><br><span class="line">  stage &#123;</span><br><span class="line">    name &#x3D; &quot;Build&quot;</span><br><span class="line"></span><br><span class="line">    action &#123;</span><br><span class="line">      configuration &#x3D; &#123;</span><br><span class="line">        ProjectName &#x3D; aws_codebuild_project.foo.name</span><br><span class="line">        EnvironmentVariables &#x3D; &quot;[&#123;\&quot;name\&quot;:\&quot;FOO\&quot;,\&quot;value\&quot;:\&quot;moge\&quot;,\&quot;type\&quot;:\&quot;PLAINTEXT\&quot;&#125;]&quot;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>これで CodePipeline を実行した場合、 <code>FOO=moge</code> が指定され、見事上書きされてます。</p>
<h2><span id="例題">例題</span></h2><p><code>${repository_url}</code> に nginx の ECR リポジトリを代入すると Nginx のイメージビルド &amp; ECR プッシュの処理をする CodeBuild が作れます。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">DOCKER_BUILDKIT:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">REPOSITORY_URL:</span> <span class="string">"$&#123;repository_url&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">phases:</span></span><br><span class="line">  <span class="attr">pre_build:</span></span><br><span class="line">    <span class="attr">commands:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">$(aws</span> <span class="string">ecr</span> <span class="string">get-login</span> <span class="string">--region</span> <span class="string">$AWS_DEFAULT_REGION</span> <span class="string">--no-include-email)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">IMAGE_TAG=$(echo</span> <span class="string">$CODEBUILD_RESOLVED_SOURCE_VERSION</span> <span class="string">|</span> <span class="string">cut</span> <span class="string">-c</span> <span class="number">1</span><span class="number">-7</span><span class="string">)</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">commands:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&gt;-</span></span><br><span class="line">        <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">$REPOSITORY_URL:latest</span> <span class="string">-f</span> <span class="string">Dockerfile</span> <span class="string">.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker</span> <span class="string">tag</span> <span class="string">$REPOSITORY_URL:latest</span> <span class="string">$REPOSITORY_URL:$IMAGE_TAG</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$REPOSITORY_URL:latest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$REPOSITORY_URL:$IMAGE_TAG</span></span><br></pre></td></tr></table></figure>

<p>CodePipeline で環境変数 <code>REPOSITORY_URL=123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/fluentd</code> と指定すると fluentd イメージをビルド &amp; ECR push ができます。</p>
<h2><span id="結論">結論</span></h2><p>無闇に CodeBuild を作成することなかれ</p>
<p>以上<br>参考になれば幸いです。</p>
<h2><span id="参考">参考</span></h2><p>環境変数の指定の仕方は以下参考にしました。</p>
<p><a href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html">Build specification reference for CodeBuild</a></p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/AWS/">AWS</a><a class="link-muted mr-2" rel="tag" href="/tags/CodeBuild/">CodeBuild</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/04/15/2020-04-16-cloudfront-csp/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Lambda Edge で Basic 認証 や CSP 対応</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/03/30/2020-03-31-go-multierr/"><span class="level-item">go.uber.org/multierr で error をまとめる</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->