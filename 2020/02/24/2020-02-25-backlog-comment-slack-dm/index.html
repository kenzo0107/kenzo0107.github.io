<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20200227/20200227215819.png" alt="Backlog でコメント追加時に 「お知らせしたいユーザ」に Slack DM する"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-02-24T15:00:00.000Z" title="2020-02-24T15:00:00.000Z">2020-02-25</time><span class="level-item"><a class="link-muted" href="/categories/Go/">Go</a></span><span class="level-item">6分 read (About 899 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Backlog でコメント追加時に 「お知らせしたいユーザ」に Slack DM する</h1><div class="content"><p>Backlog でコメント追加時に 「お知らせしたいユーザ」に Slack DM する AWS Serverless Application Model with Golang プロジェクト作りました♪</p>
<a id="more"></a>

<p>使い方は、 Git プロジェクトを見ていただければ！</p>
<p><a href="https://github.com/kenzo0107/backlog-to-slack-dm">kenzo0107/backlog-to-slack-dm</a></p>
<p>もしよくわからんぞ！という時は連絡ください♪</p>
<h3><span id="構築するに辺り-検討した点">構築するに辺り、検討した点</span></h3><h4><span id="世の中には-backlog-api-関連の-sdk-などあるか">世の中には backlog API 関連の SDK などあるか？</span></h4><p><a href="https://github.com/griffin-stewie/go-backlog">griffin-stewie/go-backlog</a> が諸々揃っていて良さそうだったので使ってみました。</p>
<p>利用したい箇所としては、以下です。</p>
<ul>
<li>コメント追加時のイベント情報を受ける <code>type Activity struct</code></li>
<li>↑で受け取れる通知したいユーザの ID から Email アドレスを取得する API 実行</li>
</ul>
<p>但し、このライブラリでは、<a href="https://github.com/griffin-stewie/go-backlog/blob/master/models.go#L242">Activity には通知したい情報を含む Notifications がコメントアウトとなっていた</a>ので、直ちに利用できず、</p>
<p>急を要していたこともあり、 fork して <a href="https://github.com/kenzo0107/go-backlog">kenzo0107/go-backlog</a> で対応しました。</p>
<p>単純にコメントアウトを外して使える様にしただけでは、 json.Unmarshal 実行時にエラーとなっており、他のパラメータも幾分か対応する必要がありました。</p>
<h4><span id="backlog-からのアクセス制御はどうする">Backlog からのアクセス制御はどうする？</span></h4><p>Backlog からのアクセス制御はBasic 認証について言及があったので Basic 認証にしました。</p>
<blockquote>
<p>IP アドレスの変更に影響されない方法であれば、 Webhook の URL に BASIC 認証をつけていただくことで、IP アドレスに依存しない認証できます。</p>
</blockquote>
<p><a href="https://support-ja.backlog.com/hc/ja/articles/360035645534-Webhook-%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E6%83%85%E5%A0%B1">Webhook 送信サーバーの IP アドレスを教えてください</a></p>
<p>IP レンジは予告なく変更される可能性があり、作成者以外ではなかなか気付きにくいかもしれません。<br>その為、 Backlog Webhook に設定する URL は、 <code>https://&lt;user&gt;:&lt;password&gt;@......</code> と Basic 認証の情報を埋め込む様にしました。</p>
<p>これを API Gateway + Lambda Authorizer (Request Type) で認証させる様にしました。</p>
<h4><span id="backlog-api-実行時に許可する-ip-はどうするか">Backlog API 実行時に許可する ip はどうするか？</span></h4><p>Backlog API を実行する Lambda を Nat Gateway をルーティングした Private Subnet に置くことで、出口 IP を固定する様にし、その IP を Backlog 側で許可 IP として設定しました。</p>
<h3><span id="注意点">注意点</span></h3><h4><span id="backlog-webhook-各プロジェクト毎に設定する必要があり">Backlog Webhook 各プロジェクト毎に設定する必要があり</span></h4><p>全プロジェクト一括して設定ということができませんでした。 2020-02-27 現在</p>
<p>各プロジェクト管理者に秘密情報として通知する様に対応をしました。</p>
<h2><span id="まとめ">まとめ</span></h2><p>まだテストを書き切れてないところはありますが、問題なく動作していることを確認しています。</p>
<p>Backlog を取り入れている方へ、何かしら参考になれば幸いです。</p>
<p>以上です。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Go/">Go</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/03/06/2020-03-07-vscode-go/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">vscode で Go Generate Unit Test が便利だった♪</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/02/19/2020-02-20-github-actions/"><span class="level-item">GitHub Actions で job を 直列 と 並列 実行どっちにしよう？</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->