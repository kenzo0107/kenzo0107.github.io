<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190628/20190628154100.png" alt="EC2 Instance Connect で AWS EC2 への ssh 管理を IAM User or Group で簡単に♪"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-06-27T15:00:00.000Z" title="2019-06-27T15:00:00.000Z">2019-06-28</time><span class="level-item">5分 read (About 702 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">EC2 Instance Connect で AWS EC2 への ssh 管理を IAM User or Group で簡単に♪</h1><div class="content"><h2><span id="概要">概要</span></h2><p>2019-06-28 に <a href="https://aws.amazon.com/jp/about-aws/whats-new/2019/06/introducing-amazon-ec2-instance-connect/">EC2 Instance Conncet</a> が発表されました！</p>
<p>これによって、セキュリティグループと IAM 権限で ssh アクセス許可が可能になります。</p>

<p>例えば、<br>
会社の IP からのみ、特定の IAM User Group に所属している IAM User に ssh アクセス権限を付与、<br>
別のプロジェクトへ異動した、退職した場合は、その IAM User Group から削除で ssh アクセス権限を剥奪できます。</p>

<a id="more"></a>

<h2><span id="試験環境">試験環境</span></h2><p>macOS 10.14.3 で試しました。</p>

<h2><span id="事前準備">事前準備</span></h2><pre class="code" data-lang data-unlink>$ pip install -U awscli

$ aws s3api get-object --bucket ec2-instance-connect --key cli/ec2instanceconnectcli-latest.tar.gz ec2instanceconnectcli-latest.tar.gz

$ sudo pip install ec2instanceconnectcli-latest.tar.gz</pre>


<p>発行した IAM User のパーミッション権限に以下を追加</p>

<pre class="code" data-lang data-unlink>{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Sid&#34;: &#34;EC2InstanceConnect&#34;,
            &#34;Action&#34;: [
                &#34;ec2:DescribeInstances&#34;,
                &#34;ec2-instance-connect:SendSSHPublicKey&#34;
            ],
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Resource&#34;: &#34;*&#34;
        }
    ]
}</pre>


<p>この辺りは terraform 管理案件ですね。</p>

<h2><span id="ec2-instance-conncect-対応-os">EC2 Instance Conncect 対応 OS</span></h2><ul>
<li>Ubuntu>=16.04</li>
<li>AmazonLinux2>=2.0.20190618</li>
</ul>


<h2><span id="ssh-ログインする-ec2側の設定">ssh ログインする EC2側の設定</span></h2><h3><span id="ubuntugt1604">Ubuntu&gt;=16.04</span></h3><p>ec2-instance-connect をインストールしておく必要があります。</p>

<pre class="code" data-lang data-unlink>$ sudo apt-get update && sudo apt-get install ec2-instance-connect</pre>




<pre class="code" data-lang data-unlink>$ dpkg -l | grep ec2-instance-connect

ii  ec2-instance-connect           1.1.9-0ubuntu3~18.04.1            all          Configures ssh daemon to accept EC2 Instance Connect ssh keys</pre>


<h3><span id="amazonlinux2gt2020190618">AmazonLinux2&gt;=2.0.20190618</span></h3><p>ec2-instance-connect は設定済みです。</p>

<h3><span id="セキュリティグループ">セキュリティグループ</span></h3><p>ssh ログイン先となる EC2 インスタンスのセキュリティグループはアクセス元から ssh (22 port) を開けておく必要があります。</p>

<h2><span id="ssh-ログインしてみる">ssh ログインしてみる</span></h2><pre class="code" data-lang data-unlink>local%$ mssh ubuntu@i-0f123456abcdefg --profile &lt;profile&gt; --region ap-northeast-1</pre>


<p>一見、誰しもが ubuntu でログインしていて監査が不安になりますが、 CloudTrail  はちゃんと誰がログインしたか見ています。</p>

<h3><span id="cloudtrail">CloudTrail</span></h3><p><figure class="figure-image figure-image-fotolife" title="CloudTrail"><span itemscope itemtype="https://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190628/20190628160255.png" alt="f:id:kenzo0107:20190628160255p:plain" title="f:id:kenzo0107:20190628160255p:plain" class="hatena-fotolife" itemprop="image"></span><figcaption>CloudTrail</figcaption></figure></p>

<p>以下イベントでログが残っています。</p>

<ul>
<li>SendSSHPublicKey</li>
<li>DescribeInstances</li>
</ul>


<p>SendSSHPublicKey の「イベントの表示」ボタンクリックで JSON が表示されますが、その中で、アクセス元 IP, IAM User Arn、アクセス先 インスタンスIDがわかります。</p>

<pre class="code" data-lang data-unlink>{
    &#34;eventVersion&#34;: &#34;1.05&#34;,
    &#34;userIdentity&#34;: {
        &#34;type&#34;: &#34;IAMUser&#34;,
        &#34;principalId&#34;: &#34;ABCDEFGHIJK....&#34;,
        &#34;arn&#34;: &#34;arn:aws:iam::123456789012:user/hogehoge&#34;,
        &#34;accountId&#34;: &#34;123456789012&#34;,
        &#34;accessKeyId&#34;: &#34;AKIxxxxxxxxxxxxxxxx&#34;,
        &#34;userName&#34;: &#34;hogehoge&#34;,
        &#34;sessionContext&#34;: {
            &#34;attributes&#34;: {
                &#34;mfaAuthenticated&#34;: &#34;false&#34;,
                &#34;creationDate&#34;: &#34;2019-06-28T06:18:50Z&#34;
            }
        }
    },
    &#34;eventTime&#34;: &#34;2019-06-28T06:18:51Z&#34;,
    &#34;eventSource&#34;: &#34;ec2-instance-connect.amazonaws.com&#34;,
    &#34;eventName&#34;: &#34;SendSSHPublicKey&#34;,
    &#34;awsRegion&#34;: &#34;ap-northeast-1&#34;,
    &#34;sourceIPAddress&#34;: &#34;xx.xxx.xxx.xxx&#34;,
    &#34;userAgent&#34;: &#34;aws-ec2-instance-connect-cli/1.0.0 Python/2.7.16 Darwin/18.2.0 Botocore/1.12.179&#34;,
    &#34;requestParameters&#34;: {
        &#34;instanceId&#34;: &#34;i-0f.......&#34;,
        &#34;osUser&#34;: &#34;ubuntu&#34;,
        &#34;SSHKey&#34;: {
            &#34;publicKey&#34;: &#34;ssh-rsa AAAAB....rHb&#34;
        }
    },
    &#34;responseElements&#34;: null,
    &#34;requestID&#34;: &#34;01234567-890a-1234-5b6d-......&#34;,
    &#34;eventID&#34;: &#34;f51...&#34;,
    &#34;eventType&#34;: &#34;AwsApiCall&#34;,
    &#34;recipientAccountId&#34;: &#34;123456789012&#34;
}</pre>


<p>こちらで EC2 インスタンスのアクセス履歴等はわかります。</p>

<h2><span id="まとめ">まとめ</span></h2><p>これまで ssh アカウント管理は手間でしたが、IAM 権限での管理によって非常に楽になりました♪</p>

<p>CloudTrail で監査もバッチリ！</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/AWS/">AWS</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/08/03/2019-08-04-ec2-instance-connect-api-ssh-cli-tool-omssh/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">EC2 Instance Connect API で ssh ログインできるインタラクティブ cli tool &quot;omssh&quot; を作ってみました。</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/04/23/2019-04-24-nginx-ip-lb/"><span class="level-item">Nginx IP 直アクセス不許可 &amp; LB ヘルスチェック設定</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->