<div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-09-30T15:00:00.000Z" title="2019-09-30T15:00:00.000Z">2019-10-01</time><span class="level-item"><a class="link-muted" href="/categories/Terraform/">Terraform</a></span><span class="level-item">9分 read (About 1412 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">terraform 0.11 系に対応した GitHub Actions 作った &amp;  tflint も入れてみた♪</h1><div class="content"><h2><span id="概要">概要</span></h2><p>Terraform 用の GitHub Actions として hashicorp 社にて以下リポジトリが用意されています。</p>
<p><a href="https://github.com/hashicorp/terraform-github-actions">hashicorp/terraform-github-actions</a></p>
<p>ですが、上記のリポジトリでは、 terraform の最新版 (2019-09-30 時点 0.12.9) にのみ適用しています。</p>
<p>hashicorp/terraform-github-actions を folk して<br>0.11 系がなかった為、 <strong>0.11 系に対応した terraform-github-actions</strong> を以下リポジトリに作成しました。</p>
<p><a href="https://github.com/kenzo0107/terraform-github-actions">kenzo0107/terraform-github-actions</a></p>
<a id="more"></a>

<p>terraform の古いバージョンについての対応は、 terraform 公式に以下リンクにて記載があります。</p>
<p><a href="https://www.terraform.io/docs/github-actions/terraform-versions.html">Terraform Versions - Terraform GitHub Actions - Terraform by HashiCorp</a></p>
<p>古いバージョンは folk して自分で作ってね♪ と書いてあります。</p>
<h2><span id="ついでに">ついでに</span></h2><p>以下追加してみました。</p>
<ul>
<li>tflint 追加</li>
<li>実行するディレクトリを表示</li>
</ul>
<h2><span id="使い方">使い方</span></h2><p>以下のような terraform プロジェクトがあるとします。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">├──</span> <span class="string">envs</span></span><br><span class="line"><span class="string">│</span>   <span class="string">├──</span> <span class="string">prd</span></span><br><span class="line"><span class="string">│</span>   <span class="string">│</span>   <span class="string">├──</span> <span class="string">backend.tf</span></span><br><span class="line"><span class="string">│</span>   <span class="string">│</span>   <span class="string">├──</span> <span class="string">main.tf</span></span><br><span class="line"><span class="string">│</span>       <span class="string">...</span></span><br><span class="line"><span class="string">│</span>   <span class="string">│</span>   <span class="string">└──</span> <span class="string">variable.tf</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">stg</span></span><br><span class="line"><span class="string">│</span>       <span class="string">├──</span> <span class="string">backend.tf</span></span><br><span class="line"><span class="string">│</span>       <span class="string">├──</span> <span class="string">main.tf</span></span><br><span class="line"><span class="string">│</span>       <span class="string">...</span></span><br><span class="line"><span class="string">│</span>       <span class="string">└──</span> <span class="string">variable.tf</span></span><br><span class="line"><span class="string">└──</span> <span class="string">modules</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">...</span></span><br></pre></td></tr></table></figure>


<h2><span id="github-actions-設定方法">GitHub Actions 設定方法</span></h2><p>以下 2 ファイルを root ディレクトリに配置します。</p>
<ul>
<li>.github/workflows/main.yml</li>
<li>.github/workflows/fmt.yml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">├── .github</span><br><span class="line">│   └── workflows</span><br><span class="line">│       ├── main.yml</span><br><span class="line">│       └── fmt.yml</span><br><span class="line">│</span><br><span class="line">├── envs</span><br><span class="line">│   ├── prd</span><br><span class="line">│   │   ├── backend.tf</span><br><span class="line">│   │   ├── main.tf</span><br><span class="line">│       ...</span><br><span class="line">│   │   └── variable.tf</span><br><span class="line">│   └── stg</span><br><span class="line">│       ├── backend.tf</span><br><span class="line">│       ├── main.tf</span><br><span class="line">│       ...</span><br><span class="line">│       └── variable.tf</span><br><span class="line">└── modules</span><br><span class="line">    ├── ...</span><br></pre></td></tr></table></figure>

<h3><span id="githubworkflowsmainyml">.github/workflows/main.yml</span></h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Terraform</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[pull_request]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">on-pull-request:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">On</span> <span class="string">Pull</span> <span class="string">Request</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">[stg,</span> <span class="string">prd]</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">Repo</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.env</span> <span class="string">&#125;&#125;</span> <span class="string">Terraform</span> <span class="string">Init</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">kenzo0107/terraform-github-actions/init@v0.6.0</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">TF_ACTION_WORKING_DIR:</span> <span class="string">'./envs/$<span class="template-variable">&#123;&#123; matrix.env &#125;&#125;</span>'</span></span><br><span class="line">        <span class="attr">AWS_ACCESS_KEY_ID:</span>  <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_ACCESS_KEY_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">AWS_SECRET_ACCESS_KEY:</span>  <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.env</span> <span class="string">&#125;&#125;</span> <span class="string">Terraform</span> <span class="string">Validate</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">kenzo0107/terraform-github-actions/validate@v0.6.0</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">TF_ACTION_WORKING_DIR:</span> <span class="string">'./envs/$<span class="template-variable">&#123;&#123; matrix.env &#125;&#125;</span>'</span></span><br><span class="line">        <span class="attr">AWS_ACCESS_KEY_ID:</span>  <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_ACCESS_KEY_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">AWS_SECRET_ACCESS_KEY:</span>  <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.env</span> <span class="string">&#125;&#125;</span> <span class="string">Terraform</span> <span class="string">Lint</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">kenzo0107/terraform-github-actions/lint@v0.6.0</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">TF_ACTION_WORKING_DIR:</span> <span class="string">'./envs/$<span class="template-variable">&#123;&#123; matrix.env &#125;&#125;</span>'</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.env</span> <span class="string">&#125;&#125;</span> <span class="string">Terraform</span> <span class="string">Plan</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">kenzo0107/terraform-github-actions/plan@v0.6.0</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">TF_ACTION_WORKING_DIR:</span> <span class="string">'./envs/$<span class="template-variable">&#123;&#123; matrix.env &#125;&#125;</span>'</span></span><br><span class="line">        <span class="attr">AWS_ACCESS_KEY_ID:</span>  <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_ACCESS_KEY_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">AWS_SECRET_ACCESS_KEY:</span>  <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>


<h4><span id="ちょっと解説">ちょっと解説</span></h4><h5><span id="pull-request-をトリガーに実行されます">Pull Request をトリガーに実行されます。</span></h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">on:</span> <span class="string">[pull_request]</span></span><br></pre></td></tr></table></figure>


<h5><span id="リポジトリをチェックアウト">リポジトリをチェックアウト</span></h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">Repo</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/checkout@v1</span></span><br></pre></td></tr></table></figure>


<h5><span id="matrix-で-stg-prd-を並列実行します">matrix で stg, prd を並列実行します。</span></h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">strategy:</span></span><br><span class="line">  <span class="attr">matrix:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">[stg,</span> <span class="string">prd]</span></span><br></pre></td></tr></table></figure>


<h5><span id="terraform-init-validate-lint-plan">terraform init, validate, lint, plan</span></h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.env</span> <span class="string">&#125;&#125;</span> <span class="string">Terraform</span> <span class="string">Init</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.env</span> <span class="string">&#125;&#125;</span> <span class="string">Terraform</span> <span class="string">Validate</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.env</span> <span class="string">&#125;&#125;</span> <span class="string">Terraform</span> <span class="string">Lint</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.env</span> <span class="string">&#125;&#125;</span> <span class="string">Terraform</span> <span class="string">Plan</span></span><br></pre></td></tr></table></figure>


<p>言わずもがな、以下を実行しています。</p>
<ul>
<li>terraform init</li>
<li>terraform validate</li>
<li>terraform lint</li>
<li>terraform plan</li>
</ul>
<p><code>kenzo0107/terraform-github-actions/init@v0.6.0</code> が terraform v0.11.14 に対応しています。</p>
<p>init, validate, lint は指摘事項がある場合は、Pull Request にコメントしてくれます。</p>
<h4><span id="terraform-plan-は必ず実行結果を貼り付けてくれます">terraform plan は必ず実行結果を貼り付けてくれます。</span></h4><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190930/20190930221527.png" width="100%">
</div>

<p>これはレビュワーに有難い機能です。</p>
<p>コードの変更内容と <code>terraform plan</code> 内容の整合性が取れているかどうかが重要なレビュー観点となる為です。</p>
<h5><span id="実行パス指定">実行パス指定</span></h5><p>パスを移動してから terraform plan 等を実行したい場合に以下環境変数に指定します。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">TF_ACTION_WORKING_DIR:</span> <span class="string">'./envs/$<span class="template-variable">&#123;&#123; matrix.env &#125;&#125;</span>'</span></span><br></pre></td></tr></table></figure>


<p><code>kenzo0107/terraform-github-actions/plan@v0.6.0</code> では、<br>上記の設定した TF_ACTION_WORKING_DIR を terraform plan 実行内容と共に表示するようにしています。((<code>hashicorp/terraform-github-actions</code> では、実行したディレクトリパスは Pull Request コメントに乗らない様になってます。))</p>
<p>これは <code>terraform plan</code> 実行内容から stg, prd どちらで実行したかわかりずらく、レビュワーを困惑させる可能性がある為です。</p>
<h5><span id="secrets-の設定">secrets の設定</span></h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">AWS_ACCESS_KEY_ID:</span>  <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_ACCESS_KEY_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">AWS_SECRET_ACCESS_KEY:</span>  <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>


<p>secrets.GITHUB_TOKEN は secrets にトークンを設定する必要がありません。</p>
<p>個人的に GitHub が実行する CI/CD だからこそ実現できる秘匿性のある管理方法で、 Actions の大きな利点だと思います。</p>
<p>その他は、 <code>settings</code> &gt; <code>secrets</code> で設定します。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190930/20190930223443.png" width="100%">
</div>

<h3><span id="githubworkflowsfmtyml">.github/workflows/fmt.yml</span></h3><p><code>terraform fmt</code> を stg, prd 等は関係なく、リポジトリのルートディレクトリで実行するので<br><code>.github/workflows/main.yml</code> とは分けました。</p>
<p>こちらも Pull Request をトリガーとして実行されます。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Terraform</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">[pull_request]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">on-pull-request:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">On</span> <span class="string">Pull</span> <span class="string">Request</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">Repo</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Terraform</span> <span class="string">fmt</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">kenzo0107/terraform-github-actions/fmt@v0.6.0</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>


<h2><span id="総評">総評</span></h2><p>GitHub Actions に触れてみようとした題材として非常に簡易だったのでとっつきやすかったです。</p>
<p>そして何より、手間かけましたが、 0.12 系に対応した方が早かったかもしれない…</p>
<p>やんごとなき理由で 0.11 にしている場合以外は、最新に追従した方が良いですね♪</p>
<p>以上<br>参考になれば幸いです。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Terraform/">Terraform</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/10/16/2019-10-17-datadog-agent-for-ecs-launch-type-ec2/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Datadog Agent for ECS Launch Type=EC2</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/09/29/2019-09-30-aws-applicationloadbalancer-ip/"><span class="level-item">AWS ApplicationLoadBalancerリスナールールで特定 IP 以外をメンテナンスページ表示</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->