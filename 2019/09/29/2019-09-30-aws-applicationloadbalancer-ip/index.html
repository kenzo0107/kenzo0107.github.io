<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190929/20190929233947.png" alt="AWS ApplicationLoadBalancerリスナールールで特定 IP 以外をメンテナンスページ表示"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-09-29T15:00:00.000Z" title="2019-09-29T15:00:00.000Z">2019-09-30</time><span class="level-item">3分 read (About 386 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">AWS ApplicationLoadBalancerリスナールールで特定 IP 以外をメンテナンスページ表示</h1><div class="content"><h2><span id="概要">概要</span></h2><p>AWS で運用している Web サービスでメンテナンスが必要となり、ALB でメンテ切り替えをした際の対応をまとめました。</p>
<a id="more"></a>

<h2><span id="手順">手順</span></h2><p>ALB Listener 一覧からルール変更をします。</p>
<p>※ 今回 2 ポートのみ解放しており、80 は 443 に転送してるので、443 のみ対応しました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190929/20190929232804.png" width="100%">
</div>

<p>その後、</p>
<ul>
<li>送信元IP = 社内IP (ex. <code>11.22.33.44/32</code> ) → default のTargetGroup へ転送 で「保存」</li>
<li>社内IP以外の送信元 IP 全て ( <code>0.0.0.0/0</code> ) → <code>503</code> <code>text/html</code> メンテ文言をレスポンス で 「保存」</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190929/20190929231656.png" width="100%">
</div>

<p>以上で 社内 IP は、通常通りアクセス可、それ以外はメンテナンスページを表示させることができました。</p>
<p>まとめてルールを追加して保存が出来ず、1つずつルール追加で保存になります。</p>
<h2><span id="レスポンスできる-content-type-って何があるの">レスポンスできる Content-Type って何があるの？</span></h2><p>Content-Type に <code>application/json</code> 等も返せるので、 API サーバのメンテ時にはこちらを利用して文言を渡しました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190929/20190929232354.png" width="100%">
</div>

<h2><span id="ちょっとした注意">ちょっとした注意</span></h2><p>最大文字数が 1024 文字でした♪</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190929/20190929232942.png" width="100%">
</div>


<p>CSS を <code>レスポンス本文</code> に追加すると文字数 1024 を超えてしまいそうなので、S3 にアップロードし公開し、そちらを参照するようにしたりしました。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/AWS/">AWS</a><a class="link-muted mr-2" rel="tag" href="/tags/ALB/">ALB</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/09/30/2019-10-01-terraform-0-11-github-actions-tflint/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">terraform 0.11 系に対応した GitHub Actions 作った &amp;  tflint も入れてみた♪</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/09/18/2019-09-19-ansible-failed-msg-to-use-the-ssh-connection-type-with-passwords-you-must-install-the-ssh-pass-program-on-macos/"><span class="level-item">Ansible FAILED! =&gt; {&quot;msg&quot;: &quot;to use the &#039;ssh&#039; connection type with passwords, you must install the ssh pass program&quot;} on MacOS</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->