<div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-12-25T15:00:00.000Z" title="2019-12-25T15:00:00.000Z">2019-12-26</time><span class="level-item"><a class="link-muted" href="/categories/Go/">Go</a></span><span class="level-item">15分 read (About 2270 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Go 静的解析 &amp; 単体テスト on GitHub Actions</h1><div class="content"><p>以前、複数の AWS Account EC2 インスタンスへの接続を EC2 Instance Connect を使用しインタラクティブに ssh 接続できるツールを作成しました。</p>
<a id="more"></a>

<p><a href="https://kenzo0107.hatenablog.com/entry/2019/08/04/180149">EC2 Instance Connect API で ssh ログインできるインタラクティブ cli tool “omssh” を作ってみました。</a></p>
<p>自分用にチャチャッと作ってアップしたもので手元でしかテストしておらず 、 lint や test もしてなかったのですが、</p>
<ul>
<li>後学の為、改めて lint, test した上でコードを管理できる様になりたい</li>
<li>自分のリポジトリとして公開しているし、愛情持ちたい</li>
</ul>
<p>という気持ちで取り組んでみたいと思いました。</p>
<h2><span id="成果物">成果物</span></h2><p><a href="https://github.com/kenzo0107/omssh">kenzo0107/omssh</a></p>
<h2><span id="静的解析-on-github-actions">静的解析 on GitHub Actions</span></h2><p><a href="https://github.com/grandcolline/golang-github-actions">grandcolline/golang-github-actions</a> を利用させていただきまして以下解析しました。</p>
<ul>
<li><a href="golang.org/x/tools/cmd/goimports">goimports</a></li>
<li><a href="github.com/kisielk/errcheck">errcheck</a></li>
<li><a href="golang.org/x/lint/golint">golint</a></li>
<li><a href="golang.org/x/tools/go/analysis/passes/shadow/cmd/shadow">shadow</a></li>
<li><a href="honnef.co/go/tools/staticcheck">staticcheck</a></li>
<li><a href="github.com/securego/gosec/cmd/gosec">gosec</a></li>
</ul>
<p>GitHub Actions での設定ファイルは以下です。</p>
<p><a href="https://gist.github.com/kenzo0107/4bdac92908244222f441c1b04f3b7c5a">kenzo0107/static_check_go.yaml</a></p>
<h2><span id="開発時にも静的解析">開発時にも静的解析</span></h2><p>開発時に解析できる様、 Makefile に設定しました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: lint</span><br><span class="line">lint: devel-deps</span><br><span class="line">	go vet .&#x2F;...</span><br><span class="line">	go vet -vettool&#x3D;$(shell which shadow)</span><br><span class="line">	staticcheck .&#x2F;...</span><br><span class="line">	errcheck .&#x2F;...</span><br><span class="line">	# exclude G106: Audit the use of ssh.InsecureIgnoreHostKey</span><br><span class="line">	gosec -quiet -exclude&#x3D;G106 .&#x2F;...</span><br><span class="line">	golint -set_exit_status .&#x2F;...</span><br></pre></td></tr></table></figure>

<p>goimports に関してはエディタの設定で保存時にチェックする様にしてます。</p>
<p>実際に設定して動かしてみたらわかりやすいですが、以下にどんなことを指摘してくるかまとめます。</p>
<h3><span id="go-vet">go vet ./…</span></h3><p>構文エラーを指摘してくれます。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a := fmt.Sprintf(<span class="string">"%s"</span>, <span class="number">1</span>)</span><br><span class="line">fmt.Println(a)</span><br></pre></td></tr></table></figure>

<h3><span id="go-vet-vettoolshell-which-shadow">go vet -vettool=$(shell which shadow)</span></h3><p>スコープの外側で定義した変数と同名の変数がスコープの内部で使用されている場合に警告されます。</p>
<p>潜在的にエラーが発生する可能性があり、変数名を変更する等の対応が必要です。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hoge</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	err := errors.New(<span class="string">"error occured"</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		err := errors.New(<span class="string">"error occured"</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./main.go:14:3: declaration of <span class="string">"err"</span> shadows declaration at line 12</span><br></pre></td></tr></table></figure>

<p>上記の場合、以下の様にスコープ内でスコープ外の変数を利用することで回避できます。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">err := errors.New(<span class="string">"error occured"</span>)</span><br><span class="line">&#123;</span><br><span class="line">	err = errors.New(<span class="string">"error occured"</span>)</span><br></pre></td></tr></table></figure>

<p>ですが、この場合だと最初は <code>err :=</code> で定義し、その後は <code>err =</code> で定義しなければならず、わかりづらいので、<br>変数 err を定義した直後に処理を実施する様にすると回避できます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">func hoge() error &#123;</span><br><span class="line">	err :&#x3D; errors.New(&quot;error occured&quot;)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		return err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		err :&#x3D; errors.New(&quot;error occured&quot;)</span><br><span class="line">		if err !&#x3D; nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="staticcheck">staticcheck ./…</span></h3><p>バグの検出、コードの簡素化の提案、デッドコードの指摘などをしてくれます。</p>
<p>以下のコードで <code>staticcheck ./...</code> を実行すると</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"github.com/aws/aws-sdk-go/aws/session"</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">session.New(&amp;config)</span><br></pre></td></tr></table></figure>

<p>session.New 使うのは非推奨だよ、と警告してくれました。</p>
<p>deprecated を指摘してくれるのありがたい！</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.New is deprecated: Use NewSession <span class="built_in">functions</span> to create sessions instead. NewSession has the same functionality as New except an error can be returned when the func is called instead of waiting to receive an error until a request is made.  (SA1019)</span><br></pre></td></tr></table></figure>

<p>以下の様に修正することで、対応できました。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.Must(session.NewSession(&amp;config))</span><br></pre></td></tr></table></figure>

<h3><span id="errcheck">errcheck ./…</span></h3><p>error を返す function の処理をチェックしているか警告してくれます。</p>
<p>以下のコードで <code>errcheck ./...</code> を実行すると</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f, err := os.Open(fpath)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br></pre></td></tr></table></figure>

<p>以下の様に警告されます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkg/utility/profile.go:19:15:   defer f.Close()</span><br></pre></td></tr></table></figure>

<p><code>f.Close()</code> が error を返しますが、その error がチェックされていないですよ、という指摘です。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Close closes the File, rendering it unusable for I&#x2F;O. On files that support SetDeadline, any pending I&#x2F;O operations will be canceled and return immediately with an error.</span><br><span class="line"></span><br><span class="line">func (*os.File).Close() error</span><br></pre></td></tr></table></figure>

<p>無名関数で wrap してその中で error check する様にし対応しました。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := f.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalln(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<h3><span id="gosec-quiet">gosec -quiet ./…</span></h3><p>使用コードでの脆弱性を指摘してくれます。</p>
<p>現状の omssh では <code>gosec -quiet ./...</code> を実行してみると以下の様な警告が出ます。</p>
<p><code>G106</code> として管理されている <code>ssh.InsecureIgnoreHostKey()</code> を利用していることへの脆弱性が指摘されています。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Results:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[/Users/kenzo.tanaka/src/github.com/kenzo0107/omssh/omssh.go:50] - G106 (CWE-322): Use of ssh InsecureIgnoreHostKey should be audited (Confidence: HIGH, Severity: MEDIUM)</span><br><span class="line">  &gt; ssh.InsecureIgnoreHostKey()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line">   Files: 9</span><br><span class="line">   Lines: 718</span><br><span class="line">   Nosec: 0</span><br><span class="line">  Issues: 1</span><br></pre></td></tr></table></figure>

<p>対応法を把握できていないので <code>-exclude=G106</code> オプションで回避しています。</p>
<h4><span id="gosec-で警告されがちなコード">gosec で警告されがちなコード</span></h4><p>よくありがちな gosec に警告されがちなコード例としては以下ではないでしょうか。</p>
<p>引数として、ファイルパスを渡して、そのファイルを開こうとしています。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetProfiles</span><span class="params">(credentialsPath <span class="keyword">string</span>)</span> <span class="params">(profiles []<span class="keyword">string</span>, err error)</span></span> &#123;</span><br><span class="line">	f, err := os.Open(credentialsPath)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>このコードを <code>gosec -quiet ./...</code> してみると以下の様に警告されます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[/Users/kenzo.tanaka/src/github.com/kenzo0107/omssh/pkg/utility/profile.go:16] - G304 (CWE-22): Potential file inclusion via variable (Confidence: HIGH, Severity: MEDIUM)</span><br><span class="line">  &gt; os.Open(credentialsPath)</span><br></pre></td></tr></table></figure>

<p>こちらの対処法としては、ファイルパスを綺麗にしてくれる <code>filepath.Clean(string)</code> を噛ませると回避できました。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- f, err := os.Open(credentialsPath)</span><br><span class="line">+ f, err := os.Open(filepath.Clean(credentialsPath))</span><br></pre></td></tr></table></figure>

<p><code>../kenzo\hoge/moge</code> というファイルパスだと <code>../kenzo\hoge/moge</code> というファイルパスが返ります。</p>
<h3><span id="golint-set_exit_status">golint -set_exit_status ./…</span></h3><p><code>-set_exit_status</code> を指定しているのは、終了ステータスを返してくれます。</p>
<p>以下の様なコードがあるとします。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> EC2Iface <span class="keyword">interface</span> &#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>golint -set_exit_status ./...</code> すると以下の様なエラーを出力されます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pkg/awsapi/ec2.go:12:6: exported <span class="built_in">type</span> EC2Iface should have comment or be unexported</span><br><span class="line">Found 1 lint suggestions; failing.</span><br></pre></td></tr></table></figure>

<p>EC2Iface と大文字始まりなので、他パッケージからも参照できる <code>exported type</code> なのでコメントを書きましょうね、<br>という指摘です。</p>
<p>VSCode を使っていますが、この様にカーソルを合わせるとコメントが表示されてくれます。</p>
<p>丁寧に書いて置いて上げるとこんな値を返すよ〜とかわかりやすいですね。</p>
<p>面倒くさがらずコメント書きましょう。</p>
<h2><span id="単体テスト-on-github-actions">単体テスト on GitHub Actions</span></h2><p>こちらはシンプルで test を実行し coverage を <a href="https://codecov.io/">CodeCov</a> に上げる様にしました。また、そのカバレッジを README にラベルとして表示できます。</p>
<p>CODECOV_TOKEN は GitHub の Settings &gt; Secrets で設定しておきます。</p>
<p><a href="https://codecov.io/gh/kenzo0107/omssh"><img src="https://codecov.io/gh/kenzo0107/omssh/branch/master/graph/badge.svg" alt="codecov"></a></p>
<p><a href="https://gist.github.com/kenzo0107/0349f1a43c2aa26abf6db51fddd48af8">kenzo0107/test_go.yaml</a></p>
<h2><span id="まとめ">まとめ</span></h2><p>静的解析と単体テストを追加したことで</p>
<ul>
<li>コード変更がしやすくなった。</li>
<li>Golang の求めるコードの書き方を学ぶことができた。</li>
<li>aws-sdk-go の mock の作成の仕方を学ぶことができた。</li>
</ul>
<p>というご利益がありました。</p>
<h2><span id="単体テストで-100-を目指しましたが">単体テストで 100% を目指しましたが、</span></h2><p>ssh 接続周りで手こずってカバレッジが微増でした。</p>
<p>ssh 接続する際に仮想的な ssh server を起動する所まではよかったんですが、<br><code>(*ssh.Session).RequestPty</code> するとそこで処理待ちが発生し、テストが進まなくなってしまいました。</p>
<p>良い案ありましたらご教示いただけましたら幸いです <code>m(_ _)m</code></p>
<h2><span id="今回の知見を活かして">今回の知見を活かして</span></h2><p>AWS の EC2 や RDS 等の Reserved Instance の使用率・カバレッジ率を Datadog にプロットする Lambda を生成する <a href="https://aws.amazon.com/jp/serverless/sam/">SAM</a> プロジェクトを Go で作ってみました。</p>
<p>プロットしたメトリクスに監視することで使用率・カバレッジ率低下をアラートできます。</p>
<p><a href="https://github.com/kenzo0107/ri-utilization-plotter">kenzo0107/ri-utilization-plotter</a></p>
<p>また、より OSS らしくロゴを作ってみました♪</p>
<p>愛情が増します。</p>
<h2><span id="参照">参照</span></h2><p><a href="https://stackoverflow.com/questions/49418982/unit-testing-an-ssh-client-in-go">Unit Testing an SSH Client in Go</a></p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Go/">Go</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/02/09/2020-02-10-disk-usage/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ディスク使用量が増加した際の調査方法</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/12/08/2019-12-09-golang-errcheck-defer/"><span class="level-item">Golang errcheck による defer 警告対応</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->