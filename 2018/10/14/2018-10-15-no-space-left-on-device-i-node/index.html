<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20181015/20181015001102.jpg" alt="No space left on device が発生して i-node 枯渇してた時の原因調査法"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-10-14T15:00:00.000Z" title="2018-10-14T15:00:00.000Z">2018-10-15</time><span class="level-item">8分 read (About 1229 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">No space left on device が発生して i-node 枯渇してた時の原因調査法</h1><div class="content"><p>Linux Server で No space left on device が発生した時の対処まとめです。</p>
<a id="more"></a>

<h2><span id="とりあえず-df-h-してみる">とりあえず df -h してみる</span></h2><p><code>df -h</code> しても 最大で 77%<br><code>no space left on device</code> が発生することでもなさそう</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ df -h</span><br><span class="line"></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">udev            1.9G     0  1.9G   0% /dev</span><br><span class="line">tmpfs           385M   40M  346M  11% /run</span><br><span class="line">/dev/nvme0n1p1   15G   11G  3.3G  77% /</span><br><span class="line">tmpfs           1.9G     0  1.9G   0% /dev/shm</span><br><span class="line">tmpfs           5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs           1.9G     0  1.9G   0% /sys/fs/cgroup</span><br><span class="line">tmpfs           385M     0  385M   0% /run/user/1022</span><br><span class="line">tmpfs           385M     0  385M   0% /run/user/1128</span><br><span class="line">tmpfs           385M     0  385M   0% /run/user/1098</span><br><span class="line">tmpfs           385M     0  385M   0% /run/user/6096</span><br></pre></td></tr></table></figure>

<p><code>-h</code> = <code>--human-readable</code> 読みやすいサイズ表示をしてます。</p>
<h2><span id="df-i-してみる">df -i してみる</span></h2><p><code>df -i</code> で i-node 情報表示。最大 95%<br>これでした。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ df -i</span><br><span class="line"></span><br><span class="line">Filesystem     Inodes  IUsed  IFree IUse% Mounted on</span><br><span class="line">udev           490419    351 490068    1% /dev</span><br><span class="line">tmpfs          492742    521 492221    1% /run</span><br><span class="line">/dev/nvme0n1p1 983040 927212  55828   95% /</span><br><span class="line">tmpfs          492742      1 492741    1% /dev/shm</span><br><span class="line">tmpfs          492742      3 492739    1% /run/lock</span><br><span class="line">tmpfs          492742     16 492726    1% /sys/fs/cgroup</span><br><span class="line">tmpfs          492742      4 492738    1% /run/user/1022</span><br><span class="line">tmpfs          492742      4 492738    1% /run/user/1128</span><br><span class="line">tmpfs          492742      4 492738    1% /run/user/1098</span><br><span class="line">tmpfs          492742      4 492738    1% /run/user/1142</span><br></pre></td></tr></table></figure>

<p>i-node とは？と思ったら、 <a href="https://wa3.i-3-i.info/word14802.html">「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典 i-node編</a> 辺りを見てみてください。</p>
<p>簡単に言うと、ファイルの属性情報を管理しているデータです。</p>
<p>要は、ファイル数が増えると、ファイルを管理するデータが増え、 i-node はどんどん増えていきます。</p>
<p>その調査法をまとめました。</p>
<h2><span id="どのディレクトリのファイル数が多いか調査">どのディレクトリのファイル数が多いか調査</span></h2><p>以下は「現ディレクトリでのファイル数多い順ランキング」です。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo find . -xdev -<span class="built_in">type</span> f | cut -d <span class="string">"/"</span> -f 2 | sort | uniq -c | sort -r</span><br></pre></td></tr></table></figure>

<p>※ find の <code>-xdev</code> オプションはマウント先のファイルシステムを検索しない様にしてます。<code>-type f</code> はファイルのみ検索。</p>
<p>このワンライナーで原因となるファイル数の多いディレクトリを探索します。</p>
<h2><span id="当たりが付いている場合はそのディレクトリで実行">当たりが付いている場合はそのディレクトリで実行</span></h2><p>例えば、ユーザ毎にディレクトリが用意されている場合等に、個々人が home directory で git clone してるとか、<br>個々人が bundle install してて vendor ディレクトリ以下がファイル数が激増してたとか。</p>
<p>そういった事象があり得そうなら、 /home/ ディレクトリ以下でワンライナー実行して原因調査をするのが良いです。</p>
<p>各ユーザ毎が原因なら相談して消して良いかも確認できるし！</p>
<h2><span id="一番手っ取り早いのは-root-path-で実行">一番手っ取り早いのは、root path 「/」 で実行</span></h2><p>どのディレクトリのファイル数が多いのかを探るのなら、一番上位階層の「/」(root) から実行した方が特定しやすいです。</p>
<p>但し、root から全てのディレクトリ内のファイルを検索するとなると非常に cpu を食います。<br>実行してしばらくレスポンスが返ってこなくてドキドキします。</p>
<p><code>top</code> コマンド等で cpu 状況を監視しつつ、実行することをオススメします。</p>
<p>本番環境の web サーバで直ちにユーザ影響が出そうな場合は、LBから一旦外して、とか、ユーザアクセスの少ない時間に実行する様に影響範囲を最小限にしたい所。</p>
<p>状況見た上で進めましょう。</p>
<h2><span id="実際にあった-i-node-枯渇原因">実際にあった i-node 枯渇原因</span></h2><p>/usr ディレクトリ以下に linux-headers-*** ファイルが溜まっており、30% 近く食ってました。</p>
<p>以下記事に救われました。ありがとうございます。</p>
<p><a href="https://qiita.com/ytkumasan/items/d6cc70f151f130d58e9b">古いカーネルの削除方法メモ</a></p>
<h3><span id="追記-2020-07-02">追記 2020-07-02</span></h3><p>linux-headers-*** ファイルの削除について、不要な利用されていないファイルを削除するには以下コマンドで削除されます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt autoremove</span><br></pre></td></tr></table></figure>

<h4><span id="自動的に削除したい場合">自動的に削除したい場合</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 自動アップデートパッケージインストール</span><br><span class="line">$ sudo apt-get install -y unattended-upgrades</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 自動アップデート有効化</span><br><span class="line">$ sudo dpkg-reconfigure -plow unattended-upgrades</span><br><span class="line">Yes を選択</span><br></pre></td></tr></table></figure>

<p><code>/etc/apt/apt.conf.d/50unattended-upgrades</code> を以下の様に編集し、 unattended-upgrade 時に autoremove する処理を追加する。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim &#x2F;etc&#x2F;apt&#x2F;apt.conf.d&#x2F;50unattended-upgrades</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Unattended-Upgrade::Remove-Unused-Dependencies &quot;false&quot;;</span><br><span class="line">Unattended-Upgrade::Remove-Unused-Dependencies &quot;true&quot;;</span><br></pre></td></tr></table></figure>

<p>自動アップデートのログは <code>/var/log/unattended-upgrades/</code> に出力される。</p>
<p>以上です。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/i-node/">i-node</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2018/12/05/2018-12-06-boto3-assumerole-credentials-mfa/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">boto3 の AssumeRole をしたアカウントスイッチ credentials 利用時の MFA 突破対応</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2018/09/13/2018-09-14-aws-ec2-t2-t3-step-by-step/"><span class="level-item">AWS EC2 t2 から t3 へ移行する為の step by step</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->