<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180514/20180514221849.jpg" alt="AWS Vault で複数アカウントにMFA認証通過"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-05-13T15:00:00.000Z" title="2018-05-13T15:00:00.000Z">2018-05-14</time><span class="level-item">4分 read (About 617 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">AWS Vault で複数アカウントにMFA認証通過</h1><div class="content"><h2><span id="aws-vault-とは">AWS Vault とは？</span></h2><p>AWS Vault は IAMの認証情報 (Access Key Id, Secret Access Key) を安全に OS のキーストアに保存しアクセスできる仕組みを提供するツールです。</p>
<p>Vault = 金庫 というだけあって<br>PC 落としても秘匿情報が漏れにくい仕組みにしてくれます。</p>
<h2><span id="今回の目的">今回の目的</span></h2><p>AWS Vault で複数アカウントのコンソールログインを簡単にしたいと思います。</p>
<a id="more"></a>

<p>AWS IAM を頂く際に MFA 設定をしているかと思います。</p>
<p>デバイス認証することでセキュアなアカウントを管理をする為です。</p>
<p>その際に、以下の様なアプリをインストールし<br>1分置きに更新される 6桁 の数字で認証する仕組みにします。</p>
<blockquote><footer><strong>AppStore</strong><cite><a href="https://itunes.apple.com/jp/app/google-authenticator/id388497605">itunes.apple.com/jp/app/google-authenticator/id388497605</a></cite></footer></blockquote>

<blockquote><footer><strong>GooglePlay</strong><cite><a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=ja">play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=ja</a></cite></footer></blockquote>

<p>MFA 自体は<br>その会社の開発ポリシーにも依りますが、入れておいて損なしの仕組みです。</p>
<p>ただ、毎回 6桁の数字をコピぺするのは面倒です。</p>
<p>それを簡易的に認証通過する様にしました。</p>
<h2><span id="aws-vault-インストール">aws-vault インストール</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ brew cask install aws-vault</span><br></pre></td></tr></table></figure>

<h2><span id="profile-設定">profile 設定</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws-vault add &lt;profile&gt;</span><br><span class="line">Enter Access Key ID: &lt;Access Key ID 入力&gt;</span><br><span class="line">Enter Secret Access Key: &lt;Secret Access Key 入力&gt;</span><br></pre></td></tr></table></figure>

<h2><span id="事前準備">事前準備</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew tap peco/peco</span><br><span class="line">brew install peco</span><br></pre></td></tr></table></figure>

<h2><span id="bash-設定">bash 設定</span></h2><p>ご利用の .bashrc, .zshrc 等に設定してください。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> peco-login-aws-<span class="function"><span class="title">account</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> account=$(aws-vault ls | awk <span class="string">'NR&gt;2 &#123;if ($2 != "-") print $2&#125;'</span> | peco)</span><br><span class="line">    aws-vault login <span class="variable">$account</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> peco-aws-<span class="function"><span class="title">exec</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> account=$(aws-vault ls | awk <span class="string">'NR&gt;2 &#123;if ($2 != "-") print $2&#125;'</span> | peco)</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"aws-vault exec \"<span class="variable">$account</span>\" -- \\"</span> | pbcopy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> avl=<span class="string">'peco-login-aws-account'</span></span><br><span class="line"><span class="built_in">alias</span> ave=<span class="string">'peco-aws-exec'</span></span><br></pre></td></tr></table></figure>

<h2><span id="使い方">使い方</span></h2><ul>
<li>設定した profile を選択して Login</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avl</span><br></pre></td></tr></table></figure>

<ul>
<li>設定した profile を選択してコマンド実行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ave</span><br></pre></td></tr></table></figure>

<p>実際のコマンドを rec して出すのは憚れる内容でしたので貼り付けられず汗</p>
<p>是非一度利用し使用感を試してみてください♪</p>
<p>毎回パスワード入力というのも辛いところではありますが<br>MFA の手間に比べれば数段楽です。</p>
<p>AWS Vault は本来はそういう意図ではないと思いますが<br>楽になるならば良し♪</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/AWS/">AWS</a><a class="link-muted mr-2" rel="tag" href="/tags/Vault/">Vault</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2018/05/17/2018-05-18-ecs_prefix/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">AWS ECS prefix 指定してまとめてタスク登録解除</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2018/05/09/2018-05-10-ecr-nologin-push/"><span class="level-item">続　ECR にログイン(aws ecr get-login)無しでプッシュする</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->