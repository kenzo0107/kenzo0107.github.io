<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180730/20180730133759.jpg" alt="Datadog NTP 監視でアラート鳴りまくり対応"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-07-29T15:00:00.000Z" title="2018-07-29T15:00:00.000Z">2018-07-30</time><span class="level-item">3分 read (About 482 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Datadog NTP 監視でアラート鳴りまくり対応</h1><div class="content"><h2><span id="概要">概要</span></h2><p>サーバ時刻の監視を Datadog で実施する際、標準時刻の参照先が異なることで<br>不要なアラートが発生する事象がありました。</p>
<p>Datadog はデフォルトで  <code>pool.ntp.org</code> を参照しています。</p>
<p>AWS EC2 に設定した Chrony ではデフォルトで <code>ntp.nict.jp</code> を参照する様にしていた為、ある日突然アラートがなりまくる事象がありました。</p>
<p>この対策として、<br> Datadog と Chrony の参照先を統一して管理する様に設定しました。</p>
<a id="more"></a>

<h2><span id="タイムサーバホストを統一する">タイムサーバホストを統一する</span></h2><p>今回は、AWS を利用しており、 AWS にも NTP サーバがある為、そちらを参照することとしました。</p>
<p><a href="https://aws.amazon.com/jp/blogs/news/keeping-time-with-amazon-time-sync-service/">AWS Time Sync Service</a> のホストは <code>169.254.169.123</code> です。</p>
<p><code>169.254.169.123</code> のリンクローカル IP アドレスを介してアクセス可能な為、プライベートサブネットからでもアクセス可能です。<br>ip アドレスという辺りがある日変更されたとかあると辛いので怖いですが、今の所、そういうことはないです。</p>
<ul>
<li><p>/etc/datadog-agent/conf.d/ntp.d/conf.yaml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init_config:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">offset_threshold:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">169.254</span><span class="number">.169</span><span class="number">.123</span> <span class="comment"># 追加</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>/etc/chrony/chrony.conf</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server ntp.nict.jp minpoll 4 maxpoll 4  # コメントアウト</span></span><br><span class="line"><span class="string">server</span> <span class="number">169.254</span><span class="number">.169</span><span class="number">.123</span> <span class="string">prefer</span> <span class="string">iburst</span> <span class="comment"># 追加</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>上記設定後、リスタート</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl restart chrony</span><br><span class="line">$ sudo systemctl restart datadog-agent</span><br></pre></td></tr></table></figure>

<p>上記によりアラート解消されました。</p>
<h2><span id="参照">参照</span></h2><ul>
<li><a href="https://aws.amazon.com/jp/blogs/news/keeping-time-with-amazon-time-sync-service/">Amazon Time Sync Service で時間を維持する</a></li>
<li><a href="https://www.pool.ntp.org/ja/use.html">どうやったらpool.ntp.orgを利用出来るのでしょうか?</a></li>
</ul>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Datadog/">Datadog</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2018/07/31/2018-08-01-face-detector/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">顔検出 3分クッキング on MacOSX</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2018/07/10/2018-07-11-cleanup_docker_no_required_resource/"><span class="level-item">Docker 不要リソースお掃除 compose</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->