<div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-02-07T15:00:00.000Z" title="2018-02-07T15:00:00.000Z">2018-02-08</time><span class="level-item">8分 read (About 1176 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">AWS ECS トラブルシューティング</h1><div class="content"><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190208/20190208225212.jpg" width="100%">
</div>

<p>ECS を利用していて幾つかはまったポイントがあったのでまとめました。</p>
<h2><span id="started-1-task-が複数回実行されるが-コンテナが起動しない">started 1 task が複数回実行されるが、コンテナが起動しない</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ecs-cli compose service up ...</span><br><span class="line"></span><br><span class="line">level=info msg=<span class="string">"(service hogehoge) has started 1 tasks ..."</span></span><br><span class="line">level=info msg=<span class="string">"(service hogehoge) has started 1 tasks ..."</span></span><br><span class="line">level=info msg=<span class="string">"(service hogehoge) has started 1 tasks ..."</span></span><br></pre></td></tr></table></figure>


<p>ecs-cli compose service up でデプロイ時にタスク起動を実行するものの、起動が正しくできていない状態です。<br>こちらはコンテナ起動時の処理に問題がある場合があります。</p>
<ul>
<li>コンテナログを確認して、コンテナ起動失敗時刻付近のログを確認してください。</li>
<li>例えば、Nginx の設定ファイル, Rails のコードに typo, syntax error がある等です。</li>
</ul>
<h2><span id="already-using-a-port-required-by-your-task">already using a port required by your task</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service hogehoge was unable to place a task because no container instance met all of its requirements.</span><br><span class="line">The closest matching container-instance a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6 is already using a port required by your task</span><br></pre></td></tr></table></figure>


<p>port mapping を以下の様に設定していた。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"portMappings"</span>: [</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="string">"hostPort"</span>: <span class="number">0</span>,</span><br><span class="line">     <span class="string">"protocol"</span>: <span class="string">"tcp"</span>,</span><br><span class="line">     <span class="string">"containerPort"</span>: <span class="number">80</span></span><br><span class="line">   &#125;</span><br><span class="line"> ],</span><br></pre></td></tr></table></figure>


<p>新しいタスクでも 0:80 のポートを利用しようとする為、エラーとなります。<br>以下の様に設定することで回避できました。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"portMappings"</span>: [</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="string">"containerPort"</span>: <span class="number">80</span></span><br><span class="line">   &#125;</span><br><span class="line"> ],</span><br></pre></td></tr></table></figure>


<h2><span id="insufficient-memory-available">insufficient memory available</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO[0031] (service hogehoge) was unable to place a task because no container instance met all of its requirements. The closest matching (container-instance a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6) has insufficient memory available. For more information, see the Troubleshooting section of the Amazon ECS Developer Guide.  timestamp=2018-03-09 15:45:24 +0000 UTC</span><br></pre></td></tr></table></figure>


<p>タスク更新（<code>ecs-cli compose service up</code>）実行時、<br>上記の様なメモリ不足が出る場合はインスタンスタイプを上げる、また、他タスクを削除する等、メモリーリソースを増やす対応が必要です。</p>
<h2><span id="no-space-on-device">no space on device</span></h2><p>no space on device で イメージを pull できない。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20191003/20191003173809.png" width="100%">
</div>

<p><code>df -hT</code> コマンドで 容量の使用状況確認</p>
<p>未使用のコンテナ・ボリュームを強制削除しお掃除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -af --volumes</span><br></pre></td></tr></table></figure>


<h2><span id="msgcouldnt-run-containers-reasonresourcecpu">msg=”Couldn’t run containers” reason=”RESOURCE:CPU”</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg=<span class="string">"Couldn't run containers"</span> reason=<span class="string">"RESOURCE:CPU"</span></span><br></pre></td></tr></table></figure>


<p>タスクで指定している cpu (vCPU) が不足しています。<br>インスタンスタイプを上げる、もしくは、他タスクを削除する等、 CPU リソースを増やす対応が必要です。</p>
<h2><span id="fargate-port-mapping-error">Fargate - Port Mapping Error</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level=error msg=<span class="string">"Create task definition failed"</span> error=<span class="string">"ClientException: When networkMode=awsvpc, the host ports and container ports in port mappings must match.\n\tstatus code: 400, request id: a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6"</span></span><br></pre></td></tr></table></figure>


<p>起動タイプ Fargate で以下の様な設定だと、NG</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"80"</span></span><br></pre></td></tr></table></figure>


<p>こちらだと OK。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"80:80"</span></span><br></pre></td></tr></table></figure>


<p>ホストポートとコンテナポートのマッピングが必要です。</p>
<h2><span id="fargate-volume_from-は利用できない">Fargate volume_from は利用できない</span></h2><p><code>volume_from</code> は Fargate では使用できません。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level=error msg=<span class="string">"Create task definition failed"</span> error=<span class="string">"ClientException: host.sourcePath should not be set for volumes in Fargate.\n\tstatus code: 400, request id: a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6"</span></span><br></pre></td></tr></table></figure>


<h2><span id="指定された-iam-role-が適切なパーミッションを与えられていない">指定された IAM Role が適切なパーミッションを与えられていない</span></h2><p>IAM Role に権限を適宜付与します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">level=info msg=<span class="string">"(service hogehoge) failed to launch a task with (error ECS was unable to assume the role 'arn:aws:iam::123456789012:role/ecsTask</span></span><br><span class="line"><span class="string">ExecutionRole' that was provided for this task. Please verify that the role being passed has the proper trust relationship and permissions and that your IAM user has permissions to pass this role.)."</span> timestamp=2018-06-21 08:15:43 +0000 UTC</span><br></pre></td></tr></table></figure>


<p>イメージ pull できないというエラーも権限を付与していないことに起因することが主です。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CannotPullContainerError: API error (500): Get https://123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/v2/: net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection<span class="string">"</span></span><br></pre></td></tr></table></figure>


<p>現在稼働している ECS の IAM Role の権限を参考してください。変更される可能性があるのであくまで参考にし、適宜最新の情報を以ってご対応ください。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="string">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"Sid"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="string">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="string">"Action"</span>: [</span><br><span class="line">                <span class="string">"logs:PutLogEvents"</span>,</span><br><span class="line">                <span class="string">"logs:CreateLogStream"</span>,</span><br><span class="line">                <span class="string">"logs:CreateLogGroup"</span>,</span><br><span class="line">                <span class="string">"elasticloadbalancing:RegisterTargets"</span>,</span><br><span class="line">                <span class="string">"elasticloadbalancing:Describe*"</span>,</span><br><span class="line">                <span class="string">"elasticloadbalancing:DeregisterTargets"</span>,</span><br><span class="line">                <span class="string">"ecs:UpdateService"</span>,</span><br><span class="line">                <span class="string">"ecs:Submit*"</span>,</span><br><span class="line">                <span class="string">"ecs:StartTelemetrySession"</span>,</span><br><span class="line">                <span class="string">"ecs:StartTask"</span>,</span><br><span class="line">                <span class="string">"ecs:RunTask"</span>,</span><br><span class="line">                <span class="string">"ecs:RegisterTaskDefinition"</span>,</span><br><span class="line">                <span class="string">"ecs:RegisterContainerInstance"</span>,</span><br><span class="line">                <span class="string">"ecs:Poll"</span>,</span><br><span class="line">                <span class="string">"ecs:ListTasks"</span>,</span><br><span class="line">                <span class="string">"ecs:DiscoverPollEndpoint"</span>,</span><br><span class="line">                <span class="string">"ecs:DescribeTasks"</span>,</span><br><span class="line">                <span class="string">"ecs:DescribeServices"</span>,</span><br><span class="line">                <span class="string">"ecs:DescribeContainerInstances"</span>,</span><br><span class="line">                <span class="string">"ecs:DeregisterContainerInstance"</span>,</span><br><span class="line">                <span class="string">"ecs:CreateService"</span>,</span><br><span class="line">                <span class="string">"ecr:UploadLayerPart"</span>,</span><br><span class="line">                <span class="string">"ecr:PutImage"</span>,</span><br><span class="line">                <span class="string">"ecr:InitiateLayerUpload"</span>,</span><br><span class="line">                <span class="string">"ecr:GetDownloadUrlForLayer"</span>,</span><br><span class="line">                <span class="string">"ecr:GetAuthorizationToken"</span>,</span><br><span class="line">                <span class="string">"ecr:CompleteLayerUpload"</span>,</span><br><span class="line">                <span class="string">"ecr:BatchGetImage"</span>,</span><br><span class="line">                <span class="string">"ecr:BatchCheckLayerAvailability"</span>,</span><br><span class="line">                <span class="string">"ec2:Describe*"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>以上です。</p>
<p>また何か発生したら追記していきたいと思います。</p>
<h2><span id="reference">Reference</span></h2><ul>
<li><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/ecs-agent-disconnected/">Amazon ECS エージェントが切断状態で表示されるのは、なぜですか?</a></li>
</ul>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/AWS/">AWS</a><a class="link-muted mr-2" rel="tag" href="/tags/ECS/">ECS</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2018/03/06/2018-03-07-push-to-ecr-without-login-ecr/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ECR にログイン(aws ecr get-login)無しでプッシュする</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2018/01/09/2018-01-10-update-datadog-and-try-loggin-feature/"><span class="level-item">Datadog Agent 6系にアップデートして Logging 機能を試す！</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->