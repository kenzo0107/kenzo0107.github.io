<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180606/20180606115540.jpg" alt="Rails × Redis でスレッドセーフなアクセス数ランキング実装"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-06-05T15:00:00.000Z" title="2018-06-05T15:00:00.000Z">2018-06-06</time><span class="level-item">7分 read (About 1055 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Rails × Redis でスレッドセーフなアクセス数ランキング実装</h1><div class="content"><h2><span id="概要">概要</span></h2><p>メディアサイトで記事ページへアクセス数ランキングを実装しました。</p>
<ul>
<li>Rails 5.1</li>
<li>Redis (AWS ElastiCache 3.2.10)</li>
</ul>
<p>その際にマルチスレッド環境を考慮してスレッドセーフな実装を心がけました。</p>
<a id="more"></a>

<h2><span id="スレッドセーフとは">スレッドセーフとは</span></h2><p>スレッドセーフとは複数のスレッドが同時並行的に実行しても問題が発生しないことを意味します。<br>スレッドセーフでない場合は、あるスレッドで変更した共有データが、他のスレッドによって上書きされてしまう可能性があります。</p>
<p>Webサーバーやデータベースなどのサーバー用ソフトウェアは、マルチスレッド（マルチプロセス）で動作しているので、サーバー向けアプリケーションを開発するときは、マルチスレッドで動作するように実装することが望ましいです。</p>
<h4><span id="参照">参照</span></h4><p><a href="https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%BB%E3%83%BC%E3%83%95">スレッドセーフ</a></p>
<p><a href="https://qiita.com/naoyoshinori/items/507c5c3ea6027033f4bb">JavaのThreadLocalとスレッドセーフについて</a></p>
<h2><span id="仕様">仕様</span></h2><p>メディアサイトで記事詳細ページへアクセスした際に<br>その記事 ID に対して閲覧数を +1 インクリメントします。</p>
<p>そして、<br>その閲覧数 TOP 10 のランキングを表示する、<br>というものです。</p>
<p>その際の Rails, Redis の設定についてまとめました。</p>
<h2><span id="実装方法検討">実装方法検討</span></h2><p>config/initializers/redis.rb((host, port は secrets.yml なり ENV で設定してください)) で Redis の初期設定の実装方法を検討しました。</p>
<h3><span id="global-変数として設定">global 変数として設定</span></h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'redis'</span></span><br><span class="line"></span><br><span class="line">REDIS = Redis.new(<span class="symbol">host:</span> host, <span class="symbol">port:</span> port)</span><br></pre></td></tr></table></figure>

<p>上記の場合、<br>グローバルで Redis クライアントを持っており<br>マルチスレッド環境では、複数のスレッドが上書きされる可能性があります。</p>
<h3><span id="threadcurrent">Thread.current</span></h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'redis'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis</span></span></span><br><span class="line">  Thread.current[<span class="symbol">:redis</span>] <span class="params">||</span>= Redis.new(<span class="symbol">host:</span> host, <span class="symbol">port:</span> port)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>現在実行中のスレッドを取得しスレッド毎のデータを担保します。</p>
<p>が、以下 2  点の問題があります。</p>
<ol>
<li>他人が上書いてしまう</li>
<li>構造化されていない</li>
</ol>
<h3><span id="activesupportperthreadregistry">ActiveSupport::PerThreadRegistry</span></h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'redis'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisRegistry</span></span></span><br><span class="line">  extend ActiveSupport::PerThreadRegistry</span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:redis</span>, <span class="symbol">:current_permissions</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis</span></span></span><br><span class="line">  RedisRegistry.redis <span class="params">||</span>= Redis.new(<span class="symbol">host:</span> host, <span class="symbol">port:</span> port)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>redis をスレッドローカル変数として定義し、そのアクセスをカプセル化し上書きされるのを防止しています。</p>
<p>ですが、<br>Rails 5.2 で <a href="http://api.rubyonrails.org/classes/ActiveSupport/PerThreadRegistry.html">deprecated</a> となっておりました (TへT)</p>
<h3><span id="thread_mattr_accessor">thread_mattr_accessor</span></h3><p>以下を見てみると <code>thread_mattr_accessor</code> の挙動が Fix していました。<br><a href="https://github.com/rails/rails/pull/25681">Fix <code>thread_mattr_accessor</code> share variable superclass with subclass</a></p>
<p><code>thread_mattr_accessor</code> を利用して書き換えます。</p>
<ul>
<li>config/initializers/redis.rb</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'redis'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisRegistry</span></span></span><br><span class="line">  thread_mattr_accessor <span class="symbol">:redis</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis</span></span></span><br><span class="line">  RedisRegistry.redis <span class="params">||</span>= Redis.new(<span class="symbol">host:</span> host, <span class="symbol">port:</span> port)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2><span id="アクセス数インクリメント">アクセス数インクリメント</span></h2><p><code>rescue</code> 設定は Redis に接続できなくなった場合でもサイト自体が落ちることはなく、ランキングだけが表示されなくなる様にする為に設定しました。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">increment_access_count</span><span class="params">(id)</span></span></span><br><span class="line">  redis.zincrby <span class="string">"entries/daily/<span class="subst">#&#123;Time.zone.today&#125;</span>"</span>, <span class="number">1</span>, id</span><br><span class="line"><span class="keyword">rescue</span> SocketError =&gt; e</span><br><span class="line">  logger.error e</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3><span id="アクセスランキング取得">アクセスランキング取得</span></h3><p>Redis の zrevrangebyscore によりスコアの大きい順に 10 個、ID を取得します。<br>もし取得できなかった場合、 <code>[]</code> を返します。<br><code>decorate</code> で体良く整形して View に渡します。 ((decorate のコードは省略してます))</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">access_ranking</span></span></span><br><span class="line">  limit = <span class="number">10</span></span><br><span class="line">  ids = redis.zrevrangebyscore <span class="string">"entries/daily/<span class="subst">#&#123;Time.zone.today&#125;</span>"</span>, <span class="string">'+inf'</span>, <span class="number">0</span>, <span class="symbol">limit:</span> [<span class="number">0</span>, limit]</span><br><span class="line">  <span class="keyword">if</span> ids.any?</span><br><span class="line">    where(<span class="symbol">id:</span> ids).order([<span class="string">'field(id, ?)'</span>, ids]).limit(limit).decorate</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    []</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">rescue</span> SocketError =&gt; e</span><br><span class="line">  logger.error e</span><br><span class="line">  []</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>以上です。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Ruby/">Ruby</a><a class="link-muted mr-2" rel="tag" href="/tags/Rails/">Rails</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2018/06/23/2018-06-24-maintenance_aws_elasticache/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ElastiCache メンテナンス対応 ~2018年梅雨~</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2018/06/05/2018-06-06-specify-ecscli-version/"><span class="level-item">ElastiCache メンテナンス対応 ~2018年梅雨~</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->