<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>タグ: Prometheus - 長生村本郷Engineers&#039;Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="長生村本郷Engineers&#039;Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="長生村本郷Engineers&#039;Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="tech"><meta property="og:type" content="blog"><meta property="og:title" content="長生村本郷Engineers&#039;Blog"><meta property="og:url" content="https://kenzo0107.github.io/"><meta property="og:site_name" content="長生村本郷Engineers&#039;Blog"><meta property="og:description" content="tech"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://kenzo0107.github.io/img/og_image.png"><meta property="article:author" content="Kenzo Tanaka"><meta property="article:tag" content="aws golang"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://kenzo0107.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kenzo0107.github.io"},"headline":"長生村本郷Engineers'Blog","image":["https://kenzo0107.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Kenzo Tanaka"},"publisher":{"@type":"Organization","name":"長生村本郷Engineers'Blog","logo":{"@type":"ImageObject","url":"https://kenzo0107.github.io/img/logo.svg"}},"description":"tech"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-162026478-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-162026478-1');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="長生村本郷Engineers'Blog" type="application/atom+xml">
</head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/2014/01/01/about/">About</a><a class="navbar-item" href="/archives">Posts</a><a class="navbar-item" href="/categories/">Categories</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/kenzo0107"><i class="fab fa-twitter"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a><a class="navbar-item search" title="検索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">タグ</a></li><li class="is-active"><a href="#" aria-current="page">Prometheus</a></li></ul></nav></div></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/11/12/2017-11-13-prometheus-remote-storage/"><img class="thumbnail" src="https://i.imgur.com/zFciewX.png" alt="Prometheus2.0 remote storage 検証"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-11-13</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/12/2017-11-13-prometheus-remote-storage/">Prometheus2.0 remote storage 検証</a></h1><div class="content"><p>いよいよ出ました Prometheus 2.0 ！</p>
<p><a target="_blank" rel="noopener" href="https://prometheus.io/blog/2017/11/08/announcing-prometheus-2-0/">Announcing Prometheus 2.0 | Prometheus</a></p>
<p>先日<a target="_blank" rel="noopener" href="https://mackerel-ug.connpass.com/event/68478/">モニタリング勉強会</a>でも Paul Taylor さんの LT を拝聴させて頂き<br>パフォーマンス向上とストレージフォーマット変更による圧縮・バックアップがしやすくなった等、<br>良い話がたくさん出ていました。</p>
<p><a target="_blank" rel="noopener" href="https://www.slideshare.net/PaulTraylor/20171027-81281205">Operating Prometheus</a></p>
<p>中でも最も期待していた機能が Remote Long-Term Storage、<br>長期保存機能には歓喜しました ♪</p>
<p>1 系以下では、短期間用と長期間用の Prometheus を別途用意する等、対策が必要で<br>冗長な作りを余儀なくされたところがありましたが<br>2.0 リリースでついに！</p>
<p>早速試してみたく使用感をまとめました。</p>
<h2><span id="今回やりたかったことまとめ">今回やりたかったことまとめ</span></h2><ul>
<li>Prometheus 2.0 リリースに際して期待の長期保存機能 (Remote long-term storage) を早速試す！</li>
<li>実際にローカル環境で構築してみて 1 系からの変更箇所を確認</li>
<li>DB 側にどんなデータが入るのか確認</li>
</ul>
<h2><span id="システム概要">システム概要</span></h2><p>あくまで使用感の検証をしたかったので docker-compose でお手軽に作れる環境にしました。</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/zFciewX.png" width="100%">
</div>

<h2><span id="前提条件">前提条件</span></h2><p>以下を Vagrant にインストール</p>
<ul>
<li>Ubuntu 16.04.3 LTS \n \l</li>
<li>Docker version 17.09.0-ce, build afdb6d4</li>
<li>docker-compose version 1.12.0, build b31ff33</li>
</ul>
<h2><span id="起動する-docker-container">起動する Docker Container</span></h2><ul>
<li>Prometheus 2.0.0</li>
<li>Node Exporter 0.15.1</li>
<li>AlertManager 0.9.1</li>
<li>cAdvisor 0.28.0</li>
<li>Prometheu Adapter</li>
<li>PostgreSQL 9.6.3</li>
<li>Grafana 4.6.1</li>
<li>Nginx 1.13.6</li>
<li>Adminer</li>
</ul>
<h2><span id="使い方">使い方</span></h2><p>以下手順通りです。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kenzo0107/vagrant-docker/tree/vagrant-docker-ubuntu16.04/docker/prometheus-grafana-on-ubuntu">kenzo0107/vagrant-docker/tree/vagrant-docker-ubuntu16.04/docker/prometheus-grafana-on-ubuntu</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/vagrant-docker</span><br><span class="line">macOS%$ <span class="built_in">cd</span> vagrant-docker</span><br><span class="line">macOS%$ vagrant up</span><br><span class="line"></span><br><span class="line">// Install docker, docker-compose</span><br><span class="line">macOS%$ vagrant provision</span><br><span class="line">macOS%$ vagrant ssh</span><br><span class="line">vagrant%$ <span class="built_in">cd</span> /vagrant/prometheus-grafana-on-ubuntu</span><br><span class="line">vagrant%$ sudo docker-compose up -d</span><br><span class="line"></span><br><span class="line">Name                             Command                            State                             Ports</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">adapter                           /prometheus-postgresql-ada ...    Up</span><br><span class="line">adminer                           entrypoint.sh docker-php-e ...    Up                                8080/tcp</span><br><span class="line">alertmanager                      /bin/alertmanager -config. ...    Up                                9093/tcp</span><br><span class="line">cadvisor                          /usr/bin/cadvisor -logtost ...    Up                                8080/tcp</span><br><span class="line">grafana                           /run.sh                           Up                                3000/tcp</span><br><span class="line">nginx                             nginx -g daemon off;              Up                                0.0.0.0:18080-&gt;18080/tcp,</span><br><span class="line">                                                                                         0.0.0.0:3000-&gt;3000/tcp, 80/tcp,</span><br><span class="line">                                                                                         0.0.0.0:8080-&gt;8080/tcp,</span><br><span class="line">                                                                                         0.0.0.0:9090-&gt;9090/tcp</span><br><span class="line">node-exporter                     /bin/node_exporter                Up                                9100/tcp</span><br><span class="line">pgsql                             docker-entrypoint.sh -csyn ...    Up                                5432/tcp</span><br><span class="line">prometheus                        /bin/prometheus --config.f ...    Up                                9090/tcp</span><br></pre></td></tr></table></figure>

<h2><span id="アクセスしてみる">アクセスしてみる</span></h2><h3><span id="prometheus">Prometheus</span></h3><ul>
<li><a target="_blank" rel="noopener" href="http://192.168.35.101:9090/">http://192.168.35.101:9090</a>.</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/rg53Xa1.png" width="100%">
</div>

<h3><span id="grafana">Grafana</span></h3><ul>
<li><a target="_blank" rel="noopener" href="http://192.168.35.101:13000/">http://192.168.35.101:13000</a>.</li>
<li>ユーザアカウントが <code>./grafana/env</code> にあります.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GF_SECURITY_ADMIN_USER=admin-user</span><br><span class="line">GF_SECURITY_ADMIN_PASSWORD=admin-pass</span><br></pre></td></tr></table></figure>

<div style="text-align:center;">
<img src="https://i.imgur.com/fDXVySw.png" width="100%">
</div>

<ul>
<li>Datasource 設定</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/8SKvdxJ.png" width="100%">
</div>

<p>Datasource 設定フォームに以下情報を入力し <code>Add</code> ボタンをクリックします。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>Prometheus</td>
</tr>
<tr>
<td>Type</td>
<td>Prometheus</td>
</tr>
<tr>
<td>URL</td>
<td><a target="_blank" rel="noopener" href="http://prometheus:9090/">http://prometheus:9090</a></td>
</tr>
<tr>
<td>Access</td>
<td>proxy</td>
</tr>
</tbody></table>
<div style="text-align:center;">
<img src="https://i.imgur.com/6Cr4WTn.png" width="100%">
</div>

<ul>
<li>Dashboard.json インポート</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/cew58vF.png" width="100%">
</div>

<p>グラフが表示されます。</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/IicXL5e.png" width="100%">
</div>

<h3><span id="cadvisor">cAdvisor</span></h3><ul>
<li><a target="_blank" rel="noopener" href="http://192.168.35.101:8080/">http://192.168.35.101:8080</a>.</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/ZDH3zmI.png" width="100%">
</div>

<h2><span id="adminer">Adminer</span></h2><div style="text-align:center;">
<img src="https://i.imgur.com/uWT7sDC.png" width="100%">
</div>

<p>ログインフォームに以下情報を入力します。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Server</td>
<td>pgsql</td>
</tr>
<tr>
<td>Username</td>
<td>prometheus</td>
</tr>
<tr>
<td>Password</td>
<td>password</td>
</tr>
<tr>
<td>Database</td>
<td>postgres</td>
</tr>
</tbody></table>
<ul>
<li>PostgreSQL に保存されているメトリクス情報が確認できます。</li>
</ul>
<p>PostgreSQL &gt;&gt; pgsql &gt;&gt; postgres &gt;&gt; prometheus &gt;&gt; Select: metrics</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/cyPrvqC.png" width="100%">
</div>

<h2><span id="alertmanager-でアラート通知してみる">AlertManager でアラート通知してみる</span></h2><p>例として node-exporter を停止</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo docker-compose stop node-exporter</span><br></pre></td></tr></table></figure>

<p><code>./alertmanager/config.yml</code> で設定した Slack Channel にちゃんと通知がきました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171113/20171113021331.png" width="100%">
</div>

<h2><span id="所感">所感</span></h2><ul>
<li><p>2.0 になって設定の仕方が諸々変わり、公式サイトじっくり見る必要あります。</p>
<ul>
<li>と思ったら、早速まとめ出てました！ありがとうございます！<ul>
<li><a target="_blank" rel="noopener" href="https://qiita.com/tkusumi/items/293174826a8a5d47d186">Prometheus 2.0 の変更点と移行</a></li>
</ul>
</li>
</ul>
</li>
<li><p>今回は Prometheus ×1 台構成ですが、2 台以上で冗長化する構成も試してみたい。</p>
</li>
</ul>
<h2><span id="余談">余談</span></h2><ul>
<li>バグなのか google/cadvisor で検出するメトリクスが重複表示されて grafana で絞るのに困りました。<ul>
<li>Issue これ？<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/google/cadvisor/issues/1704">Inconsistent container metrics in prometheus route #1704</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><span id="あとがき">あとがき</span></h2><p>Mackerel の様なマネージドな監視サービスで運用コストを削減する以上に<br>Prometheus をマネージドすれば、さらにトータルコストを抑えられる様になる、<br>と睨んでます。</p>
<p>ですが、Datadog は APM 付きプランも適度なコスト感で提供しておりマネージドサービスの魅力は尚大きいです。</p>
<p>モニタリングの棲み分けをできる様にするにも、<br>選択肢の一つにするにも Prometheus 挑戦しがいがあるのでは？<br>と思っています。</p>
<p>Prometheus、今後さらに広まることを期待しています。</p>
<h2><span id="参考">参考</span></h2><ul>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/2.0/configuration/configuration/">Configuration | Prometheus</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/blob/release-2.0/config/testdata/conf.good.yml">prometheus/config/testdata/conf.good.yml</a></li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/02/15/2017-02-16-node_exporter/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170216/20170216225748.png" alt="node_exporter シェルでクエリ自作"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-02-16</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/02/15/2017-02-16-node_exporter/">node_exporter シェルでクエリ自作</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>node_expoter のオプション <code>--collector.textfile.directory</code> で指定したディレクトリに <code>*.prom</code> という拡張子を配置することで<br>そこに記述したメトリクス情報を prometheus server が読み取ってくれます。</p>
<p>この <code>*.prom</code> ファイルを一定時間毎に更新すればメトリクスが自作できる、というものです。</p>
<h2><span id="手順">手順</span></h2><ul>
<li>node_exporter 自体のインストール・セットアップは以下ご参照ください。</li>
</ul>


<p>上記手順では以下に node_exporter を配置しています。<br>環境によって適宜書き換えてください。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/node_exporter/node_exporter</span><br></pre></td></tr></table></figure>

<h2><span id="text_collector-ディレクトリ作成">text_collector ディレクトリ作成</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/node_exporter</span><br><span class="line">$ mkdir text_collector</span><br></pre></td></tr></table></figure>

<h2><span id="shell-作成">shell 作成</span></h2><p>今回は httpd の process count のメトリクス追加することとします。</p>
<ul>
<li>/usr/local/node_exporter/text_collector/httpd.sh 作成</li>
</ul>
<script src="//gist.github.com/kenzo0107/cf245d3ba1d2f0faea7f0134414a8c81.js"></script>

<h2><span id="cron-設定">cron 設定</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># node_exporter httpd 5分毎更新</span><br><span class="line">*/5 * * * * /usr/local/node_exporter/text_collector/httpd.sh</span><br></pre></td></tr></table></figure>

<h2><span id="httpdprom-作成確認">httpd.prom 作成確認</span></h2><ul>
<li>/usr/local/node_exporter/text_collector/httpd.prom</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_httpd_count 24</span><br></pre></td></tr></table></figure>

<p>上記の <code>node_httpd_count</code> がメトリクス名になります。</p>
<h2><span id="node_expoter-再起動">node_expoter 再起動</span></h2><p>以下のようにディレクトリ指定します。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_expoter --collector.textfile.directory /usr/local/node_exporter/text_collector</span><br></pre></td></tr></table></figure>

<h2><span id="作成したメトリクスを指定し確認する">作成したメトリクスを指定し確認する。</span></h2><p>無事できました！</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170216/20170216225202.png" width="100%">
</div>

<p>これを利用してるとシェル芸で色々事足りることもあります ♪</p>
<p>一助になれば何よりです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/02/02/2017-02-03-node_exporter-hwmon-collector-failed/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170203/20170203141542.png" alt="node_expoter error occured ! hwmon collector failed"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-02-03</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/02/02/2017-02-03-node_exporter-hwmon-collector-failed/">node_expoter error occured ! hwmon collector failed</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Amazon Linux に node_exporter をインストールし起動した所以下のエラーが発生し、起動停止してしまいました。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERRO[0007] ERROR: hwmon collector failed after 0.000011s: open /proc/class/hwmon: no such file or directory  <span class="built_in">source</span>=<span class="string">&quot;node_exporter.go:92&quot;</span></span><br></pre></td></tr></table></figure>

<h3><span id="hwmon-とは">hwmon とは？</span></h3><blockquote>
<p>Hard Ware MONitoring. Linux カーネルのセンサーチップから Hard Ware の温度やファン回転数や電圧を取得できる。</p>
</blockquote>
<p>環境情報は以下の通りです。</p>
<ul>
<li>Amazon Linux AMI release 2016.09</li>
<li>node_exporter version 0.14.0-rc.1 (branch: master, revision:5a07f4173d97fa0dd307db5bd3c2e6da26a4b16e)</li>
</ul>
<p>上記エラーですが issue として上がっていました。<br>そして解決されてました！</p>
<a href="https://github.com/prometheus/node_exporter/pull/427" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://opengraph.githubassets.com/a94772e2e5f786afa17c1bffb5f658b9a331ea854bf822762aee5f3637e4e3e1/prometheus/node_exporter/pull/427"></div><div class="descriptions"><div class="og-title">Allow graceful failure in hwmon collector by mdlayher · Pull Request #427 · prometheus/node_exporter</div><div class="og-description">$ ./node_exporter -web.listen-address 192.168.1.1:9100 -collectors.enabled hwmon -log.level debug
INFO[0000] Starting node_exporter (version…</div></div></div></a>

<p>タイミングが悪かったのかマージされる前の release を取得していた為<br>このエラーに遭遇していました。</p>
<p>最新のソースは master ブランチしてビルドするのが良さそうです。</p>
<p>以下に Amazon Linux で実施したインストール手順をまとめました。</p>
<h2><span id="手順">手順</span></h2><h3><span id="golang-インストール">Golang インストール</span></h3><p>以下 Golang オフィシャルサイトにある標準的なインストール方法です。参考にしてください。</p>


<h3><span id="node_exporter-をソースからインストールしビルド">node_exporter をソースからインストールしビルド</span></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p $GOPATH/src/github.com/prometheus</span><br><span class="line">$ cd $GOPATH/src/github.com/prometheus</span><br><span class="line">$ git clone https://github.com/prometheus/node_exporter</span><br><span class="line">$ cd node_exporter</span><br><span class="line">$ make build</span><br><span class="line"></span><br><span class="line">// version 確認</span><br><span class="line">$ ./node_exporter --version</span><br><span class="line">node_exporter, version 0.14.0-rc.1 (branch: master, revision: 428bc92b1c9b38f6de96bceb67bc5d9b3bdcf6e7)</span><br></pre></td></tr></table></figure>

<h3><span id="ついでに起動スクリプト">ついでに起動スクリプト</span></h3><ul>
<li>事前準備</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// pid ファイル置き場 作成</span><br><span class="line">$ sudo mkdir -p /var/run/prometheus</span><br><span class="line"></span><br><span class="line">// log ファイル置き場 作成</span><br><span class="line">$ sudo mkdir -p /var/log/prometheus</span><br><span class="line"></span><br><span class="line">// daemonize インストール</span><br><span class="line">$ cd /usr/local/src</span><br><span class="line">$ sudo git clone https://github.com/bmc/daemonize</span><br><span class="line">$ cd daemonize</span><br><span class="line">$ sudo ./configure</span><br><span class="line">$ sudo make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line">// PATHが通ってなかったらPATHに乗せる</span><br><span class="line">$ sudo cp daemonize /bin/</span><br><span class="line"></span><br><span class="line">$ which daemonize</span><br><span class="line">/bin/daemonize</span><br></pre></td></tr></table></figure>

<ul>
<li>起動スクリプト作成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd /etc/init.d</span><br><span class="line">$ sudo git clone https://gist.github.com/kenzo0107/eebb6c1c06ba04b7073c171580cec445</span><br><span class="line">$ sudo cp eebb6c1c06ba04b7073c171580cec445/node_exporter.init ./node_exporter</span><br><span class="line">$ sudo chmod 0755 node_exporter</span><br></pre></td></tr></table></figure>

<ul>
<li>起動</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /etc/init.d/node_exporter start</span><br></pre></td></tr></table></figure>

<p>無事エラーなく起動するようになりました ♪</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/02/01/2017-02-02-prometheus-alertmanager/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170202/20170202095647.png" alt="Alertmanager 構築手順"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-02-02</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/02/01/2017-02-02-prometheus-alertmanager/">Alertmanager 構築手順</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>前回 <a target="_blank" rel="noopener" href="http://kenzo0107.hatenablog.com/entry/2017/01/25/154144">Node Exporter 構築</a>しました。</p>


<p>今回は監視実施サーバで Alertmanager 構築を実施します。</p>
<h2><span id="今回やること-3-行まとめ">今回やること 3 行まとめ</span></h2><ul>
<li>Alertmanager インストール &amp; 起動スクリプト作成</li>
<li>Prometheus 通知条件設定</li>
<li>Alertmanager で Slack 通知</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170202/20170202095647.png" width="100%">
</div>

<h2><span id="alertmanager-の役割">Alertmanager の役割</span></h2><p>アラートのレベルによって通知先をどの程度の頻度で送信するかを管理します。<br>あくまで、通知先の管理をします。</p>
<p>実際のアラート条件の設定は Prometheus Server でします。</p>
<h2><span id="環境">環境</span></h2><ul>
<li>CentOS Linux release 7.3.1611 (Core)</li>
</ul>
<h2><span id="alertmanager-インストール">Alertmanager インストール</span></h2><ul>
<li>パッケージインストール</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/src</span><br><span class="line">$ sudo wget https://github.com/prometheus/alertmanager/releases/download/v0.5.1/alertmanager-0.5.1.linux-amd64.tar.gz</span><br><span class="line">$ sudo tar -C /usr/local -xvf alertmanager-0.5.1.linux-amd64.tar.gz</span><br><span class="line">$ cd /usr/local</span><br><span class="line">$ sudo mv alertmanager-0.5.1.linux-amd64 alertmanager</span><br></pre></td></tr></table></figure>

<ul>
<li>シンボリックリンク作成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ln -s /usr/local/alertmanager/alertmanager /bin/alertmanager</span><br><span class="line"></span><br><span class="line">$ alertmanager --version</span><br><span class="line"></span><br><span class="line">alertmanager, version 0.5.1 (branch: master, revision: 0ea1cac51e6a620ec09d053f0484b97932b5c902)</span><br><span class="line">  build user:       root@fb407787b8bf</span><br><span class="line">  build date:       20161125-08:14:40</span><br><span class="line">  go version:       go1.7.3</span><br></pre></td></tr></table></figure>

<h2><span id="alert-通知先設定">Alert 通知先設定</span></h2><p>以下 Slack へ通知設定です。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/alertmanager</span><br><span class="line">$ git clone https://gist.github.com/kenzo0107/71574c2d4d70ba7a9efaa88b4ff1be1b</span><br><span class="line">$ mv 71574c2d4d70ba7a9efaa88b4ff1be1b/alertmanager.yml .</span><br></pre></td></tr></table></figure>

<ul>
<li>alertmanager.yml</li>
</ul>
<p>slack 通知箇所を適宜変更して下さい。</p>
<script src="//gist.github.com/kenzo0107/71574c2d4d70ba7a9efaa88b4ff1be1b.js"></script>

<h2><span id="alertmanager-起動">Alertmanager 起動</span></h2><p>とりあえず起動するならこれだけ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo alertmanager -config.file alertmanager.yml</span><br></pre></td></tr></table></figure>

<p><code>http://alertmanager_server:9093/#/alerts</code> にアクセスすると以下のような画面が表示されます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170126/20170126194507.png" width="100%">
</div>

<p>Prometheus 同様、Alertmanager も起動スクリプトを作成しそこで起動管理をします。</p>
<h2><span id="起動スクリプト作成">起動スクリプト作成</span></h2><ul>
<li>オプションファイル作成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt; &#x27;EOF&#x27; &gt; /usr/local/alertmanager/option</span><br><span class="line">OPTIONS=&quot;-config.file /usr/local/alertmanager/alertmanager.yml&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>Alertmanager 起動スクリプト</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cat &lt;&lt; &#x27;EOF&#x27; | sudo tee /usr/lib/systemd/system/alertmanager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus alertmanager Service</span><br><span class="line">After=syslog.target prometheus.alertmanager.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/usr/local/alertmanager/option</span><br><span class="line">ExecStart=/bin/alertmanager $OPTIONS</span><br><span class="line">PrivateTmp=false</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>起動設定</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl daemon-reload</span><br><span class="line">$ sudo systemctl enable alertmanager.service</span><br><span class="line">$ sudo systemctl start alertmanager.service</span><br><span class="line">$ sudo systemctl status alertmanager.service -l</span><br></pre></td></tr></table></figure>

<h2><span id="アラート通知条件設定">アラート通知条件設定</span></h2><p>アラート通知条件は Prometheus Server 側で設定します。</p>
<p><a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/rules/">Prometheus Official - ALERTING RULES</a></p>
<p>サンプルとして以下設定します。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/prometheus-server</span><br><span class="line">$ cat &lt;&lt; &#x27;EOF&#x27; &gt; alerts.rules</span><br><span class="line"></span><br><span class="line"># インスタンスに 5分以上(FOR) アクセスできない場合(IF up == 0)</span><br><span class="line"># severity = &quot;critical&quot; とラベル付けし通知</span><br><span class="line">ALERT InstanceDown</span><br><span class="line">  IF up == 0</span><br><span class="line">  FOR 5m</span><br><span class="line">  LABELS &#123; severity = &quot;critical&quot; &#125;</span><br><span class="line">  ANNOTATIONS &#123;</span><br><span class="line">    summary = &quot;Instance &#123;&#123; $labels.instance &#125;&#125; down&quot;,</span><br><span class="line">    description = &quot;&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; has been down for more than 5 minutes.&quot;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// Prometheus 設定ファイルチェック</span><br><span class="line">$ promtool check-config prometheus.yml</span><br><span class="line"></span><br><span class="line">Checking prometheus.yml</span><br><span class="line">  SUCCESS: 1 rule files found</span><br><span class="line"></span><br><span class="line">Checking alerts.rules</span><br><span class="line">  SUCCESS: 1 rules found</span><br></pre></td></tr></table></figure>

<h2><span id="prometheus-server-で-alertmanager-url-設定">Prometheus Server で Alertmanager URL 設定</span></h2><p>Prometheus の起動オプションで Alertmanager URL 設定します。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-alertmanager.url=http://localhost:9093</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/prometheus-server</span><br><span class="line">$ cat &lt;&lt; &#x27;EOF&#x27; &gt; option</span><br><span class="line">OPTIONS=&quot;-config.file=/usr/local/prometheus-server/prometheus.yml -web.console.libraries=/usr/local/prometheus-server/console_libraries -web.console.templates=/usr/local/prometheus-server/consoles -alertmanager.url=http://localhost:9093&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">// Prometheus 再起動</span><br><span class="line">$ sudo systemctl restart prometheus.service</span><br></pre></td></tr></table></figure>

<h4><span id="注意">注意</span></h4><p>今回 Alertmanager は Prometheus Server と同サーバ上に設定しているので</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9093</span><br></pre></td></tr></table></figure>

<p>となっていますが、ドメインが異なる場合は適宜設定してください。</p>
<h2><span id="prometheus-alerts-ページアクセス">Prometheus Alerts ページアクセス</span></h2><p>設定した通知条件が表示されています。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170126/20170126195628.png" width="100%">
</div>

<h2><span id="通知試験">通知試験</span></h2><p>監視対象サーバの node_exporter を停止してみます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl stop node_exporter</span><br></pre></td></tr></table></figure>

<p>すると…</p>
<p>Slack に通知が届きました！</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170126/20170126200326.png" width="100%">
</div>

<p><code>http://alertmanager_server:9093/#/alerts</code> にアクセスすると通知内容一覧が表示されます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170126/20170126200742.png" width="100%">
</div>

<p>以上で簡単ながら<br>Prometheus からリモートサーバを監視しアラート通知するところまでを<br>まとめました。</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://kenzo0107.hatenablog.com/entry/2017/01/20/233312">Prometheus でサーバ監視</a></li>
<li><a target="_blank" rel="noopener" href="http://kenzo0107.hatenablog.com/entry/2017/01/25/154144">Node Exporter 構築手順 + Prometheus から AWS オートスケール監視</a></li>
<li><a target="_blank" rel="noopener" href="http://kenzo0107.hatenablog.com/entry/2017/02/02/101011">Alertmanager 構築手順</a></li>
</ol>
<h2><span id="補足">補足</span></h2><h3><span id="フロントエンド">フロントエンド</span></h3><p>Grafana 3.x 以降でデフォルトプラグインで Prometheus をサポートしていたりと<br>Prometheus のフロントは Grafana が導入しやすく相性が良かったです。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170202/20170202100116.png" width="100%">
</div>

<p>メトリクスを自作したり、Prometheus 独自のクエリを駆使して<br>様々なメトリクス監視が実現できます。</p>
<h3><span id="my-alertsrules">My alerts.rules</span></h3><script src="//gist.github.com/kenzo0107/6bca3225abd763ed4ec614dbaaec2c00.js"></script>

<h3><span id="learning">Learning</span></h3><p>改めて自身で構築してみて<br>Line Casual Talks #1, #2 を見直すと非常に理解が深まると思います。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://d.hatena.ne.jp/wyukawa/20160615/1465962814">Prometheus Casual Talks #1 を開催しました</a></li>
</ul>
<p>一助になれば何よりです。</p>
<p>以上です。<br>ご静聴ありがとうございました。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/01/24/2017-01-25-prometheus-aws-autoscaling/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125144719.png" alt="Node Exporter 構築手順 + Prometheus からAWSオートスケール監視"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-01-25</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/01/24/2017-01-25-prometheus-aws-autoscaling/">Node Exporter 構築手順 + Prometheus からAWSオートスケール監視</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>前回 <a target="_blank" rel="noopener" href="https://kenzo0107.hatenablog.com/entry/2017/01/20/233312">Prometheus Server 構築</a>しました。</p>


<p>今回は 監視対象サーバで Node Exporter 構築を実施します。</p>
<h2><span id="今回やること-3-行まとめ">今回やること 3 行まとめ</span></h2><ul>
<li>Node Exporter インストール</li>
<li>Node Exporter 起動スクリプト作成</li>
<li>Node Exporter 起動し Prometheus Server からモニタリング</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125144719.png" width="100%">
</div>

<h2><span id="環境">環境</span></h2><ul>
<li>CentOS Linux release 7.1.1503 (Core)</li>
</ul>
<h2><span id="node-exporter-インストール">Node Exporter インストール</span></h2><ul>
<li>パッケージインストール</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/src</span><br><span class="line">$ sudo wget https://github.com/prometheus/node_exporter/releases/download/v0.14.0-rc.1/node_exporter-0.14.0-rc.1.linux-amd64.tar.gz</span><br><span class="line">$ sudo tar -C /usr/local -xvf node_exporter-0.14.0-rc.1.linux-amd64.tar.gz</span><br><span class="line">$ cd /usr/local</span><br><span class="line">$ sudo mv node_exporter-0.14.0-rc.1.linux-amd64 node_exporter</span><br></pre></td></tr></table></figure>

<ul>
<li>シンボリックリンク作成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ln -s /usr/local/node_exporter/node_exporter /bin/node_exporter</span><br><span class="line"></span><br><span class="line">$ node_exporter --version</span><br><span class="line">node_exporter, version 0.14.0-rc.1 (branch: master, revision: 5a07f4173d97fa0dd307db5bd3c2e6da26a4b16e)</span><br><span class="line">  build user:       root@ed143c8f2fcd</span><br><span class="line">  build date:       20170116-16:00:03</span><br><span class="line">  go version:       go1.7.4</span><br></pre></td></tr></table></figure>

<h2><span id="node-exporter-起動">Node Exporter 起動</span></h2><p>とりあえず起動するならこれだけ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo node_exporter</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://node_exporter_server:9100/metrics">http://node_exporter_server:9100/metrics</a> にアクセスし<br>取得できる node_exporter で取得しているサーバのメトリクス情報が確認できます。</p>
<p>Prometheus 同様、Node Exporter も起動スクリプトを作成しそこで起動管理をします。</p>
<h2><span id="起動スクリプト作成">起動スクリプト作成</span></h2><ul>
<li>Node Exporter 起動スクリプト</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cat &lt;&lt; &#x27;EOF&#x27; | sudo tee /usr/lib/systemd/system/node_exporter.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Node Exporter</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/bin/node_exporter</span><br><span class="line">PrivateTmp=false</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>起動設定</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl daemon-reload</span><br><span class="line">$ sudo systemctl enable node_exporter.service</span><br><span class="line">$ sudo systemctl start node_exporter.service</span><br><span class="line">$ sudo systemctl status node_exporter.service -l</span><br></pre></td></tr></table></figure>

<h2><span id="アクセスしてみる">アクセスしてみる</span></h2><p><a target="_blank" rel="noopener" href="http://node_exporter_server:9100/metrics">http://node_exporter_server:9100/metrics</a> にアクセスします。</p>
<p>以下のように表示されていれば Node Exporter 起動成功です。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/Z4Juj0i.png" width="100%">
</div>

<h2><span id="prometheus-から監視">Prometheus から監視</span></h2><p>今回は AWS EC2 インスタンスで起動中の node_exporter によるメトリクス取得設定です。</p>
<p>※ 監視実施サーバに <code>AmazonEC2ReadOnlyAccess</code> をアタッチしたロール設定をする必要があります。<br><span style="color: #ff5252">※ 監視対象サーバに 監視対象サーバから <code>9100 ポート</code> へアクセスできるようにセキュリティグループ設定します。 </span></p>
<ul>
<li>/usr/local/prometheus-server/prometheus.yml 編集</li>
</ul>
<p>以下設定は region 指定しアクセス権のある Instance のメトリクスを取得します。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">      <span class="attr">monitor:</span> <span class="string">&#x27;codelab-monitor&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - &quot;first.rules&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;second.rules&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="attr">ec2_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">region:</span> <span class="string">ap-northeast-1</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">********************</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="string">****************************************</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">9100</span></span><br></pre></td></tr></table></figure>

<h4><span id="タグで監視対象を絞る">タグで監視対象を絞る</span></h4><p>全インスタンスを監視であれば上記で問題ありません。</p>
<p>ですが、監視対象をある程度条件で絞りたいケースがあります。<br>そんな時、Prometheus では <code>relabel_configs</code> でインスタンスの設定タグで絞る方法があります。</p>
<ul>
<li>インスタンスのタグ設定</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125144948.png" width="100%">
</div>

<ul>
<li>prometheus.yml 設定</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">      <span class="attr">monitor:</span> <span class="string">&#x27;codelab-monitor&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - &quot;first.rules&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;second.rules&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="attr">ec2_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">region:</span> <span class="string">ap-northeast-1</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">********************</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="string">****************************************</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_ec2_tag_Stage</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">production</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_ec2_tag_Role</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br></pre></td></tr></table></figure>

<ul>
<li>prometheus.yml 編集後、再起動</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl restart prometheus.service</span><br></pre></td></tr></table></figure>

<h2><span id="prometheus-から-node_exporter-起動したサーバを監視できているか確認">Prometheus から node_exporter 起動したサーバを監視できているか確認</span></h2><p><a target="_blank" rel="noopener" href="http://prometheus_server:9090/consoles/node.html">http://prometheus_server:9090/consoles/node.html</a></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125153144.png" width="100%">
</div>

<p><code>Up : Yes</code> となっている Node のリンクをクリックすると CPU, Disck のグラフが確認できます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125154033.png" width="100%">
</div>

<p>次回は 監視対象で <a href="https://kenzo0107.github.io/2017/02/02/2017-02-02-prometheus-alertmanager">Alertmanager 構築</a>します。</p>
<h2><span id="参照">参照</span></h2>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/01/19/2017-01-20-prometheus-monitoring/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125140715.png" alt="Prometheus でサーバ監視"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-01-20</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/01/19/2017-01-20-prometheus-monitoring/">Prometheus でサーバ監視</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>以前 Ansible + Vagrant で Prometheus モニタリング環境構築について書きました。</p>


<p>今回は具体的によくある設定ユースケースを順追って設定していきます。</p>
<ol>
<li><a href="http://kenzo0107.github.io/2017/01/20/2017-01-20-prometheus-monitoring">Prometheus Server 構築</a></li>
<li><a href="http://kenzo0107.github.io/2017/01/25/2017-01-25-prometheus-aws-autoscaling">監視対象で Node Exporter 構築</a></li>
<li><a href="http://kenzo0107.github.io/2017/02/02/2017-02-02-prometheus-alertmanager">Alertmanager 構築</a></li>
</ol>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125134654.png" width="100%">
</div>

<h2><span id="今回やること-3-行まとめ">今回やること 3 行まとめ</span></h2><ul>
<li>Prometheus Server モジュールインストール</li>
<li>Prometheus Server 起動スクリプト作成</li>
<li>Prometheus Server 起動し自身のサーバモニタリング</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125140715.png" width="100%">
</div>

<p>Prometheus の設定ファイルについては<br>全体像を理解した後が良いと思いますので<br>Node Exporter の設定の後に実施したいと思います。</p>
<h2><span id="環境">環境</span></h2><ul>
<li>CentOS Linux release 7.3.1611 (Core)</li>
</ul>
<h2><span id="prometheus-インストール">Prometheus インストール</span></h2><ul>
<li>パッケージインストール<br><a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/releases">最新のバージョン</a>をチェックしダウンロードしてください。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/src</span><br><span class="line">$ sudo wget https://github.com/prometheus/prometheus/releases/download/v1.4.1/prometheus-1.4.1.linux-amd64.tar.gz</span><br><span class="line">$ sudo tar -C /usr/local -xvf prometheus-1.4.1.linux-amd64.tar.gz</span><br><span class="line">$ cd /usr/local</span><br><span class="line">$ sudo mv prometheus-1.4.1.linux-amd64 prometheus-server</span><br></pre></td></tr></table></figure>

<ul>
<li>シンボリックリンク作成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ln -s /usr/local/prometheus-server/prometheus /bin/prometheus</span><br><span class="line">$ sudo ln -s /usr/local/prometheus-server/promtool /bin/promtool</span><br><span class="line"></span><br><span class="line">$ prometheus --version</span><br><span class="line">prometheus, version 1.4.1 (branch: master, revision: 2a89e8733f240d3cd57a6520b52c36ac4744ce12)</span><br><span class="line">  build user:       root@e685d23d8809</span><br><span class="line">  build date:       20161128-09:59:22</span><br><span class="line">  go version:       go1.7.3</span><br><span class="line"></span><br><span class="line">$ promtool version</span><br><span class="line">promtool, version 1.4.1 (branch: master, revision: 2a89e8733f240d3cd57a6520b52c36ac4744ce12)</span><br><span class="line">  build user:       root@e685d23d8809</span><br><span class="line">  build date:       20161128-09:59:22</span><br><span class="line">  go version:       go1.7.3</span><br></pre></td></tr></table></figure>

<h2><span id="prometheus-起動">Prometheus 起動</span></h2><p>とりあえず起動するならこれだけ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo prometheus -config.file=/usr/local/prometheus-server/prometheus.yml</span><br></pre></td></tr></table></figure>

<p>ただ ↑ これを毎回実行するのは辛いので起動スクリプトを作成して<br>サーバ再起動時に自動起動したり<br><code>systemctl start ...</code> と実行したい。</p>
<h2><span id="起動スクリプト作成">起動スクリプト作成</span></h2><ul>
<li>Prometheus オプションファイル作成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt; &#x27;EOF&#x27; &gt; /usr/local/prometheus-server/option</span><br><span class="line">OPTIONS=&quot;-config.file=/usr/local/prometheus-server/prometheus.yml -web.console.libraries=/usr/local/prometheus-server/console_libraries -web.console.templates=/usr/local/prometheus-server/consoles&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>Prometheus 起動スクリプト</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cat &lt;&lt; &#x27;EOF&#x27; | sudo tee /usr/lib/systemd/system/prometheus.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus Service</span><br><span class="line">After=syslog.target prometheus.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/usr/local/prometheus-server/option</span><br><span class="line">ExecStart=/bin/prometheus $OPTIONS</span><br><span class="line">PrivateTmp=false</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>起動設定</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl daemon-reload</span><br><span class="line">$ sudo systemctl enable prometheus.service</span><br><span class="line">$ sudo systemctl start prometheus.service</span><br><span class="line">$ sudo systemctl status prometheus.service -l</span><br></pre></td></tr></table></figure>

<h2><span id="アクセスしてみる">アクセスしてみる</span></h2><p><code>&lt;IP Address&gt;:9090</code> にアクセスします。<br>以下のように表示されていれば Prometheus 起動成功です。</p>
<p><img src="http://i.imgur.com/1gchGrW.png" alt="Imgur"></p>
<p>オプション設定でも設定した、 <code>/usr/local/prometheus-server/consoles</code> の各 html にもアクセスしてみてください。</p>
<p><code>&lt;IP Address&gt;:9090/consoles/prometheus-overview.html?instance=localhost%3a9090</code></p>
<div style="text-align:center;">
<img src="http://i.imgur.com/1gchGrW.png" width="100%">
</div>

<p>次回は <a href="http://kenzo0107.github.io/2017/01/25/2017-01-25-prometheus-aws-autoscaling">監視対象で Node Exporter 構築</a> します。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/06/20/2016-06-21-ansible-vagrant-prometheus/"><img class="thumbnail" src="http://i.imgur.com/pfazhaR.png" alt="Ansible+Vagrant でシンプルなPrometheusモニタリング環境構築"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2016-06-21</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/06/20/2016-06-21-ansible-vagrant-prometheus/">Ansible+Vagrant でシンプルなPrometheusモニタリング環境構築</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p><a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/getting_started/">Prometheus 入門</a> にあるチュートリアルを<br>Ansible で簡単に構築できるようにした、<br>というものです。</p>
<p>先日 2016 年 6 月 14 日、<br>LINE 株式会社での<a target="_blank" rel="noopener" href="http://connpass.com/event/32859/">Prometheus Casual Talks #1</a>に参加し<br>ナレッジのおさらいなどしたく、<br>構築法をまとめました。</p>
<h2><span id="prometheus-とは">Prometheus とは</span></h2><p>最近話題の Pull 型の Query Filtering 可能で Grafana 等と連携できる モニタリング/Alert ツールです。</p>
<h2><span id="構成">構成</span></h2><p><img src="http://i.imgur.com/pfazhaR.png" alt="Imgur"></p>
<ul>
<li>Prometheus Server × 1</li>
<li>Prometheus Client × 2</li>
</ul>
<h2><span id="環境">環境</span></h2><ul>
<li>CentOS 6.5</li>
<li>Prometheus Server 0.20.0</li>
<li>Supervisor 3.3.0</li>
<li>Go 1.6.2</li>
<li>Ansibl 2.1.0.0</li>
<li>Vagrant 1.8.1</li>
<li>MacOSX 10.11.5</li>
</ul>
<h2><span id="前提条件">前提条件</span></h2><p>以下ツールをインストールしておいてください。</p>
<ul>
<li>VirtualBox</li>
<li>Vagrant</li>
<li>Ansible</li>
</ul>
<h2><span id="使い方">使い方</span></h2><h3><span id="1-git-repository-を-clone">1. git repository を clone</span></h3><p>[<a target="_blank" rel="noopener" href="https://github.com/kenzo0107/Vagrant-Prometheus]">https://github.com/kenzo0107/Vagrant-Prometheus]</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/kenzo0107/Vagrant-Prometheus</span><br></pre></td></tr></table></figure>

<h2><span id="2-vagrant-vm-起動">2. Vagrant VM 起動</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd Vagrant-Prometheus</span><br><span class="line">$ vagrant up</span><br></pre></td></tr></table></figure>

<p>3 node running !</p>
<ul>
<li>1 node: Prometheus Server</li>
<li><ul>
<li>192.168.11.30</li>
</ul>
</li>
<li>other 2 nodes: Prometheus Client Server</li>
<li><ul>
<li>192.168.33.31</li>
</ul>
</li>
<li><ul>
<li>192.168.33.32</li>
</ul>
</li>
</ul>
<h2><span id="3-sshconfig-追加">3. ssh.config 追加</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh-config &gt; ssh.config</span><br></pre></td></tr></table></figure>

<h2><span id="4-ping-疎通試験">4. ping 疎通試験</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ansible default -m ping</span><br><span class="line"></span><br><span class="line">server | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">client1 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">client2 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ok, success.</p>
<h2><span id="5-2node-に-prometheusclient-設定">5. 2node に PrometheusClient 設定</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook set_clients_prometheus.yml</span><br></pre></td></tr></table></figure>

<h2><span id="6-prometheusclient-の起動確認">6. PrometheusClient の起動確認</span></h2><p>以下 PrometheusClient を起動しているサーバにアクセスし<br>起動されているか確認します。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://192.168.11.31:8080/metrics">http://192.168.11.31:8080/metrics</a></li>
<li><a target="_blank" rel="noopener" href="http://192.168.11.32:8080/metrics">http://192.168.11.32:8080/metrics</a></li>
</ul>
<p>以下のように表示されれば成功です。</p>
<img src="http://i.imgur.com/igPci2Z.png" width="400px">

<h2><span id="7-prometheusserver-設定">7. PrometheusServer 設定</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook set_server_prometheus.yml</span><br></pre></td></tr></table></figure>

<h2><span id="8-prometheusserver-確認">8. PrometheusServer 確認</span></h2><p><a target="_blank" rel="noopener" href="http://192.168.33.30:9090/">http://192.168.33.30:9090</a> にアクセス</p>
<p>以下のように表示されれば成功です。</p>
<img src="http://i.imgur.com/XDTarz3.png" width="400px">

<p>是非多少なりとも一助となれば何よりです！<br>いじくり倒してみてください！</p>
<p>以上</p>
</div></article></div></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a><p class="is-size-7"><span>&copy; 2025 Kenzo Tanaka</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Privacy Policy" href="/2013/12/31/PrivacyPolicy/"><i class="fab fa-p"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("ja");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="トップに戻る" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js"></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="何かを入力してください..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"何かを入力してください...","untitled":"(無題)","posts":"投稿","pages":"ページ","categories":"カテゴリ","tags":"タグ"});
        });</script></body></html>