<div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">タグ</a></li><li class="is-active"><a href="#" aria-current="page">WAF</a></li></ul></nav></div></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/07/2017-10-08-waf-cloudfront-referer-check/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005180531.png" alt="WAF+CloudFront でリファラチェック (直リンク禁止)"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-10-07T15:00:00.000Z" title="2017-10-07T15:00:00.000Z">2017-10-08</time><span class="level-item">7分 read (About 1003 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/07/2017-10-08-waf-cloudfront-referer-check/">WAF+CloudFront でリファラチェック (直リンク禁止)</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>AWS WAF (Web Application Firewall) を利用し Cloudfront でのリファラ制御を実装しましたのでそのまとめです。</p>
<p>直リンク禁止対策として導入しました。</p>
<p>以下手順になります。</p>
<h3><span id="go-to-aws-waf-ボタンクリック">Go to AWS WAF ボタンクリック</span></h3><p>サービス &gt; WAF &amp; Shield と辿り Go to AWS WAF クリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005174955.png" width="100%">
</div>

<h3><span id="configure-web-acl-ボタンクリック">Configure Web ACL ボタンクリック</span></h3><p>ACL (Access Control List) を設定していきます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005180856.png" width="100%">
</div>

<h3><span id="概要確認">概要確認</span></h3><p>特にチェックせず Next ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181044.png" width="100%">
</div>

<h3><span id="web-acl-設定">web ACL 設定</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181315.png" width="100%">
</div>

<p>以下、設定項目を設定し、Next ボタンクリック</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Web ACL name</td>
<td>(任意) 例ではCloudfront の CNAME を設定しています。</td>
</tr>
<tr>
<td>CloudWatch metric name</td>
<td>Web ACL name を入力すると自動で入力される。変更したい場合のみ変更</td>
</tr>
<tr>
<td>Region</td>
<td>Global(CloudFront) 選択</td>
</tr>
<tr>
<td>AWS resource to associate</td>
<td>対象となるCloudfrontを選択する箇所。運用中の Cloudfront を対象とすると場合は後々設定。</td>
</tr>
</tbody></table>
<h3><span id="条件作成">条件作成</span></h3><p>今回は文字列一致を条件とする為、 String match conditions にて <code>Create condition</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181800.png" width="100%">
</div>

<h3><span id="string-match-condition-作成">string match condition 作成</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181926.png" width="100%">
</div>

<p>以下設定し <code>Add filter</code> ボタンクリック。<br>複数 filter がある場合、Add filter を繰り返します。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>(任意)</td>
</tr>
<tr>
<td>Part of the request to filter on</td>
<td>Header</td>
</tr>
<tr>
<td>Header</td>
<td>Referer</td>
</tr>
<tr>
<td>Match type</td>
<td>Contains</td>
</tr>
<tr>
<td>Transformation</td>
<td>Convert to lowercase</td>
</tr>
<tr>
<td>Value to match</td>
<td>対象となるドメイン設定</td>
</tr>
</tbody></table>
<br>

<h4><span id="add-filter-後-create-ボタンクリック"><code>Add filter</code> 後、 <code>Create</code> ボタンクリック。</span></h4><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182327.png" width="100%">
</div>

<h4><span id="next-ボタンクリック">Next ボタンクリック</span></h4><p>追加したもののすぐに反映されていない。<br>そのまま <code>Next</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182446.png" width="100%">
</div>

<h3><span id="ルール作成">ルール作成</span></h3><p><code>Create rule</code> ボタンクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182608.png" width="100%">
</div>

<h4><span id="ルールに条件を紐付け">ルールに条件を紐付け</span></h4><p>Name, Cloudwatch metric name を設定し<br>Add conditions で条件を追加します。</p>
<p>その後、<code>Create</code> ボタンクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182641.png" width="100%">
</div>

<h3><span id="ルール以外のリクエストのアクセス禁止">ルール以外のリクエストのアクセス禁止</span></h3><p>やはり Rule は反映されていない。ですが、続けて<br><code>Block all requests that don&#39;t match any rules</code> をチェックし <code>Review and create</code> ボタンクリック。</p>
<p>※対象のCloudfront に反映させたくない場合は、Cloudfront を選択したリソースを解除する必要があります。<br><span style="color: #ff0000">※最後に関連付けができるのでここではするべきではないと思います。</span></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182806.png" width="100%">
</div>

<h3><span id="確認ページで入力内容確認後作成">確認ページで入力内容確認後作成</span></h3><p><code>Confirm and create</code> ボタンクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005183423.png" width="100%">
</div>

<h3><span id="対象の-web-acl-を編集">対象の web ACL を編集</span></h3><p>WEB ACLs より選択し <code>Edit web ACL</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005183628.png" width="100%">
</div>

<h4><span id="web-acl-編集">web ACL 編集</span></h4><ol>
<li>作成したルールを選択</li>
<li><code>Add rule to web ACL</code> ボタンクリック</li>
<li>Allow 選択</li>
<li><code>Update</code> ボタンクリック</li>
</ol>
<p>[f:id:kenzo0107:20171005183720p:plain]</p>
<h3><span id="cloudfront-関連付け">Cloudfront 関連付け</span></h3><p><code>Add association</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005183720.png" width="100%">
</div>

<h4><span id="web-acl-に-cloudfront-を関連付け">Web ACL に Cloudfront を関連付け</span></h4><p>Resource で 対象の Cloudfront を選択し <code>Add</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005184119.png" width="100%">
</div>

<p>以上で数分後 WAF+CloudFront によるリファラチェックが確認できる状態になります。</p>
<h3><span id="アクセス確認">アクセス確認</span></h3><p>自環境では<br>ローカルの /etc/hosts 修正し対象ドメインから Cloudfront CNAME へのリンクを貼って確認しました。</p>
<p>Cloudfront CNAME ドメインでのリソースを直接アクセスすると<br>以下の様な エラーページが表示されることが確認できました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005184505.png" width="100%">
</div>

<h3><span id="もう少しユーザフレンドリーに">もう少しユーザフレンドリーに</span></h3><p>上記のエラーページは Cloudfront &gt; Error Pages で  <code>Create Custom Error Response</code> で S3 上のパスを指定することでカスタマイズが可能です。</p>
<p>是非サイトコンセプトに合ったエラーページをご用意されるとよりユーザフレンドリーな配信になるかと思います。</p>
<p>以上<br>ご参考になれば幸いです。</p>
</div></article></div>