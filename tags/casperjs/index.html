<div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">タグ</a></li><li class="is-active"><a href="#" aria-current="page">casperjs</a></li></ul></nav></div></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/24/2017-10-25-casperjs-phantomjs-github-organization/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171025/20171025214738.png" alt="CasperJS+PhantomJS で Github Organization 移行"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-10-24T15:00:00.000Z" title="2017-10-24T15:00:00.000Z">2017-10-25</time><span class="level-item">4分 read (About 624 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/24/2017-10-25-casperjs-phantomjs-github-organization/">CasperJS+PhantomJS で Github Organization 移行</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Github Enterprise の Organization 移行を実施した際に CasperJS と PhantomJS でヘッドレスブラウザより操作し移行しました。<br>Github 上で API がない（はず？）為、この様な対応をしました。</p>
<p>どちらかというと CasperJS+PhantomJS でブラウザ上の試験作りを楽しんでいたこともあり<br>試してみてすんなりできたので採用した経緯になります。</p>
<h2><span id="ヘッドレスブラウザとは">ヘッドレスブラウザとは？</span></h2><p>GUI なしのブラウザを CLI で利用するというもの。<br>ページ描画や画像ロード、ログインしたりとフロントの試験で期待される機能を持っています。</p>
<h2><span id="三行まとめ">三行まとめ</span></h2><ul>
<li>CasperJS + PhantomJS でログイン認証はじめブラウザ操作で Transfer する工程を実行</li>
<li>移行後、元の URL が移行先にリダイレクトされるか確認</li>
<li>期待する要素が時間内に取得できないときはページをキャプチャ</li>
</ul>
<h2><span id="やってみる">やってみる</span></h2><p><a href="https://github.com/kenzo0107/transfer-repository-on-ghe#get-started">Get Started</a> ご参照ください。</p>
<a href="https://github.com/kenzo0107/transfer-repository-on-ghe" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://avatars0.githubusercontent.com/u/6197906?s=400&v=4"></div><div class="descriptions"><div class="og-title">kenzo0107/transfer-repository-on-ghe</div><div class="og-description">Transfer repositories to a new owner by using headless browser with CasperJS and PhantomJS. - kenzo0107/transfer-repository-on-ghe</div></div></div></a>

<p>以下にも手順まとめてます。</p>
<h2><span id="clone">Clone</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/ghe-org-transfer</span><br><span class="line">macOS%$ <span class="built_in">cd</span> ghe-org-transfer</span><br></pre></td></tr></table></figure>

<h2><span id="scriptsghe-org-transferjs-の-ltyour-gt-編集">scripts/ghe-org-transfer.js の &lt;your ****&gt; 編集</span></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">  <span class="comment">// site root.</span></span><br><span class="line">  siteRoot: <span class="string">'https://&lt;your github domain&gt;'</span>,</span><br><span class="line">  <span class="comment">// Github Login path</span></span><br><span class="line">  loginPath: <span class="string">'/login'</span>,</span><br><span class="line">  <span class="comment">// Github Login Account</span></span><br><span class="line">  loginParams: &#123;</span><br><span class="line">    email: <span class="string">'&lt;your email&gt;'</span>,</span><br><span class="line">    password:  <span class="string">'&lt;your password&gt;'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  viewportSize: &#123;</span><br><span class="line">    width: <span class="number">3000</span>,</span><br><span class="line">    height: <span class="number">2500</span></span><br><span class="line">  &#125;,</span><br><span class="line">  paths: [</span><br><span class="line">    <span class="string">"&lt;your owner&gt;/&lt;your repository&gt;"</span></span><br><span class="line">  ],</span><br><span class="line">  destOrganization: <span class="string">'&lt;your destination of organization&gt;'</span>,</span><br><span class="line">  reason: <span class="string">'transfer this repository to new oragnization'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3><span id="移行イメージ">移行イメージ</span></h3><ul>
<li>ex) hoge/mywonderfulrepo —&gt; moge/mywonderfulrepo</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">paths: [</span><br><span class="line">  <span class="string">"hoge/mywonderfulrepo"</span></span><br><span class="line">],</span><br><span class="line">destOrganization: <span class="string">'moge'</span>,</span><br></pre></td></tr></table></figure>

<p>paths は複数指定しても問題ありません。</p>
<h2><span id="移行実施">移行実施</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ make run</span><br></pre></td></tr></table></figure>

<ul>
<li>実行結果</li>
</ul>
<p>※ 移行後に元の URL でリダイレクトされるか試験しています。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[url] https://github.aiueo.com/hoge/mywonderfulrepo/settings</span><br><span class="line">[step] fill <span class="string">'#transfer_confirm &gt; form'</span></span><br><span class="line">[step] input checkbox <span class="comment">#team-59</span></span><br><span class="line">[step] click the button labeled <span class="string">"Transfer"</span></span><br><span class="line">(^-^) redirect ok:https://github.aiueo.co.jp/hoge/mywonderfulrepo to https://github.aiueo.co.jp/moge/mywonderfulrepo</span><br></pre></td></tr></table></figure>

<h2><span id="総評">総評</span></h2><p>以前 Grafana のグラフのスナップショットを撮る Grafana API がうまく動作しなかったのも<br>CasperJS+PhantomJS で取得する様にできました。</p>
<p>いやはや便利♪</p>
<p>全然別件ですが、サイトの認証に利用される reCAPTCHA の突破など挑戦してましたがうまく行かず…<br>うまくいったぜ！という方、是非教えてください m(_ _)m</p>
</div></article></div>