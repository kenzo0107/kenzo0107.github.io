<div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">タグ</a></li><li class="is-active"><a href="#" aria-current="page">Kibana</a></li></ul></nav></div></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2015/11/23/2015-11-24-kibana-regex-pattern-match/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151124/20151124123137.png" alt="Kibana4 検索窓での検索 正規表現パターンマッチ等"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-11-23T15:00:00.000Z" title="2015-11-23T15:00:00.000Z">2015-11-24</time><span class="level-item">3分 read (About 406 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/11/23/2015-11-24-kibana-regex-pattern-match/">Kibana4 検索窓での検索 正規表現パターンマッチ等</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>アクセスログをfluentdで集積(aggregate)して<br>ElasticSearch へ保存、そのデータをkibanaで表示しています。</p>
<p>ちょっとしたアクセスログ解析したい場合、<br>かつては、SSHでサーバにログインして<br>コマンド実行し検索するという工程を踏んでいました。</p>
<p>ですが、Kibanaで検索することにより<br>サーバログインすることなく、検索がスムーズになりました。</p>
<p>リモートログインして誤った操作等もなくなる、<br>また本番環境アカウントの公開範囲を絞ることができ<br>良いことが増えました。</p>
<p>実際構築しても使う側がどう検索したら良いかわからないということが<br>ちょいちょいあったので<br>Kibana4 検索窓での検索方法を簡単にまとめました。</p>
<h2><span id="前提">前提</span></h2><ul>
<li>Kibana4</li>
<li>ドメイン名を以下とする</li>
</ul>
<p><code>http(s)://hogehoge.jp</code></p>
<h3><span id="範囲指定">範囲指定</span></h3><ul>
<li>httpステータスコード 200 から 400 検索</li>
</ul>
<p>status: [200 TO 400]</p>
<h3><span id="否定">否定</span></h3><ul>
<li>例) 指定ドメイン以外のリファラ検索</li>
<li><code>referer</code> という項目について 正規表現での否定(NOT)のパターンマッチで検索します。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NOT referer:&#x2F;http(s?)\:\&#x2F;\&#x2F;hogehoge\.jp\&#x2F;(.*)&#x2F;</span><br></pre></td></tr></table></figure>

<h3><span id="複合検索">複合検索</span></h3><ul>
<li>例) 指定ドメイン以外、且つ、200ステータス</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NOT referer:&#x2F;http(s?)\:\&#x2F;\&#x2F;hogehoge\.jp\&#x2F;(.*)&#x2F; AND status:200</span><br></pre></td></tr></table></figure>

<p>随時、事例があれば追記していきます。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-10-06T15:00:00.000Z" title="2015-10-06T15:00:00.000Z">2015-10-07</time><span class="level-item">2分 read (About 362 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/10/06/2015-10-07-kibana-error-discover-an-error-occured-with-your-request/">Kibana エラー対応 - Discover: An error occurred with your request. Reset your inputs and try again.</a></h1><div class="content"><h2><span id="問題">問題</span></h2><p>ある日、Kibana &gt; Discover にアクセスすると以下のようなエラー表示で<br>Searchingが完了できない状態に陥った。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151007/20151007120432.png" width="100%">
</div>

<h2><span id="elasticsearchログ確認">ElasticSearchログ確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">tail -f &#x2F;var&#x2F;log&#x2F;elasticsearch&#x2F;elasticsearch.log</span><br><span class="line"></span><br><span class="line">Failed to execute [org.elasticsearch.action.search.SearchRequest@8307e49] while moving to second phase</span><br><span class="line">java.lang.ClassCastException: java.lang.Long cannot be cast to org.apache.lucene.util.BytesRef</span><br><span class="line">        at org.apache.lucene.search.FieldComparator$TermOrdValComparator.compareValues(FieldComparator.java:902)</span><br><span class="line">        at org.apache.lucene.search.TopDocs$MergeSortQueue.lessThan(TopDocs.java:172)</span><br><span class="line">        at org.apache.lucene.search.TopDocs$MergeSortQueue.lessThan(TopDocs.java:120)</span><br><span class="line">        at org.apache.lucene.util.PriorityQueue.upHeap(PriorityQueue.java:225)</span><br><span class="line">        at org.apache.lucene.util.PriorityQueue.add(PriorityQueue.java:133)</span><br><span class="line">        at org.apache.lucene.search.TopDocs.merge(TopDocs.java:234)</span><br><span class="line">        at org.elasticsearch.search.controller.SearchPhaseController.sortDocs(SearchPhaseController.java:239)</span><br><span class="line">        at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.moveToSecondPhase(TransportSearchQueryThenFetchAction.java:89)</span><br><span class="line">        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.innerMoveToSecondPhase(TransportSearchTypeAction.java:403)</span><br><span class="line">        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.onFirstPhaseResult(TransportSearchTypeAction.java:202)</span><br><span class="line">        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$1.onResult(TransportSearchTypeAction.java:178)</span><br><span class="line">        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$1.onResult(TransportSearchTypeAction.java:175)</span><br><span class="line">        at org.elasticsearch.search.action.SearchServiceTransportAction$23.run(SearchServiceTransportAction.java:568)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>

<p>キャストがうまくいってないバグ出てました。</p>
<p>マッピングがうまくいってないのかな？<br>と問題を想定して色々設定変更していたらここにたどり着いた。</p>
<h2><span id="解決">解決</span></h2><ol>
<li>Kibana &gt; Settings &gt; Advanced</li>
<li>sort:options {“unmapped_type”: “boolean”} → {“ummapped_type”: “date” } に変更</li>
</ol>
<p>これで治った！</p>
<p>GithubでもClose Issueとして残ってましたね。</p>
<p><a href="https://github.com/elastic/kibana/issues/4593">Auto detect field type when sorting on unmapped_type fields</a></p>
</div></article></div>