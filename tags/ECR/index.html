<div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">タグ</a></li><li class="is-active"><a href="#" aria-current="page">ECR</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-05-09T15:00:00.000Z" title="2018-05-09T15:00:00.000Z">2018-05-10</time><span class="level-item">2分 read (About 249 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/09/2018-05-10-ecr-nologin-push/">続　ECR にログイン(aws ecr get-login)無しでプッシュする</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>前回 ECR への Docker イメージをプッシュする際の認証コマンドを実行せずにプッシュできる様にしました。</p>
<p><a href="http://kenzo0107.hatenablog.com/entry/2018/03/07/230736">ECR にログイン(aws ecr get-login)無しでプッシュする</a></p>
<p>ですが、<br>設定が手間というのがあり、CircleCI, AWS CodeBuild 等でワンライナーでささっと書きたいときには不便です。</p>
<h2><span id="解決">解決</span></h2><p><code>awscli profile</code> で設定した profile を利用し ecs-cli を利用することで認証をよろしくやってくれます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ecs-cli push &lt;image&gt; --aws-profile &lt;profile&gt; --region &lt;region&gt;</span><br></pre></td></tr></table></figure>

<h2><span id="設定-step">設定 Step</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws configure <span class="built_in">set</span> --profile hogehoge aws_access_key_id <span class="variable">$ACCESS_KEY_ID</span></span><br><span class="line">aws configure <span class="built_in">set</span> --profile hogehoge aws_secret_access_key <span class="variable">$SECRET_ACCESS_KEY</span></span><br><span class="line">aws configure <span class="built_in">set</span> --profile hogehoge region ap-northeast-1</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ecs-cli push 123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/stg-mogemoge-rails:latest \</span><br><span class="line">	--aws-profile hogehoge \</span><br><span class="line">	--region ap-northeast-1</span><br></pre></td></tr></table></figure>

<p>以上で <code>aws ecr get-login</code> を使用せず、ECR へプッシュができる様になりました♪</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/03/06/2018-03-07-push-to-ecr-without-login-ecr/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180307/20180307231703.png" alt="ECR にログイン(aws ecr get-login)無しでプッシュする"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-03-06T15:00:00.000Z" title="2018-03-06T15:00:00.000Z">2018-03-07</time><span class="level-item">3分 read (About 514 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/06/2018-03-07-push-to-ecr-without-login-ecr/">ECR にログイン(aws ecr get-login)無しでプッシュする</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Docker version 1.11 で実装された credential-helper を利用し<br>ECR へのプッシュを安全に簡易的に行う仕組みを実装します。</p>
<h2><span id="docker-ver-111-以上にアップグレード">Docker ver 1.11 以上にアップグレード</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D</span><br><span class="line">$ sudo sh -c <span class="string">"echo deb https://apt.dockerproject.org/repo ubuntu-trusty main\</span></span><br><span class="line"><span class="string">&gt; /etc/apt/sources.list.d/docker.list"</span></span><br><span class="line">$ sudo apt-get purge lxc-docker docker</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install docker-engine</span><br><span class="line">$ sudo service docker restart</span><br></pre></td></tr></table></figure>

<h2><span id="pull-dockerized-ecr-credential-helper">pull Dockerized ECR credential helper</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<h2><span id="認証設定">認証設定</span></h2><p>以下3つの中から1つ利用ください。<br>EC2 であれば、<code>1. インスタンスロールで認証</code> が一番すっきりしていてコードの見通しが良いです。</p>
<ol>
<li>インスタンスロールで認証</li>
<li>credential で認証</li>
<li>環境変数で認証</li>
</ol>
<h3><span id="1-インスタンスロールで認証">1. インスタンスロールで認証</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">  -e REGISTRY=123457689012.dkr.ecr.us-east-1.amazonaws.com \</span><br><span class="line">  pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'cat &lt;&lt; EOF &gt; /usr/bin/docker-credential-ecr-login</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">SECRET=\$(docker run --rm \\</span></span><br><span class="line"><span class="string">  -e METHOD=\$1 \\</span></span><br><span class="line"><span class="string">  -e REGISTRY=\$(cat -) \\</span></span><br><span class="line"><span class="string">  pottava/amazon-ecr-credential-helper)</span></span><br><span class="line"><span class="string">echo \$SECRET | grep Secret</span></span><br><span class="line"><span class="string">EOF'</span></span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/bin/docker-credential-ecr-login</span><br></pre></td></tr></table></figure>

<h3><span id="2-credential-で認証">2. credential で認証</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">  -e REGISTRY=123457689012.dkr.ecr.us-east-1.amazonaws.com \</span><br><span class="line">  -v <span class="variable">$HOME</span>/.aws/credentials:/root/.aws/credentials \</span><br><span class="line">  pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'cat &lt;&lt; EOF &gt; /usr/bin/docker-credential-ecr-login</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">SECRET=\$(docker run --rm \\</span></span><br><span class="line"><span class="string">  -e METHOD=\$1 \\</span></span><br><span class="line"><span class="string">  -e REGISTRY=\$(cat -) \\</span></span><br><span class="line"><span class="string">  -v $HOME/.aws/credentials:/root/.aws/credentials \\</span></span><br><span class="line"><span class="string">  pottava/amazon-ecr-credential-helper)</span></span><br><span class="line"><span class="string">echo \$SECRET | grep Secret</span></span><br><span class="line"><span class="string">EOF'</span></span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/bin/docker-credential-ecr-login</span><br></pre></td></tr></table></figure>

<h3><span id="3-環境変数で認証">3. 環境変数で認証</span></h3><ul>
<li>環境変数セット</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">  -e REGISTRY=123457689012.dkr.ecr.us-east-1.amazonaws.com \</span><br><span class="line">  -e AWS_ACCESS_KEY_ID \</span><br><span class="line">  -e AWS_SECRET_ACCESS_KEY \</span><br><span class="line">  pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'cat &lt;&lt; EOF &gt; /usr/bin/docker-credential-ecr-login</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">SECRET=\$(docker run --rm \\</span></span><br><span class="line"><span class="string">  -e METHOD=\$1 \\</span></span><br><span class="line"><span class="string">  -e REGISTRY=\$(cat -) \\</span></span><br><span class="line"><span class="string">  -e AWS_ACCESS_KEY_ID \\</span></span><br><span class="line"><span class="string">  -e AWS_SECRET_ACCESS_KEY \\</span></span><br><span class="line"><span class="string">  pottava/amazon-ecr-credential-helper)</span></span><br><span class="line"><span class="string">echo \$SECRET | grep Secret</span></span><br><span class="line"><span class="string">EOF'</span></span><br><span class="line">sudo chmod +x /usr/bin/docker-credential-ecr-login</span><br></pre></td></tr></table></figure>

<h2><span id="credential-保存設定">credential 保存設定</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mv <span class="variable">$HOME</span>/.docker/config.json <span class="variable">$HOME</span>/.docker/config.json.org</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"credsStore"</span>: <span class="string">"ecr-login"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>これで <code>aws ecr get-login</code> から解放されます♪</p>
</div></article></div>