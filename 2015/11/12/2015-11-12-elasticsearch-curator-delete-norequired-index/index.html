<div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-11-12T15:00:00.000Z" title="2015-11-12T15:00:00.000Z">2015-11-13</time><span class="level-item">2分 read (About 295 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Elasticsearch curatorで不要Indexをまとめて削除</h1><div class="content"><h2><span id="概要">概要</span></h2><p>fluentd + ElasticSearch + kibana を運用していますが<br>ある日ElasticSearchが動作しなくなる事象が発生しました。</p>
<p>過去indexが溜まりに溜まってメモリ不足というエラー。</p>
<p>logはS3にアップロードしているし、<br>不要なIndexは適宜削除して対策しました。</p>
<h2><span id="環境">環境</span></h2><ul>
<li>CentOS Linux release 7.0.1406 (Core)</li>
<li>ElasticSearch 1.7.1</li>
<li>Python 2.7.5</li>
<li>pip 7.1.0</li>
</ul>
<h2><span id="curator-インストール">curator インストール</span></h2><ul>
<li>ElasticSearchをインストールしているサーバにて以下実施</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># pip install curator</span><br></pre></td></tr></table></figure>

<h2><span id="curator-コマンド実行">curator コマンド実行</span></h2><ul>
<li>ElasticSearchをインストールしているサーバにて以下実施</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 14日(2週間)経過でclose</span><br><span class="line">curator --host localhost close indices --prefix logstash --older-than 14 --time-unit days --timestring %Y.%m.%d</span><br><span class="line"></span><br><span class="line"># 35日(4週間)経過でdelete</span><br><span class="line">curator --host localhost delete indices --prefix logstash --older-than 35 --time-unit days --timestring %Y.%m.%d</span><br><span class="line"></span><br><span class="line"># 2日経過でbloom filter無効化</span><br><span class="line">curator --host localhost bloom indices --prefix logstash --older-than 2 --time-unit days --timestring %Y.%m.%d</span><br></pre></td></tr></table></figure>

<p>上記をjenkinsで <a href="https://wiki.jenkins-ci.org/display/JENKINS/SSH+plugin">SSH plugin</a> で<br>リモートサーバにログインして実行するよう、<br>設定して定期ポーリングで1日1回実行させてます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151112/20151112142836.png" width="100%">
</div>

<p>以上</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Elasticsearch/">Elasticsearch</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2015/11/16/2015-11-17-versionup-nginx-without-maintenance/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">運用中のNginxをノーメンテでバージョンアップ&amp;HTTP2.0モジュールを導入</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2015/11/12/2015-11-13-check-gzip-compress/"><span class="level-item">運用中のNginxをノーメンテでバージョンアップ&amp;HTTP2.0モジュールを導入</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->