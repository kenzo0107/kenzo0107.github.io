<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208143258.png" alt="Twilio で電話通知"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-12-07T15:00:00.000Z" title="2015-12-07T15:00:00.000Z">2015-12-08</time><span class="level-item">9分 read (About 1415 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Twilio で電話通知</h1><div class="content"><h2><span id="概要">概要</span></h2><p>障害検知をメールやSlackに流しても休日に業務系連絡を見ることは少ない。<br><br>その為、より検知報告に気付きやすくする様、<br><br>電話通知にするべくTwilioを導入する運びとなりました。</p>
<p>まずは利用するまでの簡単な手順をまとめました。<br></p>
<p>※コードのサンプルがTwilioのサイト内にあるので導入しやすかったです。</p>
<h2><span id="手順">手順</span></h2><h3><span id="1-twilio-にアクセス">1. Twilio にアクセス</span></h3><p>以下リンクからTwilioにアクセスします。</p>
<p><a href="http://twilio.kddi-web.com">http://twilio.kddi-web.com</a></p>
<h3><span id="2-新規登録">2. 新規登録</span></h3><p>名前、E-mail、パスワード(大小半角英数字)と</p>
<p>何にどの言語で利用するかを選択して</p>
<p>「始めましょう」をクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208104015.png" width="100%">
</div>

<p>「始めましょう」という日本語はユーザ目線でなく違和感ありますね。</p>
<h3><span id="3-アカウント認証">3. アカウント認証</span></h3><p>以下２つの認証方法があります。</p>
<ul>
<li>電話番号にSMSに確認コードを送信させる</li>
<li>電話番号にTwilioから着信があり確認コードのダイヤルキーを入力する。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208104800.png" width="100%">
</div>

<p>後者はTwilioの音声読み上げロボットから電話がかかって来るので<br><br>どんな感じで通知されるか試してみたい方は是非後者を選択してみてください。<br></p>
<p>スムーズなイントネーションではないですが、伝えたい気持ちは誰よりもあります。</p>
<h3><span id="4-twilioから電話をかけてみる">4. Twilioから電話をかけてみる</span></h3><p>アカウント認証確認後、Twilio製品の「プログラマブルVoice」ページTopに遷移しました。<br>メニューから <code>ツール</code> をクリックしツールページに遷移してください。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208110143.png" width="100%">
</div>


<h4><span id="to指定">To指定</span></h4><p>音声通話&gt;通話&gt;電話をかける のAPI Explorer にて<br><code>必須</code> の<code>To</code> に 電話番号認証した番号を入力してください。</p>
<p>但し、日本番号（+81）の場合、<br> <code>090********</code> の番号は<br><br>はじめの <code>0</code> を削除し、 <code>+81</code> をprefixとして追加し、<br><br><code>+8190********</code> となりますので注意してください。<br></p>
<h4><span id="url指定">URL指定</span></h4><p><code>条件</code> の<code>Url</code> にTwilioからの電話を受け取った際、<br><br>電話のキーダイヤルを押下した際の挙動をurl形式で指定可能です。</p>
<p>適当に準備できるUrlがない場合は、<br><br>以下のような適当なUrlで良いです。</p>
<p><code>http:/hogehoge.hogehoge.co.jp</code></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208110552.png" width="100%">
</div>

<h4><span id="通知実行">通知実行</span></h4><p>ページ下部の <code>リクエストを発行する</code> ボタンをクリックします。</p>
<p><span style="color: #d32f2f">※</span> <code>※料金が発生します</code> とありますが、Trialは料金を請求されるということはありません。<br><br><span style="color: #d32f2f">※</span>同アカウントでアップグレードする際は、発信した電話料金も合わせて請求されることになるので、テスト完了後は別途アカウントを取得することを推奨します。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208112301.png" width="100%">
</div>

<h4><span id="電話を受け取る">電話を受け取る</span></h4><p>Twilioから電話がかかってきたかと思います。<br><br>キーダイヤルを入力すると、 Urlで指定したプログラムが動作しますが、<br><br>適当に入力したので<br><br><code>アプリケーションエラーが発生しました。電話を終了します。</code><br>と通知されるはずです。</p>
<p>実際にプログラムから使用する際は、<br><br>指定したUrlでキー入力を受け取ってその後の挙動を制御する、<br><br>という流れになります。</p>
<h2><span id="実際に利用した例">実際に利用した例</span></h2><p>担当した業務では、Zabbixからの障害検知をTwilioで担当者に電話報告（エスカレーション）するという仕組みを構築しました。</p>
<blockquote>
<p>例）以下のような挙動が実現できます。<br><br>Zabbixで障害検知 <br><br>↓<br><br>Twilio<br><br>↓ 電話<br><br>対応者 <br><br>↓ 対応者が「1」をクリック<br><br>指定したUrlのプログラム実行<br><br>↓「1」を受け取り、障害対応可能な旨をZabbixへ通知<br><br>Zabbix (障害対応中)</p>
</blockquote>
<h5><span id="zabbix-amp-twilio-参考">Zabbix &amp; Twilio 参考</span></h5><p><a href="http://begood-technology.github.io/zabbix-twilio/">zabbix-twillio</a></p>
<p>上記サイトでのzabbix-twilio連携の手順で進めた場合、<br><br>twilio でキーダイヤル入力後、 以下のようなエラーが発生し、イベント登録ができません。<br><br><code>API error -32602: The &quot;user.login&quot; method must be called without the &quot;auth&quot; parameter</code></p>
<p>zabbix-twilio.php内の <code>Zabbix_API</code>クラスが古い為です。<br></p>
<p><a href="https://github.com/begood-technology/zabbix-twilio/blob/master/zabbix-twilio.php">zabbix-twilio.php</a></p>
<p><a href="https://github.com/confirm/PhpZabbixApi">PhpZabbixApi</a></p>
<p>上記をダウンロードし、 <code>php build.php</code> で 以下2ファイルを生成し、<br><br>こちらを呼び出し <code>Zabbix_Api</code> と <code>ZabbixApi</code> とを変更してください。</p>
<ul>
<li>ZabbixApi.class.php</li>
<li>ZabbixApiAbstract.class.php</li>
</ul>
<ul>
<li>/var/www/html/zabbix-twilio/zabbix-twilio.php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ require_once &#39;ZabbixApi.class.php&#39;;</span><br><span class="line">+ use ZabbixApi\ZabbixApi;</span><br><span class="line"></span><br><span class="line">-                                       $api &#x3D; new Zabbix_API ( $ZABBIX_API, $ZABBIX_USER, $ZABBIX_PASS );</span><br><span class="line">+                                       $api &#x3D; new ZabbixApi ( $ZABBIX_API, $ZABBIX_USER, $ZABBIX_PASS);</span><br></pre></td></tr></table></figure>

<p><code>ZabbixApi</code> は Basic認証を設定している場合にも対処しています。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 例)</span><br><span class="line">$api &#x3D; new ZabbixApi ( $ZABBIX_API, $ZABBIX_USER, $ZABBIX_PASS, $BASIC_AUTH_USER, $BASIC_AUTH_PASS);</span><br></pre></td></tr></table></figure>



<h4><span id="検証環境">検証環境</span></h4><ul>
<li>Amazon Linux AMI release 2015.09</li>
<li>Zabbix 2.5 (3.0α)</li>
<li>PHP 5.6.14</li>
<li>MySQL 5.5.46</li>
</ul>
<p>以上</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Monitoring/">Monitoring</a><a class="link-muted mr-2" rel="tag" href="/tags/Twilio/">Twilio</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2015/12/08/2015-12-09-show-dotfile-on-macos/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">今更ながらMacでドットファイルを表示する</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2015/11/25/2015-11-26-cleanup-yum-cache/"><span class="level-item">意外と容量食ってた yum cache</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->