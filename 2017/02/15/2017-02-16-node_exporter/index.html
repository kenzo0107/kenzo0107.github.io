<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170216/20170216225748.png" alt="node_exporter シェルでクエリ自作"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-02-15T15:00:00.000Z" title="2017-02-15T15:00:00.000Z">2017-02-16</time><span class="level-item">3分 read (About 409 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">node_exporter シェルでクエリ自作</h1><div class="content"><h2><span id="概要">概要</span></h2><p>node_expoter のオプション <code>--collector.textfile.directory</code> で指定したディレクトリに <code>*.prom</code> という拡張子を配置することで<br>そこに記述したメトリクス情報を prometheus server が読み取ってくれます。</p>
<p>この <code>*.prom</code> ファイルを一定時間毎に更新すればメトリクスが自作できる、というものです。</p>
<h2><span id="手順">手順</span></h2><ul>
<li>node_exporter 自体のインストール・セットアップは以下ご参照ください。</li>
</ul>
<a href="http://kenzo0107.hatenablog.com/entry/2017/01/25/154144" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125144719.png"></div><div class="descriptions"><div class="og-title">Node Exporter 構築手順 + Prometheus からAWSオートスケール監視 - 長生村本郷Engineers&#39;Blog</div><div class="og-description">概要 前回 Prometheus Server 構築しました。 kenzo0107.hatenablog.com 今回は 監視対象サーバで Node Exporter 構築を実施します。 今回やること 3行まとめ Node Exporter インストール Node Exporte…</div></div></div></a>

<p>上記手順では以下にnode_exporterを配置しています。<br>環境によって適宜書き換えてください。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;node_exporter&#x2F;node_exporter</span><br></pre></td></tr></table></figure>

<h2><span id="text_collector-ディレクトリ作成">text_collector ディレクトリ作成</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd &#x2F;usr&#x2F;local&#x2F;node_exporter</span><br><span class="line">$ mkdir text_collector</span><br></pre></td></tr></table></figure>

<h2><span id="shell-作成">shell 作成</span></h2><p>今回は httpd の process count のメトリクス追加することとします。</p>
<ul>
<li>/usr/local/node_exporter/text_collector/httpd.sh 作成</li>
</ul>
<script src="//gist.github.com/kenzo0107/cf245d3ba1d2f0faea7f0134414a8c81.js"></script>

<h2><span id="cron設定">cron設定</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># node_exporter httpd 5分毎更新</span><br><span class="line">*&#x2F;5 * * * * &#x2F;usr&#x2F;local&#x2F;node_exporter&#x2F;text_collector&#x2F;httpd.sh</span><br></pre></td></tr></table></figure>

<h2><span id="httpdprom-作成確認">httpd.prom 作成確認</span></h2><ul>
<li>/usr/local/node_exporter/text_collector/httpd.prom</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_httpd_count 24</span><br></pre></td></tr></table></figure>

<p>上記の <code>node_httpd_count</code> がメトリクス名になります。</p>
<h2><span id="node_expoter-再起動">node_expoter 再起動</span></h2><p>以下のようにディレクトリ指定します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_expoter --collector.textfile.directory &#x2F;usr&#x2F;local&#x2F;node_exporter&#x2F;text_collector</span><br></pre></td></tr></table></figure>

<h2><span id="作成したメトリクスを指定し確認する">作成したメトリクスを指定し確認する。</span></h2><p>無事できました！</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170216/20170216225202.png" width="100%">
</div>

<p>これを利用してるとシェル芸で色々事足りることもあります♪</p>
<p>一助になれば何よりです。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Monitoring/">Monitoring</a><a class="link-muted mr-2" rel="tag" href="/tags/Prometheus/">Prometheus</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2017/03/22/2017-03-23-terraform-aws/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Terraform で AWS インフラストラクチャ！</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2017/02/02/2017-02-03-standard-instalation-golang/"><span class="level-item">標準的な Golang インストール方法</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->