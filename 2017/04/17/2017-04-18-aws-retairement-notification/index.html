<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170418/20170418105821.png" alt="AWS [Retirement Notification] 対応"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-04-17T15:00:00.000Z" title="2017-04-17T15:00:00.000Z">2017-04-18</time><span class="level-item">7分 read (About 1026 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">AWS [Retirement Notification] 対応</h1><div class="content"><h2><span id="概要">概要</span></h2><p>とある日、AWS よりこんなメール通知が来ました。</p>
<p>要約すると<br>ホストしている基盤のハードウェアで回復不可能な障害が検知されたので<br>指定期限までに対応しないとインスタンスが停止する、とのこと。</p>
<p>今回こちらの対応をまとめました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Dear Amazon EC2 Customer,</span><br><span class="line"></span><br><span class="line">We have important news about your account (AWS Account ID: xxxxxxxxxxxx). EC2 has detected degradation of the underlying hardware hosting your Amazon EC2 instance (instance-ID: i-xxxxxxxx) in the ap-northeast-1 region. Due to this degradation, your instance could already be unreachable. After 2017-04-25 04:00 UTC your instance, which has an EBS volume as the root device, will be stopped.</span><br><span class="line"></span><br><span class="line">You can see more information on your instances that are scheduled for retirement in the AWS Management Console (https:&#x2F;&#x2F;console.aws.amazon.com&#x2F;ec2&#x2F;v2&#x2F;home?region&#x3D;ap-northeast-1#Events)</span><br><span class="line"></span><br><span class="line">* How does this affect you?</span><br><span class="line">Your instance&#39;s root device is an EBS volume and the instance will be stopped after the specified retirement date. You can start it again at any time. Note that if you have EC2 instance store volumes attached to the instance, any data on these volumes will be lost when the instance is stopped or terminated as these volumes are physically attached to the host computer</span><br><span class="line"></span><br><span class="line">* What do you need to do?</span><br><span class="line">You may still be able to access the instance. We recommend that you replace the instance by creating an AMI of your instance and launch a new instance from the AMI. For more information please see Amazon Machine Images (http:&#x2F;&#x2F;docs.aws.amazon.com&#x2F;AWSEC2&#x2F;latest&#x2F;UserGuide&#x2F;AMIs.html) in the EC2 User Guide. In case of difficulties stopping your EBS-backed instance, please see the Instance FAQ (http:&#x2F;&#x2F;aws.amazon.com&#x2F;instance-help&#x2F;#ebs-stuck-stopping).</span><br><span class="line"></span><br><span class="line">* Why retirement?</span><br><span class="line">AWS may schedule instances for retirement in cases where there is an unrecoverable issue with the underlying hardware. For more information about scheduled retirement events please see the EC2 user guide (http:&#x2F;&#x2F;docs.aws.amazon.com&#x2F;AWSEC2&#x2F;latest&#x2F;UserGuide&#x2F;instance-retirement.html). To avoid single points of failure within critical applications, please refer to our architecture center for more information on implementing fault-tolerant architectures: http:&#x2F;&#x2F;aws.amazon.com&#x2F;architecture</span><br><span class="line"></span><br><span class="line">If you have any questions or concerns, you can contact the AWS Support Team on the community forums and via AWS Premium Support at: http:&#x2F;&#x2F;aws.amazon.com&#x2F;support</span><br><span class="line"></span><br><span class="line">Sincerely,</span><br><span class="line">Amazon Web Services</span><br></pre></td></tr></table></figure>



<ul>
<li>AWS Console イベントを見ると一覧で表示されている。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170418/20170418095219.png" width="100%">
</div>

<ul>
<li>AWS Console 詳細を見ると Notice が出ている。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170411/20170411215054.png" width="100%">
</div>

<h2><span id="todo">ToDO</span></h2><p>ボリュームタイプによって異なります。</p>
<ul>
<li>EBSボリューム<ul>
<li>インスタンスの停止後、起動 (Reboot は ×)</li>
</ul>
</li>
</ul>
<ul>
<li>インスタンスストアボリューム<ul>
<li>AMI からインスタンス再作成、データ移行</li>
</ul>
</li>
</ul>
<p>今回は EBS ボリューム対応について記載してます。</p>
<h2><span id="対応">対応</span></h2><p>対象インスタンスが多かったのでローカルPC (macOS) から awscli でインスタンス停止→起動するシェル作成しました。<br>本番環境で利用されるインスタンスも含まれていた為、1件ずつ実行することとしました。</p>
<h2><span id="事前準備">事前準備</span></h2><ul>
<li>awscli, jq インストール</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install awscli jq</span><br></pre></td></tr></table></figure>

<ul>
<li>各アカウント毎のアクセスキー、シークレットキー等設定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure --profile &lt;profile&gt;</span><br><span class="line">$ grep &#39;profile&#39; ~&#x2F;.aws&#x2F;config</span><br></pre></td></tr></table></figure>

<h3><span id="インスタンスの停止再起動シェル">インスタンスの停止・再起動シェル</span></h3><script src="//gist.github.com/kenzo0107/b841bfad242e87da3625e5d980845529.js"></script>

<p>以下のように実行すると<br>インスタンスが起動(running)していれば<br>停止後、再び起動し、ステータスチェックをするようにしました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sh stop_and_start_ec2_instance.sh &quot;&lt;profile&gt;&quot; &quot;&lt;instance id&gt;&quot;</span><br></pre></td></tr></table></figure>

<h3><span id="イベント情報取得シェル">イベント情報取得シェル</span></h3><p>.aws/config で設定されている profile を全てチェックし<br>未対応インスタンスのみ表示する様修正しました。</p>
<script src="//gist.github.com/kenzo0107/b79e05f6fc6692a1d631fd874ccb3e6b.js"></script>

<h2><span id="結果確認">結果確認</span></h2><p>大体 1インスタンス 5分程度で完了。<br>問題なく停止起動でき、対象イベントが一覧から消えたことを確認しました♪</p>
<h2><span id="所感">所感</span></h2><p>メンテ対象インスタンスの Region が northeast に集中していたのが気になる点でした。<br>このインスタンス何に使ってるんだっけ？とならない様に、インスタンスやprivate key の命名ルール必須と感じました。</p>
<p>以上です。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/AWS/">AWS</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2017/04/20/2017-04-21-fke-on-docker-compose/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">docker-compose で開発環境構築 〜Nginx アクセスログ(ltsv) を fluentd + elasticsearch + kibana で可視化〜</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2017/04/13/2017-04-14-teat-docker/"><span class="level-item">Docker コマンド早見表</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->