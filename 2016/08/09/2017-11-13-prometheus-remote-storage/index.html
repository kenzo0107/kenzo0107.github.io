<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://i.imgur.com/zFciewX.png" alt="Prometheus2.0 remote storage 検証"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-08-09T15:00:00.000Z" title="2016-08-09T15:00:00.000Z">2016-08-10</time><span class="level-item">8分 read (About 1165 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Prometheus2.0 remote storage 検証</h1><div class="content"><p>いよいよ出ました Prometheus 2.0 ！</p>
<p><a href="https://prometheus.io/blog/2017/11/08/announcing-prometheus-2-0/">Announcing Prometheus 2.0 | Prometheus</a></p>
<p>先日<a href="https://mackerel-ug.connpass.com/event/68478/">モニタリング勉強会</a>でも Paul Taylor さんの LT を拝聴させて頂き<br>パフォーマンス向上とストレージフォーマット変更による圧縮・バックアップがしやすくなった等、<br>良い話がたくさん出ていました。</p>
<p><a href="https://www.slideshare.net/PaulTraylor/20171027-81281205">Operating Prometheus</a></p>
<p>中でも最も期待していた機能が Remote Long-Term Storage、<br>長期保存機能には歓喜しました♪</p>
<p>1系以下では、短期間用と長期間用の Prometheus を別途用意する等、対策が必要で<br>冗長な作りを余儀なくされたところがありましたが<br>2.0 リリースでついに！</p>
<p>早速試してみたく使用感をまとめました。</p>
<h2><span id="今回やりたかったことまとめ">今回やりたかったことまとめ</span></h2><ul>
<li>Prometheus 2.0 リリースに際して期待の長期保存機能 (Remote long-term storage) を早速試す！</li>
<li>実際にローカル環境で構築してみて1系からの変更箇所を確認</li>
<li>DB 側にどんなデータが入るのか確認</li>
</ul>
<h2><span id="システム概要">システム概要</span></h2><p>あくまで使用感の検証をしたかったので docker-compose でお手軽に作れる環境にしました。</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/zFciewX.png" width="100%">
</div>

<h2><span id="前提条件">前提条件</span></h2><p>以下を Vagrant にインストール</p>
<ul>
<li>Ubuntu 16.04.3 LTS \n \l</li>
<li>Docker version 17.09.0-ce, build afdb6d4</li>
<li>docker-compose version 1.12.0, build b31ff33</li>
</ul>
<h2><span id="起動する-docker-container">起動する Docker Container</span></h2><ul>
<li>Prometheus 2.0.0</li>
<li>Node Exporter 0.15.1</li>
<li>AlertManager 0.9.1</li>
<li>cAdvisor 0.28.0</li>
<li>Prometheu Adapter</li>
<li>PostgreSQL 9.6.3</li>
<li>Grafana 4.6.1</li>
<li>Nginx 1.13.6</li>
<li>Adminer</li>
</ul>
<h2><span id="使い方">使い方</span></h2><p>以下手順通りです。</p>
<p><a href="https://github.com/kenzo0107/vagrant-docker/tree/vagrant-docker-ubuntu16.04/docker/prometheus-grafana-on-ubuntu">kenzo0107/vagrant-docker/tree/vagrant-docker-ubuntu16.04/docker/prometheus-grafana-on-ubuntu</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/vagrant-docker</span><br><span class="line">macOS%$ <span class="built_in">cd</span> vagrant-docker</span><br><span class="line">macOS%$ vagrant up</span><br><span class="line"></span><br><span class="line">// Install docker, docker-compose</span><br><span class="line">macOS%$ vagrant provision</span><br><span class="line">macOS%$ vagrant ssh</span><br><span class="line">vagrant%$ <span class="built_in">cd</span> /vagrant/prometheus-grafana-on-ubuntu</span><br><span class="line">vagrant%$ sudo docker-compose up -d</span><br><span class="line"></span><br><span class="line">Name                             Command                            State                             Ports</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">adapter                           /prometheus-postgresql-ada ...    Up</span><br><span class="line">adminer                           entrypoint.sh docker-php<span class="_">-e</span> ...    Up                                8080/tcp</span><br><span class="line">alertmanager                      /bin/alertmanager -config. ...    Up                                9093/tcp</span><br><span class="line">cadvisor                          /usr/bin/cadvisor -logtost ...    Up                                8080/tcp</span><br><span class="line">grafana                           /run.sh                           Up                                3000/tcp</span><br><span class="line">nginx                             nginx -g daemon off;              Up                                0.0.0.0:18080-&gt;18080/tcp,</span><br><span class="line">                                                                                         0.0.0.0:3000-&gt;3000/tcp, 80/tcp,</span><br><span class="line">                                                                                         0.0.0.0:8080-&gt;8080/tcp,</span><br><span class="line">                                                                                         0.0.0.0:9090-&gt;9090/tcp</span><br><span class="line">node-exporter                     /bin/node_exporter                Up                                9100/tcp</span><br><span class="line">pgsql                             docker-entrypoint.sh -csyn ...    Up                                5432/tcp</span><br><span class="line">prometheus                        /bin/prometheus --config.f ...    Up                                9090/tcp</span><br></pre></td></tr></table></figure>

<h2><span id="アクセスしてみる">アクセスしてみる</span></h2><h3><span id="prometheus">Prometheus</span></h3><ul>
<li><a href="http://192.168.35.101:9090">http://192.168.35.101:9090</a>.</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/rg53Xa1.png" width="100%">
</div>

<h3><span id="grafana">Grafana</span></h3><ul>
<li><a href="http://192.168.35.101:13000">http://192.168.35.101:13000</a>.</li>
<li>ユーザアカウントが <code>./grafana/env</code> にあります.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GF_SECURITY_ADMIN_USER=admin-user</span><br><span class="line">GF_SECURITY_ADMIN_PASSWORD=admin-pass</span><br></pre></td></tr></table></figure>

<div style="text-align:center;">
<img src="https://i.imgur.com/fDXVySw.png" width="100%">
</div>

<ul>
<li>Datasource 設定</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/8SKvdxJ.png" width="100%">
</div>

<p>Datasource 設定フォームに以下情報を入力し <code>Add</code> ボタンをクリックします。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>Prometheus</td>
</tr>
<tr>
<td>Type</td>
<td>Prometheus</td>
</tr>
<tr>
<td>URL</td>
<td><a href="http://prometheus:9090">http://prometheus:9090</a></td>
</tr>
<tr>
<td>Access</td>
<td>proxy</td>
</tr>
</tbody></table>
<div style="text-align:center;">
<img src="https://i.imgur.com/6Cr4WTn.png" width="100%">
</div>

<ul>
<li>Dashboard.json インポート</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/cew58vF.png" width="100%">
</div>

<p>グラフが表示されます。</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/IicXL5e.png" width="100%">
</div>


<h3><span id="cadvisor">cAdvisor</span></h3><ul>
<li><a href="http://192.168.35.101:8080">http://192.168.35.101:8080</a>.</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/ZDH3zmI.png" width="100%">
</div>

<h2><span id="adminer">Adminer</span></h2><div style="text-align:center;">
<img src="https://i.imgur.com/uWT7sDC.png" width="100%">
</div>

<p>ログインフォームに以下情報を入力します。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Server</td>
<td>pgsql</td>
</tr>
<tr>
<td>Username</td>
<td>prometheus</td>
</tr>
<tr>
<td>Password</td>
<td>password</td>
</tr>
<tr>
<td>Database</td>
<td>postgres</td>
</tr>
</tbody></table>
<ul>
<li>PostgreSQL に保存されているメトリクス情報が確認できます。</li>
</ul>
<p>PostgreSQL &gt;&gt; pgsql &gt;&gt; postgres &gt;&gt; prometheus &gt;&gt; Select: metrics</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/cyPrvqC.png" width="100%">
</div>


<h2><span id="alertmanager-でアラート通知してみる">AlertManager でアラート通知してみる</span></h2><p>例として node-exporter を停止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo docker-compose stop node-exporter</span><br></pre></td></tr></table></figure>

<p><code>./alertmanager/config.yml</code> で設定した Slack Channel にちゃんと通知がきました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171113/20171113021331.png" width="100%">
</div>


<h2><span id="所感">所感</span></h2><ul>
<li><p>2.0 になって設定の仕方が諸々変わり、公式サイトじっくり見る必要あります。</p>
<ul>
<li>と思ったら、早速まとめ出てました！ありがとうございます！<ul>
<li><a href="https://qiita.com/tkusumi/items/293174826a8a5d47d186">Prometheus 2.0 の変更点と移行</a></li>
</ul>
</li>
</ul>
</li>
<li><p>今回は Prometheus ×1 台構成ですが、2台以上で冗長化する構成も試してみたい。</p>
</li>
</ul>
<h2><span id="余談">余談</span></h2><ul>
<li>バグなのか google/cadvisor で検出するメトリクスが重複表示されて grafana で絞るのに困りました。<ul>
<li>Issue これ？<ul>
<li><a href="https://github.com/google/cadvisor/issues/1704">Inconsistent container metrics in prometheus route #1704</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><span id="あとがき">あとがき</span></h2><p>Mackerel の様なマネージドな監視サービスで運用コストを削減する以上に<br>Prometheus をマネージドすれば、さらにトータルコストを抑えられる様になる、<br>と睨んでます。</p>
<p>ですが、Datadog は APM 付きプランも適度なコスト感で提供しておりマネージドサービスの魅力は尚大きいです。</p>
<p>モニタリングの棲み分けをできる様にするにも、<br>選択肢の一つにするにも Prometheus 挑戦しがいがあるのでは？<br>と思っています。</p>
<p>Prometheus、今後さらに広まることを期待しています。</p>
<h2><span id="参考">参考</span></h2><ul>
<li><a href="https://prometheus.io/docs/prometheus/2.0/configuration/configuration/">Configuration | Prometheus</a></li>
<li><a href="https://github.com/prometheus/prometheus/blob/release-2.0/config/testdata/conf.good.yml">prometheus/config/testdata/conf.good.yml</a></li>
</ul>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Prometheus/">Prometheus</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2016/08/09/2017-08-10-how-to-see-cpu-memory-utili/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">今更聞けない！CPU, Memory 使用率の見方</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2016/08/08/2016-08-09-allow-ip-under-the-maintenance/"><span class="level-item">メンテ時に社内Wifi IPのみサイトアクセス許可する</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->