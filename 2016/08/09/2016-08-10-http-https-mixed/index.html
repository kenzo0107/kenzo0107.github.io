<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160810/20160810114001.jpg" alt="http https 混在サイトでの Cookie Secure 属性の扱い方"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-08-09T15:00:00.000Z" title="2016-08-09T15:00:00.000Z">2016-08-10</time><span class="level-item">6分 read (About 891 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">http https 混在サイトでの Cookie Secure 属性の扱い方</h1><div class="content"><h2><span id="問題提起">問題提起</span></h2><p>https 通信環境下で Cookie に Secure 属性つけていますか？</p>
<a id="more"></a>

<h2><span id="secure属性とは">Secure属性とは？</span></h2><p>http と https と各通信で相互の行き来がある場合などに<br>https の通信でのみ使うべきCookieの値が<br>http の通信に流出するおそれがあります。</p>
<p>それを防ぐ為に Cookie に secure 属性を付けて<br>https 通信でのみ扱えるようにするという対策があります。</p>
<h2><span id="実例">実例</span></h2><p>PHPの場合を扱おうと思ったので<br>お世話になってる <a href="https://www.mercari.com">メルカリ</a>さんを参照します。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160810/20160810102752.png" width="100%">
</div>

<p>Chrome の Developer Tool で Secure 項目 確認すると<br>チェックがついているのがわかります。</p>
<p>PHPSESSID は php.ini の session.name で設定されている<br>session_id の名前です。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ php -i | grep php.ini</span><br><span class="line">&lt;path to php.ini&gt;/php.ini</span><br><span class="line"></span><br><span class="line">$ grep <span class="string">'session.name ='</span> &lt;path to php.ini&gt;/php.ini</span><br><span class="line">session.name = PHPSESSID</span><br></pre></td></tr></table></figure>

<h2><span id="常時-https-通信だったら">常時 https 通信だったら</span></h2><ul>
<li>secure 属性を常に設定するようにします。</li>
</ul>
<h4><span id="session_id-発行例">session_id 発行例</span></h4><p><a href="http://php.net/manual/ja/function.session-set-cookie-params.php">session_set_cookie_params</a> 関数を用いて設定</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$secure = <span class="keyword">true</span>;</span><br><span class="line">$httponly = <span class="keyword">true</span>;</span><br><span class="line">session_set_cookie_params($lifetime, $path, DOMAIN_NAME, $secure, $httponly);</span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>

<ul>
<li>HttpOnly を true とすると クライアントサイド Javascript からの Cookie 取得不可となり <a href="https://www.websec-room.com/2013/03/14/550">XSS</a> 対策の一環となります。</li>
</ul>
<h4><span id="cookie-発行例">cookie 発行例</span></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$secure = <span class="keyword">true</span>;</span><br><span class="line">$httponly = <span class="keyword">true</span>;</span><br><span class="line">setcookie($key, $val, $expire, $path, DOMAIN_NAME, $secure, $httponly);</span><br></pre></td></tr></table></figure>

<h2><span id="http-https-混在していたら">http https 混在していたら</span></h2><p>この場合に遭遇しました。<br>よくショッピングサイトなどでは以下 http https が混在するケースが<br>見受けられます。</p>
<ul>
<li>商品一覧ページ …. http</li>
<li>決済情報入力ページ … https</li>
</ul>
<p>こういった場合の Cookie Secure 属性の扱い方を検討してみました。</p>
<h3><span id="対策1">対策1</span></h3><ul>
<li>http 用 (PHPSESSID):secure属性なし と https 用 (例: SPHPSESSID): secure属性あり で 2つ cookie を発行する</li>
</ul>
<h3><span id="対策2">対策2</span></h3><ul>
<li>PHPSESSID は http https 共通の secure 属性なし cookie を発行する</li>
<li>https 通信時に secure 属性付き token を発行し発行した token をチェック。<br>不整合が起きた場合は、session_idを書き換え、session の内容を破棄する。</li>
</ul>
<p>上記 対策1 では http,https 用の session_id の紐付けの管理がしにくい為<br>対策2 について実装しました。</p>
<h4><span id="対策-2-実装例">対策 2 実装例</span></h4><ul>
<li>session_id が発行されていない場合(初回アクセス時)、secure 属性なしの session_id (PHPSESSID) 発行</li>
<li>https 通信時は session に token がない場合、secure 属性付き token cookie を発行。 session にも token を保存</li>
<li>session と cookie にある token 情報を突き合わせて一致しない場合、 session_id を変更し session 内部を破棄</li>
</ul>
<p>あえてわかりやすく冗長な書き方してます。<br>domain, path, secure 等は 環境ごとに define するなりしてください。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$domain = <span class="string">'www.example.jp'</span>;</span><br><span class="line">$path = <span class="string">"/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (session_id() === <span class="string">""</span>) &#123;</span><br><span class="line">    $secure = <span class="keyword">false</span>;</span><br><span class="line">    $httponly = <span class="keyword">true</span>;</span><br><span class="line">    session_set_cookie_params(<span class="number">0</span>, $path, $domain, $secure, $httponly);</span><br><span class="line">    <span class="keyword">if</span> (!ini_get(<span class="string">"session.auto_start"</span>)) &#123;</span><br><span class="line">        <span class="comment">// セッション開始</span></span><br><span class="line">        session_start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTPS'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($_SESSION[<span class="string">'token'</span>])) &#123;</span><br><span class="line">        $token = getToken();</span><br><span class="line">        $secure = <span class="keyword">true</span>;</span><br><span class="line">        $httponly = <span class="keyword">true</span>;</span><br><span class="line">        setcookie(<span class="string">'token'</span>, $token, $expire, $path, $domain, $secure, $httponly);</span><br><span class="line">        $_SESSION[<span class="string">'token'</span>] = $token;</span><br><span class="line">        $_COOKIE[<span class="string">'token'</span>] = $token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $sessid = $objCookie-&gt;getCookie(<span class="string">'token'</span>);</span><br><span class="line">    <span class="keyword">if</span> ($_SESSION[<span class="string">'token'</span>] != $sessid) &#123;</span><br><span class="line">        session_regenerate_id();</span><br><span class="line">        session_destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sha1(uniqid(rand(), <span class="keyword">true</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>これで http で発行される session_id は secure 属性がなくとも<br>https 通信下での情報流出防止策をとりました。</p>
<p>以上です。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/PHP/">PHP</a><a class="link-muted mr-2" rel="tag" href="/tags/htaccess/">.htaccess</a><a class="link-muted mr-2" rel="tag" href="/tags/Cookie/">Cookie</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2016/08/17/2016-08-18-oneliner-for-phper/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">PHP エンジニアであれば必ずやるべき 1 ライナー</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2016/08/09/2017-08-10-how-to-see-cpu-memory-utili/"><span class="level-item">今更聞けない！CPU, Memory 使用率の見方</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->