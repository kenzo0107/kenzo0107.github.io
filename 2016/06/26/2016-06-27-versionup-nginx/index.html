<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160627/20160627150549.png" alt="Nginx 1.9.6 → 1.11.1 へバージョンアップ 脆弱性対応"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-06-26T15:00:00.000Z" title="2016-06-26T15:00:00.000Z">2016-06-27</time><span class="level-item">9分 read (About 1394 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Nginx 1.9.6 → 1.11.1 へバージョンアップ 脆弱性対応</h1><div class="content"><p>脆弱性CVE-2016-4450 に対応した Nginx 1.11.1 が 2016-05-31 リリースされたということで<br>早速バージョンアップを試みました。</p>
<p><a href="https://oss.sios.com/yorozu-blog/nginx-release-information-20160601">SIOS Tech. Lab - エンジニアのためになる技術トピックス</a></p>
<p>ダウンタイムゼロで実行できました。</p>
<h2><span id="現状の-nginx-configure-確認">現状の Nginx configure 確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># nginx -V</span><br><span class="line">nginx version: nginx&#x2F;1.9.6</span><br><span class="line"></span><br><span class="line">configure arguments: --prefix&#x3D;&#x2F;etc&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp --user&#x3D;nginx --group&#x3D;nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-http_xslt_module&#x3D;dynamic --with-http_image_filter_module&#x3D;dynamic --with-http_geoip_module&#x3D;dynamic --with-http_perl_module&#x3D;dynamic --add-dynamic-module&#x3D;njs-1c50334fbea6&#x2F;nginx --with-threads --with-stream --with-stream_ssl_module --with-http_slice_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_v2_module --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -m64 -mtune&#x3D;generic&#39;</span><br></pre></td></tr></table></figure>

<h2><span id="httpnginxorgendownloadhtmltitle-より-nginx-1111-をダウンロード">[ より nginx-1.11.1 をダウンロード</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line"># wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.11.1.tar.gz</span><br><span class="line"># tar xvf nginx-1.11.1.tar.gz</span><br><span class="line"># cd nginx-1.11.1</span><br></pre></td></tr></table></figure>

<h2><span id="nginx-1111-で利用モジュールやサードパーティgeoip-develをインストール">Nginx 1.11.1 で利用モジュールやサードパーティ(GeoIP-devel)をインストール</span></h2><p>以下実行しないと nginx の configure が通りませんでした。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install pcre-devel zlib-devel openssl-devel libxml2-devel libxslt-devel gd-devel perl-ExtUtils-Embed GeoIP-devel -y</span><br></pre></td></tr></table></figure>


<ul>
<li>gd-devel がインストールされていない場合の Nginx configure error</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure: error: the HTTP image filter module requires the GD library.</span><br><span class="line">You can either do not enable the module or install the libraries.</span><br></pre></td></tr></table></figure>

<ul>
<li>libxslt-devel がインストールされていない場合の Nginx configure error</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure: error: the HTTP XSLT module requires the libxml2&#x2F;libxslt</span><br><span class="line">libraries. You can either do not enable the module or install the libraries.</span><br></pre></td></tr></table></figure>

<h2><span id="configure">configure</span></h2><p>「現状の Nginx configure 確認」で取得したconfigure parameterから<br>「–add-dynamic-module=njs-1c50334fbea6/nginx」を削除</p>
<ul>
<li><code>--add-dynamic-module=njs-1c50334fbea6/nginx</code> を指定した場合の Nginx configure error</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adding module in njs-1c50334fbea6&#x2F;nginx</span><br><span class="line">.&#x2F;configure: error: no njs-1c50334fbea6&#x2F;nginx&#x2F;config was found</span><br></pre></td></tr></table></figure>

<p>「–add-dynamic-module=njs-1c50334fbea6/nginx」を削除して configure 実施</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;etc&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp --user&#x3D;nginx --group&#x3D;nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-http_xslt_module&#x3D;dynamic --with-http_image_filter_module&#x3D;dynamic --with-http_geoip_module&#x3D;dynamic --with-http_perl_module&#x3D;dynamic --with-threads --with-stream --with-stream_ssl_module --with-http_slice_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_v2_module --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -m64 -mtune&#x3D;generic&#39;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">checking for GeoIP library ... found</span><br><span class="line">checking for GeoIP IPv6 support ... found</span><br><span class="line">creating objs&#x2F;Makefile</span><br><span class="line"></span><br><span class="line">Configuration summary</span><br><span class="line">  + using threads</span><br><span class="line">  + using system PCRE library</span><br><span class="line">  + using system OpenSSL library</span><br><span class="line">  + md5: using OpenSSL library</span><br><span class="line">  + sha1: using OpenSSL library</span><br><span class="line">  + using system zlib library</span><br><span class="line"></span><br><span class="line">  nginx path prefix: &quot;&#x2F;etc&#x2F;nginx&quot;</span><br><span class="line">  nginx binary file: &quot;&#x2F;usr&#x2F;sbin&#x2F;nginx&quot;</span><br><span class="line">  nginx modules path: &quot;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules&quot;</span><br><span class="line">  nginx configuration prefix: &quot;&#x2F;etc&#x2F;nginx&quot;</span><br><span class="line">  nginx configuration file: &quot;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf&quot;</span><br><span class="line">  nginx pid file: &quot;&#x2F;var&#x2F;run&#x2F;nginx.pid&quot;</span><br><span class="line">  nginx error log file: &quot;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log&quot;</span><br><span class="line">  nginx http access log file: &quot;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log&quot;</span><br><span class="line">  nginx http client request body temporary files: &quot;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp&quot;</span><br><span class="line">  nginx http proxy temporary files: &quot;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp&quot;</span><br><span class="line">  nginx http fastcgi temporary files: &quot;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp&quot;</span><br><span class="line">  nginx http uwsgi temporary files: &quot;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp&quot;</span><br><span class="line">  nginx http scgi temporary files: &quot;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp&quot;</span><br></pre></td></tr></table></figure>

<h2><span id="ビルド">ビルド</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># make</span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>

<h2><span id="nginx-バージョン確認">Nginx バージョン確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># nginx -V</span><br><span class="line"></span><br><span class="line">nginx version: nginx&#x2F;1.11.1</span><br><span class="line"></span><br><span class="line">configure arguments: --prefix&#x3D;&#x2F;etc&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp --user&#x3D;nginx --group&#x3D;nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-http_xslt_module&#x3D;dynamic --with-http_image_filter_module&#x3D;dynamic --with-http_geoip_module&#x3D;dynamic --with-http_perl_module&#x3D;dynamic --with-threads --with-stream --with-stream_ssl_module --with-http_slice_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_v2_module --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -m64 -mtune&#x3D;generic&#39;</span><br></pre></td></tr></table></figure>

<h2><span id="構文チェック">構文チェック</span></h2><p>こける。。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># nginx -t</span><br><span class="line"></span><br><span class="line">nginx: [emerg] unknown directive &quot;geoip_country&quot; in &#x2F;etc&#x2F;nginx&#x2F;nginx.conf:15</span><br><span class="line">nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test failed</span><br></pre></td></tr></table></figure>

<p>サードパーティに依存するディレクティブについては<br><code>load_module</code> で SharedObject(*.so) を呼び出す必要があります。</p>
<ul>
<li>/etc/nignx/nginx.conf の冒頭に以下追加</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load_module &quot;modules&#x2F;ngx_http_geoip_module.so&quot;;</span><br></pre></td></tr></table></figure>

<h2><span id="再度構文チェック">再度構文チェック</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># nginx -t</span><br><span class="line"></span><br><span class="line">nginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<h2><span id="nginx-設定再読み込み">Nginx 設定再読み込み</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl reload nginx</span><br></pre></td></tr></table></figure>

<p>以上でNginx バージョンアップが無事完了しました。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Nginx/">Nginx</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2016/06/26/2016-06-27-ssl-qualys-get-a-plus/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">2016年5月現在、SSL評価Fを取らない為に</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2016/06/20/2016-06-21-ansible-vagrant-prometheus/"><span class="level-item">Ansible+Vagrant でシンプルなPrometheusモニタリング環境構築</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->