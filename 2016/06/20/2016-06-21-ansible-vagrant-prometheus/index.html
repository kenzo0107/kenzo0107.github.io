<div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="http://i.imgur.com/pfazhaR.png" alt="Ansible+Vagrant でシンプルなPrometheusモニタリング環境構築"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-06-20T15:00:00.000Z" title="2016-06-20T15:00:00.000Z">2016-06-21</time><span class="level-item">3分 read (About 401 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Ansible+Vagrant でシンプルなPrometheusモニタリング環境構築</h1><div class="content"><h2><span id="概要">概要</span></h2><p><a href="https://prometheus.io/docs/introduction/getting_started/">Prometheus入門</a> にあるチュートリアルを<br>Ansibleで簡単に構築できるようにした、<br>というものです。</p>
<p>先日2016年6月14日、<br>LINE株式会社での<a href="http://connpass.com/event/32859/">Prometheus Casual Talks #1</a>に参加し<br>ナレッジのおさらいなどしたく、<br>構築法をまとめました。</p>
<h2><span id="prometheusとは">Prometheusとは</span></h2><p>最近話題のPull型のQuery Filtering可能で Grafana等と連携できる モニタリング/Alertツールです。</p>
<h2><span id="構成">構成</span></h2><p><img src="http://i.imgur.com/pfazhaR.png" alt="Imgur"></p>
<ul>
<li>Prometheus Server × 1</li>
<li>Prometheus Client × 2</li>
</ul>
<h2><span id="環境">環境</span></h2><ul>
<li>CentOS 6.5</li>
<li>Prometheus Server 0.20.0</li>
<li>Supervisor 3.3.0</li>
<li>Go 1.6.2</li>
<li>Ansibl 2.1.0.0</li>
<li>Vagrant 1.8.1</li>
<li>MacOSX 10.11.5</li>
</ul>
<h2><span id="前提条件">前提条件</span></h2><p>以下ツールをインストールしておいてください。</p>
<ul>
<li>VirtualBox</li>
<li>Vagrant</li>
<li>Ansible</li>
</ul>
<h2><span id="使い方">使い方</span></h2><h3><span id="1-git-repository-を-clone">1. git repository を clone</span></h3><p>[<a href="https://github.com/kenzo0107/Vagrant-Prometheus]">https://github.com/kenzo0107/Vagrant-Prometheus]</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;kenzo0107&#x2F;Vagrant-Prometheus</span><br></pre></td></tr></table></figure>

<h2><span id="2-vagrant-vm-起動">2. Vagrant VM 起動</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd Vagrant-Prometheus</span><br><span class="line">$ vagrant up</span><br></pre></td></tr></table></figure>

<p>3 node running !</p>
<ul>
<li>1 node: Prometheus Server</li>
<li><ul>
<li>192.168.11.30</li>
</ul>
</li>
<li>other 2 nodes: Prometheus Client Server</li>
<li><ul>
<li>192.168.33.31</li>
</ul>
</li>
<li><ul>
<li>192.168.33.32</li>
</ul>
</li>
</ul>
<h2><span id="3-sshconfig-追加">3. ssh.config 追加</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh-config &gt; ssh.config</span><br></pre></td></tr></table></figure>

<h2><span id="4-ping-疎通試験">4. ping 疎通試験</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ansible default -m ping</span><br><span class="line"></span><br><span class="line">server | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">client1 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">client2 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ok, success.</p>
<h2><span id="5-2node-に-prometheusclient-設定">5. 2node に PrometheusClient 設定</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook set_clients_prometheus.yml</span><br></pre></td></tr></table></figure>

<h2><span id="6-prometheusclient-の起動確認">6. PrometheusClient の起動確認</span></h2><p>以下PrometheusClientを起動しているサーバにアクセスし<br>起動されているか確認します。</p>
<ul>
<li><a href="http://192.168.11.31:8080/metrics">http://192.168.11.31:8080/metrics</a></li>
<li><a href="http://192.168.11.32:8080/metrics">http://192.168.11.32:8080/metrics</a></li>
</ul>
<p>以下のように表示されれば成功です。</p>
<img src="http://i.imgur.com/igPci2Z.png" width="400px">


<h2><span id="7-prometheusserver-設定">7. PrometheusServer 設定</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook set_server_prometheus.yml</span><br></pre></td></tr></table></figure>

<h2><span id="8-prometheusserver-確認">8. PrometheusServer 確認</span></h2><p><a href="http://192.168.33.30:9090">http://192.168.33.30:9090</a> にアクセス</p>
<p>以下のように表示されれば成功です。</p>
<img src="http://i.imgur.com/XDTarz3.png" width="400px">

<p>是非多少なりとも一助となれば何よりです！<br>いじくり倒してみてください！</p>
<p>以上</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Vagrant/">Vagrant</a><a class="link-muted mr-2" rel="tag" href="/tags/Monitoring/">Monitoring</a><a class="link-muted mr-2" rel="tag" href="/tags/Prometheus/">Prometheus</a><a class="link-muted mr-2" rel="tag" href="/tags/Ansible/">Ansible</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Gefällt Ihnen der Artikel? Unterstützen Sie den Autor mit</h3><div class="buttons is-centered"><a class="button is-danger donate" href="https://www.patreon.com/kenzo0107" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2016/06/26/2016-06-27-versionup-nginx/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Nginx 1.9.6 → 1.11.1 へバージョンアップ 脆弱性対応</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2016/05/31/2016-06-01-jenkins-short-cycles-in-the-day-of-month-field-will-behave-oddly-near-the-end-of-a-month/"><span class="level-item">Jenkins - Short cycles in the day-of-month field will behave oddly near the end of a month</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!-->