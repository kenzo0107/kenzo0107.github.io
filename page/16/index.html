<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>長生村本郷Engineers&#039;Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="長生村本郷Engineers&#039;Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="長生村本郷Engineers&#039;Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="tech"><meta property="og:type" content="blog"><meta property="og:title" content="長生村本郷Engineers&#039;Blog"><meta property="og:url" content="https://kenzo0107.github.io/"><meta property="og:site_name" content="長生村本郷Engineers&#039;Blog"><meta property="og:description" content="tech"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://kenzo0107.github.io/img/og_image.png"><meta property="article:author" content="Kenzo Tanaka"><meta property="article:tag" content="aws golang"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://kenzo0107.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kenzo0107.github.io"},"headline":"長生村本郷Engineers'Blog","image":["https://kenzo0107.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Kenzo Tanaka"},"publisher":{"@type":"Organization","name":"長生村本郷Engineers'Blog","logo":{"@type":"ImageObject","url":"https://kenzo0107.github.io/img/logo.svg"}},"description":"tech"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-162026478-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-162026478-1');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><script data-ad-client="ca-pub-6265337967545472" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="長生村本郷Engineers'Blog" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/2013/12/31/PrivacyPolicy/">PrivacyPolicy</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="navbar-item search" title="検索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-10-desktop is-8-widescreen"><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/30/2017-05-01-nginx-prometheus-nodeexporter-grafana-cadvisor-on-raspi3/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170430/20170430235153.png" alt="Raspberry PI3 Model B に docker-compose で Nginx で認証かけて Prometheus + Node Exporter + Grafana + cAdvisor構築"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-05-01</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/30/2017-05-01-nginx-prometheus-nodeexporter-grafana-cadvisor-on-raspi3/">Raspberry PI3 Model B に docker-compose で Nginx で認証かけて Prometheus + Node Exporter + Grafana + cAdvisor構築</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Raspi3 に docker-compose で Prometheus による監視機構を作成しました。</p>
<a href="https://github.com/kenzo0107/vagrant-docker/tree/master/docker/prometheus-grafana-on-raspi3" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://opengraph.githubassets.com/e0bfc754350fb20c18525418a916b9138887382351418e753383effd87a70893/kenzo0107/vagrant-docker"></div><div class="descriptions"><div class="og-title">vagrant-docker/docker/prometheus-grafana-on-raspi3 at master · kenzo0107/vagrant-docker</div><div class="og-description">Docker on Vagrant(ubuntu). Contribute to kenzo0107/vagrant-docker development by creating an account on GitHub.</div></div></div></a>

<h2><span id="環境">環境</span></h2><ul>
<li>Raspberry Pi 3 Model B (Raspbian GNU/Linux 8) arm7l</li>
<li>Docker version 17.04.0-ce, build 4845c56</li>
<li>docker-compose version 1.9.0, build 2585387</li>
</ul>
<h2><span id="raspi-に-docker-インストール">Raspi に docker インストール</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ wget -qO- https://get.docker.com/ | sh</span><br><span class="line">raspi%$ sudo usermod -aG docker pi</span><br><span class="line">raspi%$ sudo gpasswd -a $USER docker</span><br></pre></td></tr></table></figure>

<h2><span id="raspi-に-docker-compose-インストール">Raspi に docker-compose インストール</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ sudo apt-get update</span><br><span class="line">raspi%$ sudo apt-get install -y apt-transport-https</span><br><span class="line">raspi%$ echo &quot;deb https://packagecloud.io/Hypriot/Schatzkiste/debian/ jessie main&quot; | raspi%sudo tee /etc/apt/sources.list.d/hypriot.list</span><br><span class="line">raspi%$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 37BBEE3F7AD95B3F</span><br><span class="line">raspi%$ sudo apt-get update</span><br><span class="line">raspi%$ sudo apt-get install docker-compose</span><br></pre></td></tr></table></figure>

<ul>
<li>version 確認</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ docker-compose --version</span><br><span class="line">docker-compose version 1.9.0, build 2585387</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-のプロジェクト設定">docker-compose のプロジェクト設定</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ cd ~</span><br><span class="line">raspi%$ git clone https://github.com/kenzo0107/vagrant-docker</span><br><span class="line">raspi%$ cd vagrant-docker/docker/prometheus-grafana-on-raspi3</span><br></pre></td></tr></table></figure>

<h2><span id="nginx-basic-認証設定">Nginx Basic 認証設定</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.htpasswd 作成時のユーザ/パス == GF_SECURITY_ADMIN_USER/GF_SECURITY_ADMIN_PASSWORD</span><br></pre></td></tr></table></figure>

<p>である必要があります。</p>
<p>Grafana の認証機能により設定した Basic 認証でログインできる仕組みがあり、<br>一致しない場合、ログインできず、失敗します。</p>
<ul>
<li>grafana/env</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GF_SECURITY_ADMIN_USER=admin-user</span><br><span class="line">GF_SECURITY_ADMIN_PASSWORD=admin-pass</span><br></pre></td></tr></table></figure>

<ul>
<li>.htpasswd</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ htpasswd -c nginx/conf/conf.d/.htpasswd admin-user</span><br><span class="line">New password: (「admin-pass」と入力しEnter)</span><br><span class="line">Re-type new password: (「admin-pass」と入力しEnter)</span><br><span class="line">Adding password for user admin-user</span><br><span class="line"></span><br><span class="line">raspi%$ cat nginx/conf/conf.d/.htpasswd</span><br><span class="line">admin-user:$apr1$JLxC83lt$uO7aEn9Z59fZtba4EA7C6/</span><br></pre></td></tr></table></figure>

<h2><span id="cron-設定">Cron 設定</span></h2><p>Raspi の温度や電圧を定期取得し Prometheus に読み込ませるファイル(*.prom)作成します。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/5 * * * * &lt;home/to/path&gt;/vagrant-docker/docker/prometheus-grafana-on-raspi3/node-exporter/collector/raspi.sh</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-により-docker-起動">docker-compose により Docker 起動</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ docker-compose up -d</span><br></pre></td></tr></table></figure>

<h2><span id="grafana-にアクセスしてみる">Grafana にアクセスしてみる</span></h2><p><code>http://&lt;your_server_ip&gt;:13000</code> にアクセスすると .htpasswd で指定したユーザ/パスを求められるので入力します</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170430/20170430235949.png" width="100%">
</div>

<p>その後、Grafana のページが表示されれば成功です。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170501/20170501002430.png" width="100%">
</div>

<p>「Add data Source」をクリックします。</p>
<h2><span id="data-source-設定">Data Source 設定</span></h2><p>以下の様に設定し「Save &amp; Test」をクリックしし Success することを確認します。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170501/20170501002606.png" width="100%">
</div>

<h2><span id="dashboardjson-インポート">Dashboard.json インポート</span></h2><p>左上のアイコンから Dashboards &gt; Import 選択し DockerDashboard.json をインポートします。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170501/20170501003915.png" width="100%">
</div>

<h2><span id="dashboard-表示">Dashboard 表示</span></h2><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170501/20170501003051.png" width="100%">
</div>

<h2><span id="ポイント">ポイント !</span></h2><h3><span id="セキュリティ上の観点から外から直接-grafana-を参照させない様にしました">セキュリティ上の観点から外から直接 Grafana を参照させない様にしました。</span></h3><p>nginx/conf/conf.d/default.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        auth_basic &quot;Restricted&quot;;</span><br><span class="line">        auth_basic_user_file /etc/nginx/conf.d/.htpasswd;</span><br><span class="line"></span><br><span class="line">        proxy_pass                          http://grafana:3000/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="image-選びは慎重に">image 選びは慎重に。</span></h3><p>以下の点で非常にハマりました。</p>
<ol>
<li>Raspberry Pi3 Model B (今回は arm7l)上で動作するか</li>
<li>Nginx で Proxy 機能が正しく動作するか</li>
</ol>
<p>nginx の proxy 機能で grafana に繋げても 以下の様に表示されてしまうケースにぶつかりまくりました。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;alert.title&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="総評">総評</span></h2><p>イメージ探しについ時間取ってしまいましたが<br>自作した方が早かったかもと反省。</p>
<p>今回は自身を監視するという仕組みにしましたが外部から監視し相互に監視し合う体制が必要です。<br>家庭内稟議が通ればもう一台 get しよう！</p>
<p>そして、家庭の為になるものを作ろう！</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/26/2017-04-27-peco/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170427/20170427172718.jpg" alt="peco 小技シリーズ  〜多段ssh + peco, ghq + peco + atom〜"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-04-27</span><span class="level-item"><a class="link-muted" href="/categories/Go/">Go</a></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/26/2017-04-27-peco/">peco 小技シリーズ  〜多段ssh + peco, ghq + peco + atom〜</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>本当に小技です。<br>が、割と使ってみると作業時間の短縮となって便利という声を頂き<br>peco 関連でよく使うものを記事にしました。</p>
<h2><span id="peco-インストール">peco インストール</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS %$ brew install peco</span><br></pre></td></tr></table></figure>

<h2><span id="ssh-ログインする-host-を検索して選択">ssh ログインする Host を検索して選択</span></h2><p>前提条件として <code>~/.ssh/config</code> で接続ホストを管理しています。</p>
<script src="//gist.github.com/kenzo0107/06b3b1e202f36b70815cfe0207292a66.js"></script>

<p>上記を <code>~/.bashrc</code> などに貼り付けて <code>source ~/.bashrc</code> すれば使えます ♪</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">macOS %$ git clone https://gist.github.com/kenzo0107/06b3b1e202f36b70815cfe0207292a66</span><br><span class="line">macOS %$ cd 06b3b1e202f36b70815cfe0207292a66</span><br><span class="line">macOS %$ cat peco-sshconfig-ssh.sh &gt;&gt; ~/.bashrc</span><br><span class="line">macOS %$ source ~/.bashrc</span><br><span class="line"></span><br><span class="line">// sshc 実行！</span><br><span class="line">macOS %$ sshc</span><br></pre></td></tr></table></figure>

<p>上記の様に順調に進むと候補がリストされます。<br>モザイクしかなくすいません (&gt;_&lt;)</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170427/20170427171121.png" width="100%">
</div>

<h2><span id="ghq-で管理している-repository-を検索して選択し-atom-で開く">ghq で管理している repository を検索して選択し atom で開く</span></h2><script src="//gist.github.com/kenzo0107/e460e31ae2478341cc7a39859ad7fefd.js"></script>

<p>こちらも同様、</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">macOS %$ git clone https://gist.github.com/kenzo0107/e460e31ae2478341cc7a39859ad7fefd</span><br><span class="line">macOS %$ cd e460e31ae2478341cc7a39859ad7fefd</span><br><span class="line">macOS %$ cat peco-git-atom.sh &gt;&gt; ~/.bashrc</span><br><span class="line">macOS %$ source ~/.bashrc</span><br><span class="line"></span><br><span class="line">// opg 実行！</span><br><span class="line">macOS %$ opg</span><br></pre></td></tr></table></figure>

<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170427/20170427171728.png" width="100%">
</div>

<p>他にも様々な箇所で peco を利用させて頂いてます。<br>こんな peco の使い所あるよーという方、是非教えてください ♪</p>
<h2><span id="参照">参照</span></h2><p>zsh ですが dotfile をまとめてます。</p>
<a href="https://github.com/kenzo0107/dotfiles" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://opengraph.githubassets.com/2ea69c957f63b14ef4a55cac1e8363245d4f04619f56a3839c3466c22f3cfcde/kenzo0107/dotfiles"></div><div class="descriptions"><div class="og-title">GitHub - kenzo0107/dotfiles: dotfile setting</div><div class="og-description">dotfile setting. Contribute to kenzo0107/dotfiles development by creating an account on GitHub.</div></div></div></a>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/20/2017-04-21-fke-on-docker-compose/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421221055.png" alt="docker-compose で開発環境構築 〜Nginx アクセスログ(ltsv) を fluentd + elasticsearch + kibana で可視化〜"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-04-21</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/20/2017-04-21-fke-on-docker-compose/">docker-compose で開発環境構築 〜Nginx アクセスログ(ltsv) を fluentd + elasticsearch + kibana で可視化〜</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>前回構築した Vagrant 環境上で docker-compose による開発環境構築をします。</p>
<a href="http://kenzo0107.hatenablog.com/entry/2017/04/13/225610" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413222957.png"></div><div class="descriptions"><div class="og-title">Vagrant (Ubuntu) に Docker, Docker Compose インストール - 長生村本郷Engineers&#39;Blog</div><div class="og-description">以下に移行しました。 kenzo0107.github.io</div></div></div></a>

<p>今回は前回の続きで Nginx のアクセスログを Elasticsearch + Fluentd + Kibana で可視化してみます。<br>アプリ</p>
<h2><span id="簡単構築手順">簡単構築手順</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">macOS% $ git clone https://github.com/kenzo0107/vagrant-docker</span><br><span class="line">macOS% $ cd vagrant-docker</span><br><span class="line">macOS% $ vagrant up</span><br><span class="line">macOS% $ vagrant ssh</span><br><span class="line">vagrant% $ cd /vagrant/nginx-efk</span><br><span class="line"></span><br><span class="line">// -d デタッチモードでないのは各コンテナの起動状況がログで見える為です。</span><br><span class="line">vagrant% $ docker-compose up</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-構成">docker-compose 構成</span></h2><p>Git にまとめています。</p>
<a href="https://github.com/kenzo0107/vagrant-docker/tree/master/docker/nginx-efk" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://opengraph.githubassets.com/e0bfc754350fb20c18525418a916b9138887382351418e753383effd87a70893/kenzo0107/vagrant-docker"></div><div class="descriptions"><div class="og-title">vagrant-docker/docker/nginx-efk at master · kenzo0107/vagrant-docker</div><div class="og-description">Docker on Vagrant(ubuntu). Contribute to kenzo0107/vagrant-docker development by creating an account on GitHub.</div></div></div></a>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">├── docker-compose.yml</span><br><span class="line">├── fluentd</span><br><span class="line">│   ├── conf</span><br><span class="line">│   │   ├── conf.d</span><br><span class="line">│   │   │   └── nginx.log.conf</span><br><span class="line">│   │   └── fluent.conf</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">└── nginx</span><br><span class="line">    └── conf</span><br><span class="line">        └── nginx.conf</span><br></pre></td></tr></table></figure>

<h3><span id="ポイント">ポイント</span></h3><ul>
<li>nginx のログ格納場所を <code>volume</code> 指定しホスト側とシンク。 それを fluentd 側でも <code>volume</code> 指定し tail するようにしました。</li>
</ul>
<p>以下のようなイメージです。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421221055.png" width="100%">
</div>

<h2><span id="ブラウザから-nginx-起動確認">ブラウザから Nginx 起動確認</span></h2><p>ブラウザから <code>http://192.168.35.101/</code> にアクセスすると<br>Nginx の Welcome ページが確認できます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421222343.png" width="100%">
</div>

<p>先程の <code>docker-compose up</code> 後に以下のようなログが見え<br>fluentd が Nginx アクセスログを捕まえているのがわかります。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421222937.png" width="100%">
</div>

<h2><span id="kibana-にアクセス">Kibana にアクセス</span></h2><p>ブラウザから <code>http://192.168.35.101:5601</code> にアクセスすると<br>Kibana ページが表示されます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421223008.png" width="100%">
</div>

<ol>
<li><p>Index name or pattern</p>
<ul>
<li>fluentd-* 指定</li>
</ul>
</li>
<li><p>Time-field name</p>
<ul>
<li>@timestamp 指定</li>
</ul>
</li>
<li><p> Create ボタン押下</p>
</li>
<li><p> レフトメニューから <code>Discover</code> クリック</p>
</li>
</ol>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421223626.png" width="100%">
</div>

<h2><span id="macos-からログ確認">macOS からログ確認</span></h2><p>当然ながら macOS と vagrant とシンクしているので<br>macOS 上からもログが tail できます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ tail -f &lt;path/to/vagrant-docker&gt;/docker/nginx-efk/_log/nginx/access.log</span><br></pre></td></tr></table></figure>

<p>以上です。<br>参考になれば幸いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/17/2017-04-18-aws-retairement-notification/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170418/20170418105821.png" alt="AWS [Retirement Notification] 対応"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-04-18</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/17/2017-04-18-aws-retairement-notification/">AWS [Retirement Notification] 対応</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>とある日、AWS よりこんなメール通知が来ました。</p>
<p>要約すると<br>ホストしている基盤のハードウェアで回復不可能な障害が検知されたので<br>指定期限までに対応しないとインスタンスが停止する、とのこと。</p>
<p>今回こちらの対応をまとめました。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Dear Amazon EC2 Customer,</span><br><span class="line"></span><br><span class="line">We have important news about your account (AWS Account ID: xxxxxxxxxxxx). EC2 has detected degradation of the underlying hardware hosting your Amazon EC2 instance (instance-ID: i-xxxxxxxx) in the ap-northeast-1 region. Due to this degradation, your instance could already be unreachable. After 2017-04-25 04:00 UTC your instance, which has an EBS volume as the root device, will be stopped.</span><br><span class="line"></span><br><span class="line">You can see more information on your instances that are scheduled for retirement in the AWS Management Console (https://console.aws.amazon.com/ec2/v2/home?region=ap-northeast-1#Events)</span><br><span class="line"></span><br><span class="line">* How does this affect you?</span><br><span class="line">Your instance&#x27;s root device is an EBS volume and the instance will be stopped after the specified retirement date. You can start it again at any time. Note that if you have EC2 instance store volumes attached to the instance, any data on these volumes will be lost when the instance is stopped or terminated as these volumes are physically attached to the host computer</span><br><span class="line"></span><br><span class="line">* What do you need to do?</span><br><span class="line">You may still be able to access the instance. We recommend that you replace the instance by creating an AMI of your instance and launch a new instance from the AMI. For more information please see Amazon Machine Images (http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html) in the EC2 User Guide. In case of difficulties stopping your EBS-backed instance, please see the Instance FAQ (http://aws.amazon.com/instance-help/#ebs-stuck-stopping).</span><br><span class="line"></span><br><span class="line">* Why retirement?</span><br><span class="line">AWS may schedule instances for retirement in cases where there is an unrecoverable issue with the underlying hardware. For more information about scheduled retirement events please see the EC2 user guide (http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-retirement.html). To avoid single points of failure within critical applications, please refer to our architecture center for more information on implementing fault-tolerant architectures: http://aws.amazon.com/architecture</span><br><span class="line"></span><br><span class="line">If you have any questions or concerns, you can contact the AWS Support Team on the community forums and via AWS Premium Support at: http://aws.amazon.com/support</span><br><span class="line"></span><br><span class="line">Sincerely,</span><br><span class="line">Amazon Web Services</span><br></pre></td></tr></table></figure>

<ul>
<li>AWS Console イベントを見ると一覧で表示されている。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170418/20170418095219.png" width="100%">
</div>

<ul>
<li>AWS Console 詳細を見ると Notice が出ている。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170411/20170411215054.png" width="100%">
</div>

<h2><span id="todo">ToDO</span></h2><p>ボリュームタイプによって異なります。</p>
<ul>
<li><p>EBS ボリューム</p>
<ul>
<li>インスタンスの停止後、起動 (Reboot は ×)</li>
</ul>
</li>
<li><p>インスタンスストアボリューム</p>
<ul>
<li>AMI からインスタンス再作成、データ移行</li>
</ul>
</li>
</ul>
<p>今回は EBS ボリューム対応について記載してます。</p>
<h2><span id="対応">対応</span></h2><p>対象インスタンスが多かったのでローカル PC (macOS) から awscli でインスタンス停止 → 起動するシェル作成しました。<br>本番環境で利用されるインスタンスも含まれていた為、1 件ずつ実行することとしました。</p>
<h2><span id="事前準備">事前準備</span></h2><ul>
<li>awscli, jq インストール</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install awscli jq</span><br></pre></td></tr></table></figure>

<ul>
<li>各アカウント毎のアクセスキー、シークレットキー等設定</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure --profile &lt;profile&gt;</span><br><span class="line">$ grep &#x27;profile&#x27; ~/.aws/config</span><br></pre></td></tr></table></figure>

<h3><span id="インスタンスの停止再起動シェル">インスタンスの停止・再起動シェル</span></h3><script src="//gist.github.com/kenzo0107/b841bfad242e87da3625e5d980845529.js"></script>

<p>以下のように実行すると<br>インスタンスが起動(running)していれば<br>停止後、再び起動し、ステータスチェックをするようにしました。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sh stop_and_start_ec2_instance.sh &quot;&lt;profile&gt;&quot; &quot;&lt;instance id&gt;&quot;</span><br></pre></td></tr></table></figure>

<h3><span id="イベント情報取得シェル">イベント情報取得シェル</span></h3><p>.aws/config で設定されている profile を全てチェックし<br>未対応インスタンスのみ表示する様修正しました。</p>
<script src="//gist.github.com/kenzo0107/b79e05f6fc6692a1d631fd874ccb3e6b.js"></script>

<h2><span id="結果確認">結果確認</span></h2><p>大体 1 インスタンス 5 分程度で完了。<br>問題なく停止起動でき、対象イベントが一覧から消えたことを確認しました ♪</p>
<h2><span id="所感">所感</span></h2><p>メンテ対象インスタンスの Region が northeast に集中していたのが気になる点でした。<br>このインスタンス何に使ってるんだっけ？とならない様に、インスタンスや private key の命名ルール必須と感じました。</p>
<p>以上です。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/13/2017-04-14-teat-docker/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170414/20170414222435.png" alt="Docker コマンド早見表"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-04-14</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/13/2017-04-14-teat-docker/">Docker コマンド早見表</a></h1><div class="content"><h2><span id="バージョン">バージョン</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker --version</span><br><span class="line"></span><br><span class="line">Docker version 17.04.0-ce, build 4845c56</span><br></pre></td></tr></table></figure>

<h2><span id="コンテナ">コンテナ</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker ps                     # running コンテナ一覧</span><br><span class="line">docker ps -a                  # 全コンテナ一覧表示</span><br><span class="line">docker start &lt;CONTAINER ID&gt;   # コンテナ起動</span><br><span class="line">docker restart &lt;CONTAINER ID&gt; # コンテナ再起動</span><br><span class="line">docker stop &lt;CONTAINER ID&gt;    # コンテナ終了</span><br><span class="line">docker kill &lt;CONTAINER ID&gt;    # コンテナ強制終了</span><br><span class="line">docker attach &lt;CONTAINER ID&gt;  # コンテナへアタッチ</span><br><span class="line">docker top &lt;CONTAINER ID&gt;     # コンテナプロセスを表示</span><br><span class="line">docker logs -f &lt;CONTAINER ID&gt; # コンテナログ表示</span><br><span class="line">docker inspect &lt;CONTAINER ID&gt; # コンテナ情報表示</span><br><span class="line">docker rm &lt;CONTAINER ID&gt;      # コンテナID指定でコンテナ削除</span><br><span class="line">dockre rm &lt;CONTAINER NAME...&gt; # コンテナ名(複数)指定でコンテナ削除</span><br><span class="line">docker container prune        # 停止コンテナを削除</span><br><span class="line"></span><br><span class="line">dockr run -it -h &lt;host name&gt; &lt;IMAGE&gt;[:TAG] &lt;command&gt;  # イメージよりコンテナ起動 command 実施</span><br></pre></td></tr></table></figure>

<h2><span id="イメージ">イメージ</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull &lt;IMAGE NAME&gt;[:tag]     # イメージダウンロード</span><br><span class="line">docker images ls              # イメージ一覧</span><br><span class="line">docker inspect &lt;IMAGE ID&gt;     # イメージ情報表示</span><br><span class="line">docker rmi &lt;IMAGE ID&gt;         # イメージ削除</span><br></pre></td></tr></table></figure>

<h2><span id="イメージ作成">イメージ作成</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t NAME[:TAG]</span><br><span class="line">docker commit -m &quot;&lt;comment here&gt;&quot; &lt;CONTAINER ID&gt; &lt;IMAGE NAME&gt;[:TAG]</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose">Docker Compose</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d    # デタッチモードでイメージよりコンテナ起動</span><br><span class="line">docker-compose ps       # コンテナ一覧表示</span><br><span class="line">docker-compose stop     # docker compose 管理下全てのコンテナ停止</span><br><span class="line">docker-compose start    # docker compose 管理下全てのコンテナ起動</span><br><span class="line">docker-compose rm       # docker compose 管理下全ての停止コンテナ削除</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/12/2017-04-13-install-docker-and-docker-compose-on-vagrant/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413222957.png" alt="Vagrant (Ubuntu) に Docker, Docker Compose インストール"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-04-13</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/12/2017-04-13-install-docker-and-docker-compose-on-vagrant/">Vagrant (Ubuntu) に Docker, Docker Compose インストール</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>開発環境構築用に作成した、<br>Vagrant (Ubuntu) に Docker と Docker Compose をインストールする手順をまとめました。</p>
<h2><span id="vagrantfile-作成">Vagrantfile 作成</span></h2><p>かなりシンプルにしてます。</p>
<ul>
<li>Vagrantfile</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line"><span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line">Vagrant.configure(<span class="string">&quot;2&quot;</span>) <span class="keyword">do</span> |<span class="params">config</span>|</span><br><span class="line">  config.vm.box = <span class="string">&quot;ubuntu/trusty64&quot;</span></span><br><span class="line">  config.vm.network <span class="string">&quot;private_network&quot;</span>, <span class="symbol">ip:</span> <span class="string">&quot;192.168.35.101&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>vagrant provision で docker compose をインストールすることも可能ですが<br>vagrant ならではの provision だと他環境で利用できない為、OS 上でインストールする方針です。</p>
<h2><span id="vm-起動">VM 起動</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MacOS%$ vagrant up</span><br><span class="line">...</span><br><span class="line">しばし待つ</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">MacOS%$ vagrant ssh</span><br><span class="line"></span><br><span class="line">// ssh ログイン成功</span><br><span class="line">vagrant%$</span><br></pre></td></tr></table></figure>

<h2><span id="vagrant-ubuntu-環境情報確認">Vagrant Ubuntu 環境情報確認</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ lsb_release -a</span><br><span class="line"></span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 14.04.5 LTS</span><br><span class="line">Release:        14.04</span><br><span class="line">Codename:       trusty</span><br></pre></td></tr></table></figure>

<h2><span id="カーネルバージョン確認">カーネルバージョン確認</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ uname -r</span><br><span class="line">3.13.0-116-generic</span><br></pre></td></tr></table></figure>

<p>カーネルバージョンが 3.10 より低いとバグを引き起こす危険性があるので NG。<br>別のカーネルバージョンの高い box を使用しましょう。</p>
<h2><span id="古いバージョンをアンインストール">古いバージョンをアンインストール</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo apt-get remove docker docker-engine</span><br></pre></td></tr></table></figure>

<h2><span id="extra-パッケージインストール">extra パッケージインストール</span></h2><p>Docker に <a target="_blank" rel="noopener" href="http://docs.docker.jp/engine/userguide/storagedriver/aufs-driver.html">aufs</a> ストレージを使用許可する為です。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo apt-get update</span><br><span class="line">vagrant%$ sudo apt-get -y install \</span><br><span class="line">    wget \</span><br><span class="line">    linux-image-extra-$(uname -r) \</span><br><span class="line">    linux-image-extra-virtual</span><br></pre></td></tr></table></figure>

<h2><span id="docker-インストール">Docker インストール</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Docker インストール</span><br><span class="line">vagrant%$ wget -qO- https://get.docker.com/ | sh</span><br><span class="line"></span><br><span class="line">// Docker バージョン確認</span><br><span class="line">vagrant%$ docker --version</span><br><span class="line">Docker version 17.04.0-ce, build 4845c56</span><br><span class="line"></span><br><span class="line">// vagrant ユーザを docker グループに追加 (一旦ログアウトしログインし直すと有効になることを確認できます)</span><br><span class="line">vagrant%$ sudo usermod -aG docker vagrant</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-インストール">Docker Compose インストール</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ curl -L &quot;https://github.com/docker/compose/releases/download/1.12.0/docker-compose-$(uname -s)-$(uname -m)&quot; &gt;  ~/docker-compose</span><br><span class="line"></span><br><span class="line">// 実行権限付与</span><br><span class="line">vagrant%$ chmod +x ~/docker-compose</span><br><span class="line"></span><br><span class="line">// 実行パス移動</span><br><span class="line">vagrant%$ sudo mv docker-compose /usr/bin/</span><br><span class="line"></span><br><span class="line">// Docker Compose バージョン確認</span><br><span class="line">vagrant%$ docker-compose --version</span><br><span class="line">docker-compose version 1.12.0, build b31ff33</span><br></pre></td></tr></table></figure>

<h2><span id="一度ログアウトし再度ログイン">一度ログアウトし再度ログイン</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ exit</span><br><span class="line">MacOS%$ vagrant ssh</span><br><span class="line">vagrant%$</span><br></pre></td></tr></table></figure>

<h2><span id="メモリとスワップ利用量の調整">メモリとスワップ利用量の調整</span></h2><p>Docker を使用していない時にメモリのオーバーヘッドとパフォーマンス劣化を低減させる様、<br>GRUB (GRand Unified Bootloader: グラブ or ジーラブ) に設定する必要があります。</p>
<ul>
<li>grub 設定</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo vi /etc/default/grub</span><br><span class="line"></span><br><span class="line"># GRUB_CMDLINE_LINUX=&quot;&quot;</span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;cgroup_enable=memory swapaccount=1&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>GRUB (GRand Unified Bootloader: グラブ or ジーラブ) 更新</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo update-grub</span><br><span class="line"></span><br><span class="line">// 念の為、再起動</span><br><span class="line">vagrant%$ sudo reboot</span><br></pre></td></tr></table></figure>

<p>以上で準備完了です ♪</p>
<h2><span id="早速試してみる">早速試してみる</span></h2><p>簡単なチュートリアルとして nginx コンテナを立ててみます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker run --rm -p 80:80 nginx:mainline-alpine</span><br><span class="line"></span><br><span class="line">Unable to find image &#x27;nginx:mainline-alpine&#x27; locally</span><br><span class="line">mainline-alpine: Pulling from library/nginx</span><br><span class="line">709515475419: Already exists</span><br><span class="line">4b21d71b440a: Pull complete</span><br><span class="line">c92260fe6357: Pull complete</span><br><span class="line">ed383a1b82df: Pull complete</span><br><span class="line">Digest: sha256:5aadb68304a38a8e2719605e4e180413f390cd6647602bee9bdedd59753c3590</span><br><span class="line">Status: Downloaded newer image for nginx:mainline-alpine</span><br></pre></td></tr></table></figure>

<h2><span id="ブラウザアクセス">ブラウザアクセス</span></h2><p>ローカルの Mac からブラウザでアクセス</p>
<p><a target="_blank" rel="noopener" href="http://192.168.35.101/">http://192.168.35.101</a></p>
<p>※192.168.35.101 … Vagrant で指定した private ip</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413224153.png" width="100%">
</div>

<p>問題なく Welcome ページが表示されました。</p>
<p>先程のログに以下のようにアクセスログが出力されるのがわかります。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.35.1 - - [13/Apr/2017:10:45:46 +0000] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<p>MacOS → Vagrant → Docker<br>とアクセスできるようになりました ♪</p>
<h2><span id="追記">追記</span></h2><p>今回作成した Box を Vagrant Cloud に置きました。</p>
<p><a target="_blank" rel="noopener" href="https://atlas.hashicorp.com/kenzo0107/boxes/ubuntu14.04.5LTS-docker-dockercompose/">https://atlas.hashicorp.com/kenzo0107/boxes/ubuntu14.04.5LTS-docker-dockercompose/</a></p>
<p>こちら設定を元にこれから様々な環境構築を記載していきたいと思います ♪</p>
<h2><span id="参照">参照</span></h2><ul>
<li><a target="_blank" rel="noopener" href="http://docs.docker.jp/engine/userguide/storagedriver/aufs-driver.html">AUFS ストレージ・ドライバの使用</a></li>
<li><a target="_blank" rel="noopener" href="http://docs.docker.jp/engine/reference/run.html">Docker run リファレンス</a></li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/12/2017-04-13-tutorial-docker-compose/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170414/20170414222435.png" alt="Docker Compose チュートリアル"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-04-13</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/12/2017-04-13-tutorial-docker-compose/">Docker Compose チュートリアル</a></h1><div class="content"><p>前回 Vagrant (Ubuntu)で Docker, Docker Compose 環境構築しました。</p>
<a href="http://kenzo0107.hatenablog.com/entry/2017/04/13/225610" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413222957.png"></div><div class="descriptions"><div class="og-title">Vagrant (Ubuntu) に Docker, Docker Compose インストール - 長生村本郷Engineers&#39;Blog</div><div class="og-description">以下に移行しました。 kenzo0107.github.io</div></div></div></a>

<p>上記環境を元に <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/gettingstarted/#step-1-setup">Docker Compose チュートリアル</a>を実行しました。</p>
<p>完全な備忘録です。</p>
<h2><span id="プロジェクトディレクトリ作成">プロジェクトディレクトリ作成</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ mkdir composetest &amp;&amp; cd composetest</span><br></pre></td></tr></table></figure>

<h2><span id="apppy-作成">app.py 作成</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=<span class="string">&#x27;redis&#x27;</span>, port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    count = redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="comment">#return &#x27;Hello World! I have been seen &#123;&#125; times.\n&#x27;.format(count)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello from Docker! I have been seen &#123;&#125; times.\n&#x27;</span>.<span class="built_in">format</span>(count)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2><span id="requirementstxt-作成">requirements.txt 作成</span></h2><p>pip でインストールするモジュールを列挙します。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flask</span><br><span class="line">redis</span><br></pre></td></tr></table></figure>

<h2><span id="dockerfile-作成">Dockerfile 作成</span></h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.4</span>-alpine</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> . /code</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /code</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install -r requirements.txt</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h2><span id="docker-composeyml-作成">docker-compose.yml 作成</span></h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;5000:5000&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/code</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;redis:alpine&#x27;</span></span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-でイメージビルド-コンテナ起動">Docker Compose でイメージビルド、コンテナ起動</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker-compose up</span><br><span class="line"></span><br><span class="line">Creating composetest_web_1</span><br><span class="line">Creating composetest_redis_1</span><br><span class="line">Attaching to composetest_redis_1, composetest_web_1</span><br><span class="line">redis_1  | 1:C 13 Apr 14:25:38.483 # Warning: no config file specified, using the default config. Inorder to specify a config file use redis-server /path/to/redis.conf</span><br><span class="line">redis_1  |                 _._</span><br><span class="line">redis_1  |            _.-``__ &#x27;&#x27;-._</span><br><span class="line">redis_1  |       _.-``    `.  `_.  &#x27;&#x27;-._           Redis 3.2.8 (00000000/0) 64 bit</span><br><span class="line">redis_1  |   .-`` .-```.  ```\/    _.,_ &#x27;&#x27;-._</span><br><span class="line">redis_1  |  (    &#x27;      ,       .-`  | `,    )     Running in standalone mode</span><br><span class="line">redis_1  |  |`-._`-...-` __...-.``-._|&#x27;` _.-&#x27;|     Port: 6379</span><br><span class="line">redis_1  |  |    `-._   `._    /     _.-&#x27;    |     PID: 1</span><br><span class="line">redis_1  |   `-._    `-._  `-./  _.-&#x27;    _.-&#x27;</span><br><span class="line">redis_1  |  |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|</span><br><span class="line">redis_1  |  |    `-._`-._        _.-&#x27;_.-&#x27;    |           http://redis.io</span><br><span class="line">redis_1  |   `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;</span><br><span class="line">redis_1  |  |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|</span><br><span class="line">redis_1  |  |    `-._`-._        _.-&#x27;_.-&#x27;    |</span><br><span class="line">redis_1  |   `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;</span><br><span class="line">redis_1  |       `-._    `-.__.-&#x27;    _.-&#x27;</span><br><span class="line">redis_1  |           `-._        _.-&#x27;</span><br><span class="line">redis_1  |               `-.__.-&#x27;</span><br><span class="line">redis_1  |</span><br><span class="line">redis_1  | 1:M 13 Apr 14:25:38.486 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">redis_1  | 1:M 13 Apr 14:25:38.486 # Server started, Redis version 3.2.8</span><br><span class="line">redis_1  | 1:M 13 Apr 14:25:38.486 # WARNING overcommit_memory is set to 0! Background save may failunder low memory condition. To fix this issue add &#x27;vm.overcommit_memory = 1&#x27; to /etc/sysctl.conf andthen reboot or run the command &#x27;sysctl vm.overcommit_memory=1&#x27; for this to take effect.</span><br><span class="line">redis_1  | 1:M 13 Apr 14:25:38.486 * The server is now ready to accept connections on port 6379</span><br><span class="line">web_1    |  * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)</span><br><span class="line">web_1    |  * Restarting with stat</span><br><span class="line">web_1    |  * Debugger is active!</span><br><span class="line">web_1    |  * Debugger PIN: 135-466-976</span><br><span class="line">web_1    | 192.168.35.1 - - [13/Apr/2017 14:25:53] &quot;GET / HTTP/1.1&quot; 200 -</span><br><span class="line">web_1    | 192.168.35.1 - - [13/Apr/2017 14:25:53] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -</span><br></pre></td></tr></table></figure>

<p>ブラウザにアクセスしてみる。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413233236.png" width="100%">
</div>

<p>表示されました！</p>
<p>リロードする度に以下数字部分がインクリメントされるのが確認できます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello from Docker! I have been seen 1 times.</span><br></pre></td></tr></table></figure>

<p>便利 ♪</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/03/26/2017-03-27-create-keypair-by-terraform/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327212027.png" alt="Terraform でキーペア登録し起動した EC2 に SSH接続"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-03-27</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/03/26/2017-03-27-create-keypair-by-terraform/">Terraform でキーペア登録し起動した EC2 に SSH接続</a></h1><div class="content"><h2><span id="今回やること">今回やること</span></h2><ul>
<li>Mac ローカルで公開鍵、秘密鍵を生成</li>
<li>Terraform で EC2 起動、セキュリティグループで SSH (ポート 22)許可、key-pair 登録</li>
</ul>
<p>Terraform の Hello World 的なチュートリアルと思っていただけたら幸いです。</p>
<h2><span id="環境">環境</span></h2><ul>
<li>Mac OS 10.12.3 (Sierra)</li>
<li>Terraform 0.9.1</li>
</ul>
<h2><span id="公開鍵-秘密鍵生成">公開鍵、秘密鍵生成</span></h2><p>RSA フォーマットで鍵を生成します。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line">Enter file in which to save the key (/Users/kenzo_tanaka/.ssh/id_rsa): /Users/kenzo_tanaka/.ssh/terraform-test</span><br><span class="line">Enter passphrase (empty for no passphrase): (空のままEnter)</span><br><span class="line">Enter same passphrase again: (空のままEnter)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// 生成されたか確認</span><br><span class="line">$ ls ~/.ssh/terraform-test*</span><br><span class="line"></span><br><span class="line">/Users/kenzo_tanaka/.ssh/terraform-test      # 秘密鍵</span><br><span class="line">/Users/kenzo_tanaka/.ssh/terraform-test.pub　# 公開鍵</span><br></pre></td></tr></table></figure>

<p>公開鍵を起動した EC2 インスタンスに登録し<br>秘密鍵でアクセスします。</p>
<p>以下のように利用する予定です。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -i ~/.ssh/terraform-test &lt;ec2 user&gt;@&lt;ec2 public ip&gt;</span><br></pre></td></tr></table></figure>

<h2><span id="terraform-設定ファイル">Terraform 設定ファイル</span></h2><ul>
<li><p>Point !</p>
<ul>
<li><code>resource &quot;aws_key_pair&quot;</code> で使用する公開鍵設定をしています。</li>
<li><code>resource &quot;aws_security_group&quot;</code> で SSH（ポート 22）を開いてます。</li>
<li><code>resource &quot;aws_instance&quot;</code> で使用しているセキュリティグループの指定は <code>vpc_security_group_ids</code> を利用<ul>
<li>セキュリティグループの条件追加・削除する場合にインスタンスを一度削除し作り直すことをしたくない場合に vpc_security_group_ids を利用すると良いです。</li>
</ul>
</li>
</ul>
</li>
<li><p>main.tf</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key = &quot;$&#123;var.access_key&#125;&quot;</span><br><span class="line">  secret_key = &quot;$&#123;var.secret_key&#125;&quot;</span><br><span class="line">  region     = &quot;$&#123;var.region&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;example&quot; &#123;</span><br><span class="line">  ami           = &quot;$&#123;lookup(var.amis, var.region)&#125;&quot;</span><br><span class="line">  instance_type = &quot;t2.nano&quot;</span><br><span class="line">  key_name      = &quot;$&#123;aws_key_pair.auth.id&#125;&quot;</span><br><span class="line">  vpc_security_group_ids = [&quot;$&#123;aws_security_group.default.id&#125;&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_key_pair&quot; &quot;auth&quot; &#123;</span><br><span class="line">  key_name   = &quot;$&#123;var.key_name&#125;&quot;</span><br><span class="line">  public_key = &quot;$&#123;file(var.public_key_path)&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_security_group&quot; &quot;default&quot; &#123;</span><br><span class="line">  name        = &quot;terraform_security_group&quot;</span><br><span class="line">  description = &quot;Used in the terraform&quot;</span><br><span class="line"></span><br><span class="line">  # SSH access from anywhere</span><br><span class="line">  ingress &#123;</span><br><span class="line">    from_port   = 22</span><br><span class="line">    to_port     = 22</span><br><span class="line">    protocol    = &quot;tcp&quot;</span><br><span class="line">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>variables.tf</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;access_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;secret_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;region&quot; &#123;</span><br><span class="line">  default = &quot;ap-northeast-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;amis&quot; &#123;</span><br><span class="line">  type = &quot;map&quot;</span><br><span class="line">  default = &#123;</span><br><span class="line">    us-east-1 = &quot;ami-13be557e&quot;</span><br><span class="line">    us-west-2 = &quot;ami-21f78e11&quot;</span><br><span class="line">    ap-northeast-1 = &quot;ami-1bfdb67c&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;key_name&quot; &#123;</span><br><span class="line">  description = &quot;Desired name of AWS key pair&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;public_key_path&quot; &#123;</span><br><span class="line">  description = &lt;&lt;DESCRIPTION</span><br><span class="line">Path to the SSH public key to be used for authentication.</span><br><span class="line">Ensure this keypair is added to your local SSH agent so provisioners can</span><br><span class="line">connect.</span><br><span class="line"></span><br><span class="line">Example: ~/.ssh/terraform.pub</span><br><span class="line">DESCRIPTION</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>terraform.tfvars</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">access_key = &quot;A******************Q&quot;</span><br><span class="line">secret_key = &quot;q**************************************Z&quot;</span><br><span class="line"></span><br><span class="line">key_name = &quot;terraform-test&quot;</span><br><span class="line">public_key_path = &quot;~/.ssh/terraform-test.pub&quot;</span><br></pre></td></tr></table></figure>

<h2><span id="いざ実行">いざ実行</span></h2><ul>
<li>実行計画確認</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br></pre></td></tr></table></figure>

<ul>
<li>実行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply</span><br></pre></td></tr></table></figure>

<h2><span id="確認">確認</span></h2><ul>
<li><p>AWS コンソール上で起動確認</p>
<ul>
<li>キーペアに terraform-test が指定されています。</li>
<li>vpc, subnet も自動的にアタッチされてます。</li>
</ul>
</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327214009.png" width="100%">
</div>

<ul>
<li>キーペア<br>一応キーペアを見てみると登録されているのがわかります。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327214404.png" width="100%">
</div>

<ul>
<li>セキュリティグループ確認</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327214628.png" width="100%">
</div>

<ul>
<li>SSH ログイン確認</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -i ~/.ssh/terraform-test ubuntu@ec2-54-65-244-25.ap-northeast-1.compute.amazonaws.com</span><br></pre></td></tr></table></figure>

<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327214837.png" width="100%">
</div>

<p>無事 SSH ログインできました！</p>
<h2><span id="所感">所感</span></h2><p><a target="_blank" rel="noopener" href="https://www.terraform.io/">terraform</a> を見ながら各パラメータの利用意図を確認しながら<br>設定してみましたが<br>パラメータの説明自体はざっくりで利用方法まではわからないです。</p>
<p><a target="_blank" rel="noopener" href="https://www.terraform.io/intro/getting-started/build.html">Teffaform のチュートリアル</a>に始まり<br>その他 <a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/tagged/terraform">Stack Overflow</a> で<br>適宜パターンを蓄積していく学習が程よいと思います。</p>
<h2><span id="参考">参考</span></h2><a href="http://cross-black777.hatenablog.com/entry/2016/02/25/090000" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://blog.st-hatena.com/images/theme/og-image-1500.png"></div><div class="descriptions"><div class="og-title">Terraformで立てたEC2に後からSGを追加しようとするとEC2が再作成される - tjinjin&#39;s blog</div><div class="og-description">About 初回に立てた時はSGが1つだったが、あとからSGを追加したくなったときどうなるか試した結果です。</div></div></div></a>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/03/22/2017-03-23-terraform-aws/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170323/20170323222447.png" alt="Terraform で AWS インフラストラクチャ！"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-03-23</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/03/22/2017-03-23-terraform-aws/">Terraform で AWS インフラストラクチャ！</a></h1><div class="content"><h2><span id="terraform-とは">Terraform とは</span></h2><ul>
<li>インフラ構成や設定をコードにより実行計画を確認しながら自動化できるツール</li>
<li>AWS, Google Cloud 等多数のクラウドサービスで利用可能</li>
<li>HashiCorp 社製</li>
</ul>
<h2><span id="今回やること">今回やること</span></h2><ul>
<li>インスタンス起動</li>
<li>Elastic IP 付きインスタンス起動</li>
<li>インスタンス破棄</li>
</ul>
<p>非常にミニマムなインフラ構築をしてみます。<br>※個人のアカウントでも無料枠を使えば数十円しか掛からなかったです。</p>
<h2><span id="環境">環境</span></h2><ul>
<li>Mac OS Sierra X 10.12.3 16D32</li>
<li>Terraform 0.9.1</li>
</ul>
<h2><span id="terraform-インストール">terraform インストール</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install terraform</span><br></pre></td></tr></table></figure>

<h2><span id="バージョン確認">バージョン確認</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ terraform version</span><br><span class="line"></span><br><span class="line">Terraform v0.9.1</span><br></pre></td></tr></table></figure>

<p>では、早速使ってみます。</p>
<h2><span id="ec2-instance-t2micro-起動">EC2 instance (t2.micro) 起動</span></h2><ul>
<li>main.tf 作成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key = &quot;A******************Q&quot;</span><br><span class="line">  secret_key = &quot;q**************************************Z&quot;</span><br><span class="line">  region     = &quot;ap-northeast-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;example&quot; &#123;</span><br><span class="line">  ami           = &quot;ami-71d79f16&quot;</span><br><span class="line">  instance_type = &quot;t2.micro&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>実行計画確認</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br></pre></td></tr></table></figure>

<ul>
<li>実行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply</span><br></pre></td></tr></table></figure>

<p>Amazon Console からインスタンスが起動されたことが確認できます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170323/20170323224719.png" width="100%">
</div>

<h2><span id="変数を別ファイルで管理">変数を別ファイルで管理</span></h2><p>上記 main.tf を github 等で管理するとなると<br>access_key, secret_key が露見されてしまいます。</p>
<p>その為、以下の様に別ファイルで管理することが望ましいです。</p>
<ul>
<li>main.tf</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;access_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;secret_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;region&quot; &#123;</span><br><span class="line">  default = &quot;ap-northeast-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key = &quot;$&#123;var.access_key&#125;&quot;</span><br><span class="line">  secret_key = &quot;$&#123;var.secret_key&#125;&quot;</span><br><span class="line">  region     = &quot;$&#123;var.region&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;example&quot; &#123;</span><br><span class="line">  ami           = &quot;ami-71d79f16&quot;</span><br><span class="line">  instance_type = &quot;t2.micro&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>terraform.tfvars<ul>
<li>terraform 実行時に自動で読み込まれるファイル</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access_key = &quot;A******************Q&quot;</span><br><span class="line">secret_key = &quot;q**************************************Z&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>実行計画確認</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>

<p>正しく実行できることが確認できました。</p>
<p><code>terraform.tfvars</code> ファイルは .gitignore に登録しておくなど<br>絶対に公開されない様な設定が望ましいと思います。</p>
<h2><span id="ec2-instance-t2micro-ami-変更">EC2 instance (t2.micro) AMI 変更</span></h2><ul>
<li>main.tf</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;access_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;secret_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;region&quot; &#123;</span><br><span class="line">  default = &quot;ap-northeast-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key = &quot;$&#123;var.access_key&#125;&quot;</span><br><span class="line">  secret_key = &quot;$&#123;var.secret_key&#125;&quot;</span><br><span class="line">  region     = &quot;$&#123;var.region&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;example&quot; &#123;</span><br><span class="line">  ami           = &quot;ami-047aed04&quot;</span><br><span class="line">  instance_type = &quot;t2.micro&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>実行計画</li>
</ul>
<p>変更される内容が表示されます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-/+ aws_instance.example</span><br><span class="line">    ami:                         &quot;ami-71d79f16&quot; =&gt; &quot;ami-047aed04&quot; (forces new resource)</span><br><span class="line">    associate_public_ip_address: &quot;true&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    availability_zone:           &quot;ap-northeast-1a&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    ebs_block_device.#:          &quot;0&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    ephemeral_block_device.#:    &quot;0&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    instance_state:              &quot;running&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    instance_type:               &quot;t2.micro&quot; =&gt; &quot;t2.micro&quot;</span><br><span class="line">    ipv6_addresses.#:            &quot;0&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    key_name:                    &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    network_interface_id:        &quot;eni-f4a214bb&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    placement_group:             &quot;&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    private_dns:                 &quot;ip-172-31-31-239.ap-northeast-1.compute.internal&quot; =&gt; &quot;&lt;c</span><br><span class="line">omputed&gt;&quot;</span><br><span class="line">    private_ip:                  &quot;172.31.31.239&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    public_dns:                  &quot;ec2-52-199-88-146.ap-northeast-1.compute.amazonaws.com&quot;</span><br><span class="line">=&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    public_ip:                   &quot;52.199.88.146&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    root_block_device.#:         &quot;1&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    security_groups.#:           &quot;0&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    source_dest_check:           &quot;true&quot; =&gt; &quot;true&quot;</span><br><span class="line">    subnet_id:                   &quot;subnet-7a79cc0d&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    tenancy:                     &quot;default&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line">    vpc_security_group_ids.#:    &quot;1&quot; =&gt; &quot;&lt;computed&gt;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 1 to destroy.</span><br></pre></td></tr></table></figure>

<p>最初に作成したインスタンスは破棄され、新たにインスタンスを作成していることがわかります。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170323/20170323225232.png" width="100%">
</div>

<p>terraform で新規作成・変更ができました。</p>
<p>次は破棄してみましょう。</p>
<h2><span id="ec2-instance-t2micro-破棄">EC2 instance (t2.micro) 破棄</span></h2><ul>
<li>実行計画確認</li>
</ul>
<p>破棄対象のリソースが表示されます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan -destroy</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- aws_instance.example</span><br></pre></td></tr></table></figure>

<ul>
<li>実行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ terraform destroy</span><br><span class="line"></span><br><span class="line">Do you really want to destroy?</span><br><span class="line">  Terraform will delete all your managed infrastructure.</span><br><span class="line">  There is no undo. Only &#x27;yes&#x27; will be accepted to confirm.</span><br><span class="line"></span><br><span class="line">  Enter a value: yes (← yes 入力)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Destroy complete! Resources: 1 destroyed.</span><br></pre></td></tr></table></figure>

<p>Amazon コンソールで破棄されたことを確認できます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170323/20170323225807.png" width="100%">
</div>

<h2><span id="インスタンス起動し-elastic-ip-固定-ip-設定">インスタンス起動し Elastic IP (固定 IP) 設定</span></h2><ul>
<li>main.tf</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;access_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;secret_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;region&quot; &#123;</span><br><span class="line">  default = &quot;ap-northeast-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key = &quot;$&#123;var.access_key&#125;&quot;</span><br><span class="line">  secret_key = &quot;$&#123;var.secret_key&#125;&quot;</span><br><span class="line">  region     = &quot;$&#123;var.region&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;example&quot; &#123;</span><br><span class="line">  ami           = &quot;ami-047aed04&quot;</span><br><span class="line">  instance_type = &quot;t2.micro&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_eip&quot; &quot;ip&quot; &#123;</span><br><span class="line">    instance = &quot;$&#123;aws_instance.example.id&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>実行計画確認</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">+ aws_eip.ip</span><br><span class="line">    allocation_id:     &quot;&lt;computed&gt;&quot;</span><br><span class="line">    association_id:    &quot;&lt;computed&gt;&quot;</span><br><span class="line">    domain:            &quot;&lt;computed&gt;&quot;</span><br><span class="line">    instance:          &quot;$&#123;aws_instance.example.id&#125;&quot;</span><br><span class="line">    network_interface: &quot;&lt;computed&gt;&quot;</span><br><span class="line">    private_ip:        &quot;&lt;computed&gt;&quot;</span><br><span class="line">    public_ip:         &quot;&lt;computed&gt;&quot;</span><br><span class="line">    vpc:               &quot;&lt;computed&gt;&quot;</span><br><span class="line"></span><br><span class="line">+ aws_instance.example</span><br><span class="line">    ami:                         &quot;ami-047aed04&quot;</span><br><span class="line">    associate_public_ip_address: &quot;&lt;computed&gt;&quot;</span><br><span class="line">    availability_zone:           &quot;&lt;computed&gt;&quot;</span><br><span class="line">    ebs_block_device.#:          &quot;&lt;computed&gt;&quot;</span><br><span class="line">    ephemeral_block_device.#:    &quot;&lt;computed&gt;&quot;</span><br><span class="line">    instance_state:              &quot;&lt;computed&gt;&quot;</span><br><span class="line">    instance_type:               &quot;t2.micro&quot;</span><br><span class="line">    ipv6_addresses.#:            &quot;&lt;computed&gt;&quot;</span><br><span class="line">    key_name:                    &quot;&lt;computed&gt;&quot;</span><br><span class="line">    network_interface_id:        &quot;&lt;computed&gt;&quot;</span><br><span class="line">    placement_group:             &quot;&lt;computed&gt;&quot;</span><br><span class="line">    private_dns:                 &quot;&lt;computed&gt;&quot;</span><br><span class="line">    private_ip:                  &quot;&lt;computed&gt;&quot;</span><br><span class="line">    public_dns:                  &quot;&lt;computed&gt;&quot;</span><br><span class="line">    public_ip:                   &quot;&lt;computed&gt;&quot;</span><br><span class="line">    root_block_device.#:         &quot;&lt;computed&gt;&quot;</span><br><span class="line">    security_groups.#:           &quot;&lt;computed&gt;&quot;</span><br><span class="line">    source_dest_check:           &quot;true&quot;</span><br><span class="line">    subnet_id:                   &quot;&lt;computed&gt;&quot;</span><br><span class="line">    tenancy:                     &quot;&lt;computed&gt;&quot;</span><br><span class="line">    vpc_security_group_ids.#:    &quot;&lt;computed&gt;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>

<ul>
<li>実行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply</span><br></pre></td></tr></table></figure>

<p>Elastic IP が設定されたインスタンスが起動していることが確認できます。<br>※ただ、起動しただけで接続できないことがわかります(&gt;_&lt;) 次回実施します</p>
<p>[f:id:kenzo0107:20170323230208p:plain]</p>
<ul>
<li>実行計画確認</li>
</ul>
<p>破棄される Elastic IP, インスタンスが確認できます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan -destroy</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- aws_eip.ip</span><br><span class="line"></span><br><span class="line">- aws_instance.example</span><br></pre></td></tr></table></figure>

<ul>
<li>実行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ terraform destroy</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Destroy complete! Resources: 2 destroyed.</span><br></pre></td></tr></table></figure>

<p>全インスタンスが破棄されていることが確認できました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170323/20170323230746.png" width="100%">
</div>

<h2><span id="その他便利な設定">その他便利な設定</span></h2><h3><span id="map-設定">Map 設定</span></h3><ul>
<li>region 毎に AMI を選択し terraform apply 時に変数指定し選択可能</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">variable &quot;amis&quot; &#123;</span><br><span class="line">  type = &quot;map&quot;</span><br><span class="line">  default = &#123;</span><br><span class="line">    us-east-1 = &quot;ami-13be557e&quot;</span><br><span class="line">    us-east-2 = &quot;ami-71d79f16&quot;</span><br><span class="line">    us-west-1 = &quot;ami-00175967&quot;</span><br><span class="line">    us-west-2 = &quot;ami-06b94666&quot;</span><br><span class="line">    ap-northeast-1 = &quot;ami-047aed04&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;example&quot; &#123;</span><br><span class="line">  ami           = &quot;$&#123;lookup(var.amis, var.region)&#125;&quot;</span><br><span class="line">  instance_type = &quot;t2.micro&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ex) region us-west-2 を選択</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -var region=us-west-2</span><br></pre></td></tr></table></figure>

<h3><span id="出力設定">出力設定</span></h3><p>生成された Elastic IP の値が知りたいときなど便利です。</p>
<ul>
<li>main.tf</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_eip&quot; &quot;ip&quot; &#123;</span><br><span class="line">    instance = &quot;$&#123;aws_instance.example.id&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;ip&quot; &#123;</span><br><span class="line">    value = &quot;$&#123;aws_eip.ip.public_ip&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>出力値が確認できます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Outputs:</span><br><span class="line"></span><br><span class="line">ip = 52.197.157.206</span><br></pre></td></tr></table></figure>

<ul>
<li>terraform output <var></var></li>
</ul>
<p>より明示的にパラメータを絞って表示できます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ terraform output ip</span><br><span class="line"></span><br><span class="line">52.197.157.206</span><br></pre></td></tr></table></figure>

<ul>
<li>show</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ terraform show</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Outputs:</span><br><span class="line"></span><br><span class="line">ip = 52.197.157.206</span><br></pre></td></tr></table></figure>

<h3><span id="構成のグラフ化">構成のグラフ化</span></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform graph | dot -Tpng &gt; graph.png</span><br></pre></td></tr></table></figure>

<ul>
<li>graph.png</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170324/20170324172034.png" width="100%">
</div>

<ul>
<li>dot コマンドがない場合は graphviz インストール</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install graphviz</span><br></pre></td></tr></table></figure>

<h2><span id="総評">総評</span></h2><p>簡単でしょ？と言われているようなツールでした ♪</p>
<p>引き続きプロビジョニングや AWS の各種設定をしていきたいと思います。</p>
<p>次回 <a href="https://kenzo0107.github.io/2017/03/27/2017-03-27-create-keypair-by-terraform/">EC2 インスタンスを起動し、ローカル環境で作った鍵をキーペア登録し SSH ログイン</a>を実施します。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/02/15/2017-02-16-node_exporter/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170216/20170216225748.png" alt="node_exporter シェルでクエリ自作"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-02-16</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/02/15/2017-02-16-node_exporter/">node_exporter シェルでクエリ自作</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>node_expoter のオプション <code>--collector.textfile.directory</code> で指定したディレクトリに <code>*.prom</code> という拡張子を配置することで<br>そこに記述したメトリクス情報を prometheus server が読み取ってくれます。</p>
<p>この <code>*.prom</code> ファイルを一定時間毎に更新すればメトリクスが自作できる、というものです。</p>
<h2><span id="手順">手順</span></h2><ul>
<li>node_exporter 自体のインストール・セットアップは以下ご参照ください。</li>
</ul>
<a href="http://kenzo0107.hatenablog.com/entry/2017/01/25/154144" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170125/20170125144719.png"></div><div class="descriptions"><div class="og-title">Node Exporter 構築手順 + Prometheus からAWSオートスケール監視 - 長生村本郷Engineers&#39;Blog</div><div class="og-description">以下に移行しました。 kenzo0107.github.io</div></div></div></a>

<p>上記手順では以下に node_exporter を配置しています。<br>環境によって適宜書き換えてください。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/node_exporter/node_exporter</span><br></pre></td></tr></table></figure>

<h2><span id="text_collector-ディレクトリ作成">text_collector ディレクトリ作成</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/node_exporter</span><br><span class="line">$ mkdir text_collector</span><br></pre></td></tr></table></figure>

<h2><span id="shell-作成">shell 作成</span></h2><p>今回は httpd の process count のメトリクス追加することとします。</p>
<ul>
<li>/usr/local/node_exporter/text_collector/httpd.sh 作成</li>
</ul>
<script src="//gist.github.com/kenzo0107/cf245d3ba1d2f0faea7f0134414a8c81.js"></script>

<h2><span id="cron-設定">cron 設定</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># node_exporter httpd 5分毎更新</span><br><span class="line">*/5 * * * * /usr/local/node_exporter/text_collector/httpd.sh</span><br></pre></td></tr></table></figure>

<h2><span id="httpdprom-作成確認">httpd.prom 作成確認</span></h2><ul>
<li>/usr/local/node_exporter/text_collector/httpd.prom</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_httpd_count 24</span><br></pre></td></tr></table></figure>

<p>上記の <code>node_httpd_count</code> がメトリクス名になります。</p>
<h2><span id="node_expoter-再起動">node_expoter 再起動</span></h2><p>以下のようにディレクトリ指定します。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_expoter --collector.textfile.directory /usr/local/node_exporter/text_collector</span><br></pre></td></tr></table></figure>

<h2><span id="作成したメトリクスを指定し確認する">作成したメトリクスを指定し確認する。</span></h2><p>無事できました！</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170216/20170216225202.png" width="100%">
</div>

<p>これを利用してるとシェル芸で色々事足りることもあります ♪</p>
<p>一助になれば何よりです。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/15/">前</a></div><div class="pagination-next"><a href="/page/17/">次</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/15/">15</a></li><li><a class="pagination-link is-current" href="/page/16/">16</a></li><li><a class="pagination-link" href="/page/17/">17</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/34/">34</a></li></ul></nav></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="kenzo0107"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">kenzo0107</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">投稿</p><a href="/archives"><p class="title">335</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">カテゴリ</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">タグ</p><a href="/tags"><p class="title">88</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/kenzo0107" target="_blank" rel="noopener">フォローする</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/kenzo0107"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">カテゴリ</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/AWS/"><span class="level-start"><span class="level-item">AWS</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><li><a class="level is-mobile" href="/categories/DIY/"><span class="level-start"><span class="level-item">DIY</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Go/"><span class="level-start"><span class="level-item">Go</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile" href="/categories/RaspberryPI/"><span class="level-start"><span class="level-item">RaspberryPI</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/Terraform/"><span class="level-start"><span class="level-item">Terraform</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最近の記事</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-06T15:00:00.000Z">2023-07-07</time></p><p class="title"><a href="/2023/07/06/2023-07-07-aws-sam-enable-apigateway-accesslog/">SAM プロジェクトで管理する API Gateway のアクセスログを有効化する</a></p><p class="categories"><a href="/categories/AWS/">AWS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-05T15:00:00.000Z">2023-07-06</time></p><p class="title"><a href="/2023/07/05/2023-07-06-install-terraform-multi-versions-by-asdf/">asdf で terraform 複数バージョン管理</a></p><p class="categories"><a href="/categories/AWS/">AWS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-19T15:00:00.000Z">2023-06-20</time></p><p class="title"><a href="/2023/06/19/2023-06-20-aws-sam-import-iam-role/">SAM テンプレートに既存リソースをインポートする手順 - IAM Role 編 -</a></p><p class="categories"><a href="/categories/AWS/">AWS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-06T15:00:00.000Z">2023-06-07</time></p><p class="title"><a href="/2023/06/06/2023-06-07-aws-sam-import-resource/">SAM テンプレートに既存リソースをインポートする手順 - CloudWatch Logs 編 -</a></p><p class="categories"><a href="/categories/AWS/">AWS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-31T15:00:00.000Z">2023-06-01</time></p><p class="title"><a href="/2023/05/31/2023-06-01-fix-no-space-left-on-device-when-pip-install/">fix: Could not install packages due to an EnvironmentError: [Errno 28] No space left on device</a></p><p class="categories"><a href="/categories/RaspberryPI/">RaspberryPI</a></p></div></article></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">タグ</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/htaccess/"><span class="tag">.htaccess</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ALB/"><span class="tag">ALB</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AWS/"><span class="tag">AWS</span><span class="tag">43</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AntiVirus/"><span class="tag">AntiVirus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apache/"><span class="tag">Apache</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chef/"><span class="tag">Chef</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CodeBuild/"><span class="tag">CodeBuild</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cookie/"><span class="tag">Cookie</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Corosync/"><span class="tag">Corosync</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Datadog/"><span class="tag">Datadog</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECR/"><span class="tag">ECR</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECS/"><span class="tag">ECS</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElastiCache/"><span class="tag">ElastiCache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Elasticsearch/"><span class="tag">Elasticsearch</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Email/"><span class="tag">Email</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FTPS/"><span class="tag">FTPS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fluentd/"><span class="tag">Fluentd</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GKE/"><span class="tag">GKE</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GitHub-Actions/"><span class="tag">GitHub Actions</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag">24</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GooglePlay/"><span class="tag">GooglePlay</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hubot/"><span class="tag">Hubot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jenkins/"><span class="tag">Jenkins</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kibana/"><span class="tag">Kibana</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LINE-Notify/"><span class="tag">LINE Notify</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Lambda/"><span class="tag">Lambda</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Let-s-encrypt/"><span class="tag">Let&#039;s encrypt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MachineLearning/"><span class="tag">MachineLearning</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Monitoring/"><span class="tag">Monitoring</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenSSL/"><span class="tag">OpenSSL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Outlook/"><span class="tag">Outlook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP/"><span class="tag">PHP</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pacemaker/"><span class="tag">Pacemaker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ProxySQL/"><span class="tag">ProxySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Puppeteer/"><span class="tag">Puppeteer</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rails/"><span class="tag">Rails</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RaspberryPI/"><span class="tag">RaspberryPI</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reactio/"><span class="tag">Reactio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ruby/"><span class="tag">Ruby</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/S3/"><span class="tag">S3</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSL/"><span class="tag">SSL</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Security/"><span class="tag">Security</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SendGrid/"><span class="tag">SendGrid</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Slack/"><span class="tag">Slack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SonarQube/"><span class="tag">SonarQube</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/StatsBot/"><span class="tag">StatsBot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Terraform/"><span class="tag">Terraform</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Twilio/"><span class="tag">Twilio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Unity/"><span class="tag">Unity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vagrant/"><span class="tag">Vagrant</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vault/"><span class="tag">Vault</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WAF/"><span class="tag">WAF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zabbix/"><span class="tag">Zabbix</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/awk/"><span class="tag">awk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/casperjs/"><span class="tag">casperjs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu/"><span class="tag">cpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/csv/"><span class="tag">csv</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flask/"><span class="tag">flask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/i-node/"><span class="tag">i-node</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iftop/"><span class="tag">iftop</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ipinfo/"><span class="tag">ipinfo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iptable/"><span class="tag">iptable</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kibana/"><span class="tag">kibana</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macos/"><span class="tag">macos</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/no-ip/"><span class="tag">no-ip</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ping/"><span class="tag">ping</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pip/"><span class="tag">pip</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reCAPTCHA/"><span class="tag">reCAPTCHA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sftp/"><span class="tag">sftp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spam/"><span class="tag">spam</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vim/"><span class="tag">vim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wget/"><span class="tag">wget</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/yum/"><span class="tag">yum</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zsh/"><span class="tag">zsh</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">更新を購読する</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="購読する"></div></div></form></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">広告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6265337967545472" data-ad-slot="9975280607" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Kenzo Tanaka</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("ja");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="トップに戻る" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="何かを入力してください..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"何かを入力してください...","untitled":"(無題)","posts":"投稿","pages":"ページ","categories":"カテゴリ","tags":"タグ"});
        });</script></body></html>