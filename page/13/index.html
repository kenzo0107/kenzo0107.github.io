<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>長生村本郷Engineers&#039;Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="長生村本郷Engineers&#039;Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="長生村本郷Engineers&#039;Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="tech"><meta property="og:type" content="blog"><meta property="og:title" content="長生村本郷Engineers&#039;Blog"><meta property="og:url" content="https://kenzo0107.github.io/"><meta property="og:site_name" content="長生村本郷Engineers&#039;Blog"><meta property="og:description" content="tech"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://kenzo0107.github.io/img/og_image.png"><meta property="article:author" content="Kenzo Tanaka"><meta property="article:tag" content="aws golang"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://kenzo0107.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kenzo0107.github.io"},"headline":"長生村本郷Engineers'Blog","image":["https://kenzo0107.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Kenzo Tanaka"},"publisher":{"@type":"Organization","name":"長生村本郷Engineers'Blog","logo":{"@type":"ImageObject","url":"https://kenzo0107.github.io/img/logo.svg"}},"description":"tech"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-162026478-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-162026478-1');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><script data-ad-client="ca-pub-6265337967545472" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="長生村本郷Engineers'Blog" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/2013/12/31/PrivacyPolicy/">PrivacyPolicy</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="navbar-item search" title="検索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/01/09/2018-01-10-update-datadog-and-try-loggin-feature/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180110/20180110145104.png" alt="Datadog Agent 6系にアップデートして Logging 機能を試す！"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2018-01-10</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/01/09/2018-01-10-update-datadog-and-try-loggin-feature/">Datadog Agent 6系にアップデートして Logging 機能を試す！</a></h1><div class="content"><p>Datadog Agent 6 系にアップデートして Logging 機能を試す！</p>
<p>2017 年末に β 版ですが、Datadog の Log 可視化ツールの利用が発表されました。</p>
<ul>
<li>Unifying the views でグラフの高負荷時刻付近のログを参照する機能があったり</li>
<li>Elasticsearch+Fluentd の代替として期待できそう</li>
</ul>
<p>と思い早速導入してみました。</p>
<h2><span id="datadog-agent-インストール方法">datadog-agent インストール方法</span></h2><p>2018 年 1 月 10 日時点では 5 系がインストールされます。</p>
<h2><span id="5-系-6-系とで主に変わった点">5 系、6 系とで主に変わった点</span></h2><ul>
<li>Datadog 設定ファイルパス変更</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th><em>5 系</em></th>
<th><em>6 系</em></th>
</tr>
</thead>
<tbody><tr>
<td>ベースディレクトリ</td>
<td>/etc/dd-agent</td>
<td>/etc/datadog-agent</td>
</tr>
<tr>
<td>各種設定ファイル</td>
<td>/etc/dd-agent/conf.d/nginx.yaml</td>
<td>/etc/dd-agent/conf.d/nginx.d/conf.yaml</td>
</tr>
<tr>
<td>メトリクス情報</td>
<td>dd-agent info</td>
<td>datadog-agent status</td>
</tr>
</tbody></table>
<p>6 系では dd-agent コマンドがありませんでした。</p>
<ul>
<li>dd-agent configcheck に該当するコマンドが見当たらない？<br>どこにあるのか教えてください(;&gt;_&lt;)</li>
</ul>
<h2><span id="5-系からのアップグレード方法">5 系からのアップグレード方法</span></h2><p><a target="_blank" rel="noopener" href="https://github.com/DataDog/datadog-agent/blob/master/docs/beta.md">https://github.com/DataDog/datadog-agent/blob/master/docs/beta.md</a></p>
<p>自身の環境は Ubuntu 16.04.2 LTS だったので以下方法でアップグレードしました。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ DD_UPGRADE=<span class="literal">true</span> bash -c <span class="string">&quot;<span class="subst">$(curl -L https://raw.githubusercontent.com/DataDog/datadog-agent/master/cmd/agent/install_script.sh)</span>&quot;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Error: /etc/datadog-agent/datadog.yaml seems to contain a valid configuration, run the <span class="built_in">command</span> again with --force or -f to overwrite it</span><br><span class="line">Automatic import failed, you can still try to manually run: datadog-agent import /etc/dd-agent /etc/datadog-agent</span><br></pre></td></tr></table></figure>

<p>Error と出るので一瞬ハッとしましたが、Error Message をよく見ると<br>6 系の <code>/etc/datadog-agent/datadog.yaml</code> は問題ない設定となっている様に見えますが、上書きしたい場合は –force を使ってね、<br>とあります。</p>
<p>datadog-agent のアップグレードは無事完了していました。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo datadog-agent status</span><br><span class="line"></span><br><span class="line">Getting the status from the agent.</span><br><span class="line"></span><br><span class="line">===================</span><br><span class="line">Agent (v6.0.0-rc.2)</span><br><span class="line">===================</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>また各種設定(/etc/datadog-agent/conf.d, checks.d)ファイルも問題なく移行できていました。</p>
<h2><span id="5-系の設定ファイルを-6-系へオーバーライド">5 系の設定ファイルを 6 系へオーバーライド</span></h2><p>特に上記の手法で問題ないですが強制的にオーバーライドする方法を明記しておきます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// /etc/dd-agent/conf.d 以下のファイルを 6系へ移行</span><br><span class="line">$ /opt/datadog-agent/bin/agent/agent import /etc/dd-agent /etc/datadog-agent --force</span><br><span class="line"></span><br><span class="line">Success: imported the contents of /etc/dd-agent/datadog.conf into /etc/datadog-agent/datadog.yaml</span><br><span class="line">Copied conf.d/http_check.yaml over the new http_check.d directory</span><br><span class="line">Copied conf.d/network.yaml over the new network.d directory</span><br><span class="line">Copied conf.d/nginx.yaml over the new nginx.d directory</span><br><span class="line">Copied conf.d/process.yaml over the new process.d directory</span><br><span class="line">Copied conf.d/process_check.yaml over the new process_check.d directory</span><br><span class="line">Copied conf.d/ssl_check_expire_days.yaml over the new ssl_check_expire_days.d directory</span><br><span class="line">Copied conf.d/unicorn_check.yaml over the new unicorn_check.d directory</span><br><span class="line">Error: unable to list auto_conf files from /etc/dd-agent: open /etc/dd-agent/conf.d/auto_conf: no such file or directory</span><br><span class="line"></span><br><span class="line">// /etc/dd-agent/checks.d/ 以下のファイルを 6系へ移行</span><br><span class="line">$ sudo -u dd-agent -- <span class="built_in">cp</span> /etc/dd-agent/checks.d/*.py /etc/datadog-agent/checks.d/</span><br></pre></td></tr></table></figure>

<h2><span id="nginx-log-を-logging-へ送付">nginx log を Logging へ送付</span></h2><ul>
<li><code>/etc/datadog-agent/conf.d/nginx.d/conf.yaml</code></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init_config:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nginx_status_url:</span> <span class="string">http://localhost/nginx_status/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">hogehoge</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/nginx/access.log</span></span><br><span class="line">    <span class="attr">source:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">sourcecategory:</span> <span class="string">nginx_access</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">hogehoge</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/nginx/error.log</span></span><br><span class="line">    <span class="attr">source:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">sourcecategory:</span> <span class="string">nginx_error</span></span><br></pre></td></tr></table></figure>

<p>基本的に logs ディレクティブを記述することで OK</p>
<ul>
<li><code>/etc/datadog-agent/conf.d/fluentd.d/conf.yaml</code></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init_config:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">monitor_agent_url:</span> <span class="string">http://localhost:24220/api/plugins.json</span></span><br><span class="line">    <span class="attr">tag_by:</span> <span class="string">type</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">hogehoge</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/td-agent/td-agent.log</span></span><br><span class="line">    <span class="attr">source:</span> <span class="string">td-agent</span></span><br><span class="line">    <span class="attr">sourcecategory:</span> <span class="string">td-agent</span></span><br></pre></td></tr></table></figure>

<h2><span id="datadogconf-修正">datadog.conf 修正</span></h2><p><code>/etc/datadog-agent/datadog.yaml</code> に以下設定を加えます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_enabled: true</span><br></pre></td></tr></table></figure>

<h2><span id="設定反映">設定反映</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl restart datadog-agent</span><br></pre></td></tr></table></figure>

<h2><span id="うまく-datadog-に反映されないときは">うまく Datadog に反映されないときは</span></h2><p>ログを見てみます。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tail -f /var/log/datadog/agent.log</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">2018-01-07 11:01:58 JST | INFO | (logs-agent.go:75 in func1) | open /var/log/nginx/access.log: permission denied</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>パーミッションエラーが発生しており<br><code>datadog-agent</code> を起動している <code>dd-agent</code> ユーザからアクセスできない状態となっていました。</p>
<h3><span id="対処">対処</span></h3><p>単純に <code>/var/log/nginx/access.log</code> に 0644 (-rw-r–r–) を付与するだけでなく、<br>logrotate で生成される新たな log のパーミッションにも注意します。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/var/log/nginx/*.log &#123;</span><br><span class="line">        daily</span><br><span class="line">        missingok</span><br><span class="line">        rotate 14</span><br><span class="line">        compress</span><br><span class="line">        delaycompress</span><br><span class="line">        notifempty</span><br><span class="line">        create 0644 www-data adm</span><br><span class="line">        sharedscripts</span><br><span class="line">        prerotate</span><br><span class="line">                if [ -d /etc/logrotate.d/httpd-prerotate ]; then \</span><br><span class="line">                        run-parts /etc/logrotate.d/httpd-prerotate; \</span><br><span class="line">                fi \</span><br><span class="line">        endscript</span><br><span class="line">        postrotate</span><br><span class="line">                invoke-rc.d nginx rotate &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">        endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>元々 0640 でしたが 0644 で生成するようにしました。<br>これにて解決 ♪</p>
<h2><span id="datadog-logging-で確認">Datadog Logging で確認</span></h2><p>ログが流れてくるのを確認できました。<br>Kibana の Discover ページのような作りです。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180110/20180110155520.png" width="100%">
</div>

<p>今後フィルタリングしてグラフを作ったりできたりしてくるのか、<br>Pro 版なら無料で使わせてもらえないかな、<br>なんて期待が高まっております</p>
<p>お願い、Datadog さん(-人-)</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/12/22/2017-12-23-monitoring-rails-unicorn-by-datadog-using-mackerel/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171223/20171223193555.png" alt="Datadog で Rails Unicorn の Memory, Idle|Busy Worker 監視 〜呉越同舟〜"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-12-23</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/12/22/2017-12-23-monitoring-rails-unicorn-by-datadog-using-mackerel/">Datadog で Rails Unicorn の Memory, Idle|Busy Worker 監視 〜呉越同舟〜</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Rails の乗っているホストへ Datadog で Unicorn を監視しようとした所、<br>それらしい Integration がありません((あったら教えてください &gt;_&lt; ))。</p>
<p>ということで独自スクリプトを作成しようと思いました！</p>
<h2><span id="独自スクリプトを書こうとしてたら">独自スクリプトを書こうとしてたら…</span></h2><p>同僚「Mackerel なら plugin ありますよ？」</p>
<p>自分「えっ？…」</p>
<h2><span id="mackerel-入ってる">Mackerel 入ってる</span></h2><p>Mackerel に unicorn 監視用の plugin がありました。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mackerelio/mackerel-agent-plugins/tree/master/mackerel-plugin-unicorn">mackerel-plugin-unicorn</a></p>
<p>はてなさんも OSS で出して頂いている、<br>車輪の再開発は時間の無駄、<br>人生は一度しかないのでこの Mackerel プラグインを Datadog で使わせて頂こうと思いました。</p>
<h2><span id="mackerel-datadog-呉越同舟スクリプト">Mackerel + Datadog 呉越同舟スクリプト</span></h2><ul>
<li>/etc/dd-agent/unicorn_check.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> checks <span class="keyword">import</span> AgentCheck</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UnicornCheck</span>(<span class="title class_ inherited__">AgentCheck</span>):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">self, instance</span>):</span><br><span class="line">    pidfile = instance[<span class="string">&#x27;pidfile&#x27;</span>]</span><br><span class="line">    cmd = <span class="string">&quot;/usr/bin/mackerel-plugin-unicorn -pidfile=%s&quot;</span> % (pidfile)</span><br><span class="line"></span><br><span class="line">    res = self.exeCmdWithStripLF(cmd)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">        y = re.split(<span class="string">r&#x27;\t+&#x27;</span>, r.rstrip(<span class="string">&#x27;\t&#x27;</span>))</span><br><span class="line">        metrics = y[<span class="number">0</span>]</span><br><span class="line">        out     = y[<span class="number">1</span>]</span><br><span class="line">        self.gauge(metrics, out)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># コマンド実行結果から改行コードから取り除く</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">exeCmdWithStripLF</span>(<span class="params">self, cmd</span>):</span><br><span class="line">    res = self.exeCmd(cmd)</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">str</span>(x).rstrip(<span class="string">&quot;\n&quot;</span>) <span class="keyword">for</span> x <span class="keyword">in</span> res]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># コマンド実行</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">exeCmd</span>(<span class="params">self, cmd</span>):</span><br><span class="line">    <span class="keyword">return</span> subprocess.Popen(</span><br><span class="line">      cmd,</span><br><span class="line">      stdout=subprocess.PIPE,</span><br><span class="line">      shell=<span class="literal">True</span></span><br><span class="line">    ).stdout.readlines()</span><br></pre></td></tr></table></figure>

<ul>
<li>/etc/dd-agent/conf.d/unicorn_check.yaml</li>
</ul>
<p>Unicorn の PID ファイルを指定します。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init_config:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pidfile:</span> <span class="string">/path/to/rails_project/shared/tmp/pids/unicorn.pid</span></span><br></pre></td></tr></table></figure>

<h2><span id="datadog-agent-設定ファイルチェック">Datadog Agent 設定ファイルチェック</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dd-agent configcheck</span><br><span class="line"></span><br><span class="line">unicorn_check.yaml is valid</span><br></pre></td></tr></table></figure>

<h2><span id="datadog-agent-再起動">Datadog Agent 再起動</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service datadog-agent restart</span><br></pre></td></tr></table></figure>

<h2><span id="数分後グラフを見てみる">数分後グラフを見てみる</span></h2><p>出てきた！</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171223/20171223203723.png" width="100%">
</div>

<h2><span id="総評">総評</span></h2><p>これで呉越同舟型モニタリングができました！</p>
<p>自分自身が呉でも越でもない所に若干の背徳感がありますが<br>手っ取り早く舟をこしらえたことに本記事の意味があるかと<br>筆を取りました。</p>
<p>参考になれば幸いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/12/04/2017-12-05-terraform-workspace-tfsate/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171205/20171205214728.jpg" alt="terraform workspace で環境毎に tfsate 管理"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-12-05</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/12/04/2017-12-05-terraform-workspace-tfsate/">terraform workspace で環境毎に tfsate 管理</a></h1><div class="content"><p>terraform workspace で環境毎に tfsate 管理した話です。</p>
<h2><span id="追記-20190417">追記 2019/04/17</span></h2><p>追記時点で workspace は運用時点の問題が多くあった為、利用していません。以下記事ご参考いただければと思います。</p>


<h2><span id="概要">概要</span></h2><p>Terraform tfstate の管理をかつて<br>0.8 系では <code>-backend-config</code> でせっせと環境(stg,prod) 毎に bucket を変えて、<br>なんてコードを見てきました。</p>
<p>ですが、<br>workspace で 1 つの bucket に 環境毎に保管できる様になりました。</p>
<p>厳密には環境毎でなくとも<br>リソースの集合毎、module 毎等で管理するイメージですが</p>
<p>今回はイメージを捉えやすく環境毎で分けました。</p>
<h2><span id="歴史">歴史</span></h2><ul>
<li>0.5 で S3 で管理、</li>
<li>&lt; 0.9 では、 remote config で管理場所を設定</li>
<li><blockquote>
<p>= 0.9 では、terraform workspace で同一ディレクトリで複数のリソース群を管理</p>
</blockquote>
</li>
</ul>
<p>とより利用しやすくなりました。</p>
<h2><span id="前提">前提</span></h2><p>以下条件とします。</p>
<ul>
<li>tfstate は backend.tf で s3 管理</li>
</ul>
<h2><span id="移行手順">移行手順</span></h2><h3><span id="既存-terraform-で-tfstate-確認">既存 terraform で tfstate 確認</span></h3><ul>
<li>想定の実行計画通りか確認します。</li>
<li>異なる場合は、そもそも現環境と差分が生じている、及び、tfstate が正しく取得できていない等、問題ありなのでそちらを修正します。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br></pre></td></tr></table></figure>

<h3><span id="tfstate-ファイル取得">tfstate ファイル取得</span></h3><p>local に terraform.tfstate を取得します。<br>中身を確認してリソースの設定がある程度問題ないか確認しておきます。</p>
<ul>
<li>0.8 系</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ terraform remote config \</span><br><span class="line">-backend=s3 \</span><br><span class="line">-backend-config=&quot;bucket=tfstate.bucket&quot; \</span><br><span class="line">-backend-config=&quot;key=terraform.tfstate&quot; \</span><br><span class="line">-backend-config=&quot;region=ap-northeast-1&quot; \</span><br><span class="line">-backend-config=&quot;profile=aws-hogehoge&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>0.9 系以降</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ terraform state pull &gt; terraform.tfstate</span><br></pre></td></tr></table></figure>

<h3><span id="terraform-011x-2017-年-12-月現在最新-へバージョンアップ">terraform 0.11.x (2017 年 12 月現在最新) へバージョンアップ</span></h3><p>Homebrew ならば upgrade で！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ brew upgrade terraform</span><br></pre></td></tr></table></figure>

<h3><span id="state-管理を-backenttf-で記述">state 管理を backent.tf で記述</span></h3><p>既にこの様に設定されている方はスキップです。特に普遍的な書き方です。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  backend &quot;s3&quot; &#123;</span><br><span class="line">      bucket  = &quot;tfstate.bucket&quot;</span><br><span class="line">      key        = &quot;terraform.tfstate&quot;</span><br><span class="line">      region   = &quot;ap-northeast-1&quot;</span><br><span class="line">      encrypt = true</span><br><span class="line">      profile   = &quot;aws-hogehoge&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="workspace-作成">Workspace 作成</span></h2><ul>
<li>Workspace <code>stg</code> 作成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace new stg</span><br></pre></td></tr></table></figure>

<ul>
<li>workspace リスト一覧</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace list</span><br><span class="line">  default</span><br><span class="line">* stg</span><br></pre></td></tr></table></figure>

<h2><span id="tfstate-を-push">tfstate を push</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state push -force .terraform/terraform.tfstate</span><br></pre></td></tr></table></figure>

<p>これで S3 <code>tfstate.bucket</code> の <code>env:/stg/</code> ディレクトリ以下に terraform.tfstate が push されました。<br>実際に S3 を見て確認してみてください。</p>
<p><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171205/20171205213108.png"></p>
<p><code>env</code> でなく <code>env:</code> なのが肝です。</p>
<h2><span id="実行計画確認">実行計画確認</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br></pre></td></tr></table></figure>

<p>想定の実行計画通りか確認して問題なければ移行完了です。</p>
<h2><span id="おまけ">おまけ</span></h2><p>terraform を指定したバージョンで実行するには<br>one-off Container で実行できる様に Makefile でラップする、<br>が今の所自分の中のベストプラクティスです。</p>
<p>これによって local 環境に依存せず指定したバージョンの terraform 実行が可能となります。</p>
<h4><span id="one-off-container-とは">one-off Container とは</span></h4><p>one-off Container は Docker コンテナを <code>run --rm</code> で 1 度のコマンド実行の為だけに起動する手法です。</p>
<p>Makefile で Docker コマンドをラップしておくと<br><code>TERRAFORM_VERSION</code> を変更するだけで<br>指定の terraform バージョンを利用できます。</p>
<p>以下は 0.11.1 の例です。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">TERRAFORM_VERSION=0.11.1</span><br><span class="line"></span><br><span class="line">DOCKER=docker run --rm -v ~/.ssh:/root/.ssh:ro -v ~/.aws:/root/.aws:ro -v $&#123;PWD&#125;:/work -w /work hashicorp/terraform:$&#123;TERRAFORM_VERSION&#125;</span><br><span class="line"></span><br><span class="line">$(eval ENV := $(shell $&#123;DOCKER&#125; workspace show))</span><br><span class="line"></span><br><span class="line">ifeq ($&#123;ENV&#125;, default)</span><br><span class="line">$(error select workspace ! ex: make init ENV=&lt;stg|prod&gt;)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">default: init</span><br><span class="line"></span><br><span class="line">init:</span><br><span class="line">	# tfstate ファイル初期化</span><br><span class="line">	$&#123;DOCKER&#125; init</span><br><span class="line">	# workspace 作成. &quot;; true&quot; は既に作成済みエラーをスキップする為</span><br><span class="line">	$&#123;DOCKER&#125; workspace new $&#123;ENV&#125;; true</span><br><span class="line">	# 作成した workspace を選択</span><br><span class="line">	$&#123;DOCKER&#125; workspace select $&#123;ENV&#125;</span><br><span class="line">	# 作成した workspace の tfstate ファイルを同期</span><br><span class="line">	$&#123;DOCKER&#125; init</span><br><span class="line"></span><br><span class="line">plan:</span><br><span class="line">	$&#123;DOCKER&#125; plan</span><br><span class="line"></span><br><span class="line">apply</span><br><span class="line">	$&#123;DOCKER&#125; apply -auto-approve</span><br></pre></td></tr></table></figure>

<ul>
<li><code>make init ENV=stg</code> 実行で以下まとめてました<ul>
<li>tfstate 初期化</li>
<li>workspace <code>stg</code> 作成</li>
<li>選択した workspace の tfstate で初期化</li>
</ul>
</li>
</ul>
<p>きっとさらに素敵なベストプラクティスがあれば教えてください！</p>
<p>参考になれば幸いです。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-11-23</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/22/2017-11-23-slack-dm-pullrequest-or-issue-comment-by-Hubot/">Hubot で Git の Pull Request や Issue のコメントのメンション相手に Slack DM で通知</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Git での Pull Request や Issue コメントのメンションがメール通知で気づけず困った！<br>という声を多く聞き、メンション相手に Slack DM を通知する様な仕組みを作りました。</p>
<h2><span id="システム概要">システム概要</span></h2><p>今回は AWS 上に構築しました。</p>
<ul>
<li>Git は GHE on EC2<ul>
<li>github.com の場合だと、IP 定まらない問題があるかと思うので、動的に IP を取得して解放させる様な仕組みを入れる必要がありそう。</li>
</ul>
</li>
<li>hubot は t2.nano と最小<ul>
<li>当初、IBM Bluemix で構築してみましたが、サポートから IP 制限はまだできていない、とのことなので on AWS にしました。</li>
</ul>
</li>
<li>GHE からの hubot の受け口は ELB で EIP のみ許可させてます。<ul>
<li>今後、受け口を色々作る目的で ELB 立てました。</li>
<li>元々は JIRA のメンションを Slack DM に送るだけの目的だったので 同一 Private Subnet に置いてました。</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/lAlhMpW.png"></p>
<h2><span id="スクリプト">スクリプト</span></h2><ul>
<li>getSlackUsernameByGitUsername<ul>
<li>基本 git name と slack name は命名規則が統一されていたので正規表現で変換させる様に解決しています。</li>
<li>git name: kenzo-tanaka だったら slack name: kenzo.tanaka に変換</li>
<li>命名規則に即していないユーザは以下の <code>users</code> リストに変換を任せます。<ul>
<li><code>kimika.himura</code> は DM 送られたくないと言う人を想定してます。</li>
</ul>
</li>
</ul>
</li>
<li>依存ライブラリ<ul>
<li>  “hubot-slack”: “^4.4.0”</li>
<li>  “hubot-slack-attachement”: “^1.0.1”</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">users = &#123;</span><br><span class="line">    &quot;kenzo-tanaka&quot;: &quot;kenzo0107&quot;,</span><br><span class="line">    &quot;kimika.himura&quot;: &quot;no_send&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ソース全容は以下になります。</p>
<script src="//gist.github.com/kenzo0107/d9f3618633d0243453bae7ab5ef5a1dd.js"></script>


<h2><span id="git-設定">Git 設定</span></h2><p>設定したい Organization or Owner &gt; Settings &gt; Hooks で hubot への URL を設定します。((Organization 跨いで一気に全部のリポジトリにHookかけるのは別途スクリプト組むなりしないと難しそう。GitHub社も Organization は 1つとすることを推奨とのことなので今回はこれで！))</p>
<p>その他設定</p>
<ul>
<li>Content type: <code>application/json</code></li>
<li>Let me select individual events:<ul>
<li>Issues</li>
<li>Issue comment</li>
<li>Pull request</li>
<li>Pull request review</li>
<li>Pull request review comment</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/6lBkFAL.png"></p>
<p>※ よりセキュアにする際には Secret 設定してください。</p>
<h2><span id="通知が来た">通知が来た！</span></h2><p>早速 Pull Request でメンションしてみたら通知が来ました！<br>絵文字もしっかり！<br>URL も自動でリンクされている！</p>
<p><img src="https://i.imgur.com/5sxmFVO.png"></p>
<p>以上、参考になれば幸いです♪</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/11/12/2017-11-13-prometheus-remote-storage/"><img class="fill" src="https://i.imgur.com/zFciewX.png" alt="Prometheus2.0 remote storage 検証"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-11-13</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/12/2017-11-13-prometheus-remote-storage/">Prometheus2.0 remote storage 検証</a></h1><div class="content"><p>いよいよ出ました Prometheus 2.0 ！</p>
<p><a target="_blank" rel="noopener" href="https://prometheus.io/blog/2017/11/08/announcing-prometheus-2-0/">Announcing Prometheus 2.0 | Prometheus</a></p>
<p>先日<a target="_blank" rel="noopener" href="https://mackerel-ug.connpass.com/event/68478/">モニタリング勉強会</a>でも Paul Taylor さんの LT を拝聴させて頂き<br>パフォーマンス向上とストレージフォーマット変更による圧縮・バックアップがしやすくなった等、<br>良い話がたくさん出ていました。</p>
<p><a target="_blank" rel="noopener" href="https://www.slideshare.net/PaulTraylor/20171027-81281205">Operating Prometheus</a></p>
<p>中でも最も期待していた機能が Remote Long-Term Storage、<br>長期保存機能には歓喜しました ♪</p>
<p>1 系以下では、短期間用と長期間用の Prometheus を別途用意する等、対策が必要で<br>冗長な作りを余儀なくされたところがありましたが<br>2.0 リリースでついに！</p>
<p>早速試してみたく使用感をまとめました。</p>
<h2><span id="今回やりたかったことまとめ">今回やりたかったことまとめ</span></h2><ul>
<li>Prometheus 2.0 リリースに際して期待の長期保存機能 (Remote long-term storage) を早速試す！</li>
<li>実際にローカル環境で構築してみて 1 系からの変更箇所を確認</li>
<li>DB 側にどんなデータが入るのか確認</li>
</ul>
<h2><span id="システム概要">システム概要</span></h2><p>あくまで使用感の検証をしたかったので docker-compose でお手軽に作れる環境にしました。</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/zFciewX.png" width="100%">
</div>

<h2><span id="前提条件">前提条件</span></h2><p>以下を Vagrant にインストール</p>
<ul>
<li>Ubuntu 16.04.3 LTS \n \l</li>
<li>Docker version 17.09.0-ce, build afdb6d4</li>
<li>docker-compose version 1.12.0, build b31ff33</li>
</ul>
<h2><span id="起動する-docker-container">起動する Docker Container</span></h2><ul>
<li>Prometheus 2.0.0</li>
<li>Node Exporter 0.15.1</li>
<li>AlertManager 0.9.1</li>
<li>cAdvisor 0.28.0</li>
<li>Prometheu Adapter</li>
<li>PostgreSQL 9.6.3</li>
<li>Grafana 4.6.1</li>
<li>Nginx 1.13.6</li>
<li>Adminer</li>
</ul>
<h2><span id="使い方">使い方</span></h2><p>以下手順通りです。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kenzo0107/vagrant-docker/tree/vagrant-docker-ubuntu16.04/docker/prometheus-grafana-on-ubuntu">kenzo0107/vagrant-docker/tree/vagrant-docker-ubuntu16.04/docker/prometheus-grafana-on-ubuntu</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/vagrant-docker</span><br><span class="line">macOS%$ <span class="built_in">cd</span> vagrant-docker</span><br><span class="line">macOS%$ vagrant up</span><br><span class="line"></span><br><span class="line">// Install docker, docker-compose</span><br><span class="line">macOS%$ vagrant provision</span><br><span class="line">macOS%$ vagrant ssh</span><br><span class="line">vagrant%$ <span class="built_in">cd</span> /vagrant/prometheus-grafana-on-ubuntu</span><br><span class="line">vagrant%$ sudo docker-compose up -d</span><br><span class="line"></span><br><span class="line">Name                             Command                            State                             Ports</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">adapter                           /prometheus-postgresql-ada ...    Up</span><br><span class="line">adminer                           entrypoint.sh docker-php-e ...    Up                                8080/tcp</span><br><span class="line">alertmanager                      /bin/alertmanager -config. ...    Up                                9093/tcp</span><br><span class="line">cadvisor                          /usr/bin/cadvisor -logtost ...    Up                                8080/tcp</span><br><span class="line">grafana                           /run.sh                           Up                                3000/tcp</span><br><span class="line">nginx                             nginx -g daemon off;              Up                                0.0.0.0:18080-&gt;18080/tcp,</span><br><span class="line">                                                                                         0.0.0.0:3000-&gt;3000/tcp, 80/tcp,</span><br><span class="line">                                                                                         0.0.0.0:8080-&gt;8080/tcp,</span><br><span class="line">                                                                                         0.0.0.0:9090-&gt;9090/tcp</span><br><span class="line">node-exporter                     /bin/node_exporter                Up                                9100/tcp</span><br><span class="line">pgsql                             docker-entrypoint.sh -csyn ...    Up                                5432/tcp</span><br><span class="line">prometheus                        /bin/prometheus --config.f ...    Up                                9090/tcp</span><br></pre></td></tr></table></figure>

<h2><span id="アクセスしてみる">アクセスしてみる</span></h2><h3><span id="prometheus">Prometheus</span></h3><ul>
<li><a target="_blank" rel="noopener" href="http://192.168.35.101:9090/">http://192.168.35.101:9090</a>.</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/rg53Xa1.png" width="100%">
</div>

<h3><span id="grafana">Grafana</span></h3><ul>
<li><a target="_blank" rel="noopener" href="http://192.168.35.101:13000/">http://192.168.35.101:13000</a>.</li>
<li>ユーザアカウントが <code>./grafana/env</code> にあります.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GF_SECURITY_ADMIN_USER=admin-user</span><br><span class="line">GF_SECURITY_ADMIN_PASSWORD=admin-pass</span><br></pre></td></tr></table></figure>

<div style="text-align:center;">
<img src="https://i.imgur.com/fDXVySw.png" width="100%">
</div>

<ul>
<li>Datasource 設定</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/8SKvdxJ.png" width="100%">
</div>

<p>Datasource 設定フォームに以下情報を入力し <code>Add</code> ボタンをクリックします。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>Prometheus</td>
</tr>
<tr>
<td>Type</td>
<td>Prometheus</td>
</tr>
<tr>
<td>URL</td>
<td><a target="_blank" rel="noopener" href="http://prometheus:9090/">http://prometheus:9090</a></td>
</tr>
<tr>
<td>Access</td>
<td>proxy</td>
</tr>
</tbody></table>
<div style="text-align:center;">
<img src="https://i.imgur.com/6Cr4WTn.png" width="100%">
</div>

<ul>
<li>Dashboard.json インポート</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/cew58vF.png" width="100%">
</div>

<p>グラフが表示されます。</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/IicXL5e.png" width="100%">
</div>

<h3><span id="cadvisor">cAdvisor</span></h3><ul>
<li><a target="_blank" rel="noopener" href="http://192.168.35.101:8080/">http://192.168.35.101:8080</a>.</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/ZDH3zmI.png" width="100%">
</div>

<h2><span id="adminer">Adminer</span></h2><div style="text-align:center;">
<img src="https://i.imgur.com/uWT7sDC.png" width="100%">
</div>

<p>ログインフォームに以下情報を入力します。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Server</td>
<td>pgsql</td>
</tr>
<tr>
<td>Username</td>
<td>prometheus</td>
</tr>
<tr>
<td>Password</td>
<td>password</td>
</tr>
<tr>
<td>Database</td>
<td>postgres</td>
</tr>
</tbody></table>
<ul>
<li>PostgreSQL に保存されているメトリクス情報が確認できます。</li>
</ul>
<p>PostgreSQL &gt;&gt; pgsql &gt;&gt; postgres &gt;&gt; prometheus &gt;&gt; Select: metrics</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/cyPrvqC.png" width="100%">
</div>

<h2><span id="alertmanager-でアラート通知してみる">AlertManager でアラート通知してみる</span></h2><p>例として node-exporter を停止</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo docker-compose stop node-exporter</span><br></pre></td></tr></table></figure>

<p><code>./alertmanager/config.yml</code> で設定した Slack Channel にちゃんと通知がきました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171113/20171113021331.png" width="100%">
</div>

<h2><span id="所感">所感</span></h2><ul>
<li><p>2.0 になって設定の仕方が諸々変わり、公式サイトじっくり見る必要あります。</p>
<ul>
<li>と思ったら、早速まとめ出てました！ありがとうございます！<ul>
<li><a target="_blank" rel="noopener" href="https://qiita.com/tkusumi/items/293174826a8a5d47d186">Prometheus 2.0 の変更点と移行</a></li>
</ul>
</li>
</ul>
</li>
<li><p>今回は Prometheus ×1 台構成ですが、2 台以上で冗長化する構成も試してみたい。</p>
</li>
</ul>
<h2><span id="余談">余談</span></h2><ul>
<li>バグなのか google/cadvisor で検出するメトリクスが重複表示されて grafana で絞るのに困りました。<ul>
<li>Issue これ？<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/google/cadvisor/issues/1704">Inconsistent container metrics in prometheus route #1704</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><span id="あとがき">あとがき</span></h2><p>Mackerel の様なマネージドな監視サービスで運用コストを削減する以上に<br>Prometheus をマネージドすれば、さらにトータルコストを抑えられる様になる、<br>と睨んでます。</p>
<p>ですが、Datadog は APM 付きプランも適度なコスト感で提供しておりマネージドサービスの魅力は尚大きいです。</p>
<p>モニタリングの棲み分けをできる様にするにも、<br>選択肢の一つにするにも Prometheus 挑戦しがいがあるのでは？<br>と思っています。</p>
<p>Prometheus、今後さらに広まることを期待しています。</p>
<h2><span id="参考">参考</span></h2><ul>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/2.0/configuration/configuration/">Configuration | Prometheus</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/blob/release-2.0/config/testdata/conf.good.yml">prometheus/config/testdata/conf.good.yml</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-11-08</span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-07T03:41:29.124Z" title="5/7/2020, 3:41:29 AM">2020-05-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/07/2017-11-08-iftop/">iftop でネットワーク接続状況をリアルタイム監視</a></h1><div class="content"><h2><span id="iftop-概要">iftop 概要</span></h2><p>CLI上で利用できるネットワークの接続状況をリアルモニタリングするツールです。<br>→ ネットワークのボトルネックを特定する為に利用します。</p>
<p>単にネットワークのモニタリングであれば、モニタリングツールで良いですが</p>
<p>具体的にどこ（ドメイン・IP・ポート）にどれくらい（データ転送量）がわかります。</p>
<h2><span id="インストール方法">インストール方法</span></h2><ul>
<li>Ubuntu</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y iftop</span><br></pre></td></tr></table></figure>

<ul>
<li>CentOS</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum -y install epel-release</span><br><span class="line">$ sudo yum -y install iftop</span><br></pre></td></tr></table></figure>

<h2><span id="使い方">使い方</span></h2><p>よく利用するのはこんな形です。<br>※eth0 がない場合は <code>-i eth0</code> を除いてください。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iftop -i eth0 -B -P -n -N</span><br></pre></td></tr></table></figure>

<ul>
<li>-i インターフェース指定</li>
<li>-B 表示単位を Byte にする</li>
<li>-P プロトコル or ポート表示</li>
<li>-n ドメインでなく ip で表示</li>
<li>-N プロトコルサービス名でなくポート番号で表示</li>
</ul>
<h3><span id="表示項目">表示項目</span></h3><p><code>=&gt;</code> が送信、<br><code>&lt;=</code> が受信です</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">                           24.4kB                      48.8kB                      73.2kB                      97.7kB                 122kB</span><br><span class="line">+--------------------------+---------------------------+---------------------------+---------------------------+---------------------------</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-100-41.ap-northeast-1.compute.internal:62635     559kB   121kB  67.1kB</span><br><span class="line">                                                        &lt;=                                                          3.60kB  1.90kB  1.05kB</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:35244     =&gt; ip-10-13-102-56.ap-northeast-1.compute.internal:mysql       0B   2.18kB  1.21kB</span><br><span class="line">                                                        &lt;=                                                             0B   23.1kB  12.8kB</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:35247     =&gt; ip-10-13-102-56.ap-northeast-1.compute.internal:mysql       0B   2.13kB  1.18kB</span><br><span class="line">                                                        &lt;=                                                             0B   23.0kB  12.8kB</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-0-231.ap-northeast-1.compute.internal:8239         0B   7.73kB  4.29kB</span><br><span class="line">                                                        &lt;=                                                             0B   1.16kB   658B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:ssh       =&gt; ip-10-13-0-11.ap-northeast-1.compute.internal:56320       612B    576B    522B</span><br><span class="line">                                                        &lt;=                                                            26B     26B     32B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-100-41.ap-northeast-1.compute.internal:62657       0B     49B     27B</span><br><span class="line">                                                        &lt;=                                                             0B     92B     51B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:40069     =&gt; ip-10-13-103-247.ap-northeast-1.compute.internal:6379       0B     99B     55B</span><br><span class="line">                                                        &lt;=                                                             0B     34B     19B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:40072     =&gt; ip-10-13-103-247.ap-northeast-1.compute.internal:6379       0B     99B     55B</span><br><span class="line">                                                        &lt;=                                                             0B     34B     19B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-100-73.ap-northeast-1.compute.internal:27698       0B     44B     25B</span><br><span class="line">                                                        &lt;=                                                             0B     33B     18B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:53696     =&gt; ip-10-13-0-2.ap-northeast-1.compute.internal:domain         0B     21B     12B</span><br><span class="line">                                                        &lt;=                                                             0B     31B     17B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:41975     =&gt; ip-10-13-0-2.ap-northeast-1.compute.internal:domain         0B     21B     12B</span><br><span class="line">                                                        &lt;=                                                             0B     31B     17B</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">TX:             cum:   1.31MB   peak:    560kB                                                             rates:    560kB   134kB  74.7kB</span><br><span class="line">RX:                     505kB            117kB                                                                      3.69kB  49.8kB  28.1kB</span><br><span class="line">TOTAL:                 1.81MB            564kB                                                                       564kB   184kB   103kB</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>TX (Transmitter)</td>
<td>送信量</td>
</tr>
<tr>
<td>RX (Receiver)</td>
<td>受信量</td>
</tr>
<tr>
<td>TOTAL</td>
<td>iftop 起動からの総量</td>
</tr>
<tr>
<td>cum</td>
<td>総量</td>
</tr>
<tr>
<td>peak</td>
<td>最大</td>
</tr>
<tr>
<td>右端3列 (各トラフィック, rates含む)</td>
<td>2秒、10秒、40秒の転送量平均値</td>
</tr>
</tbody></table>
<p>※TX,RX の 「X」 は省略しますよという意味</p>
<p>閲覧し続けると気になる処理があった時には<br><code>Shift + P</code> で一旦停止させます。</p>
<p>もう一度開始したい場合は <code>Shift + P</code> です。</p>
<h2><span id="実際のcli">実際のCLI</span></h2><p>以下見ていただくと白い帯グラフが左から伸びているのが見えるかと思います。<br>この横棒が一番上のバーの目盛りに相応してぱっと見でどの程度かわかるのが便利です。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171109/20171109011640.png" width="100%">
</div>

<h2><span id="db-への接続を確かめる">DB への接続を確かめる</span></h2><p>DB (MySQL) のデフォルトポート 3306 への送受信を調べたいとき</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iftop -B -P -n -N -f &quot;port 3306&quot;</span><br></pre></td></tr></table></figure>

<p>当然ながら受信の方が大きいです。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171109/20171109120917.png" width="100%">
</div>

<h2><span id="補足">補足</span></h2><p>実際に負荷が高い時等、特定のインシデントがあった際に追記していこうと思います♪</p>
<h2><span id="reference">Reference</span></h2><ul>
<li><a target="_blank" rel="noopener" href="http://blog.father.gedow.net/2017/10/17/middleware-benchmark/">ミドルウェア性能検証の手引き</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.bitmeister.jp/?p=3930">Linux上でネットワークの帯域制限と遅延を設定する</a></li>
<li><a target="_blank" rel="noopener" href="http://labs.gree.jp/blog/2014/10/11288/">Linux TC (帯域制御、帯域保証) 設定ガイドライン</a></li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/28/2017-10-29-toda-tocochan-bus-flask-on-ibm-bluemix/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171029/20171029095513.png" alt="toda-tocochan-bus flask on IBM Bluemix へ引っ越し"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-10-29</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/28/2017-10-29-toda-tocochan-bus-flask-on-ibm-bluemix/">toda-tocochan-bus flask on IBM Bluemix へ引っ越し</a></h1><div class="content"><p>GCP から IBM Bluemix へ引っ越しました！</p>
<p><a target="_blank" rel="noopener" href="https://toda-tocochan-bus.mybluemix.net/">toco ちゃんバス あと何分？</a></p>
<h2><span id="概要">概要</span></h2><p>さくら VPS から GCP、<br>そして今度は GCP から IBM Bluemix に引越ししました。</p>
<p>以前 GCP 運用時の話はコチラ</p>


<p>GCP は GKE に LB かましたら価格がバコッと上がってしまい<br>無料枠を逸脱してしまいました (&gt;_&lt;)</p>
<p>なんとか低価格で運用したいという目論見です。</p>
<h2><span id="何故-heroku-でなく-ibm-bluemix">何故 Heroku でなく IBM Bluemix ？</span></h2><p>IBM Bluemix の良い所は機能が充実している所です。<br>無料・デフォルトで kibana が見れます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171029/20171029101148.png" width="100%">
</div>

<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171029/20171029101853.png" width="100%">
</div>

<p>その他 Git との連携も可です。</p>
<p>以下 Mac で作業することを前提に手順まとめました。</p>
<h2><span id="事前準備">事前準備</span></h2><ul>
<li>IBM Bluemix に Sign Up しときます</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://console.bluemix.net/registration/">Signup IBM Bluemix</a></p>
<ul>
<li>clone</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/toda-tocochan-bus-on-ibmbluemix</span><br><span class="line">macOS%$ <span class="built_in">cd</span> toda-tocochan-bus-on-ibmbluemix</span><br></pre></td></tr></table></figure>

<ul>
<li>cloudfoundry の CLI インストール</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ brew tap cloudfoundry/tap</span><br><span class="line">macOS%$ brew install cf-cli</span><br></pre></td></tr></table></figure>

<h2><span id="デプロイ">デプロイ</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ cf api https://api.ng.bluemix.net</span><br><span class="line">macOS%$ cf login</span><br><span class="line">macOS%$ cf push &lt;application name&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>API は Region によって変わります。</li>
</ul>
<table>
<thead>
<tr>
<th>Region</th>
<th>API URL</th>
</tr>
</thead>
<tbody><tr>
<td>米国南部</td>
<td><a target="_blank" rel="noopener" href="https://api.ng.bluemix.net/">https://api.ng.bluemix.net</a></td>
</tr>
<tr>
<td>英国</td>
<td><a target="_blank" rel="noopener" href="https://api.eu-gb.bluemix.net/">https://api.eu-gb.bluemix.net</a></td>
</tr>
</tbody></table>
<h2><span id="総評">総評</span></h2><p>Cloudfoundry の CLI のお陰で引っ越しも簡単でした ♪</p>
<p>セキュリティとして特定 IP やドメインからアクセスさせないとか出来たら<br>商用のメソッドとして利用出来そうかなと思いました。</p>
<p>その点質問してみましたが 2 週間ほど連絡がないので再度連絡してみます。<br>↑ 質問は英語限定でした！</p>
<p>サポートが強化されると有難いなと思いました。</p>
<p>以上<br>ご参考になれば幸いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/24/2017-10-25-casperjs-phantomjs-github-organization/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171025/20171025214738.png" alt="CasperJS+PhantomJS で Github Organization 移行"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-10-25</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/24/2017-10-25-casperjs-phantomjs-github-organization/">CasperJS+PhantomJS で Github Organization 移行</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Github Enterprise の Organization 移行を実施した際に CasperJS と PhantomJS でヘッドレスブラウザより操作し移行しました。<br>Github 上で API がない（はず？）為、この様な対応をしました。</p>
<p>どちらかというと CasperJS+PhantomJS でブラウザ上の試験作りを楽しんでいたこともあり<br>試してみてすんなりできたので採用した経緯になります。</p>
<h2><span id="ヘッドレスブラウザとは">ヘッドレスブラウザとは？</span></h2><p>GUI なしのブラウザを CLI で利用するというもの。<br>ページ描画や画像ロード、ログインしたりとフロントの試験で期待される機能を持っています。</p>
<h2><span id="三行まとめ">三行まとめ</span></h2><ul>
<li>CasperJS + PhantomJS でログイン認証はじめブラウザ操作で Transfer する工程を実行</li>
<li>移行後、元の URL が移行先にリダイレクトされるか確認</li>
<li>期待する要素が時間内に取得できないときはページをキャプチャ</li>
</ul>
<h2><span id="やってみる">やってみる</span></h2><p><a target="_blank" rel="noopener" href="https://github.com/kenzo0107/transfer-repository-on-ghe#get-started">Get Started</a> ご参照ください。</p>
<a href="https://github.com/kenzo0107/transfer-repository-on-ghe" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://opengraph.githubassets.com/5445338e00e948d85f03ad518ee8513a3cb8047b837723139e2db15b67b54639/kenzo0107/transfer-repository-on-ghe"></div><div class="descriptions"><div class="og-title">GitHub - kenzo0107/transfer-repository-on-ghe: Transfer repositories to a new owner by using headless browser with CasperJS and PhantomJS.</div><div class="og-description">Transfer repositories to a new owner by using headless browser with CasperJS and PhantomJS. - GitHub - kenzo0107/transfer-repository-on-ghe:…</div></div></div></a>

<p>以下にも手順まとめてます。</p>
<h2><span id="clone">Clone</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/ghe-org-transfer</span><br><span class="line">macOS%$ <span class="built_in">cd</span> ghe-org-transfer</span><br></pre></td></tr></table></figure>

<h2><span id="scriptsghe-org-transferjs-の-ltyour-gt-編集">scripts/ghe-org-transfer.js の &lt;your ****&gt; 編集</span></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">  <span class="comment">// site root.</span></span><br><span class="line">  <span class="attr">siteRoot</span>: <span class="string">&#x27;https://&lt;your github domain&gt;&#x27;</span>,</span><br><span class="line">  <span class="comment">// Github Login path</span></span><br><span class="line">  <span class="attr">loginPath</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">  <span class="comment">// Github Login Account</span></span><br><span class="line">  <span class="attr">loginParams</span>: &#123;</span><br><span class="line">    <span class="attr">email</span>: <span class="string">&#x27;&lt;your email&gt;&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;&lt;your password&gt;&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">viewportSize</span>: &#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="number">3000</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="number">2500</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">paths</span>: [<span class="string">&#x27;&lt;your owner&gt;/&lt;your repository&gt;&#x27;</span>],</span><br><span class="line">  <span class="attr">destOrganization</span>: <span class="string">&#x27;&lt;your destination of organization&gt;&#x27;</span>,</span><br><span class="line">  <span class="attr">reason</span>: <span class="string">&#x27;transfer this repository to new oragnization&#x27;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3><span id="移行イメージ">移行イメージ</span></h3><ul>
<li>ex) hoge/mywonderfulrepo —&gt; moge/mywonderfulrepo</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">paths</span>: [</span><br><span class="line">  <span class="string">&quot;hoge/mywonderfulrepo&quot;</span></span><br><span class="line">],</span><br><span class="line"><span class="attr">destOrganization</span>: <span class="string">&#x27;moge&#x27;</span>,</span><br></pre></td></tr></table></figure>

<p>paths は複数指定しても問題ありません。</p>
<h2><span id="移行実施">移行実施</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ make run</span><br></pre></td></tr></table></figure>

<ul>
<li>実行結果</li>
</ul>
<p>※ 移行後に元の URL でリダイレクトされるか試験しています。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[url] https://github.aiueo.com/hoge/mywonderfulrepo/settings</span><br><span class="line">[step] fill <span class="string">&#x27;#transfer_confirm &gt; form&#x27;</span></span><br><span class="line">[step] input checkbox <span class="comment">#team-59</span></span><br><span class="line">[step] click the button labeled <span class="string">&quot;Transfer&quot;</span></span><br><span class="line">(^-^) redirect ok:https://github.aiueo.co.jp/hoge/mywonderfulrepo to https://github.aiueo.co.jp/moge/mywonderfulrepo</span><br></pre></td></tr></table></figure>

<h2><span id="総評">総評</span></h2><p>以前 Grafana のグラフのスナップショットを撮る Grafana API がうまく動作しなかったのも<br>CasperJS+PhantomJS で取得する様にできました。</p>
<p>いやはや便利 ♪</p>
<p>全然別件ですが、サイトの認証に利用される reCAPTCHA の突破など挑戦してましたがうまく行かず…<br>うまくいったぜ！という方、是非教えてください m(_ _)m</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/07/2017-10-08-waf-cloudfront-referer-check/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005180531.png" alt="WAF+CloudFront でリファラチェック (直リンク禁止)"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-10-08</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/07/2017-10-08-waf-cloudfront-referer-check/">WAF+CloudFront でリファラチェック (直リンク禁止)</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>AWS WAF (Web Application Firewall) を利用し Cloudfront でのリファラ制御を実装しましたのでそのまとめです。</p>
<p>直リンク禁止対策として導入しました。</p>
<p>以下手順になります。</p>
<h3><span id="go-to-aws-waf-ボタンクリック">Go to AWS WAF ボタンクリック</span></h3><p>サービス &gt; WAF &amp; Shield と辿り Go to AWS WAF クリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005174955.png" width="100%">
</div>

<h3><span id="configure-web-acl-ボタンクリック">Configure Web ACL ボタンクリック</span></h3><p>ACL (Access Control List) を設定していきます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005180856.png" width="100%">
</div>

<h3><span id="概要確認">概要確認</span></h3><p>特にチェックせず Next ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181044.png" width="100%">
</div>

<h3><span id="web-acl-設定">web ACL 設定</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181315.png" width="100%">
</div>

<p>以下、設定項目を設定し、Next ボタンクリック</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Web ACL name</td>
<td>(任意) 例では Cloudfront の CNAME を設定しています。</td>
</tr>
<tr>
<td>CloudWatch metric name</td>
<td>Web ACL name を入力すると自動で入力される。変更したい場合のみ変更</td>
</tr>
<tr>
<td>Region</td>
<td>Global(CloudFront) 選択</td>
</tr>
<tr>
<td>AWS resource to associate</td>
<td>対象となる Cloudfront を選択する箇所。運用中の Cloudfront を対象とすると場合は後々設定。</td>
</tr>
</tbody></table>
<h3><span id="条件作成">条件作成</span></h3><p>今回は文字列一致を条件とする為、 String match conditions にて <code>Create condition</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181800.png" width="100%">
</div>

<h3><span id="string-match-condition-作成">string match condition 作成</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181926.png" width="100%">
</div>

<p>以下設定し <code>Add filter</code> ボタンクリック。<br>複数 filter がある場合、Add filter を繰り返します。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>(任意)</td>
</tr>
<tr>
<td>Part of the request to filter on</td>
<td>Header</td>
</tr>
<tr>
<td>Header</td>
<td>Referer</td>
</tr>
<tr>
<td>Match type</td>
<td>Contains</td>
</tr>
<tr>
<td>Transformation</td>
<td>Convert to lowercase</td>
</tr>
<tr>
<td>Value to match</td>
<td>対象となるドメイン設定</td>
</tr>
</tbody></table>
<br>

<h4><span id="add-filter-後-create-ボタンクリック"><code>Add filter</code> 後、 <code>Create</code> ボタンクリック。</span></h4><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182327.png" width="100%">
</div>

<h4><span id="next-ボタンクリック">Next ボタンクリック</span></h4><p>追加したもののすぐに反映されていない。<br>そのまま <code>Next</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182446.png" width="100%">
</div>

<h3><span id="ルール作成">ルール作成</span></h3><p><code>Create rule</code> ボタンクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182608.png" width="100%">
</div>

<h4><span id="ルールに条件を紐付け">ルールに条件を紐付け</span></h4><p>Name, Cloudwatch metric name を設定し<br>Add conditions で条件を追加します。</p>
<p>その後、<code>Create</code> ボタンクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182641.png" width="100%">
</div>

<h3><span id="ルール以外のリクエストのアクセス禁止">ルール以外のリクエストのアクセス禁止</span></h3><p>やはり Rule は反映されていない。ですが、続けて<br><code>Block all requests that don&#39;t match any rules</code> をチェックし <code>Review and create</code> ボタンクリック。</p>
<p>※対象の Cloudfront に反映させたくない場合は、Cloudfront を選択したリソースを解除する必要があります。<br><span style="color: #ff0000">※最後に関連付けができるのでここではするべきではないと思います。</span></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182806.png" width="100%">
</div>

<h3><span id="確認ページで入力内容確認後作成">確認ページで入力内容確認後作成</span></h3><p><code>Confirm and create</code> ボタンクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005183423.png" width="100%">
</div>

<h3><span id="対象の-web-acl-を編集">対象の web ACL を編集</span></h3><p>WEB ACLs より選択し <code>Edit web ACL</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005183628.png" width="100%">
</div>

<h4><span id="web-acl-編集">web ACL 編集</span></h4><ol>
<li>作成したルールを選択</li>
<li><code>Add rule to web ACL</code> ボタンクリック</li>
<li>Allow 選択</li>
<li><code>Update</code> ボタンクリック</li>
</ol>
<p>[f:id:kenzo0107:20171005183720p:plain]</p>
<h3><span id="cloudfront-関連付け">Cloudfront 関連付け</span></h3><p><code>Add association</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005183720.png" width="100%">
</div>

<h4><span id="web-acl-に-cloudfront-を関連付け">Web ACL に Cloudfront を関連付け</span></h4><p>Resource で 対象の Cloudfront を選択し <code>Add</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005184119.png" width="100%">
</div>

<p>以上で数分後 WAF+CloudFront によるリファラチェックが確認できる状態になります。</p>
<h3><span id="アクセス確認">アクセス確認</span></h3><p>自環境では<br>ローカルの /etc/hosts 修正し対象ドメインから Cloudfront CNAME へのリンクを貼って確認しました。</p>
<p>Cloudfront CNAME ドメインでのリソースを直接アクセスすると<br>以下の様な エラーページが表示されることが確認できました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005184505.png" width="100%">
</div>

<h3><span id="もう少しユーザフレンドリーに">もう少しユーザフレンドリーに</span></h3><p>上記のエラーページは Cloudfront &gt; Error Pages で <code>Create Custom Error Response</code> で S3 上のパスを指定することでカスタマイズが可能です。</p>
<p>是非サイトコンセプトに合ったエラーページをご用意されるとよりユーザフレンドリーな配信になるかと思います。</p>
<p>以上<br>ご参考になれば幸いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/01/2017-10-02-elasticsearch-service-version-up/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170924/20170924222936.png" alt="AWS Elasticsearch Service バージョンアップ 2.2 → 5.5"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2017-10-02</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/01/2017-10-02-elasticsearch-service-version-up/">AWS Elasticsearch Service バージョンアップ 2.2 → 5.5</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>AWS Elasticsearch Service (ES) 2.3 → 5.5 へバージョンアップを実施に際して<br>以下記事をまとめました。</p>
<h2><span id="大まかな流れ">大まかな流れ</span></h2><ol>
<li>ES バージョン 2.3 のドメインから Snapshot 取得</li>
<li>ES バージョン 5.5 のドメイン作成</li>
<li>アプリの fluentd の向け先を ES バージョン 5.5 へ変更</li>
<li>ES バージョン 5.5 のドメインにデータリストア</li>
<li>ES バージョン 2.3 のドメイン削除</li>
</ol>
<h2><span id="現状バージョン確認">現状バージョン確認</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;Jackdaw&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;&lt;Account ID&gt;:xxxxxxxxxx&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number&quot;</span> : <span class="string">&quot;2.3.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_hash&quot;</span> : <span class="string">&quot;72aa8010df1a4fc849da359c9c58acba6c4d9518&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_timestamp&quot;</span> : <span class="string">&quot;2016-11-14T15:59:50Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;lucene_version&quot;</span> : <span class="string">&quot;5.5.0&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="その他-aws-console-のクラスターの設定確認">その他、AWS console のクラスターの設定確認</span></h3><p>その他クラスターへ設定している情報をメモ</p>
<ul>
<li>インスタンスタイプ</li>
<li>アクセスポリシーの確認</li>
</ul>
<h1><span id="aws-elasticsearch-service-スナップショットを-s3-で管理する">AWS Elasticsearch Service スナップショットを S3 で管理する</span></h1><h2><span id="iam-role-作成">IAM role 作成</span></h2><ul>
<li>ec2 タイプで作成</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170924/20170924221853.png" width="100%">
</div>

<ul>
<li>アクセス権限は特に設定せず 「次のステップ」ボタンクリック</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925113614.png" width="100%">
</div>

<ul>
<li>ロール名を <b><span style="color: #1464b3">es-index-backups</span></b> とし作成</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925113908.png" width="100%">
</div>

<p>ロール ARN arn:aws:iam::<account id>:role/es-index-backups で作成されていることが確認できる</account></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925114402.png" width="100%">
</div>

<ul>
<li>信頼関係の編集</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925114635.png" width="100%">
</div>

<p>Service を es.amazonaws.com に編集</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;Sid&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Principal&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Service&quot;</span>: <span class="string">&quot;es.amazonaws.com&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;sts:AssumeRole&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="iam-user-作成">IAM User 作成</span></h2><ul>
<li>ユーザ &gt; ユーザ追加 選択</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925114822.png" width="100%">
</div>

<br>
<br>

<ul>
<li>ユーザ名 <code>es-index-backup-user</code> とし プログラムによるアクセスにチェックを入れて <code>次のステップ</code> クリック</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925115200.png" width="100%">
</div>

<br>
<br>

<ul>
<li>特にポリシーをアタッチせず <code>次のステップ</code> クリック</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925115357.png" width="100%">
</div>

<ul>
<li><code>es-index-backup-user</code> を作成し独自ポリシーで先ほど作成した role へのアクセス許可設定をアタッチします。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;iam:PassRole&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Resource&quot;</span>: <span class="string">&quot;arn:aws:iam::&lt;Account ID&gt;:role/es-index-backups&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<ul>
<li>発行されたアクセスキー、シークレットアクセスキーをメモしておきます。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925120635.png" width="100%">
</div>

<h2><span id="s3-バケット作成">S3 バケット作成</span></h2><p>S3 &gt; <code>バケットを作成する</code> でバケット作成してください。</p>
<h2><span id="elasticsearch-にてスナップショットリポジトリ作成">Elasticsearch にてスナップショットリポジトリ作成</span></h2><p>スナップショットを管理するリポジトリを Elasticsearch に作成する必要があります。</p>
<p>Elasticsearch へのアクセス可能なサーバにて以下スクリプト実行します。</p>
<ul>
<li>register_es_repository.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> boto.connection <span class="keyword">import</span> AWSAuthConnection</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ESConnection</span>(<span class="title class_ inherited__">AWSAuthConnection</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, region, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(ESConnection, self).__init__(**kwargs)</span><br><span class="line">        self._set_auth_region_name(region)</span><br><span class="line">        self._set_auth_service_name(<span class="string">&quot;es&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_required_auth_capability</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;hmac-v4&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    client = ESConnection(</span><br><span class="line">            region=<span class="string">&#x27;ap-northeast-1&#x27;</span>,</span><br><span class="line">            host=<span class="string">&#x27;&lt;Elasticsearch 2.3 Endpoint Domain&gt;&#x27;</span>,</span><br><span class="line">            aws_access_key_id=<span class="string">&#x27;&lt;ACCESS KEY ID&gt;&#x27;</span>,</span><br><span class="line">            aws_secret_access_key=<span class="string">&#x27;&lt;SECRET ACCESS KEY&gt;&#x27;</span>, is_secure=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    resp = client.make_request(</span><br><span class="line">        method=<span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        path=<span class="string">&#x27;/_snapshot/index-backups&#x27;</span>,</span><br><span class="line">        data=<span class="string">&#x27;&#123;&quot;type&quot;: &quot;s3&quot;,&quot;settings&quot;: &#123; &quot;bucket&quot;: &quot;&lt;bucket name&gt;&quot;,&quot;region&quot;: &quot;ap-northeast-1&quot;,&quot;role_arn&quot;: &quot;arn:aws:iam::&lt;Account ID&gt;:role/es-index-backups&quot;&#125;&#125;&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    body = resp.read()</span><br><span class="line">    <span class="built_in">print</span> body</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">chmod</span> +x register_es_repository.py</span><br><span class="line"></span><br><span class="line">$ python register_es_repository.py</span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<p>リポジトリ登録完了しました。</p>
<h2><span id="snapshot-取得">Snapshot 取得</span></h2><p>snapshot 名を <code>20170926</code> とします。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPUT <span class="string">&quot;https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;/_snapshot/index-backups/20170926&quot;</span></span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">&quot;accepted&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="snapshot-一覧">Snapshot 一覧</span></h2><p><code>20170926</code> という snapshot 名で取得したことが確認できます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s -XGET <span class="string">&quot;https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;/_snapshot/index-backups/_all&quot;</span> | jq .</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;snapshots&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;snapshot&quot;</span>: <span class="string">&quot;20170926&quot;</span>,</span><br><span class="line">      <span class="string">&quot;version_id&quot;</span>: 2030299,</span><br><span class="line">      <span class="string">&quot;version&quot;</span>: <span class="string">&quot;2.3.2&quot;</span>,</span><br><span class="line">      <span class="string">&quot;indices&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;nginx-access-2017.09.09&quot;</span>,</span><br><span class="line">        <span class="string">&quot;nginx-access-2017.09.07&quot;</span>,</span><br><span class="line">        <span class="string">&quot;nginx-access-2017.09.08&quot;</span>,</span><br><span class="line">        <span class="string">&quot;nginx-error-2017.08.24&quot;</span>,</span><br><span class="line">        <span class="string">&quot;nginx-error-2017.08.23&quot;</span>,</span><br><span class="line">        <span class="string">&quot;.kibana-4&quot;</span>,</span><br><span class="line">...</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;state&quot;</span>: <span class="string">&quot;IN_PROGRESS&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_time&quot;</span>: <span class="string">&quot;2017-09-26T03:58:51.040Z&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_time_in_millis&quot;</span>: 1506398331040,</span><br><span class="line">      <span class="string">&quot;failures&quot;</span>: [],</span><br><span class="line">      <span class="string">&quot;shards&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;total&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;failed&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;successful&quot;</span>: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="snapshot-削除">Snapshot 削除</span></h2><p>スナップショット <code>20170926</code> を削除する場合、DELETE メソッドを実行します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XDELETE https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;/_snapshot/index-backups/20170926</span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="s3-確認">S3 確認</span></h2><p>以下が作成されているのがわかります。</p>
<ul>
<li>indices/*</li>
<li>meta-*</li>
<li>snap-*</li>
</ul>
<p>はじめ meta-_ が作成できたら完了なのかなと思いきや<br>snap-_ も作られるまで待つ必要がありました。</p>
<ul>
<li>CLI 上でスナップショット完了確認した方が確実です。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s -GET https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;/_snapshot/index-backups/20170926</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">      <span class="string">&quot;state&quot;</span>: <span class="string">&quot;SUCCESS&quot;</span>,</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2><span id="elasticsearch-55-service-新規ドメイン作成">Elasticsearch 5.5 Service 新規ドメイン作成</span></h2><p>Elasticsearch 2.3 の設定に倣って作成します。</p>
<h2><span id="リポジトリ作成">リポジトリ作成</span></h2><ul>
<li>register_es55_repository.py</li>
</ul>
<p>register_es_repository.py の host 部分を新規ドメインに修正します。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> boto.connection <span class="keyword">import</span> AWSAuthConnection</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ESConnection</span>(<span class="title class_ inherited__">AWSAuthConnection</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, region, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(ESConnection, self).__init__(**kwargs)</span><br><span class="line">        self._set_auth_region_name(region)</span><br><span class="line">        self._set_auth_service_name(<span class="string">&quot;es&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_required_auth_capability</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;hmac-v4&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    client = ESConnection(</span><br><span class="line">            region=<span class="string">&#x27;ap-northeast-1&#x27;</span>,</span><br><span class="line">            host=<span class="string">&#x27;&lt;Elasticsearch 5.5 Endpoint Domain&gt;&#x27;</span>,</span><br><span class="line">            aws_access_key_id=<span class="string">&#x27;&lt;ACCESS KEY ID&gt;&#x27;</span>,</span><br><span class="line">            aws_secret_access_key=<span class="string">&#x27;&lt;SECRET ACCESS KEY&gt;&#x27;</span>, is_secure=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;Registering Snapshot Repository&#x27;</span></span><br><span class="line">    resp = client.make_request(</span><br><span class="line">        method=<span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        path=<span class="string">&#x27;/_snapshot/index-backups&#x27;</span>,</span><br><span class="line">        data=<span class="string">&#x27;&#123;&quot;type&quot;: &quot;s3&quot;,&quot;settings&quot;: &#123; &quot;bucket&quot;: &quot;&lt;bucket name&gt;&quot;,&quot;region&quot;: &quot;ap-northeast-1&quot;,&quot;role_arn&quot;: &quot;arn:aws:iam::&lt;Account ID&gt;:role/es-index-backups&quot;&#125;&#125;&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    body = resp.read()</span><br><span class="line">    <span class="built_in">print</span> body</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">chmod</span> +x register_es55_repository.py</span><br><span class="line"></span><br><span class="line">$ python register_es55_repository.py</span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="スナップショットからリストア">スナップショットからリストア</span></h2><p><code>20170926</code> のスナップショットをリストアします。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST <span class="string">&quot;https://&lt;Elasticsearch 5.5 Endpoint Domain&gt;/_snapshot/index-backups/20170926/_restore&quot;</span></span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">&quot;accepted&quot;</span>: <span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="リストア確認">リストア確認</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XGET <span class="string">&quot;https://&lt;Elasticsearch 5.5 Endpoint Domain&gt;/_cat/indices&quot;</span></span><br></pre></td></tr></table></figure>

<h2><span id="スナップショットに失敗するケース">スナップショットに失敗するケース</span></h2><ul>
<li>.kibana index が既に存在しており、リストアできない。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;error&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;root_cause&quot;</span>:[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>:<span class="string">&quot;snapshot_restore_exception&quot;</span>,</span><br><span class="line">                <span class="string">&quot;reason&quot;</span>:<span class="string">&quot;[index-backups:20170926/Hc4rLIoARCWqpyJXeP7edw] cannot restore index [.kibana] because it&#x27;s open&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:<span class="string">&quot;snapshot_restore_exception&quot;</span>,</span><br><span class="line">        <span class="string">&quot;reason&quot;</span>:<span class="string">&quot;[index-backups:20170926/Hc4rLIoARCWqpyJXeP7edw] cannot restore index [.kibana] because it&#x27;s open&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;status&quot;</span>:<span class="number">500</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4><span id="対応策">対応策</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST https://&lt;Elasticsearch 5.5 Endpoint Domain&gt;/_snapshot/index-backups/20170926/_restore -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">	&quot;indices&quot;: &quot;nginx-*&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span> | jq .</span><br></pre></td></tr></table></figure>

<p><code>indices</code> を用い、スナップショット内のインデックスの中からマッチする正規表現のみをリストアできます。</p>
<p>自身ではこの様な解決法を実施し回避できました。<br>その他良い方法があれば御指南いただけますと幸いです。</p>
<h2><span id="ちなみに">ちなみに</span></h2><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171002/20171002144856.png" width="100%">
</div>

<p>Terraform で ES 2.2 → 5.5 バージョンアップを実施した所<br>1 時間以上経過してようやくアップデートが完了しました。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws_elasticsearch_domain.elasticsearch: Still destroying... (ID: arn:aws:es:ap-northeast-1:xxxxxxxxxxxx:domain/***, 59m11s elapsed)</span><br><span class="line">aws_elasticsearch_domain.elasticsearch: Still destroying... (ID: arn:aws:es:ap-northeast-1:xxxxxxxxxxxx:domain/***, 59m21s elapsed)</span><br><span class="line">aws_elasticsearch_domain.elasticsearch: Still destroying... (ID: arn:aws:es:ap-northeast-1:xxxxxxxxxxxx:domain/***, 59m31s elapsed)</span><br><span class="line">aws_elasticsearch_domain.elasticsearch: Destruction complete after 59m41s</span><br></pre></td></tr></table></figure>

<p>これは辛い (&gt;_&lt;)</p>
<p>Terraform で管理している場合、<br>スナップショットを取得したら aws console 上でドメイン削除した方が早い。</p>
<p>ブルーグリーン的に ES 5.5 作成して ES 2.2 から乗り換えて<br>しばらく運用して問題なければ ES 2.2 を削除する方法が一番確実だなと思いました。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/12/">前</a></div><div class="pagination-next"><a href="/page/14/">次</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/12/">12</a></li><li><a class="pagination-link is-current" href="/page/13/">13</a></li><li><a class="pagination-link" href="/page/14/">14</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/33/">33</a></li></ul></nav></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="kenzo0107"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">kenzo0107</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">投稿</p><a href="/archives"><p class="title">329</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">カテゴリ</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">タグ</p><a href="/tags"><p class="title">88</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/kenzo0107" target="_blank" rel="noopener">フォローする</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/kenzo0107"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">カテゴリ</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/AWS/"><span class="level-start"><span class="level-item">AWS</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/categories/DIY/"><span class="level-start"><span class="level-item">DIY</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Go/"><span class="level-start"><span class="level-item">Go</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile" href="/categories/RaspberryPI/"><span class="level-start"><span class="level-item">RaspberryPI</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/Terraform/"><span class="level-start"><span class="level-item">Terraform</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最近の記事</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-31T15:00:00.000Z">2023-06-01</time></p><p class="title"><a href="/2023/05/31/2023-06-01-get-savings-plans-coverage-data-unavailable-exception/">AWS Savings Plans Coverage API 実行時に DataUnavailableException エラーが発生する</a></p><p class="categories"><a href="/categories/AWS/">AWS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-17T15:00:00.000Z">2023-05-18</time></p><p class="title"><a href="/2023/05/17/2023-05-18-raspberrypi4b-speaks-via-usb-speaker/">Raspberry Pi に USB スピーカーを接続しテキストを音声変換しお話しさせる</a></p><p class="categories"><a href="/categories/RaspberryPI/">RaspberryPI</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-20T15:00:00.000Z">2023-04-21</time></p><p class="title"><a href="/2023/04/20/2023-04-21-install-awscli-on-alpine/">alpine イメージに awscli をインストールする</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-13T15:00:00.000Z">2023-04-14</time></p><p class="title"><a href="/2023/04/13/2023-04-14-curl-not-match-libcurl-on-alpine/">fix: curl: (48) An unknown option was passed in to libcurl</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-04T15:00:00.000Z">2023-04-05</time></p><p class="title"><a href="/2023/04/04/2023-04-05-s3-bucket-public-access-block/">S3 のパブリックアクセスブロック有効後、無効にした際の S3 Object の ACL の挙動</a></p><p class="categories"><a href="/categories/AWS/">AWS</a></p></div></article></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">タグ</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/htaccess/"><span class="tag">.htaccess</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ALB/"><span class="tag">ALB</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AWS/"><span class="tag">AWS</span><span class="tag">43</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AntiVirus/"><span class="tag">AntiVirus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apache/"><span class="tag">Apache</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chef/"><span class="tag">Chef</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CodeBuild/"><span class="tag">CodeBuild</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cookie/"><span class="tag">Cookie</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Corosync/"><span class="tag">Corosync</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Datadog/"><span class="tag">Datadog</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECR/"><span class="tag">ECR</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECS/"><span class="tag">ECS</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElastiCache/"><span class="tag">ElastiCache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Elasticsearch/"><span class="tag">Elasticsearch</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Email/"><span class="tag">Email</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FTPS/"><span class="tag">FTPS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fluentd/"><span class="tag">Fluentd</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GKE/"><span class="tag">GKE</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GitHub-Actions/"><span class="tag">GitHub Actions</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag">24</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GooglePlay/"><span class="tag">GooglePlay</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hubot/"><span class="tag">Hubot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jenkins/"><span class="tag">Jenkins</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kibana/"><span class="tag">Kibana</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LINE-Notify/"><span class="tag">LINE Notify</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Lambda/"><span class="tag">Lambda</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Let-s-encrypt/"><span class="tag">Let&#039;s encrypt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MachineLearning/"><span class="tag">MachineLearning</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Monitoring/"><span class="tag">Monitoring</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenSSL/"><span class="tag">OpenSSL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Outlook/"><span class="tag">Outlook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP/"><span class="tag">PHP</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pacemaker/"><span class="tag">Pacemaker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ProxySQL/"><span class="tag">ProxySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Puppeteer/"><span class="tag">Puppeteer</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rails/"><span class="tag">Rails</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RaspberryPI/"><span class="tag">RaspberryPI</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reactio/"><span class="tag">Reactio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ruby/"><span class="tag">Ruby</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/S3/"><span class="tag">S3</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSL/"><span class="tag">SSL</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Security/"><span class="tag">Security</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SendGrid/"><span class="tag">SendGrid</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Slack/"><span class="tag">Slack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SonarQube/"><span class="tag">SonarQube</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/StatsBot/"><span class="tag">StatsBot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Terraform/"><span class="tag">Terraform</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Twilio/"><span class="tag">Twilio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Unity/"><span class="tag">Unity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vagrant/"><span class="tag">Vagrant</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vault/"><span class="tag">Vault</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WAF/"><span class="tag">WAF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zabbix/"><span class="tag">Zabbix</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/awk/"><span class="tag">awk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/casperjs/"><span class="tag">casperjs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu/"><span class="tag">cpu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/csv/"><span class="tag">csv</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flask/"><span class="tag">flask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/i-node/"><span class="tag">i-node</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iftop/"><span class="tag">iftop</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ipinfo/"><span class="tag">ipinfo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iptable/"><span class="tag">iptable</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kibana/"><span class="tag">kibana</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macos/"><span class="tag">macos</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/no-ip/"><span class="tag">no-ip</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ping/"><span class="tag">ping</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pip/"><span class="tag">pip</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reCAPTCHA/"><span class="tag">reCAPTCHA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sftp/"><span class="tag">sftp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spam/"><span class="tag">spam</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vim/"><span class="tag">vim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wget/"><span class="tag">wget</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/yum/"><span class="tag">yum</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zsh/"><span class="tag">zsh</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">更新を購読する</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="購読する"></div></div></form></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">広告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6265337967545472" data-ad-slot="9975280607" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Kenzo Tanaka</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("ja");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="トップに戻る" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="何かを入力してください..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"何かを入力してください...","untitled":"(無題)","posts":"投稿","pages":"ページ","categories":"カテゴリ","tags":"タグ"});
        });</script></body></html>