<div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-06-05T15:00:00.000Z" title="2018-06-05T15:00:00.000Z">2018-06-06</time><span class="level-item">2分 read (About 332 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/06/05/2018-06-06-specify-ecscli-version/">ElastiCache メンテナンス対応 ~2018年梅雨~</a></h1><div class="content"><p>完全な備忘録です。</p>
<h2 id="経緯"><a href="#経緯" class="headerlink" title="経緯"></a>経緯</h2><p>6月に入って数日、<br>ecs-cli の latest をインストールすると latest が 1.6.0 となり<br><code>ecs-cli compose ...</code> を実行すると以下のようなエラーが出るようになりました。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level=error msg=<span class="string">"Unable to open ECS Compose Project"</span> error=<span class="string">"Volume driver is not supported"</span></span><br></pre></td></tr></table></figure>

<p>1.4.0 では問題なかったタスク定義でしたが<br>1.6.0 では <code>Volume driver is not supported</code> となったそうで処理がこけるようになりました。</p>
<p>その対応として 1.4.0 にバージョン固定した設定です。</p></div><a class="article-more button is-small size-small" href="/2018/06/05/2018-06-06-specify-ecscli-version/#more">Read More</a></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/05/17/2018-05-18-ecs_prefix/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180606/20180606115540.jpg" alt="AWS ECS prefix 指定してまとめてタスク登録解除"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-05-17T15:00:00.000Z" title="2018-05-17T15:00:00.000Z">2018-05-18</time><span class="level-item">数秒 read (About 63 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/17/2018-05-18-ecs_prefix/">AWS ECS prefix 指定してまとめてタスク登録解除</a></h1><div class="content"><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>awscli でタスク定義のまとめて登録解除がなかったので簡単に Shell 化しました</p>
<script src="//gist.github.com/kenzo0107/adadc860e85f8b136ad040c71d249a3d.js"></script></div><a class="article-more button is-small size-small" href="/2018/05/17/2018-05-18-ecs_prefix/#more">Read More</a></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/05/13/2018-05-14-aws-vault-mfa/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180514/20180514221849.jpg" alt="AWS Vault で複数アカウントにMFA認証通過"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-05-13T15:00:00.000Z" title="2018-05-13T15:00:00.000Z">2018-05-14</time><span class="level-item">4分 read (About 617 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/13/2018-05-14-aws-vault-mfa/">AWS Vault で複数アカウントにMFA認証通過</a></h1><div class="content"><h2 id="AWS-Vault-とは？"><a href="#AWS-Vault-とは？" class="headerlink" title="AWS Vault とは？"></a>AWS Vault とは？</h2><p>AWS Vault は IAMの認証情報 (Access Key Id, Secret Access Key) を安全に OS のキーストアに保存しアクセスできる仕組みを提供するツールです。</p>
<p>Vault = 金庫 というだけあって<br>PC 落としても秘匿情報が漏れにくい仕組みにしてくれます。</p>
<h2 id="今回の目的"><a href="#今回の目的" class="headerlink" title="今回の目的"></a>今回の目的</h2><p>AWS Vault で複数アカウントのコンソールログインを簡単にしたいと思います。</p></div><a class="article-more button is-small size-small" href="/2018/05/13/2018-05-14-aws-vault-mfa/#more">Read More</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-05-09T15:00:00.000Z" title="2018-05-09T15:00:00.000Z">2018-05-10</time><span class="level-item">2分 read (About 249 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/09/2018-05-10-ecr-nologin-push/">続　ECR にログイン(aws ecr get-login)無しでプッシュする</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>前回 ECR への Docker イメージをプッシュする際の認証コマンドを実行せずにプッシュできる様にしました。</p>
<p><a href="http://kenzo0107.hatenablog.com/entry/2018/03/07/230736">ECR にログイン(aws ecr get-login)無しでプッシュする</a></p>
<p>ですが、<br>設定が手間というのがあり、CircleCI, AWS CodeBuild 等でワンライナーでささっと書きたいときには不便です。</p>
<h2><span id="解決">解決</span></h2><p><code>awscli profile</code> で設定した profile を利用し ecs-cli を利用することで認証をよろしくやってくれます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ecs-cli push &lt;image&gt; --aws-profile &lt;profile&gt; --region &lt;region&gt;</span><br></pre></td></tr></table></figure>

<h2><span id="設定-step">設定 Step</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws configure <span class="built_in">set</span> --profile hogehoge aws_access_key_id <span class="variable">$ACCESS_KEY_ID</span></span><br><span class="line">aws configure <span class="built_in">set</span> --profile hogehoge aws_secret_access_key <span class="variable">$SECRET_ACCESS_KEY</span></span><br><span class="line">aws configure <span class="built_in">set</span> --profile hogehoge region ap-northeast-1</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ecs-cli push 123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/stg-mogemoge-rails:latest \</span><br><span class="line">	--aws-profile hogehoge \</span><br><span class="line">	--region ap-northeast-1</span><br></pre></td></tr></table></figure>

<p>以上で <code>aws ecr get-login</code> を使用せず、ECR へプッシュができる様になりました♪</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/04/17/2018-04-18-fix-text-file-busy-on-docker-build/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180418/20180418215217.jpg" alt="docker build 時に Text file busy で shell が実行できない対策"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-04-17T15:00:00.000Z" title="2018-04-17T15:00:00.000Z">2018-04-18</time><span class="level-item">2分 read (About 301 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/17/2018-04-18-fix-text-file-busy-on-docker-build/">docker build 時に Text file busy で shell が実行できない対策</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Dockerfile 内に以下のように shell の実行を記述していました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RUN chmod +x hoge.sh \</span><br><span class="line">  &amp;&amp; hoge.sh</span><br></pre></td></tr></table></figure>

<p>上記記述のある状態で <code>docker build</code> 実行した所、以下のようなエラーに遭遇しました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;bin&#x2F;sh: hoge.sh: Text file busy</span><br></pre></td></tr></table></figure>

<h2><span id="what-is-text-file-busy">What is Text file busy ?</span></h2><p>書き込みのために現在開いている手続きのみの (共用テキスト) ファイルを実行しようとした場合や、実行中の手続きのみのファイルを書き込みのために開こうとしたり、削除しようとしたりする場合に発生します。</p>
<p>上記鑑みると<br><code>chmod +x hoge.sh</code> 実行中に <code>hoge.sh</code> を実行しようとしたが為に発生しているということ？？<br>と推測。</p>
<h2><span id="環境情報">環境情報</span></h2><ul>
<li>Ubuntu 14.04.5 LTS \n \l</li>
<li>Docker version 17.05.0-ce, build 89658be</li>
<li>Base Image: ruby:2.5-alpine</li>
</ul>
<h2><span id="対策">対策</span></h2><p>以下 sync 処理を追加し無事問題解決できました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RUN chmod +x hoge.sh \</span><br><span class="line">  &amp;&amp; sync \</span><br><span class="line">  &amp;&amp; hoge.sh</span><br></pre></td></tr></table></figure>


<h2><span id="what-is-sync-command">What is sync command ?</span></h2><a href="http://kazmax.zpp.jp/cmd/s/sync.8.html" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img></div><div class="descriptions"><div class="og-title">sync - システム管理コマンドの説明 - Linux コマンド集 一覧表</div><div class="og-description">sync - システム管理コマンドの説明。sync - ディスク上のデータをメモリと同期させる。</div></div></div></a>



<h2><span id="参考">参考</span></h2>

<a href="https://qiita.com/todanano/items/05570fac310d56758888" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-1.2.2&w=1200&mark=https%3A%2F%2Fqiita-user-contents.imgix.net%2F~text%3Fixlib%3Drb-1.2.2%26w%3D840%26h%3D380%26txt%3Dcp%25E3%2581%25A8mv%25E3%2581%25A8inode%25E3%2581%25AE%25E8%25A9%25B1%26txt-color%3D%2523333%26txt-font%3DAvenir-Black%26txt-size%3D54%26txt-clip%3Dellipsis%26txt-align%3Dcenter%252Cmiddle%26s%3Dc2b9f61e752bef7aa8e7438a0cc98c90&mark-align=center%2Cmiddle&blend=https%3A%2F%2Fqiita-user-contents.imgix.net%2F~text%3Fixlib%3Drb-1.2.2%26w%3D840%26h%3D500%26txt%3D%2540todanano%26txt-color%3D%2523333%26txt-font%3DAvenir-Black%26txt-size%3D45%26txt-align%3Dright%252Cbottom%26s%3D783d1d275dd22f39f51bf270f3384473&blend-align=center%2Cmiddle&blend-mode=normal&s=1437ceb4aa281c20396246b11938dbae"></div><div class="descriptions"><div class="og-title">cpとmvとinodeの話 - Qiita</div><div class="og-description">実行中のファイルに対して、
cpで上書きする場合だと、Text file busyで置き換えられず、
mvだと何も聞かれず置き換えられます。

この挙動の違いについて、まとめと実験。

inodeを見ると、それとなく分かります。

h...</div></div></div></a>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/04/17/2018-04-18-ftps-by-curl/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180418/20180418082402.png" alt="curl で FTPS (File Transfer Protocol over SSL/TLS) 接続確認"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-04-17T15:00:00.000Z" title="2018-04-17T15:00:00.000Z">2018-04-18</time><span class="level-item">1分 read (About 187 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/17/2018-04-18-ftps-by-curl/">curl で FTPS (File Transfer Protocol over SSL/TLS) 接続確認</a></h1><div class="content"><p>以下コマンドで FTPS 接続確認ができます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -u &lt;user&gt; --ftp-ssl -k ftp:&#x2F;&#x2F;&lt;ftp domain&gt;&#x2F;</span><br></pre></td></tr></table></figure>

<h2><span id="概要">概要</span></h2><p>備忘録記事です。</p>
<p>社外向けに FTPS で接続許可をする必要があり設定しました。</p>
<p>単純に作成・更新した user, password で認証をパスできるか、<br>の確認だけができれば良いので、その確認方法を模索している時に<br>程よいコマンドがありました。</p>
<p>その接続確認を FileZilla, Cyberduck でしましたが<br>どうもうまくいかず。。</p>
<p>改めて、 <code>lftp</code> とか色々 ftp だけでもコマンドは多々あるんだなと実感しました。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/03/06/2018-03-07-change-ruby-version-via-rbenv/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180307/20180307225204.png" alt="Linux に rbenv をセットアップして ruby バージョンを切り替える"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-03-06T15:00:00.000Z" title="2018-03-06T15:00:00.000Z">2018-03-07</time><span class="level-item">1分 read (About 190 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/06/2018-03-07-change-ruby-version-via-rbenv/">Linux に rbenv をセットアップして ruby バージョンを切り替える</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>サーバの ruby のバージョンが古かった為、<br>rbenv で ruby のバージョンを切り替える様にした際の設定メモです。</p>
<h2><span id="setup-rbenv">setup rbenv</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/sstephenson/rbenv.git ~/.rbenv</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'export PATH="$HOME/.rbenv/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'eval "$(rbenv init -)"'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br><span class="line">$ rbenv --version</span><br><span class="line">rbenv 1.1.1-30-gc8ba27f</span><br></pre></td></tr></table></figure>

<h2><span id="rbenv-経由で-ruby-250-インストール">rbenv 経由で Ruby 2.5.0 インストール</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ rbenv install 2.5.0</span><br><span class="line"></span><br><span class="line">// 現 version は system. まだ 2.5.0 に切り替わっていない</span><br><span class="line">$ rbenv versions</span><br><span class="line">* system (<span class="built_in">set</span> by /home/vagrant/.rbenv/version)</span><br><span class="line">  2.5.0</span><br><span class="line"></span><br><span class="line">// 2.5.0 へ切り替え</span><br><span class="line">$ rbenv global 2.5.0</span><br><span class="line"></span><br><span class="line">// 切り替え確認</span><br><span class="line">$ rbenv versions</span><br><span class="line">  system</span><br><span class="line">* 2.5.0 (<span class="built_in">set</span> by /home/vagrant/.rbenv/version)</span><br><span class="line"></span><br><span class="line">$ ruby -v</span><br><span class="line">ruby 2.5.0p0 (2017-12-25 revision 61468) [x86_64-linux]</span><br><span class="line"></span><br><span class="line">// リフレッシュしないと .rbenv/versions/2.5.0/bin 以下のパスを通らない</span><br><span class="line">$ rbenv <span class="built_in">rehash</span></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/03/06/2018-03-07-push-to-ecr-without-login-ecr/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180307/20180307231703.png" alt="ECR にログイン(aws ecr get-login)無しでプッシュする"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-03-06T15:00:00.000Z" title="2018-03-06T15:00:00.000Z">2018-03-07</time><span class="level-item">3分 read (About 514 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/06/2018-03-07-push-to-ecr-without-login-ecr/">ECR にログイン(aws ecr get-login)無しでプッシュする</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Docker version 1.11 で実装された credential-helper を利用し<br>ECR へのプッシュを安全に簡易的に行う仕組みを実装します。</p>
<h2><span id="docker-ver-111-以上にアップグレード">Docker ver 1.11 以上にアップグレード</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D</span><br><span class="line">$ sudo sh -c <span class="string">"echo deb https://apt.dockerproject.org/repo ubuntu-trusty main\</span></span><br><span class="line"><span class="string">&gt; /etc/apt/sources.list.d/docker.list"</span></span><br><span class="line">$ sudo apt-get purge lxc-docker docker</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install docker-engine</span><br><span class="line">$ sudo service docker restart</span><br></pre></td></tr></table></figure>

<h2><span id="pull-dockerized-ecr-credential-helper">pull Dockerized ECR credential helper</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<h2><span id="認証設定">認証設定</span></h2><p>以下3つの中から1つ利用ください。<br>EC2 であれば、<code>1. インスタンスロールで認証</code> が一番すっきりしていてコードの見通しが良いです。</p>
<ol>
<li>インスタンスロールで認証</li>
<li>credential で認証</li>
<li>環境変数で認証</li>
</ol>
<h3><span id="1-インスタンスロールで認証">1. インスタンスロールで認証</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">  -e REGISTRY=123457689012.dkr.ecr.us-east-1.amazonaws.com \</span><br><span class="line">  pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'cat &lt;&lt; EOF &gt; /usr/bin/docker-credential-ecr-login</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">SECRET=\$(docker run --rm \\</span></span><br><span class="line"><span class="string">  -e METHOD=\$1 \\</span></span><br><span class="line"><span class="string">  -e REGISTRY=\$(cat -) \\</span></span><br><span class="line"><span class="string">  pottava/amazon-ecr-credential-helper)</span></span><br><span class="line"><span class="string">echo \$SECRET | grep Secret</span></span><br><span class="line"><span class="string">EOF'</span></span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/bin/docker-credential-ecr-login</span><br></pre></td></tr></table></figure>

<h3><span id="2-credential-で認証">2. credential で認証</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">  -e REGISTRY=123457689012.dkr.ecr.us-east-1.amazonaws.com \</span><br><span class="line">  -v <span class="variable">$HOME</span>/.aws/credentials:/root/.aws/credentials \</span><br><span class="line">  pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'cat &lt;&lt; EOF &gt; /usr/bin/docker-credential-ecr-login</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">SECRET=\$(docker run --rm \\</span></span><br><span class="line"><span class="string">  -e METHOD=\$1 \\</span></span><br><span class="line"><span class="string">  -e REGISTRY=\$(cat -) \\</span></span><br><span class="line"><span class="string">  -v $HOME/.aws/credentials:/root/.aws/credentials \\</span></span><br><span class="line"><span class="string">  pottava/amazon-ecr-credential-helper)</span></span><br><span class="line"><span class="string">echo \$SECRET | grep Secret</span></span><br><span class="line"><span class="string">EOF'</span></span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/bin/docker-credential-ecr-login</span><br></pre></td></tr></table></figure>

<h3><span id="3-環境変数で認証">3. 環境変数で認証</span></h3><ul>
<li>環境変数セット</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">  -e REGISTRY=123457689012.dkr.ecr.us-east-1.amazonaws.com \</span><br><span class="line">  -e AWS_ACCESS_KEY_ID \</span><br><span class="line">  -e AWS_SECRET_ACCESS_KEY \</span><br><span class="line">  pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'cat &lt;&lt; EOF &gt; /usr/bin/docker-credential-ecr-login</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">SECRET=\$(docker run --rm \\</span></span><br><span class="line"><span class="string">  -e METHOD=\$1 \\</span></span><br><span class="line"><span class="string">  -e REGISTRY=\$(cat -) \\</span></span><br><span class="line"><span class="string">  -e AWS_ACCESS_KEY_ID \\</span></span><br><span class="line"><span class="string">  -e AWS_SECRET_ACCESS_KEY \\</span></span><br><span class="line"><span class="string">  pottava/amazon-ecr-credential-helper)</span></span><br><span class="line"><span class="string">echo \$SECRET | grep Secret</span></span><br><span class="line"><span class="string">EOF'</span></span><br><span class="line">sudo chmod +x /usr/bin/docker-credential-ecr-login</span><br></pre></td></tr></table></figure>

<h2><span id="credential-保存設定">credential 保存設定</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mv <span class="variable">$HOME</span>/.docker/config.json <span class="variable">$HOME</span>/.docker/config.json.org</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"credsStore"</span>: <span class="string">"ecr-login"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>これで <code>aws ecr get-login</code> から解放されます♪</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-02-07T15:00:00.000Z" title="2018-02-07T15:00:00.000Z">2018-02-08</time><span class="level-item">8分 read (About 1176 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/07/2019-02-08-aws-ecs/">AWS ECS トラブルシューティング</a></h1><div class="content"><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190208/20190208225212.jpg" width="100%">
</div>

<p>ECS を利用していて幾つかはまったポイントがあったのでまとめました。</p>
<h2><span id="started-1-task-が複数回実行されるが-コンテナが起動しない">started 1 task が複数回実行されるが、コンテナが起動しない</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ecs-cli compose service up ...</span><br><span class="line"></span><br><span class="line">level=info msg=<span class="string">"(service hogehoge) has started 1 tasks ..."</span></span><br><span class="line">level=info msg=<span class="string">"(service hogehoge) has started 1 tasks ..."</span></span><br><span class="line">level=info msg=<span class="string">"(service hogehoge) has started 1 tasks ..."</span></span><br></pre></td></tr></table></figure>


<p>ecs-cli compose service up でデプロイ時にタスク起動を実行するものの、起動が正しくできていない状態です。<br>こちらはコンテナ起動時の処理に問題がある場合があります。</p>
<ul>
<li>コンテナログを確認して、コンテナ起動失敗時刻付近のログを確認してください。</li>
<li>例えば、Nginx の設定ファイル, Rails のコードに typo, syntax error がある等です。</li>
</ul>
<h2><span id="already-using-a-port-required-by-your-task">already using a port required by your task</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service hogehoge was unable to place a task because no container instance met all of its requirements.</span><br><span class="line">The closest matching container-instance a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6 is already using a port required by your task</span><br></pre></td></tr></table></figure>


<p>port mapping を以下の様に設定していた。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"portMappings"</span>: [</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="string">"hostPort"</span>: <span class="number">0</span>,</span><br><span class="line">     <span class="string">"protocol"</span>: <span class="string">"tcp"</span>,</span><br><span class="line">     <span class="string">"containerPort"</span>: <span class="number">80</span></span><br><span class="line">   &#125;</span><br><span class="line"> ],</span><br></pre></td></tr></table></figure>


<p>新しいタスクでも 0:80 のポートを利用しようとする為、エラーとなります。<br>以下の様に設定することで回避できました。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"portMappings"</span>: [</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="string">"containerPort"</span>: <span class="number">80</span></span><br><span class="line">   &#125;</span><br><span class="line"> ],</span><br></pre></td></tr></table></figure>


<h2><span id="insufficient-memory-available">insufficient memory available</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO[0031] (service hogehoge) was unable to place a task because no container instance met all of its requirements. The closest matching (container-instance a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6) has insufficient memory available. For more information, see the Troubleshooting section of the Amazon ECS Developer Guide.  timestamp=2018-03-09 15:45:24 +0000 UTC</span><br></pre></td></tr></table></figure>


<p>タスク更新（<code>ecs-cli compose service up</code>）実行時、<br>上記の様なメモリ不足が出る場合はインスタンスタイプを上げる、また、他タスクを削除する等、メモリーリソースを増やす対応が必要です。</p>
<h2><span id="no-space-on-device">no space on device</span></h2><p>no space on device で イメージを pull できない。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20191003/20191003173809.png" width="100%">
</div>

<p><code>df -hT</code> コマンドで 容量の使用状況確認</p>
<p>未使用のコンテナ・ボリュームを強制削除しお掃除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -af --volumes</span><br></pre></td></tr></table></figure>


<h2><span id="msgcouldnt-run-containers-reasonresourcecpu">msg=”Couldn’t run containers” reason=”RESOURCE:CPU”</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg=<span class="string">"Couldn't run containers"</span> reason=<span class="string">"RESOURCE:CPU"</span></span><br></pre></td></tr></table></figure>


<p>タスクで指定している cpu (vCPU) が不足しています。<br>インスタンスタイプを上げる、もしくは、他タスクを削除する等、 CPU リソースを増やす対応が必要です。</p>
<h2><span id="fargate-port-mapping-error">Fargate - Port Mapping Error</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level=error msg=<span class="string">"Create task definition failed"</span> error=<span class="string">"ClientException: When networkMode=awsvpc, the host ports and container ports in port mappings must match.\n\tstatus code: 400, request id: a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6"</span></span><br></pre></td></tr></table></figure>


<p>起動タイプ Fargate で以下の様な設定だと、NG</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"80"</span></span><br></pre></td></tr></table></figure>


<p>こちらだと OK。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"80:80"</span></span><br></pre></td></tr></table></figure>


<p>ホストポートとコンテナポートのマッピングが必要です。</p>
<h2><span id="fargate-volume_from-は利用できない">Fargate volume_from は利用できない</span></h2><p><code>volume_from</code> は Fargate では使用できません。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level=error msg=<span class="string">"Create task definition failed"</span> error=<span class="string">"ClientException: host.sourcePath should not be set for volumes in Fargate.\n\tstatus code: 400, request id: a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6"</span></span><br></pre></td></tr></table></figure>


<h2><span id="指定された-iam-role-が適切なパーミッションを与えられていない">指定された IAM Role が適切なパーミッションを与えられていない</span></h2><p>IAM Role に権限を適宜付与します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">level=info msg=<span class="string">"(service hogehoge) failed to launch a task with (error ECS was unable to assume the role 'arn:aws:iam::123456789012:role/ecsTask</span></span><br><span class="line"><span class="string">ExecutionRole' that was provided for this task. Please verify that the role being passed has the proper trust relationship and permissions and that your IAM user has permissions to pass this role.)."</span> timestamp=2018-06-21 08:15:43 +0000 UTC</span><br></pre></td></tr></table></figure>


<p>イメージ pull できないというエラーも権限を付与していないことに起因することが主です。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CannotPullContainerError: API error (500): Get https://123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/v2/: net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection<span class="string">"</span></span><br></pre></td></tr></table></figure>


<p>現在稼働している ECS の IAM Role の権限を参考してください。変更される可能性があるのであくまで参考にし、適宜最新の情報を以ってご対応ください。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="string">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"Sid"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="string">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="string">"Action"</span>: [</span><br><span class="line">                <span class="string">"logs:PutLogEvents"</span>,</span><br><span class="line">                <span class="string">"logs:CreateLogStream"</span>,</span><br><span class="line">                <span class="string">"logs:CreateLogGroup"</span>,</span><br><span class="line">                <span class="string">"elasticloadbalancing:RegisterTargets"</span>,</span><br><span class="line">                <span class="string">"elasticloadbalancing:Describe*"</span>,</span><br><span class="line">                <span class="string">"elasticloadbalancing:DeregisterTargets"</span>,</span><br><span class="line">                <span class="string">"ecs:UpdateService"</span>,</span><br><span class="line">                <span class="string">"ecs:Submit*"</span>,</span><br><span class="line">                <span class="string">"ecs:StartTelemetrySession"</span>,</span><br><span class="line">                <span class="string">"ecs:StartTask"</span>,</span><br><span class="line">                <span class="string">"ecs:RunTask"</span>,</span><br><span class="line">                <span class="string">"ecs:RegisterTaskDefinition"</span>,</span><br><span class="line">                <span class="string">"ecs:RegisterContainerInstance"</span>,</span><br><span class="line">                <span class="string">"ecs:Poll"</span>,</span><br><span class="line">                <span class="string">"ecs:ListTasks"</span>,</span><br><span class="line">                <span class="string">"ecs:DiscoverPollEndpoint"</span>,</span><br><span class="line">                <span class="string">"ecs:DescribeTasks"</span>,</span><br><span class="line">                <span class="string">"ecs:DescribeServices"</span>,</span><br><span class="line">                <span class="string">"ecs:DescribeContainerInstances"</span>,</span><br><span class="line">                <span class="string">"ecs:DeregisterContainerInstance"</span>,</span><br><span class="line">                <span class="string">"ecs:CreateService"</span>,</span><br><span class="line">                <span class="string">"ecr:UploadLayerPart"</span>,</span><br><span class="line">                <span class="string">"ecr:PutImage"</span>,</span><br><span class="line">                <span class="string">"ecr:InitiateLayerUpload"</span>,</span><br><span class="line">                <span class="string">"ecr:GetDownloadUrlForLayer"</span>,</span><br><span class="line">                <span class="string">"ecr:GetAuthorizationToken"</span>,</span><br><span class="line">                <span class="string">"ecr:CompleteLayerUpload"</span>,</span><br><span class="line">                <span class="string">"ecr:BatchGetImage"</span>,</span><br><span class="line">                <span class="string">"ecr:BatchCheckLayerAvailability"</span>,</span><br><span class="line">                <span class="string">"ec2:Describe*"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>以上です。</p>
<p>また何か発生したら追記していきたいと思います。</p>
<h2><span id="reference">Reference</span></h2><ul>
<li><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/ecs-agent-disconnected/">Amazon ECS エージェントが切断状態で表示されるのは、なぜですか?</a></li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/01/09/2018-01-10-update-datadog-and-try-loggin-feature/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180110/20180110145104.png" alt="Datadog Agent 6系にアップデートして Logging 機能を試す！"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-01-09T15:00:00.000Z" title="2018-01-09T15:00:00.000Z">2018-01-10</time><span class="level-item">8分 read (About 1260 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/01/09/2018-01-10-update-datadog-and-try-loggin-feature/">Datadog Agent 6系にアップデートして Logging 機能を試す！</a></h1><div class="content"><p>Datadog Agent 6系にアップデートして Logging 機能を試す！</p>
<p>2017年末にβ版ですが、Datadog の Log 可視化ツールの利用が発表されました。</p>
<ul>
<li>Unifying the views でグラフの高負荷時刻付近のログを参照する機能があったり</li>
<li>Elasticsearch+Fluentd の代替として期待できそう</li>
</ul>
<p>と思い早速導入してみました。</p>
<h2><span id="datadog-agent-インストール方法">datadog-agent インストール方法</span></h2><p>2018年1月10日時点では 5系がインストールされます。</p>
<h2><span id="5系-6系とで主に変わった点">5系、6系とで主に変わった点</span></h2><ul>
<li>Datadog 設定ファイルパス変更</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th><em>5系</em></th>
<th><em>6系</em></th>
</tr>
</thead>
<tbody><tr>
<td>ベースディレクトリ</td>
<td>/etc/dd-agent</td>
<td>/etc/datadog-agent</td>
</tr>
<tr>
<td>各種設定ファイル</td>
<td>/etc/dd-agent/conf.d/nginx.yaml</td>
<td>/etc/dd-agent/conf.d/nginx.d/conf.yaml</td>
</tr>
<tr>
<td>メトリクス情報</td>
<td>dd-agent info</td>
<td>datadog-agent status</td>
</tr>
</tbody></table>
<p>6系では dd-agent コマンドがありませんでした。</p>
<ul>
<li>dd-agent configcheck に該当するコマンドが見当たらない？<br>どこにあるのか教えてください(;&gt;_&lt;)</li>
</ul>
<h2><span id="5系からのアップグレード方法">5系からのアップグレード方法</span></h2><p><a href="https://github.com/DataDog/datadog-agent/blob/master/docs/beta.md">https://github.com/DataDog/datadog-agent/blob/master/docs/beta.md</a></p>
<p>自身の環境は Ubuntu 16.04.2 LTS だったので以下方法でアップグレードしました。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ DD_UPGRADE=<span class="literal">true</span> bash -c <span class="string">"<span class="variable">$(curl -L https://raw.githubusercontent.com/DataDog/datadog-agent/master/cmd/agent/install_script.sh)</span>"</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Error: /etc/datadog-agent/datadog.yaml seems to contain a valid configuration, run the <span class="built_in">command</span> again with --force or -f to overwrite it</span><br><span class="line">Automatic import failed, you can still try to manually run: datadog-agent import /etc/dd-agent /etc/datadog-agent</span><br></pre></td></tr></table></figure>

<p>Error と出るので一瞬ハッとしましたが、Error Message をよく見ると<br>6系の <code>/etc/datadog-agent/datadog.yaml</code> は問題ない設定となっている様に見えますが、上書きしたい場合は –force を使ってね、<br>とあります。</p>
<p>datadog-agent のアップグレードは無事完了していました。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo datadog-agent status</span><br><span class="line"></span><br><span class="line">Getting the status from the agent.</span><br><span class="line"></span><br><span class="line">===================</span><br><span class="line">Agent (v6.0.0-rc.2)</span><br><span class="line">===================</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>また各種設定(/etc/datadog-agent/conf.d, checks.d)ファイルも問題なく移行できていました。</p>
<h2><span id="5系の設定ファイルを-6系へオーバーライド">5系の設定ファイルを 6系へオーバーライド</span></h2><p>特に上記の手法で問題ないですが強制的にオーバーライドする方法を明記しておきます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// /etc/dd-agent/conf.d 以下のファイルを 6系へ移行</span><br><span class="line">$ /opt/datadog-agent/bin/agent/agent import /etc/dd-agent /etc/datadog-agent --force</span><br><span class="line"></span><br><span class="line">Success: imported the contents of /etc/dd-agent/datadog.conf into /etc/datadog-agent/datadog.yaml</span><br><span class="line">Copied conf.d/http_check.yaml over the new http_check.d directory</span><br><span class="line">Copied conf.d/network.yaml over the new network.d directory</span><br><span class="line">Copied conf.d/nginx.yaml over the new nginx.d directory</span><br><span class="line">Copied conf.d/process.yaml over the new process.d directory</span><br><span class="line">Copied conf.d/process_check.yaml over the new process_check.d directory</span><br><span class="line">Copied conf.d/ssl_check_expire_days.yaml over the new ssl_check_expire_days.d directory</span><br><span class="line">Copied conf.d/unicorn_check.yaml over the new unicorn_check.d directory</span><br><span class="line">Error: unable to list auto_conf files from /etc/dd-agent: open /etc/dd-agent/conf.d/auto_conf: no such file or directory</span><br><span class="line"></span><br><span class="line">// /etc/dd-agent/checks.d/ 以下のファイルを 6系へ移行</span><br><span class="line">$ sudo -u dd-agent -- cp /etc/dd-agent/checks.d/*.py /etc/datadog-agent/checks.d/</span><br></pre></td></tr></table></figure>

<h2><span id="nginx-log-を-logging-へ送付">nginx log を Logging へ送付</span></h2><ul>
<li><code>/etc/datadog-agent/conf.d/nginx.d/conf.yaml</code></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init_config:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nginx_status_url:</span> <span class="string">http://localhost/nginx_status/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">hogehoge</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/nginx/access.log</span></span><br><span class="line">    <span class="attr">source:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">sourcecategory:</span> <span class="string">nginx_access</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">hogehoge</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/nginx/error.log</span></span><br><span class="line">    <span class="attr">source:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">sourcecategory:</span> <span class="string">nginx_error</span></span><br></pre></td></tr></table></figure>

<p>基本的に logs ディレクティブを記述することで OK</p>
<ul>
<li><code>/etc/datadog-agent/conf.d/fluentd.d/conf.yaml</code></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init_config:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line">    <span class="bullet">-</span>  <span class="attr">monitor_agent_url:</span> <span class="string">http://localhost:24220/api/plugins.json</span></span><br><span class="line">       <span class="attr">tag_by:</span> <span class="string">type</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">hogehoge</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/log/td-agent/td-agent.log</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">td-agent</span></span><br><span class="line">      <span class="attr">sourcecategory:</span> <span class="string">td-agent</span></span><br></pre></td></tr></table></figure>

<h2><span id="datadogconf-修正">datadog.conf 修正</span></h2><p><code>/etc/datadog-agent/datadog.yaml</code> に以下設定を加えます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_enabled: true</span><br></pre></td></tr></table></figure>


<h2><span id="設定反映">設定反映</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl restart datadog-agent</span><br></pre></td></tr></table></figure>

<h2><span id="うまく-datadog-に反映されないときは">うまく Datadog に反映されないときは</span></h2><p>ログを見てみます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tail -f &#x2F;var&#x2F;log&#x2F;datadog&#x2F;agent.log</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">2018-01-07 11:01:58 JST | INFO | (logs-agent.go:75 in func1) | open &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log: permission denied</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>パーミッションエラーが発生しており<br><code>datadog-agent</code> を起動している <code>dd-agent</code> ユーザからアクセスできない状態となっていました。</p>
<h3><span id="対処">対処</span></h3><p>単純に <code>/var/log/nginx/access.log</code> に 0644 (-rw-r–r–) を付与するだけでなく、<br>logrotate で生成される新たな log のパーミッションにも注意します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;log&#x2F;nginx&#x2F;*.log &#123;</span><br><span class="line">        daily</span><br><span class="line">        missingok</span><br><span class="line">        rotate 14</span><br><span class="line">        compress</span><br><span class="line">        delaycompress</span><br><span class="line">        notifempty</span><br><span class="line">        create 0644 www-data adm</span><br><span class="line">        sharedscripts</span><br><span class="line">        prerotate</span><br><span class="line">                if [ -d &#x2F;etc&#x2F;logrotate.d&#x2F;httpd-prerotate ]; then \</span><br><span class="line">                        run-parts &#x2F;etc&#x2F;logrotate.d&#x2F;httpd-prerotate; \</span><br><span class="line">                fi \</span><br><span class="line">        endscript</span><br><span class="line">        postrotate</span><br><span class="line">                invoke-rc.d nginx rotate &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1</span><br><span class="line">        endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>元々 0640 でしたが 0644 で生成するようにしました。<br>これにて解決♪</p>
<h2><span id="datadog-logging-で確認">Datadog Logging で確認</span></h2><p>ログが流れてくるのを確認できました。<br>Kibana の Discover ページのような作りです。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180110/20180110155520.png" width="100%">
</div>

<p>今後フィルタリングしてグラフを作ったりできたりしてくるのか、<br>Pro版なら無料で使わせてもらえないかな、<br>なんて期待が高まっております</p>
<p>お願い、Datadog さん(-人-)</p>
</div></article></div><nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/5/">前</a></div><div class="pagination-next"><a href="/page/7/">次</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/5/">5</a></li><li><a class="pagination-link is-current" href="/page/6/">6</a></li><li><a class="pagination-link" href="/page/7/">7</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/20/">20</a></li></ul></nav>