<div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-12-11T15:00:00.000Z" title="2015-12-11T15:00:00.000Z">2015-12-12</time><span class="level-item">3分 read (About 407 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/11/2015-12-12-redis-error-noauth-authentication-required/">Redis - (error) NOAUTH Authentication required への対応</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>経年運用し特にメモリも問題なかったRedisが突如接続エラーが発生したので<br>その際の対応をまとめました。</p>
<h2><span id="エラー内容">エラー内容</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP Fatal error:  Uncaught exception &#39;RedisException&#39; with message &#39;Failed to AUTH connection&#39;</span><br></pre></td></tr></table></figure>

<p>認証接続に失敗して Exception になっている。</p>
<p>Redisの設定周りで特にrequirepass を設定していないし<br>何故突然？という感じでした。</p>
<p>各環境でRedisの設定パスは異なると思いますが、自環境の場合以下です。<br>/etc/redis/6379.conf</p>
<p>以下のようにrequirepassはコメントアウトされている。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># requirepass</span><br></pre></td></tr></table></figure>


<h2><span id="対応">対応</span></h2><ul>
<li>process を kill する<br>※ <code>service redis restart</code> のように redisを再起動しても状況は変わりませんでした。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ps aux | grep &#39;redis&#39; | grep -v &#39;grep&#39;</span><br><span class="line"></span><br><span class="line">root     12743  0.1  0.2  40604  2124 ?        Ssl  10:50   0:00 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-server *:6379</span><br></pre></td></tr></table></figure>

<ul>
<li><p>再度 redis を起動させる。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service redis start</span><br></pre></td></tr></table></figure>
</li>
<li><p>requirepass 設定</p>
</li>
</ul>
<p>運用中でアプリケーション自体のソースをいじりたくなかったので<br>空のrequirepass を設定しました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli&gt; CONFIG SET REQUIREPASS &#39;&#39;</span><br></pre></td></tr></table></figure>

<p>上記で取り急ぎ対応は問題なかったです。</p>
<h2><span id="総評">総評</span></h2><p>改めて利用する際には<br>認証設定をしてアプリケーションからも<br>passwordを指定して接続する仕組みが良いですね。</p>
<p>ただ何故急に発生したかは引き続き調査をしていきます。</p>
<p>理由がわかる方はコメントなどいただけましたら幸いです。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-12-08T15:00:00.000Z" title="2015-12-08T15:00:00.000Z">2015-12-09</time><span class="level-item">1分 read (About 212 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/08/2015-12-09-revive-deleted-git-branch/">Git で削除したブランチを復活させる</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>以下コマンドでブランチを強制的に削除した後、やっぱり必要だったのに、となったときの対処</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git branch -D &lt;branch_name&gt;</span><br></pre></td></tr></table></figure>

<h2><span id="復活手順">復活手順</span></h2><ol>
<li>HEADの変更履歴を確認する</li>
<li>HEADのログ番号からブランチ名作成</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git reflog</span><br><span class="line">$ git branch &lt;branch_name&gt; HEAD@&#123;num&#125;</span><br></pre></td></tr></table></figure>

<p>-</p>
<p>例)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git reflog</span><br><span class="line"></span><br><span class="line">c95c7e9 HEAD@&#123;0&#125;: merge release: Merge made by the &#39;recursive&#39; strategy.</span><br><span class="line">ad5bed0 HEAD@&#123;1&#125;: checkout: moving from release to master</span><br><span class="line">ffe45df HEAD@&#123;2&#125;: merge develop: Merge made by the &#39;recursive&#39; strategy.</span><br><span class="line">6aa536b HEAD@&#123;3&#125;: checkout: moving from develop to release</span><br></pre></td></tr></table></figure>

<p>上記のHEAD@{3}が消してしまったブランチに対してのcommitだ！<br>とわかれば、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git branch hogehoge HEAD@&#123;3&#125;</span><br></pre></td></tr></table></figure>

<p>上記コマンド完了後、<br><code>git branch</code>すると branch <code>hogehoge</code>が作成されたことがわかる。</p>
<p>なので、commitはこまめにしておくと良いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2015/12/08/2015-12-09-show-dotfile-on-macos/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151209/20151209101926.png" alt="今更ながらMacでドットファイルを表示する"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-12-08T15:00:00.000Z" title="2015-12-08T15:00:00.000Z">2015-12-09</time><span class="level-item">1分 read (About 124 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/08/2015-12-09-show-dotfile-on-macos/">今更ながらMacでドットファイルを表示する</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Finderでドットファイルを開きたいという際にやっておく設定</p>
<h2><span id="環境">環境</span></h2><ul>
<li>MacOSX Yosemite 10.10.3</li>
</ul>
<h2><span id="手順">手順</span></h2><h3><span id="ターミナルを開き以下コマンド実行">ターミナルを開き以下コマンド実行</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ defaults write com.apple.finder AppleShowAllFiles -boolean true</span><br></pre></td></tr></table></figure>

<h3><span id="finderアプリ再起動">Finderアプリ再起動</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ killall Finder</span><br></pre></td></tr></table></figure>

<p>これでドットファイルが反映されています。</p>
<h2><span id="元に戻したい場合">元に戻したい場合</span></h2><h3><span id="ターミナルで以下コマンド実行">ターミナルで以下コマンド実行</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ defaults delete com.apple.finder AppleShowAllFiles</span><br></pre></td></tr></table></figure>

<h3><span id="再起動">再起動</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ killall Finder</span><br></pre></td></tr></table></figure>

<p>以上です</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2015/12/07/2015-12-08-tellme-twillio/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208143258.png" alt="Twilio で電話通知"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-12-07T15:00:00.000Z" title="2015-12-07T15:00:00.000Z">2015-12-08</time><span class="level-item">9分 read (About 1415 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/07/2015-12-08-tellme-twillio/">Twilio で電話通知</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>障害検知をメールやSlackに流しても休日に業務系連絡を見ることは少ない。<br><br>その為、より検知報告に気付きやすくする様、<br><br>電話通知にするべくTwilioを導入する運びとなりました。</p>
<p>まずは利用するまでの簡単な手順をまとめました。<br></p>
<p>※コードのサンプルがTwilioのサイト内にあるので導入しやすかったです。</p>
<h2><span id="手順">手順</span></h2><h3><span id="1-twilio-にアクセス">1. Twilio にアクセス</span></h3><p>以下リンクからTwilioにアクセスします。</p>
<p><a href="http://twilio.kddi-web.com">http://twilio.kddi-web.com</a></p>
<h3><span id="2-新規登録">2. 新規登録</span></h3><p>名前、E-mail、パスワード(大小半角英数字)と</p>
<p>何にどの言語で利用するかを選択して</p>
<p>「始めましょう」をクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208104015.png" width="100%">
</div>

<p>「始めましょう」という日本語はユーザ目線でなく違和感ありますね。</p>
<h3><span id="3-アカウント認証">3. アカウント認証</span></h3><p>以下２つの認証方法があります。</p>
<ul>
<li>電話番号にSMSに確認コードを送信させる</li>
<li>電話番号にTwilioから着信があり確認コードのダイヤルキーを入力する。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208104800.png" width="100%">
</div>

<p>後者はTwilioの音声読み上げロボットから電話がかかって来るので<br><br>どんな感じで通知されるか試してみたい方は是非後者を選択してみてください。<br></p>
<p>スムーズなイントネーションではないですが、伝えたい気持ちは誰よりもあります。</p>
<h3><span id="4-twilioから電話をかけてみる">4. Twilioから電話をかけてみる</span></h3><p>アカウント認証確認後、Twilio製品の「プログラマブルVoice」ページTopに遷移しました。<br>メニューから <code>ツール</code> をクリックしツールページに遷移してください。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208110143.png" width="100%">
</div>


<h4><span id="to指定">To指定</span></h4><p>音声通話&gt;通話&gt;電話をかける のAPI Explorer にて<br><code>必須</code> の<code>To</code> に 電話番号認証した番号を入力してください。</p>
<p>但し、日本番号（+81）の場合、<br> <code>090********</code> の番号は<br><br>はじめの <code>0</code> を削除し、 <code>+81</code> をprefixとして追加し、<br><br><code>+8190********</code> となりますので注意してください。<br></p>
<h4><span id="url指定">URL指定</span></h4><p><code>条件</code> の<code>Url</code> にTwilioからの電話を受け取った際、<br><br>電話のキーダイヤルを押下した際の挙動をurl形式で指定可能です。</p>
<p>適当に準備できるUrlがない場合は、<br><br>以下のような適当なUrlで良いです。</p>
<p><code>http:/hogehoge.hogehoge.co.jp</code></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208110552.png" width="100%">
</div>

<h4><span id="通知実行">通知実行</span></h4><p>ページ下部の <code>リクエストを発行する</code> ボタンをクリックします。</p>
<p><span style="color: #d32f2f">※</span> <code>※料金が発生します</code> とありますが、Trialは料金を請求されるということはありません。<br><br><span style="color: #d32f2f">※</span>同アカウントでアップグレードする際は、発信した電話料金も合わせて請求されることになるので、テスト完了後は別途アカウントを取得することを推奨します。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208112301.png" width="100%">
</div>

<h4><span id="電話を受け取る">電話を受け取る</span></h4><p>Twilioから電話がかかってきたかと思います。<br><br>キーダイヤルを入力すると、 Urlで指定したプログラムが動作しますが、<br><br>適当に入力したので<br><br><code>アプリケーションエラーが発生しました。電話を終了します。</code><br>と通知されるはずです。</p>
<p>実際にプログラムから使用する際は、<br><br>指定したUrlでキー入力を受け取ってその後の挙動を制御する、<br><br>という流れになります。</p>
<h2><span id="実際に利用した例">実際に利用した例</span></h2><p>担当した業務では、Zabbixからの障害検知をTwilioで担当者に電話報告（エスカレーション）するという仕組みを構築しました。</p>
<blockquote>
<p>例）以下のような挙動が実現できます。<br><br>Zabbixで障害検知 <br><br>↓<br><br>Twilio<br><br>↓ 電話<br><br>対応者 <br><br>↓ 対応者が「1」をクリック<br><br>指定したUrlのプログラム実行<br><br>↓「1」を受け取り、障害対応可能な旨をZabbixへ通知<br><br>Zabbix (障害対応中)</p>
</blockquote>
<h5><span id="zabbix-amp-twilio-参考">Zabbix &amp; Twilio 参考</span></h5><p><a href="http://begood-technology.github.io/zabbix-twilio/">zabbix-twillio</a></p>
<p>上記サイトでのzabbix-twilio連携の手順で進めた場合、<br><br>twilio でキーダイヤル入力後、 以下のようなエラーが発生し、イベント登録ができません。<br><br><code>API error -32602: The &quot;user.login&quot; method must be called without the &quot;auth&quot; parameter</code></p>
<p>zabbix-twilio.php内の <code>Zabbix_API</code>クラスが古い為です。<br></p>
<p><a href="https://github.com/begood-technology/zabbix-twilio/blob/master/zabbix-twilio.php">zabbix-twilio.php</a></p>
<p><a href="https://github.com/confirm/PhpZabbixApi">PhpZabbixApi</a></p>
<p>上記をダウンロードし、 <code>php build.php</code> で 以下2ファイルを生成し、<br><br>こちらを呼び出し <code>Zabbix_Api</code> と <code>ZabbixApi</code> とを変更してください。</p>
<ul>
<li>ZabbixApi.class.php</li>
<li>ZabbixApiAbstract.class.php</li>
</ul>
<ul>
<li>/var/www/html/zabbix-twilio/zabbix-twilio.php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ require_once &#39;ZabbixApi.class.php&#39;;</span><br><span class="line">+ use ZabbixApi\ZabbixApi;</span><br><span class="line"></span><br><span class="line">-                                       $api &#x3D; new Zabbix_API ( $ZABBIX_API, $ZABBIX_USER, $ZABBIX_PASS );</span><br><span class="line">+                                       $api &#x3D; new ZabbixApi ( $ZABBIX_API, $ZABBIX_USER, $ZABBIX_PASS);</span><br></pre></td></tr></table></figure>

<p><code>ZabbixApi</code> は Basic認証を設定している場合にも対処しています。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 例)</span><br><span class="line">$api &#x3D; new ZabbixApi ( $ZABBIX_API, $ZABBIX_USER, $ZABBIX_PASS, $BASIC_AUTH_USER, $BASIC_AUTH_PASS);</span><br></pre></td></tr></table></figure>



<h4><span id="検証環境">検証環境</span></h4><ul>
<li>Amazon Linux AMI release 2015.09</li>
<li>Zabbix 2.5 (3.0α)</li>
<li>PHP 5.6.14</li>
<li>MySQL 5.5.46</li>
</ul>
<p>以上</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-11-25T15:00:00.000Z" title="2015-11-25T15:00:00.000Z">2015-11-26</time><span class="level-item">1分 read (About 176 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/11/25/2015-11-26-cleanup-yum-cache/">意外と容量食ってた yum cache</a></h1><div class="content"><h2><span id="yum-cache-容量">yum cache 容量</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># du -sh &#x2F;var&#x2F;cache&#x2F;yum</span><br><span class="line">155M    &#x2F;var&#x2F;cache&#x2F;yum</span><br></pre></td></tr></table></figure>

<p>155MByteある汗</p>
<h2><span id="yum-cache-削除">yum cache 削除</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># yum clean all</span><br><span class="line">読み込んだプラグイン:fastestmirror</span><br><span class="line">リポジトリーを清掃しています: base epel extras mysql-connectors-community mysql-tools-community mysql56-community nginx treasuredata updates</span><br><span class="line">Cleaning up everything</span><br><span class="line">Cleaning up list of fastest mirrors</span><br></pre></td></tr></table></figure>


<h2><span id="yum-cache容量確認">yum cache容量確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># du -sh &#x2F;var&#x2F;cache&#x2F;yum</span><br><span class="line">8.0K    &#x2F;var&#x2F;cache&#x2F;yum</span><br></pre></td></tr></table></figure>

<p>スッキリ！</p>
<p>サーバから容量不足のアラートで少しでも容量減らしたいときに<br>役立ちました。</p>
<p>潤沢にサーバスペックを用意できるクライアントでない場合もあるので<br>地道に必要な知識だと感じました。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2015/11/23/2015-11-24-kibana-regex-pattern-match/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151124/20151124123137.png" alt="Kibana4 検索窓での検索 正規表現パターンマッチ等"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-11-23T15:00:00.000Z" title="2015-11-23T15:00:00.000Z">2015-11-24</time><span class="level-item">3分 read (About 406 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/11/23/2015-11-24-kibana-regex-pattern-match/">Kibana4 検索窓での検索 正規表現パターンマッチ等</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>アクセスログをfluentdで集積(aggregate)して<br>ElasticSearch へ保存、そのデータをkibanaで表示しています。</p>
<p>ちょっとしたアクセスログ解析したい場合、<br>かつては、SSHでサーバにログインして<br>コマンド実行し検索するという工程を踏んでいました。</p>
<p>ですが、Kibanaで検索することにより<br>サーバログインすることなく、検索がスムーズになりました。</p>
<p>リモートログインして誤った操作等もなくなる、<br>また本番環境アカウントの公開範囲を絞ることができ<br>良いことが増えました。</p>
<p>実際構築しても使う側がどう検索したら良いかわからないということが<br>ちょいちょいあったので<br>Kibana4 検索窓での検索方法を簡単にまとめました。</p>
<h2><span id="前提">前提</span></h2><ul>
<li>Kibana4</li>
<li>ドメイン名を以下とする</li>
</ul>
<p><code>http(s)://hogehoge.jp</code></p>
<h3><span id="範囲指定">範囲指定</span></h3><ul>
<li>httpステータスコード 200 から 400 検索</li>
</ul>
<p>status: [200 TO 400]</p>
<h3><span id="否定">否定</span></h3><ul>
<li>例) 指定ドメイン以外のリファラ検索</li>
<li><code>referer</code> という項目について 正規表現での否定(NOT)のパターンマッチで検索します。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NOT referer:&#x2F;http(s?)\:\&#x2F;\&#x2F;hogehoge\.jp\&#x2F;(.*)&#x2F;</span><br></pre></td></tr></table></figure>

<h3><span id="複合検索">複合検索</span></h3><ul>
<li>例) 指定ドメイン以外、且つ、200ステータス</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NOT referer:&#x2F;http(s?)\:\&#x2F;\&#x2F;hogehoge\.jp\&#x2F;(.*)&#x2F; AND status:200</span><br></pre></td></tr></table></figure>

<p>随時、事例があれば追記していきます。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2015/11/16/2015-11-17-versionup-nginx-without-maintenance/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160810/20160810163018.png" alt="運用中のNginxをノーメンテでバージョンアップ&amp;HTTP2.0モジュールを導入"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-11-16T15:00:00.000Z" title="2015-11-16T15:00:00.000Z">2015-11-17</time><span class="level-item">9分 read (About 1295 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/11/16/2015-11-17-versionup-nginx-without-maintenance/">運用中のNginxをノーメンテでバージョンアップ&amp;HTTP2.0モジュールを導入</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>運用中の Nginx に HTTP2.0モジュール <code>http_v2_module</code> を導入し<br>サイトのパフォーマンス向上を図ります。</p>
<p>※ Nginx 1.9.5 から <code>http_spdy_module</code> は <code>http_v2_module</code> に変更しています。</p>
<h2><span id="環境">環境</span></h2><ul>
<li>CentOS Linux release 7.1.1503 (Core)</li>
<li>Nginx 1.9.3 インストール済み/稼働中</li>
</ul>
<h2><span id="したいこと">したいこと</span></h2><ul>
<li>Nginx のバージョンアップ (1.9.5以上)</li>
<li>http_v2_module インストール</li>
</ul>
<h2><span id="現状確認">現状確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># nginx -V</span><br><span class="line"></span><br><span class="line">nginx version: nginx&#x2F;1.9.3</span><br><span class="line">built by gcc 4.8.3 20140911 (Red Hat 4.8.3-9) (GCC)</span><br><span class="line">built with OpenSSL 1.0.1e-fips 11 Feb 2013</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix&#x3D;&#x2F;etc&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp --user&#x3D;nginx --group&#x3D;nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-threads --with-stream --with-stream_ssl_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_spdy_module --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -m64 -mtune&#x3D;generic&#39;</span><br></pre></td></tr></table></figure>

<p>※moduleやlog, pidのパスは各環境に毎に異なります。</p>
<p>まずは 1.9.5以上にバージョンアップして <code>http_v2_module</code> を導入したいと思います。</p>
<h2><span id="nginx-196-インストール">Nginx 1.9.6 インストール</span></h2><p>今回は <b>2015.11.17</b> 時点で最新の <code>1.9.6</code> をインストールします。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line"># wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.9.6.tar.gz</span><br><span class="line"># tar xvf load&#x2F;nginx-1.9.6.tar.gz</span><br><span class="line"># cd nginx-1.9.6</span><br><span class="line"># .&#x2F;configure --prefix&#x3D;&#x2F;etc&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp --user&#x3D;nginx --group&#x3D;nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-threads --with-stream --with-stream_ssl_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_v2_module --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -m64 -mtune&#x3D;generic&#39;</span><br><span class="line"></span><br><span class="line"># make</span><br><span class="line"># make install</span><br><span class="line"></span><br><span class="line">   ~~~ インストール完了 ~~~</span><br><span class="line"></span><br><span class="line"># nginx -V</span><br><span class="line">nginx version: nginx&#x2F;1.9.6</span><br><span class="line">built by gcc 4.8.3 20140911 (Red Hat 4.8.3-9) (GCC)</span><br><span class="line">built with OpenSSL 1.0.1e-fips 11 Feb 2013</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix&#x3D;&#x2F;etc&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.lock --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp --user&#x3D;nginx --group&#x3D;nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_v2_module --with-http_geoip_module --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector --param&#x3D;ssp-buffer-size&#x3D;4 -m64 -mtune&#x3D;generic&#39;</span><br></pre></td></tr></table></figure>

<p>version が 1.9.6 となり<br>configure arguments に <code>--with-http_v2_module</code> が追加されていることがわかります。</p>
<p>要点は元々導入済み <code>http_spdy_module</code> を <code>http_v2_module</code> に変更しビルドです。<br><code>--with-http_spdy_module</code> がなければ <code>--with-http_v2_module</code> 追加です。</p>
<h2><span id="nginx-serverディレクティブ修正">nginx serverディレクティブ修正</span></h2><p>ssl http2.0対応する様、修正します</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">-    listen 443;</span><br><span class="line">+    listen 443 ssl http2;</span><br></pre></td></tr></table></figure>

<h2><span id="nginx-configure-test-amp-reload">Nginx configure test &amp; reload</span></h2><ul>
<li>configure test 実施します。</li>
<li>以下のように <code>syntax is ok</code> が出ない場合は設定に誤りがあるので修正してください。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># nginx -t</span><br><span class="line"></span><br><span class="line">nginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<ul>
<li>設定を再読み込みします。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># nginx -s reload</span><br></pre></td></tr></table></figure>

<p>上記で設定完了です。<br>これまでノーメンテでバージョンアップし、http_v2_moduleインストールができました。</p>
<p>早速httpsスキーマとなるページにアクセスしてみましょう。</p>
<h2><span id="http20設定確認">http2.0設定確認</span></h2><ul>
<li>Chrome ブラウザの Extension SPDYインディケータで確認</li>
<li>FireFox 開発ツール&gt; ネットワーク &gt; ヘッダから確認</li>
</ul>
<h4><span id="spdyインディケータで確認">SPDYインディケータで確認</span></h4><p><a href="https://chrome.google.com/webstore/detail/http2-and-spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin?hl=ja">HTTP/2 and SPDY indicator</a></p>
<p>拡張モジュールをインストールして確認してみると<br>SPDYインディケータが青くなっていることが確認できます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151117/20151117105049.png" width="100%">
</div>

<h4><span id="firefox-開発ツールgt-ネットワーク-gt-ヘッダから確認">FireFox 開発ツール&gt; ネットワーク &gt; ヘッダから確認</span></h4><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151117/20151117105530.png" width="100%">
</div>

<h2><span id="参考サイト">参考サイト</span></h2><ul>
<li><a href="http://qiita.com/takapan/items/756be5b47134f9e51a11">nginxでHTTP2接続(not spdy3.1)の検証</a></li>
<li><a href="http://qiita.com/tatsuhiro-t/items/6cbe5b095e24d7feb381">HTTP/2, SPDY 対応の負荷テストツール h2load</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-11-12T15:00:00.000Z" title="2015-11-12T15:00:00.000Z">2015-11-13</time><span class="level-item">2分 read (About 295 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/11/12/2015-11-12-elasticsearch-curator-delete-norequired-index/">Elasticsearch curatorで不要Indexをまとめて削除</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>fluentd + ElasticSearch + kibana を運用していますが<br>ある日ElasticSearchが動作しなくなる事象が発生しました。</p>
<p>過去indexが溜まりに溜まってメモリ不足というエラー。</p>
<p>logはS3にアップロードしているし、<br>不要なIndexは適宜削除して対策しました。</p>
<h2><span id="環境">環境</span></h2><ul>
<li>CentOS Linux release 7.0.1406 (Core)</li>
<li>ElasticSearch 1.7.1</li>
<li>Python 2.7.5</li>
<li>pip 7.1.0</li>
</ul>
<h2><span id="curator-インストール">curator インストール</span></h2><ul>
<li>ElasticSearchをインストールしているサーバにて以下実施</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># pip install curator</span><br></pre></td></tr></table></figure>

<h2><span id="curator-コマンド実行">curator コマンド実行</span></h2><ul>
<li>ElasticSearchをインストールしているサーバにて以下実施</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 14日(2週間)経過でclose</span><br><span class="line">curator --host localhost close indices --prefix logstash --older-than 14 --time-unit days --timestring %Y.%m.%d</span><br><span class="line"></span><br><span class="line"># 35日(4週間)経過でdelete</span><br><span class="line">curator --host localhost delete indices --prefix logstash --older-than 35 --time-unit days --timestring %Y.%m.%d</span><br><span class="line"></span><br><span class="line"># 2日経過でbloom filter無効化</span><br><span class="line">curator --host localhost bloom indices --prefix logstash --older-than 2 --time-unit days --timestring %Y.%m.%d</span><br></pre></td></tr></table></figure>

<p>上記をjenkinsで <a href="https://wiki.jenkins-ci.org/display/JENKINS/SSH+plugin">SSH plugin</a> で<br>リモートサーバにログインして実行するよう、<br>設定して定期ポーリングで1日1回実行させてます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151112/20151112142836.png" width="100%">
</div>

<p>以上</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2015/11/12/2015-11-13-check-gzip-compress/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160810/20160810163018.png" alt="運用中のNginxをノーメンテでバージョンアップ&amp;HTTP2.0モジュールを導入"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-11-12T15:00:00.000Z" title="2015-11-12T15:00:00.000Z">2015-11-13</time><span class="level-item">数秒 read (About 41 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/11/12/2015-11-13-check-gzip-compress/">運用中のNginxをノーメンテでバージョンアップ&amp;HTTP2.0モジュールを導入</a></h1><div class="content"><p>本当にただの備忘録です。</p>
<p>Nginxで <code>gzip on</code> にしたけど設定反映されているかshellで確認</p>
<script src="//gist.github.com/kenzo0107/204bd3504301b2eeae0d.js"></script>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2015-11-09T15:00:00.000Z" title="2015-11-09T15:00:00.000Z">2015-11-10</time><span class="level-item">1分 read (About 123 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/11/09/2015-11-10-redis-python/">Use Redis via Python</a></h1><div class="content"><h2><span id="memorandum">Memorandum</span></h2><p>The below codes is how to use redis via Python.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># coding: UTF-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">r = redis.StrictRedis(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># set/get string.</span></span><br><span class="line">r.set(<span class="string">'test1'</span>, <span class="string">'aiueo'</span>)</span><br><span class="line">r.expire(<span class="string">'test1'</span>, <span class="number">1000</span>)</span><br><span class="line"><span class="keyword">print</span> r.get(<span class="string">'test1'</span>)     <span class="comment"># aiueo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set/get integer.</span></span><br><span class="line">r.set(<span class="string">'test2'</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">print</span> r.get(<span class="string">'test2'</span>)    <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check key exit.</span></span><br><span class="line"><span class="keyword">print</span> r.exists(<span class="string">'test1'</span>) <span class="comment"># True</span></span><br><span class="line"><span class="keyword">print</span> r.exists(<span class="string">'test0'</span>) <span class="comment"># False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pattern match</span></span><br><span class="line">keys = r.keys(<span class="string">'test*'</span>)</span><br><span class="line"><span class="keyword">if</span> len(keys) &gt; <span class="number">0</span> :</span><br><span class="line">	<span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">		<span class="keyword">print</span> <span class="string">'--------------------------------------------'</span></span><br><span class="line">		<span class="keyword">print</span> key			<span class="comment"># test1, test2</span></span><br><span class="line">		<span class="keyword">print</span> r.get(key) 	<span class="comment"># aiueo, 2</span></span><br><span class="line">		<span class="keyword">print</span> r.type(key)	<span class="comment"># Type : string, string</span></span><br><span class="line">		<span class="keyword">print</span> r.ttl(key)    <span class="comment"># Expire : if not set, set "-1"</span></span><br><span class="line"></span><br><span class="line">r.append(<span class="string">'test1'</span>, <span class="string">'_kkkkkkk'</span>)</span><br><span class="line"><span class="keyword">print</span> r.get(<span class="string">'test1'</span>)   <span class="comment"># aiueo_kkkkkkk</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete cache.</span></span><br><span class="line">r.delete(<span class="string">'test1'</span>)</span><br><span class="line"><span class="keyword">print</span> r.exists(<span class="string">'test1'</span>) <span class="comment"># False</span></span><br></pre></td></tr></table></figure>

<p>Thanks.</p>
</div></article></div><nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/16/">前</a></div><div class="pagination-next"><a href="/page/18/">次</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/16/">16</a></li><li><a class="pagination-link is-current" href="/page/17/">17</a></li><li><a class="pagination-link" href="/page/18/">18</a></li><li><a class="pagination-link" href="/page/19/">19</a></li><li><a class="pagination-link" href="/page/20/">20</a></li></ul></nav>