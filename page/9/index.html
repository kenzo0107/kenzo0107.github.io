<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>長生村本郷Engineers&#039;Blog</title><meta description="tech"><meta property="og:type" content="blog"><meta property="og:title" content="長生村本郷Engineers&#039;Blog"><meta property="og:url" content="https://kenzo0107.github.io/"><meta property="og:site_name" content="長生村本郷Engineers&#039;Blog"><meta property="og:description" content="tech"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://kenzo0107.github.io/img/og_image.png"><meta property="article:author" content="Kenzo Tanaka"><meta property="article:tag" content="aws golang"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kenzo0107.github.io"},"headline":"長生村本郷Engineers'Blog","image":["https://kenzo0107.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Kenzo Tanaka"},"description":"tech"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-162026478-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-162026478-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="ca-pub-6265337967545472" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/2013/12/31/PrivacyPolicy/">PrivacyPolicy</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/04/17/2018-04-18-ftps-by-curl/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180418/20180418082402.png" alt="curl で FTPS (File Transfer Protocol over SSL/TLS) 接続確認"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-04-17T15:00:00.000Z" title="2018-04-17T15:00:00.000Z">2018-04-18</time><span class="level-item">1分 read (About 187 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/17/2018-04-18-ftps-by-curl/">curl で FTPS (File Transfer Protocol over SSL/TLS) 接続確認</a></h1><div class="content"><p>以下コマンドで FTPS 接続確認ができます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -u &lt;user&gt; --ftp-ssl -k ftp:&#x2F;&#x2F;&lt;ftp domain&gt;&#x2F;</span><br></pre></td></tr></table></figure>

<h2><span id="概要">概要</span></h2><p>備忘録記事です。</p>
<p>社外向けに FTPS で接続許可をする必要があり設定しました。</p>
<p>単純に作成・更新した user, password で認証をパスできるか、<br>の確認だけができれば良いので、その確認方法を模索している時に<br>程よいコマンドがありました。</p>
<p>その接続確認を FileZilla, Cyberduck でしましたが<br>どうもうまくいかず。。</p>
<p>改めて、 <code>lftp</code> とか色々 ftp だけでもコマンドは多々あるんだなと実感しました。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/03/06/2018-03-07-change-ruby-version-via-rbenv/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180307/20180307225204.png" alt="Linux に rbenv をセットアップして ruby バージョンを切り替える"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-03-06T15:00:00.000Z" title="2018-03-06T15:00:00.000Z">2018-03-07</time><span class="level-item">1分 read (About 190 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/06/2018-03-07-change-ruby-version-via-rbenv/">Linux に rbenv をセットアップして ruby バージョンを切り替える</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>サーバの ruby のバージョンが古かった為、<br>rbenv で ruby のバージョンを切り替える様にした際の設定メモです。</p>
<h2><span id="setup-rbenv">setup rbenv</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/sstephenson/rbenv.git ~/.rbenv</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'export PATH="$HOME/.rbenv/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'eval "$(rbenv init -)"'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> ~/.bash_profile</span><br><span class="line">$ rbenv --version</span><br><span class="line">rbenv 1.1.1-30-gc8ba27f</span><br></pre></td></tr></table></figure>

<h2><span id="rbenv-経由で-ruby-250-インストール">rbenv 経由で Ruby 2.5.0 インストール</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ rbenv install 2.5.0</span><br><span class="line"></span><br><span class="line">// 現 version は system. まだ 2.5.0 に切り替わっていない</span><br><span class="line">$ rbenv versions</span><br><span class="line">* system (<span class="built_in">set</span> by /home/vagrant/.rbenv/version)</span><br><span class="line">  2.5.0</span><br><span class="line"></span><br><span class="line">// 2.5.0 へ切り替え</span><br><span class="line">$ rbenv global 2.5.0</span><br><span class="line"></span><br><span class="line">// 切り替え確認</span><br><span class="line">$ rbenv versions</span><br><span class="line">  system</span><br><span class="line">* 2.5.0 (<span class="built_in">set</span> by /home/vagrant/.rbenv/version)</span><br><span class="line"></span><br><span class="line">$ ruby -v</span><br><span class="line">ruby 2.5.0p0 (2017-12-25 revision 61468) [x86_64-linux]</span><br><span class="line"></span><br><span class="line">// リフレッシュしないと .rbenv/versions/2.5.0/bin 以下のパスを通らない</span><br><span class="line">$ rbenv <span class="built_in">rehash</span></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/03/06/2018-03-07-push-to-ecr-without-login-ecr/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180307/20180307231703.png" alt="ECR にログイン(aws ecr get-login)無しでプッシュする"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-03-06T15:00:00.000Z" title="2018-03-06T15:00:00.000Z">2018-03-07</time><span class="level-item">3分 read (About 514 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/06/2018-03-07-push-to-ecr-without-login-ecr/">ECR にログイン(aws ecr get-login)無しでプッシュする</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Docker version 1.11 で実装された credential-helper を利用し<br>ECR へのプッシュを安全に簡易的に行う仕組みを実装します。</p>
<h2><span id="docker-ver-111-以上にアップグレード">Docker ver 1.11 以上にアップグレード</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D</span><br><span class="line">$ sudo sh -c <span class="string">"echo deb https://apt.dockerproject.org/repo ubuntu-trusty main\</span></span><br><span class="line"><span class="string">&gt; /etc/apt/sources.list.d/docker.list"</span></span><br><span class="line">$ sudo apt-get purge lxc-docker docker</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install docker-engine</span><br><span class="line">$ sudo service docker restart</span><br></pre></td></tr></table></figure>

<h2><span id="pull-dockerized-ecr-credential-helper">pull Dockerized ECR credential helper</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<h2><span id="認証設定">認証設定</span></h2><p>以下3つの中から1つ利用ください。<br>EC2 であれば、<code>1. インスタンスロールで認証</code> が一番すっきりしていてコードの見通しが良いです。</p>
<ol>
<li>インスタンスロールで認証</li>
<li>credential で認証</li>
<li>環境変数で認証</li>
</ol>
<h3><span id="1-インスタンスロールで認証">1. インスタンスロールで認証</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">  -e REGISTRY=123457689012.dkr.ecr.us-east-1.amazonaws.com \</span><br><span class="line">  pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'cat &lt;&lt; EOF &gt; /usr/bin/docker-credential-ecr-login</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">SECRET=\$(docker run --rm \\</span></span><br><span class="line"><span class="string">  -e METHOD=\$1 \\</span></span><br><span class="line"><span class="string">  -e REGISTRY=\$(cat -) \\</span></span><br><span class="line"><span class="string">  pottava/amazon-ecr-credential-helper)</span></span><br><span class="line"><span class="string">echo \$SECRET | grep Secret</span></span><br><span class="line"><span class="string">EOF'</span></span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/bin/docker-credential-ecr-login</span><br></pre></td></tr></table></figure>

<h3><span id="2-credential-で認証">2. credential で認証</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">  -e REGISTRY=123457689012.dkr.ecr.us-east-1.amazonaws.com \</span><br><span class="line">  -v <span class="variable">$HOME</span>/.aws/credentials:/root/.aws/credentials \</span><br><span class="line">  pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'cat &lt;&lt; EOF &gt; /usr/bin/docker-credential-ecr-login</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">SECRET=\$(docker run --rm \\</span></span><br><span class="line"><span class="string">  -e METHOD=\$1 \\</span></span><br><span class="line"><span class="string">  -e REGISTRY=\$(cat -) \\</span></span><br><span class="line"><span class="string">  -v $HOME/.aws/credentials:/root/.aws/credentials \\</span></span><br><span class="line"><span class="string">  pottava/amazon-ecr-credential-helper)</span></span><br><span class="line"><span class="string">echo \$SECRET | grep Secret</span></span><br><span class="line"><span class="string">EOF'</span></span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/bin/docker-credential-ecr-login</span><br></pre></td></tr></table></figure>

<h3><span id="3-環境変数で認証">3. 環境変数で認証</span></h3><ul>
<li>環境変数セット</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm \</span><br><span class="line">  -e REGISTRY=123457689012.dkr.ecr.us-east-1.amazonaws.com \</span><br><span class="line">  -e AWS_ACCESS_KEY_ID \</span><br><span class="line">  -e AWS_SECRET_ACCESS_KEY \</span><br><span class="line">  pottava/amazon-ecr-credential-helper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">'cat &lt;&lt; EOF &gt; /usr/bin/docker-credential-ecr-login</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">SECRET=\$(docker run --rm \\</span></span><br><span class="line"><span class="string">  -e METHOD=\$1 \\</span></span><br><span class="line"><span class="string">  -e REGISTRY=\$(cat -) \\</span></span><br><span class="line"><span class="string">  -e AWS_ACCESS_KEY_ID \\</span></span><br><span class="line"><span class="string">  -e AWS_SECRET_ACCESS_KEY \\</span></span><br><span class="line"><span class="string">  pottava/amazon-ecr-credential-helper)</span></span><br><span class="line"><span class="string">echo \$SECRET | grep Secret</span></span><br><span class="line"><span class="string">EOF'</span></span><br><span class="line">sudo chmod +x /usr/bin/docker-credential-ecr-login</span><br></pre></td></tr></table></figure>

<h2><span id="credential-保存設定">credential 保存設定</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mv <span class="variable">$HOME</span>/.docker/config.json <span class="variable">$HOME</span>/.docker/config.json.org</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; <span class="variable">$HOME</span>/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"credsStore"</span>: <span class="string">"ecr-login"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>これで <code>aws ecr get-login</code> から解放されます♪</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-02-07T15:00:00.000Z" title="2018-02-07T15:00:00.000Z">2018-02-08</time><span class="level-item">8分 read (About 1176 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/07/2019-02-08-aws-ecs/">AWS ECS トラブルシューティング</a></h1><div class="content"><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190208/20190208225212.jpg" width="100%">
</div>

<p>ECS を利用していて幾つかはまったポイントがあったのでまとめました。</p>
<h2><span id="started-1-task-が複数回実行されるが-コンテナが起動しない">started 1 task が複数回実行されるが、コンテナが起動しない</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ecs-cli compose service up ...</span><br><span class="line"></span><br><span class="line">level=info msg=<span class="string">"(service hogehoge) has started 1 tasks ..."</span></span><br><span class="line">level=info msg=<span class="string">"(service hogehoge) has started 1 tasks ..."</span></span><br><span class="line">level=info msg=<span class="string">"(service hogehoge) has started 1 tasks ..."</span></span><br></pre></td></tr></table></figure>


<p>ecs-cli compose service up でデプロイ時にタスク起動を実行するものの、起動が正しくできていない状態です。<br>こちらはコンテナ起動時の処理に問題がある場合があります。</p>
<ul>
<li>コンテナログを確認して、コンテナ起動失敗時刻付近のログを確認してください。</li>
<li>例えば、Nginx の設定ファイル, Rails のコードに typo, syntax error がある等です。</li>
</ul>
<h2><span id="already-using-a-port-required-by-your-task">already using a port required by your task</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service hogehoge was unable to place a task because no container instance met all of its requirements.</span><br><span class="line">The closest matching container-instance a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6 is already using a port required by your task</span><br></pre></td></tr></table></figure>


<p>port mapping を以下の様に設定していた。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"portMappings"</span>: [</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="string">"hostPort"</span>: <span class="number">0</span>,</span><br><span class="line">     <span class="string">"protocol"</span>: <span class="string">"tcp"</span>,</span><br><span class="line">     <span class="string">"containerPort"</span>: <span class="number">80</span></span><br><span class="line">   &#125;</span><br><span class="line"> ],</span><br></pre></td></tr></table></figure>


<p>新しいタスクでも 0:80 のポートを利用しようとする為、エラーとなります。<br>以下の様に設定することで回避できました。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"portMappings"</span>: [</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="string">"containerPort"</span>: <span class="number">80</span></span><br><span class="line">   &#125;</span><br><span class="line"> ],</span><br></pre></td></tr></table></figure>


<h2><span id="insufficient-memory-available">insufficient memory available</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO[0031] (service hogehoge) was unable to place a task because no container instance met all of its requirements. The closest matching (container-instance a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6) has insufficient memory available. For more information, see the Troubleshooting section of the Amazon ECS Developer Guide.  timestamp=2018-03-09 15:45:24 +0000 UTC</span><br></pre></td></tr></table></figure>


<p>タスク更新（<code>ecs-cli compose service up</code>）実行時、<br>上記の様なメモリ不足が出る場合はインスタンスタイプを上げる、また、他タスクを削除する等、メモリーリソースを増やす対応が必要です。</p>
<h2><span id="no-space-on-device">no space on device</span></h2><p>no space on device で イメージを pull できない。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20191003/20191003173809.png" width="100%">
</div>

<p><code>df -hT</code> コマンドで 容量の使用状況確認</p>
<p>未使用のコンテナ・ボリュームを強制削除しお掃除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -af --volumes</span><br></pre></td></tr></table></figure>


<h2><span id="msgcouldnt-run-containers-reasonresourcecpu">msg=”Couldn’t run containers” reason=”RESOURCE:CPU”</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg=<span class="string">"Couldn't run containers"</span> reason=<span class="string">"RESOURCE:CPU"</span></span><br></pre></td></tr></table></figure>


<p>タスクで指定している cpu (vCPU) が不足しています。<br>インスタンスタイプを上げる、もしくは、他タスクを削除する等、 CPU リソースを増やす対応が必要です。</p>
<h2><span id="fargate-port-mapping-error">Fargate - Port Mapping Error</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level=error msg=<span class="string">"Create task definition failed"</span> error=<span class="string">"ClientException: When networkMode=awsvpc, the host ports and container ports in port mappings must match.\n\tstatus code: 400, request id: a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6"</span></span><br></pre></td></tr></table></figure>


<p>起動タイプ Fargate で以下の様な設定だと、NG</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"80"</span></span><br></pre></td></tr></table></figure>


<p>こちらだと OK。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"80:80"</span></span><br></pre></td></tr></table></figure>


<p>ホストポートとコンテナポートのマッピングが必要です。</p>
<h2><span id="fargate-volume_from-は利用できない">Fargate volume_from は利用できない</span></h2><p><code>volume_from</code> は Fargate では使用できません。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">level=error msg=<span class="string">"Create task definition failed"</span> error=<span class="string">"ClientException: host.sourcePath should not be set for volumes in Fargate.\n\tstatus code: 400, request id: a1b2c3d4-e5f6-g7h8-j9k0-l1m2n3o4p5q6"</span></span><br></pre></td></tr></table></figure>


<h2><span id="指定された-iam-role-が適切なパーミッションを与えられていない">指定された IAM Role が適切なパーミッションを与えられていない</span></h2><p>IAM Role に権限を適宜付与します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">level=info msg=<span class="string">"(service hogehoge) failed to launch a task with (error ECS was unable to assume the role 'arn:aws:iam::123456789012:role/ecsTask</span></span><br><span class="line"><span class="string">ExecutionRole' that was provided for this task. Please verify that the role being passed has the proper trust relationship and permissions and that your IAM user has permissions to pass this role.)."</span> timestamp=2018-06-21 08:15:43 +0000 UTC</span><br></pre></td></tr></table></figure>


<p>イメージ pull できないというエラーも権限を付与していないことに起因することが主です。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CannotPullContainerError: API error (500): Get https://123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/v2/: net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection<span class="string">"</span></span><br></pre></td></tr></table></figure>


<p>現在稼働している ECS の IAM Role の権限を参考してください。変更される可能性があるのであくまで参考にし、適宜最新の情報を以ってご対応ください。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="string">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"Sid"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="string">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="string">"Action"</span>: [</span><br><span class="line">                <span class="string">"logs:PutLogEvents"</span>,</span><br><span class="line">                <span class="string">"logs:CreateLogStream"</span>,</span><br><span class="line">                <span class="string">"logs:CreateLogGroup"</span>,</span><br><span class="line">                <span class="string">"elasticloadbalancing:RegisterTargets"</span>,</span><br><span class="line">                <span class="string">"elasticloadbalancing:Describe*"</span>,</span><br><span class="line">                <span class="string">"elasticloadbalancing:DeregisterTargets"</span>,</span><br><span class="line">                <span class="string">"ecs:UpdateService"</span>,</span><br><span class="line">                <span class="string">"ecs:Submit*"</span>,</span><br><span class="line">                <span class="string">"ecs:StartTelemetrySession"</span>,</span><br><span class="line">                <span class="string">"ecs:StartTask"</span>,</span><br><span class="line">                <span class="string">"ecs:RunTask"</span>,</span><br><span class="line">                <span class="string">"ecs:RegisterTaskDefinition"</span>,</span><br><span class="line">                <span class="string">"ecs:RegisterContainerInstance"</span>,</span><br><span class="line">                <span class="string">"ecs:Poll"</span>,</span><br><span class="line">                <span class="string">"ecs:ListTasks"</span>,</span><br><span class="line">                <span class="string">"ecs:DiscoverPollEndpoint"</span>,</span><br><span class="line">                <span class="string">"ecs:DescribeTasks"</span>,</span><br><span class="line">                <span class="string">"ecs:DescribeServices"</span>,</span><br><span class="line">                <span class="string">"ecs:DescribeContainerInstances"</span>,</span><br><span class="line">                <span class="string">"ecs:DeregisterContainerInstance"</span>,</span><br><span class="line">                <span class="string">"ecs:CreateService"</span>,</span><br><span class="line">                <span class="string">"ecr:UploadLayerPart"</span>,</span><br><span class="line">                <span class="string">"ecr:PutImage"</span>,</span><br><span class="line">                <span class="string">"ecr:InitiateLayerUpload"</span>,</span><br><span class="line">                <span class="string">"ecr:GetDownloadUrlForLayer"</span>,</span><br><span class="line">                <span class="string">"ecr:GetAuthorizationToken"</span>,</span><br><span class="line">                <span class="string">"ecr:CompleteLayerUpload"</span>,</span><br><span class="line">                <span class="string">"ecr:BatchGetImage"</span>,</span><br><span class="line">                <span class="string">"ecr:BatchCheckLayerAvailability"</span>,</span><br><span class="line">                <span class="string">"ec2:Describe*"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>以上です。</p>
<p>また何か発生したら追記していきたいと思います。</p>
<h2><span id="reference">Reference</span></h2><ul>
<li><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/ecs-agent-disconnected/">Amazon ECS エージェントが切断状態で表示されるのは、なぜですか?</a></li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/01/09/2018-01-10-update-datadog-and-try-loggin-feature/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180110/20180110145104.png" alt="Datadog Agent 6系にアップデートして Logging 機能を試す！"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-01-09T15:00:00.000Z" title="2018-01-09T15:00:00.000Z">2018-01-10</time><span class="level-item">8分 read (About 1260 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/01/09/2018-01-10-update-datadog-and-try-loggin-feature/">Datadog Agent 6系にアップデートして Logging 機能を試す！</a></h1><div class="content"><p>Datadog Agent 6系にアップデートして Logging 機能を試す！</p>
<p>2017年末にβ版ですが、Datadog の Log 可視化ツールの利用が発表されました。</p>
<ul>
<li>Unifying the views でグラフの高負荷時刻付近のログを参照する機能があったり</li>
<li>Elasticsearch+Fluentd の代替として期待できそう</li>
</ul>
<p>と思い早速導入してみました。</p>
<h2><span id="datadog-agent-インストール方法">datadog-agent インストール方法</span></h2><p>2018年1月10日時点では 5系がインストールされます。</p>
<h2><span id="5系-6系とで主に変わった点">5系、6系とで主に変わった点</span></h2><ul>
<li>Datadog 設定ファイルパス変更</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th><em>5系</em></th>
<th><em>6系</em></th>
</tr>
</thead>
<tbody><tr>
<td>ベースディレクトリ</td>
<td>/etc/dd-agent</td>
<td>/etc/datadog-agent</td>
</tr>
<tr>
<td>各種設定ファイル</td>
<td>/etc/dd-agent/conf.d/nginx.yaml</td>
<td>/etc/dd-agent/conf.d/nginx.d/conf.yaml</td>
</tr>
<tr>
<td>メトリクス情報</td>
<td>dd-agent info</td>
<td>datadog-agent status</td>
</tr>
</tbody></table>
<p>6系では dd-agent コマンドがありませんでした。</p>
<ul>
<li>dd-agent configcheck に該当するコマンドが見当たらない？<br>どこにあるのか教えてください(;&gt;_&lt;)</li>
</ul>
<h2><span id="5系からのアップグレード方法">5系からのアップグレード方法</span></h2><p><a href="https://github.com/DataDog/datadog-agent/blob/master/docs/beta.md">https://github.com/DataDog/datadog-agent/blob/master/docs/beta.md</a></p>
<p>自身の環境は Ubuntu 16.04.2 LTS だったので以下方法でアップグレードしました。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ DD_UPGRADE=<span class="literal">true</span> bash -c <span class="string">"<span class="variable">$(curl -L https://raw.githubusercontent.com/DataDog/datadog-agent/master/cmd/agent/install_script.sh)</span>"</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Error: /etc/datadog-agent/datadog.yaml seems to contain a valid configuration, run the <span class="built_in">command</span> again with --force or -f to overwrite it</span><br><span class="line">Automatic import failed, you can still try to manually run: datadog-agent import /etc/dd-agent /etc/datadog-agent</span><br></pre></td></tr></table></figure>

<p>Error と出るので一瞬ハッとしましたが、Error Message をよく見ると<br>6系の <code>/etc/datadog-agent/datadog.yaml</code> は問題ない設定となっている様に見えますが、上書きしたい場合は –force を使ってね、<br>とあります。</p>
<p>datadog-agent のアップグレードは無事完了していました。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo datadog-agent status</span><br><span class="line"></span><br><span class="line">Getting the status from the agent.</span><br><span class="line"></span><br><span class="line">===================</span><br><span class="line">Agent (v6.0.0-rc.2)</span><br><span class="line">===================</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>また各種設定(/etc/datadog-agent/conf.d, checks.d)ファイルも問題なく移行できていました。</p>
<h2><span id="5系の設定ファイルを-6系へオーバーライド">5系の設定ファイルを 6系へオーバーライド</span></h2><p>特に上記の手法で問題ないですが強制的にオーバーライドする方法を明記しておきます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// /etc/dd-agent/conf.d 以下のファイルを 6系へ移行</span><br><span class="line">$ /opt/datadog-agent/bin/agent/agent import /etc/dd-agent /etc/datadog-agent --force</span><br><span class="line"></span><br><span class="line">Success: imported the contents of /etc/dd-agent/datadog.conf into /etc/datadog-agent/datadog.yaml</span><br><span class="line">Copied conf.d/http_check.yaml over the new http_check.d directory</span><br><span class="line">Copied conf.d/network.yaml over the new network.d directory</span><br><span class="line">Copied conf.d/nginx.yaml over the new nginx.d directory</span><br><span class="line">Copied conf.d/process.yaml over the new process.d directory</span><br><span class="line">Copied conf.d/process_check.yaml over the new process_check.d directory</span><br><span class="line">Copied conf.d/ssl_check_expire_days.yaml over the new ssl_check_expire_days.d directory</span><br><span class="line">Copied conf.d/unicorn_check.yaml over the new unicorn_check.d directory</span><br><span class="line">Error: unable to list auto_conf files from /etc/dd-agent: open /etc/dd-agent/conf.d/auto_conf: no such file or directory</span><br><span class="line"></span><br><span class="line">// /etc/dd-agent/checks.d/ 以下のファイルを 6系へ移行</span><br><span class="line">$ sudo -u dd-agent -- cp /etc/dd-agent/checks.d/*.py /etc/datadog-agent/checks.d/</span><br></pre></td></tr></table></figure>

<h2><span id="nginx-log-を-logging-へ送付">nginx log を Logging へ送付</span></h2><ul>
<li><code>/etc/datadog-agent/conf.d/nginx.d/conf.yaml</code></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init_config:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nginx_status_url:</span> <span class="string">http://localhost/nginx_status/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">hogehoge</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/nginx/access.log</span></span><br><span class="line">    <span class="attr">source:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">sourcecategory:</span> <span class="string">nginx_access</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">hogehoge</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/nginx/error.log</span></span><br><span class="line">    <span class="attr">source:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">sourcecategory:</span> <span class="string">nginx_error</span></span><br></pre></td></tr></table></figure>

<p>基本的に logs ディレクティブを記述することで OK</p>
<ul>
<li><code>/etc/datadog-agent/conf.d/fluentd.d/conf.yaml</code></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init_config:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line">    <span class="bullet">-</span>  <span class="attr">monitor_agent_url:</span> <span class="string">http://localhost:24220/api/plugins.json</span></span><br><span class="line">       <span class="attr">tag_by:</span> <span class="string">type</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">hogehoge</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/log/td-agent/td-agent.log</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">td-agent</span></span><br><span class="line">      <span class="attr">sourcecategory:</span> <span class="string">td-agent</span></span><br></pre></td></tr></table></figure>

<h2><span id="datadogconf-修正">datadog.conf 修正</span></h2><p><code>/etc/datadog-agent/datadog.yaml</code> に以下設定を加えます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_enabled: true</span><br></pre></td></tr></table></figure>


<h2><span id="設定反映">設定反映</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl restart datadog-agent</span><br></pre></td></tr></table></figure>

<h2><span id="うまく-datadog-に反映されないときは">うまく Datadog に反映されないときは</span></h2><p>ログを見てみます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tail -f &#x2F;var&#x2F;log&#x2F;datadog&#x2F;agent.log</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">2018-01-07 11:01:58 JST | INFO | (logs-agent.go:75 in func1) | open &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log: permission denied</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>パーミッションエラーが発生しており<br><code>datadog-agent</code> を起動している <code>dd-agent</code> ユーザからアクセスできない状態となっていました。</p>
<h3><span id="対処">対処</span></h3><p>単純に <code>/var/log/nginx/access.log</code> に 0644 (-rw-r–r–) を付与するだけでなく、<br>logrotate で生成される新たな log のパーミッションにも注意します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;log&#x2F;nginx&#x2F;*.log &#123;</span><br><span class="line">        daily</span><br><span class="line">        missingok</span><br><span class="line">        rotate 14</span><br><span class="line">        compress</span><br><span class="line">        delaycompress</span><br><span class="line">        notifempty</span><br><span class="line">        create 0644 www-data adm</span><br><span class="line">        sharedscripts</span><br><span class="line">        prerotate</span><br><span class="line">                if [ -d &#x2F;etc&#x2F;logrotate.d&#x2F;httpd-prerotate ]; then \</span><br><span class="line">                        run-parts &#x2F;etc&#x2F;logrotate.d&#x2F;httpd-prerotate; \</span><br><span class="line">                fi \</span><br><span class="line">        endscript</span><br><span class="line">        postrotate</span><br><span class="line">                invoke-rc.d nginx rotate &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1</span><br><span class="line">        endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>元々 0640 でしたが 0644 で生成するようにしました。<br>これにて解決♪</p>
<h2><span id="datadog-logging-で確認">Datadog Logging で確認</span></h2><p>ログが流れてくるのを確認できました。<br>Kibana の Discover ページのような作りです。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20180110/20180110155520.png" width="100%">
</div>

<p>今後フィルタリングしてグラフを作ったりできたりしてくるのか、<br>Pro版なら無料で使わせてもらえないかな、<br>なんて期待が高まっております</p>
<p>お願い、Datadog さん(-人-)</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/12/22/2017-12-23-monitoring-rails-unicorn-by-datadog-using-mackerel/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171223/20171223193555.png" alt="Datadog で Rails Unicorn の Memory, Idle|Busy Worker 監視 〜呉越同舟〜"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-12-22T15:00:00.000Z" title="2017-12-22T15:00:00.000Z">2017-12-23</time><span class="level-item">3分 read (About 524 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/12/22/2017-12-23-monitoring-rails-unicorn-by-datadog-using-mackerel/">Datadog で Rails Unicorn の Memory, Idle|Busy Worker 監視 〜呉越同舟〜</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Rails の乗っているホストへ Datadog で Unicorn を監視しようとした所、<br>それらしい Integration がありません((あったら教えてください &gt;_&lt; ))。</p>
<p>ということで独自スクリプトを作成しようと思いました！</p>
<h2><span id="独自スクリプトを書こうとしてたら">独自スクリプトを書こうとしてたら…</span></h2><p>同僚「Mackerel なら plugin ありますよ？」</p>
<p>自分「えっ？…」</p>
<h2><span id="mackerel-入ってる">Mackerel 入ってる</span></h2><p>Mackerel に unicorn 監視用の plugin がありました。</p>
<p><a href="https://github.com/mackerelio/mackerel-agent-plugins/tree/master/mackerel-plugin-unicorn">mackerel-plugin-unicorn</a></p>
<p>はてなさんもOSSで出して頂いている、<br>車輪の再開発は時間の無駄、<br>人生は一度しかないのでこの Mackerel プラグインを Datadog で使わせて頂こうと思いました。</p>
<h2><span id="mackerel-datadog-呉越同舟スクリプト">Mackerel + Datadog 呉越同舟スクリプト</span></h2><ul>
<li>/etc/dd-agent/unicorn_check.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> checks <span class="keyword">import</span> AgentCheck</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnicornCheck</span><span class="params">(AgentCheck)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">    pidfile = instance[<span class="string">'pidfile'</span>]</span><br><span class="line">    cmd = <span class="string">"/usr/bin/mackerel-plugin-unicorn -pidfile=%s"</span> % (pidfile)</span><br><span class="line"></span><br><span class="line">    res = self.exeCmdWithStripLF(cmd)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">        y = re.split(<span class="string">r'\t+'</span>, r.rstrip(<span class="string">'\t'</span>))</span><br><span class="line">        metrics = y[<span class="number">0</span>]</span><br><span class="line">        out     = y[<span class="number">1</span>]</span><br><span class="line">        self.gauge(metrics, out)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># コマンド実行結果から改行コードから取り除く</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">exeCmdWithStripLF</span><span class="params">(self, cmd)</span>:</span></span><br><span class="line">    res = self.exeCmd(cmd)</span><br><span class="line">    <span class="keyword">return</span> [str(x).rstrip(<span class="string">"\n"</span>) <span class="keyword">for</span> x <span class="keyword">in</span> res]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># コマンド実行</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">exeCmd</span><span class="params">(self, cmd)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.Popen(</span><br><span class="line">      cmd,</span><br><span class="line">      stdout=subprocess.PIPE,</span><br><span class="line">      shell=<span class="literal">True</span></span><br><span class="line">    ).stdout.readlines()</span><br></pre></td></tr></table></figure>

<ul>
<li>/etc/dd-agent/conf.d/unicorn_check.yaml</li>
</ul>
<p>Unicorn の PID ファイルを指定します。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">init_config:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pidfile:</span> <span class="string">/path/to/rails_project/shared/tmp/pids/unicorn.pid</span></span><br></pre></td></tr></table></figure>

<h2><span id="datadog-agent-設定ファイルチェック">Datadog Agent 設定ファイルチェック</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dd-agent configcheck</span><br><span class="line"></span><br><span class="line">unicorn_check.yaml is valid</span><br></pre></td></tr></table></figure>

<h2><span id="datadog-agent-再起動">Datadog Agent 再起動</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service datadog-agent restart</span><br></pre></td></tr></table></figure>

<h2><span id="数分後グラフを見てみる">数分後グラフを見てみる</span></h2><p>出てきた！</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171223/20171223203723.png" width="100%">
</div>


<h2><span id="総評">総評</span></h2><p>これで呉越同舟型モニタリングができました！</p>
<p>自分自身が呉でも越でもない所に若干の背徳感がありますが<br>手っ取り早く舟をこしらえたことに本記事の意味があるかと<br>筆を取りました。</p>
<p>参考になれば幸いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/12/04/2017-12-05-terraform-workspace-tfsate/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171205/20171205214728.jpg" alt="terraform workspace で環境毎に tfsate 管理"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-12-04T15:00:00.000Z" title="2017-12-04T15:00:00.000Z">2017-12-05</time><span class="level-item">7分 read (About 1064 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/12/04/2017-12-05-terraform-workspace-tfsate/">terraform workspace で環境毎に tfsate 管理</a></h1><div class="content"><p>terraform workspace で環境毎に tfsate 管理した話です。</p>
<h2><span id="追記-20190417">追記 2019/04/17</span></h2><p>追記時点で workspace は運用時点の問題が多くあった為、利用していません。以下記事ご参考いただければと思います。</p>
<a href="https://kenzo0107.github.io/2019/04/17/2019-04-17-terraform-2019-workspace/" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20190417/20190417103456.png"></div><div class="descriptions"><div class="og-title">Terraform 運用ベストプラクティス 2019 ~workspace をやめてみた等諸々~</div><div class="og-description">以前 terraform で workspace 毎に tfstate 管理する方法を執筆しましたが、実運用上いくつかの問題がありました。 結論、現在は workspace 運用をやめています。  terraform workspace で環境毎に tfsate 管理terraf…</div></div></div></a>

<h2><span id="概要">概要</span></h2><p>Terraform tfstate の管理をかつて<br>0.8 系では <code>-backend-config</code> でせっせと環境(stg,prod) 毎に bucket を変えて、<br>なんてコードを見てきました。</p>
<p>ですが、<br>workspace で 1つの bucket に 環境毎に保管できる様になりました。</p>
<p>厳密には環境毎でなくとも<br>リソースの集合毎、module 毎等で管理するイメージですが</p>
<p>今回はイメージを捉えやすく環境毎で分けました。</p>
<h2><span id="歴史">歴史</span></h2><ul>
<li>0.5 で S3 で管理、</li>
<li>&lt; 0.9 では、 remote config で管理場所を設定</li>
<li><blockquote>
<p>= 0.9 では、terraform workspace で同一ディレクトリで複数のリソース群を管理</p>
</blockquote>
</li>
</ul>
<p>とより利用しやすくなりました。</p>
<h2><span id="前提">前提</span></h2><p>以下条件とします。</p>
<ul>
<li>tfstate は backend.tf で s3 管理</li>
</ul>
<h2><span id="移行手順">移行手順</span></h2><h3><span id="既存-terraform-で-tfstate-確認">既存 terraform で tfstate 確認</span></h3><ul>
<li>想定の実行計画通りか確認します。</li>
<li>異なる場合は、そもそも現環境と差分が生じている、及び、tfstate が正しく取得できていない等、問題ありなのでそちらを修正します。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br></pre></td></tr></table></figure>

<h3><span id="tfstate-ファイル取得">tfstate ファイル取得</span></h3><p>local に terraform.tfstate を取得します。<br>中身を確認してリソースの設定がある程度問題ないか確認しておきます。</p>
<ul>
<li>0.8 系</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ terraform remote config \</span><br><span class="line">-backend&#x3D;s3 \</span><br><span class="line">-backend-config&#x3D;&quot;bucket&#x3D;tfstate.bucket&quot; \</span><br><span class="line">-backend-config&#x3D;&quot;key&#x3D;terraform.tfstate&quot; \</span><br><span class="line">-backend-config&#x3D;&quot;region&#x3D;ap-northeast-1&quot; \</span><br><span class="line">-backend-config&#x3D;&quot;profile&#x3D;aws-hogehoge&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>0.9 系以降</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ terraform state pull &gt; terraform.tfstate</span><br></pre></td></tr></table></figure>

<h3><span id="terraform-011x-2017年12月現在最新-へバージョンアップ">terraform 0.11.x (2017年12月現在最新) へバージョンアップ</span></h3><p>Homebrew ならば upgrade で！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ brew upgrade terraform</span><br></pre></td></tr></table></figure>

<h3><span id="state-管理を-backenttf-で記述">state 管理を backent.tf で記述</span></h3><p>既にこの様に設定されている方はスキップです。特に普遍的な書き方です。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  backend &quot;s3&quot; &#123;</span><br><span class="line">      bucket  &#x3D; &quot;tfstate.bucket&quot;</span><br><span class="line">      key        &#x3D; &quot;terraform.tfstate&quot;</span><br><span class="line">      region   &#x3D; &quot;ap-northeast-1&quot;</span><br><span class="line">      encrypt &#x3D; true</span><br><span class="line">      profile   &#x3D; &quot;aws-hogehoge&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="workspace-作成">Workspace 作成</span></h2><ul>
<li>Workspace <code>stg</code> 作成</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace new stg</span><br></pre></td></tr></table></figure>

<ul>
<li>workspace リスト一覧</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace list</span><br><span class="line">  default</span><br><span class="line">* stg</span><br></pre></td></tr></table></figure>

<h2><span id="tfstate-を-push">tfstate を push</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state push -force .terraform&#x2F;terraform.tfstate</span><br></pre></td></tr></table></figure>

<p>これで S3 <code>tfstate.bucket</code> の <code>env:/stg/</code> ディレクトリ以下に terraform.tfstate が push されました。<br>実際に S3 を見て確認してみてください。</p>
<p>[f:id:kenzo0107:20171205213108p:plain]</p>
<p><code>env</code> でなく <code>env:</code> なのが肝です。</p>
<h2><span id="実行計画確認">実行計画確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br></pre></td></tr></table></figure>

<p>想定の実行計画通りか確認して問題なければ移行完了です。</p>
<h2><span id="おまけ">おまけ</span></h2><p>terraform を指定したバージョンで実行するには<br>one-off Container で実行できる様に Makefile でラップする、<br>が今の所自分の中のベストプラクティスです。</p>
<p>これによって local 環境に依存せず指定したバージョンの terraform 実行が可能となります。</p>
<h4><span id="one-off-container-とは">one-off Container とは</span></h4><p>one-off Container は Docker コンテナを <code>run --rm</code> で1度のコマンド実行の為だけに起動する手法です。</p>
<p>Makefile で Docker コマンドをラップしておくと<br><code>TERRAFORM_VERSION</code> を変更するだけで<br>指定の terraform バージョンを利用できます。</p>
<p>以下は 0.11.1 の例です。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">TERRAFORM_VERSION&#x3D;0.11.1</span><br><span class="line"></span><br><span class="line">DOCKER&#x3D;docker run --rm -v ~&#x2F;.ssh:&#x2F;root&#x2F;.ssh:ro -v ~&#x2F;.aws:&#x2F;root&#x2F;.aws:ro -v $&#123;PWD&#125;:&#x2F;work -w &#x2F;work hashicorp&#x2F;terraform:$&#123;TERRAFORM_VERSION&#125;</span><br><span class="line"></span><br><span class="line">$(eval ENV :&#x3D; $(shell $&#123;DOCKER&#125; workspace show))</span><br><span class="line"></span><br><span class="line">ifeq ($&#123;ENV&#125;, default)</span><br><span class="line">$(error select workspace ! ex: make init ENV&#x3D;&lt;stg|prod&gt;)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">default: init</span><br><span class="line"></span><br><span class="line">init:</span><br><span class="line">	# tfstate ファイル初期化</span><br><span class="line">	$&#123;DOCKER&#125; init</span><br><span class="line">	# workspace 作成. &quot;; true&quot; は既に作成済みエラーをスキップする為</span><br><span class="line">	$&#123;DOCKER&#125; workspace new $&#123;ENV&#125;; true</span><br><span class="line">	# 作成した workspace を選択</span><br><span class="line">	$&#123;DOCKER&#125; workspace select $&#123;ENV&#125;</span><br><span class="line">	# 作成した workspace の tfstate ファイルを同期</span><br><span class="line">	$&#123;DOCKER&#125; init</span><br><span class="line"></span><br><span class="line">plan:</span><br><span class="line">	$&#123;DOCKER&#125; plan</span><br><span class="line"></span><br><span class="line">apply</span><br><span class="line">	$&#123;DOCKER&#125; apply -auto-approve</span><br></pre></td></tr></table></figure>

<ul>
<li><code>make init ENV=stg</code> 実行で以下まとめてました<ul>
<li>tfstate 初期化</li>
<li>workspace <code>stg</code> 作成</li>
<li>選択したworkspace の tfstate で初期化</li>
</ul>
</li>
</ul>
<p>きっとさらに素敵なベストプラクティスがあれば教えてください！</p>
<p>参考になれば幸いです。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-11-22T15:00:00.000Z" title="2017-11-22T15:00:00.000Z">2017-11-23</time><span class="level-item">5分 read (About 680 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/22/2017-11-23-slack-dm-pullrequest-or-issue-comment-by-Hubot/">Hubot で Git の Pull Request や Issue のコメントのメンション相手に Slack DM で通知</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Git での Pull Request や Issue コメントのメンションがメール通知で気づけず困った！<br>という声を多く聞き、メンション相手に Slack DM を通知する様な仕組みを作りました。</p>
<h2><span id="システム概要">システム概要</span></h2><p>今回は AWS 上に構築しました。</p>
<ul>
<li>Git は GHE on EC2<ul>
<li>github.com の場合だと、IP 定まらない問題があるかと思うので、動的に IP を取得して解放させる様な仕組みを入れる必要がありそう。</li>
</ul>
</li>
<li>hubot は t2.nano と最小<ul>
<li>当初、IBM Bluemix で構築してみましたが、サポートから IP 制限はまだできていない、とのことなので on AWS にしました。</li>
</ul>
</li>
<li>GHE からの hubot の受け口は ELB で EIP のみ許可させてます。<ul>
<li>今後、受け口を色々作る目的で ELB 立てました。</li>
<li>元々は JIRA のメンションを Slack DM に送るだけの目的だったので 同一 Private Subnet に置いてました。</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/lAlhMpW.png"></p>
<h2><span id="スクリプト">スクリプト</span></h2><ul>
<li>getSlackUsernameByGitUsername<ul>
<li>基本 git name と slack name は命名規則が統一されていたので正規表現で変換させる様に解決しています。</li>
<li>git name: kenzo-tanaka だったら slack name: kenzo.tanaka に変換</li>
<li>命名規則に即していないユーザは以下の <code>users</code> リストに変換を任せます。<ul>
<li><code>kimika.himura</code> は DM 送られたくないと言う人を想定してます。</li>
</ul>
</li>
</ul>
</li>
<li>依存ライブラリ<ul>
<li>  “hubot-slack”: “^4.4.0”</li>
<li>  “hubot-slack-attachement”: “^1.0.1”</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">users &#x3D; &#123;</span><br><span class="line">    &quot;kenzo-tanaka&quot;: &quot;kenzo0107&quot;,</span><br><span class="line">    &quot;kimika.himura&quot;: &quot;no_send&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ソース全容は以下になります。</p>
<script src="//gist.github.com/kenzo0107/d9f3618633d0243453bae7ab5ef5a1dd.js"></script>


<h2><span id="git-設定">Git 設定</span></h2><p>設定したい Organization or Owner &gt; Settings &gt; Hooks で hubot への URL を設定します。((Organization 跨いで一気に全部のリポジトリにHookかけるのは別途スクリプト組むなりしないと難しそう。GitHub社も Organization は 1つとすることを推奨とのことなので今回はこれで！))</p>
<p>その他設定</p>
<ul>
<li>Content type: <code>application/json</code></li>
<li>Let me select individual events:<ul>
<li>Issues</li>
<li>Issue comment</li>
<li>Pull request</li>
<li>Pull request review</li>
<li>Pull request review comment</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/6lBkFAL.png"></p>
<p>※ よりセキュアにする際には Secret 設定してください。</p>
<h2><span id="通知が来た">通知が来た！</span></h2><p>早速 Pull Request でメンションしてみたら通知が来ました！<br>絵文字もしっかり！<br>URL も自動でリンクされている！</p>
<p><img src="https://i.imgur.com/5sxmFVO.png"></p>
<p>以上、参考になれば幸いです♪</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/11/12/2017-11-13-prometheus-remote-storage/"><img class="thumbnail" src="https://i.imgur.com/zFciewX.png" alt="Prometheus2.0 remote storage 検証"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-11-12T15:00:00.000Z" title="2017-11-12T15:00:00.000Z">2017-11-13</time><span class="level-item">8分 read (About 1165 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/12/2017-11-13-prometheus-remote-storage/">Prometheus2.0 remote storage 検証</a></h1><div class="content"><p>いよいよ出ました Prometheus 2.0 ！</p>
<p><a href="https://prometheus.io/blog/2017/11/08/announcing-prometheus-2-0/">Announcing Prometheus 2.0 | Prometheus</a></p>
<p>先日<a href="https://mackerel-ug.connpass.com/event/68478/">モニタリング勉強会</a>でも Paul Taylor さんの LT を拝聴させて頂き<br>パフォーマンス向上とストレージフォーマット変更による圧縮・バックアップがしやすくなった等、<br>良い話がたくさん出ていました。</p>
<p><a href="https://www.slideshare.net/PaulTraylor/20171027-81281205">Operating Prometheus</a></p>
<p>中でも最も期待していた機能が Remote Long-Term Storage、<br>長期保存機能には歓喜しました♪</p>
<p>1系以下では、短期間用と長期間用の Prometheus を別途用意する等、対策が必要で<br>冗長な作りを余儀なくされたところがありましたが<br>2.0 リリースでついに！</p>
<p>早速試してみたく使用感をまとめました。</p>
<h2><span id="今回やりたかったことまとめ">今回やりたかったことまとめ</span></h2><ul>
<li>Prometheus 2.0 リリースに際して期待の長期保存機能 (Remote long-term storage) を早速試す！</li>
<li>実際にローカル環境で構築してみて1系からの変更箇所を確認</li>
<li>DB 側にどんなデータが入るのか確認</li>
</ul>
<h2><span id="システム概要">システム概要</span></h2><p>あくまで使用感の検証をしたかったので docker-compose でお手軽に作れる環境にしました。</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/zFciewX.png" width="100%">
</div>

<h2><span id="前提条件">前提条件</span></h2><p>以下を Vagrant にインストール</p>
<ul>
<li>Ubuntu 16.04.3 LTS \n \l</li>
<li>Docker version 17.09.0-ce, build afdb6d4</li>
<li>docker-compose version 1.12.0, build b31ff33</li>
</ul>
<h2><span id="起動する-docker-container">起動する Docker Container</span></h2><ul>
<li>Prometheus 2.0.0</li>
<li>Node Exporter 0.15.1</li>
<li>AlertManager 0.9.1</li>
<li>cAdvisor 0.28.0</li>
<li>Prometheu Adapter</li>
<li>PostgreSQL 9.6.3</li>
<li>Grafana 4.6.1</li>
<li>Nginx 1.13.6</li>
<li>Adminer</li>
</ul>
<h2><span id="使い方">使い方</span></h2><p>以下手順通りです。</p>
<p><a href="https://github.com/kenzo0107/vagrant-docker/tree/vagrant-docker-ubuntu16.04/docker/prometheus-grafana-on-ubuntu">kenzo0107/vagrant-docker/tree/vagrant-docker-ubuntu16.04/docker/prometheus-grafana-on-ubuntu</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/vagrant-docker</span><br><span class="line">macOS%$ <span class="built_in">cd</span> vagrant-docker</span><br><span class="line">macOS%$ vagrant up</span><br><span class="line"></span><br><span class="line">// Install docker, docker-compose</span><br><span class="line">macOS%$ vagrant provision</span><br><span class="line">macOS%$ vagrant ssh</span><br><span class="line">vagrant%$ <span class="built_in">cd</span> /vagrant/prometheus-grafana-on-ubuntu</span><br><span class="line">vagrant%$ sudo docker-compose up -d</span><br><span class="line"></span><br><span class="line">Name                             Command                            State                             Ports</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">adapter                           /prometheus-postgresql-ada ...    Up</span><br><span class="line">adminer                           entrypoint.sh docker-php<span class="_">-e</span> ...    Up                                8080/tcp</span><br><span class="line">alertmanager                      /bin/alertmanager -config. ...    Up                                9093/tcp</span><br><span class="line">cadvisor                          /usr/bin/cadvisor -logtost ...    Up                                8080/tcp</span><br><span class="line">grafana                           /run.sh                           Up                                3000/tcp</span><br><span class="line">nginx                             nginx -g daemon off;              Up                                0.0.0.0:18080-&gt;18080/tcp,</span><br><span class="line">                                                                                         0.0.0.0:3000-&gt;3000/tcp, 80/tcp,</span><br><span class="line">                                                                                         0.0.0.0:8080-&gt;8080/tcp,</span><br><span class="line">                                                                                         0.0.0.0:9090-&gt;9090/tcp</span><br><span class="line">node-exporter                     /bin/node_exporter                Up                                9100/tcp</span><br><span class="line">pgsql                             docker-entrypoint.sh -csyn ...    Up                                5432/tcp</span><br><span class="line">prometheus                        /bin/prometheus --config.f ...    Up                                9090/tcp</span><br></pre></td></tr></table></figure>

<h2><span id="アクセスしてみる">アクセスしてみる</span></h2><h3><span id="prometheus">Prometheus</span></h3><ul>
<li><a href="http://192.168.35.101:9090/">http://192.168.35.101:9090</a>.</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/rg53Xa1.png" width="100%">
</div>

<h3><span id="grafana">Grafana</span></h3><ul>
<li><a href="http://192.168.35.101:13000/">http://192.168.35.101:13000</a>.</li>
<li>ユーザアカウントが <code>./grafana/env</code> にあります.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GF_SECURITY_ADMIN_USER=admin-user</span><br><span class="line">GF_SECURITY_ADMIN_PASSWORD=admin-pass</span><br></pre></td></tr></table></figure>

<div style="text-align:center;">
<img src="https://i.imgur.com/fDXVySw.png" width="100%">
</div>

<ul>
<li>Datasource 設定</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/8SKvdxJ.png" width="100%">
</div>

<p>Datasource 設定フォームに以下情報を入力し <code>Add</code> ボタンをクリックします。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>Prometheus</td>
</tr>
<tr>
<td>Type</td>
<td>Prometheus</td>
</tr>
<tr>
<td>URL</td>
<td><a href="http://prometheus:9090/">http://prometheus:9090</a></td>
</tr>
<tr>
<td>Access</td>
<td>proxy</td>
</tr>
</tbody></table>
<div style="text-align:center;">
<img src="https://i.imgur.com/6Cr4WTn.png" width="100%">
</div>

<ul>
<li>Dashboard.json インポート</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/cew58vF.png" width="100%">
</div>

<p>グラフが表示されます。</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/IicXL5e.png" width="100%">
</div>


<h3><span id="cadvisor">cAdvisor</span></h3><ul>
<li><a href="http://192.168.35.101:8080/">http://192.168.35.101:8080</a>.</li>
</ul>
<div style="text-align:center;">
<img src="https://i.imgur.com/ZDH3zmI.png" width="100%">
</div>

<h2><span id="adminer">Adminer</span></h2><div style="text-align:center;">
<img src="https://i.imgur.com/uWT7sDC.png" width="100%">
</div>

<p>ログインフォームに以下情報を入力します。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Server</td>
<td>pgsql</td>
</tr>
<tr>
<td>Username</td>
<td>prometheus</td>
</tr>
<tr>
<td>Password</td>
<td>password</td>
</tr>
<tr>
<td>Database</td>
<td>postgres</td>
</tr>
</tbody></table>
<ul>
<li>PostgreSQL に保存されているメトリクス情報が確認できます。</li>
</ul>
<p>PostgreSQL &gt;&gt; pgsql &gt;&gt; postgres &gt;&gt; prometheus &gt;&gt; Select: metrics</p>
<div style="text-align:center;">
<img src="https://i.imgur.com/cyPrvqC.png" width="100%">
</div>


<h2><span id="alertmanager-でアラート通知してみる">AlertManager でアラート通知してみる</span></h2><p>例として node-exporter を停止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo docker-compose stop node-exporter</span><br></pre></td></tr></table></figure>

<p><code>./alertmanager/config.yml</code> で設定した Slack Channel にちゃんと通知がきました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171113/20171113021331.png" width="100%">
</div>


<h2><span id="所感">所感</span></h2><ul>
<li><p>2.0 になって設定の仕方が諸々変わり、公式サイトじっくり見る必要あります。</p>
<ul>
<li>と思ったら、早速まとめ出てました！ありがとうございます！<ul>
<li><a href="https://qiita.com/tkusumi/items/293174826a8a5d47d186">Prometheus 2.0 の変更点と移行</a></li>
</ul>
</li>
</ul>
</li>
<li><p>今回は Prometheus ×1 台構成ですが、2台以上で冗長化する構成も試してみたい。</p>
</li>
</ul>
<h2><span id="余談">余談</span></h2><ul>
<li>バグなのか google/cadvisor で検出するメトリクスが重複表示されて grafana で絞るのに困りました。<ul>
<li>Issue これ？<ul>
<li><a href="https://github.com/google/cadvisor/issues/1704">Inconsistent container metrics in prometheus route #1704</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><span id="あとがき">あとがき</span></h2><p>Mackerel の様なマネージドな監視サービスで運用コストを削減する以上に<br>Prometheus をマネージドすれば、さらにトータルコストを抑えられる様になる、<br>と睨んでます。</p>
<p>ですが、Datadog は APM 付きプランも適度なコスト感で提供しておりマネージドサービスの魅力は尚大きいです。</p>
<p>モニタリングの棲み分けをできる様にするにも、<br>選択肢の一つにするにも Prometheus 挑戦しがいがあるのでは？<br>と思っています。</p>
<p>Prometheus、今後さらに広まることを期待しています。</p>
<h2><span id="参考">参考</span></h2><ul>
<li><a href="https://prometheus.io/docs/prometheus/2.0/configuration/configuration/">Configuration | Prometheus</a></li>
<li><a href="https://github.com/prometheus/prometheus/blob/release-2.0/config/testdata/conf.good.yml">prometheus/config/testdata/conf.good.yml</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-11-07T15:00:00.000Z" title="2017-11-07T15:00:00.000Z">2017-11-08</time><span class="level-item">6分 read (About 879 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/07/2017-11-08-iftop/">iftop でネットワーク接続状況をリアルタイム監視</a></h1><div class="content"><h2><span id="iftop-概要">iftop 概要</span></h2><p>CLI上で利用できるネットワークの接続状況をリアルモニタリングするツールです。<br>→ ネットワークのボトルネックを特定する為に利用します。</p>
<p>単にネットワークのモニタリングであれば、モニタリングツールで良いですが</p>
<p>具体的にどこ（ドメイン・IP・ポート）にどれくらい（データ転送量）がわかります。</p>
<h2><span id="インストール方法">インストール方法</span></h2><ul>
<li>Ubuntu</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y iftop</span><br></pre></td></tr></table></figure>

<ul>
<li>CentOS</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum -y install epel-release</span><br><span class="line">$ sudo yum -y install iftop</span><br></pre></td></tr></table></figure>

<h2><span id="使い方">使い方</span></h2><p>よく利用するのはこんな形です。<br>※eth0 がない場合は <code>-i eth0</code> を除いてください。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iftop -i eth0 -B -P -n -N</span><br></pre></td></tr></table></figure>

<ul>
<li>-i インターフェース指定</li>
<li>-B 表示単位を Byte にする</li>
<li>-P プロトコル or ポート表示</li>
<li>-n ドメインでなく ip で表示</li>
<li>-N プロトコルサービス名でなくポート番号で表示</li>
</ul>
<h3><span id="表示項目">表示項目</span></h3><p><code>=&gt;</code> が送信、<br><code>&lt;=</code> が受信です</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">                           24.4kB                      48.8kB                      73.2kB                      97.7kB                 122kB</span><br><span class="line">+--------------------------+---------------------------+---------------------------+---------------------------+---------------------------</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-100-41.ap-northeast-1.compute.internal:62635     559kB   121kB  67.1kB</span><br><span class="line">                                                        &lt;=                                                          3.60kB  1.90kB  1.05kB</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:35244     =&gt; ip-10-13-102-56.ap-northeast-1.compute.internal:mysql       0B   2.18kB  1.21kB</span><br><span class="line">                                                        &lt;=                                                             0B   23.1kB  12.8kB</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:35247     =&gt; ip-10-13-102-56.ap-northeast-1.compute.internal:mysql       0B   2.13kB  1.18kB</span><br><span class="line">                                                        &lt;=                                                             0B   23.0kB  12.8kB</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-0-231.ap-northeast-1.compute.internal:8239         0B   7.73kB  4.29kB</span><br><span class="line">                                                        &lt;=                                                             0B   1.16kB   658B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:ssh       =&gt; ip-10-13-0-11.ap-northeast-1.compute.internal:56320       612B    576B    522B</span><br><span class="line">                                                        &lt;=                                                            26B     26B     32B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-100-41.ap-northeast-1.compute.internal:62657       0B     49B     27B</span><br><span class="line">                                                        &lt;=                                                             0B     92B     51B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:40069     =&gt; ip-10-13-103-247.ap-northeast-1.compute.internal:6379       0B     99B     55B</span><br><span class="line">                                                        &lt;=                                                             0B     34B     19B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:40072     =&gt; ip-10-13-103-247.ap-northeast-1.compute.internal:6379       0B     99B     55B</span><br><span class="line">                                                        &lt;=                                                             0B     34B     19B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-100-73.ap-northeast-1.compute.internal:27698       0B     44B     25B</span><br><span class="line">                                                        &lt;=                                                             0B     33B     18B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:53696     =&gt; ip-10-13-0-2.ap-northeast-1.compute.internal:domain         0B     21B     12B</span><br><span class="line">                                                        &lt;=                                                             0B     31B     17B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:41975     =&gt; ip-10-13-0-2.ap-northeast-1.compute.internal:domain         0B     21B     12B</span><br><span class="line">                                                        &lt;=                                                             0B     31B     17B</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">TX:             cum:   1.31MB   peak:    560kB                                                             rates:    560kB   134kB  74.7kB</span><br><span class="line">RX:                     505kB            117kB                                                                      3.69kB  49.8kB  28.1kB</span><br><span class="line">TOTAL:                 1.81MB            564kB                                                                       564kB   184kB   103kB</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>TX (Transmitter)</td>
<td>送信量</td>
</tr>
<tr>
<td>RX (Receiver)</td>
<td>受信量</td>
</tr>
<tr>
<td>TOTAL</td>
<td>iftop 起動からの総量</td>
</tr>
<tr>
<td>cum</td>
<td>総量</td>
</tr>
<tr>
<td>peak</td>
<td>最大</td>
</tr>
<tr>
<td>右端3列 (各トラフィック, rates含む)</td>
<td>2秒、10秒、40秒の転送量平均値</td>
</tr>
</tbody></table>
<p>※TX,RX の 「X」 は省略しますよという意味</p>
<p>閲覧し続けると気になる処理があった時には<br><code>Shift + P</code> で一旦停止させます。</p>
<p>もう一度開始したい場合は <code>Shift + P</code> です。</p>
<h2><span id="実際のcli">実際のCLI</span></h2><p>以下見ていただくと白い帯グラフが左から伸びているのが見えるかと思います。<br>この横棒が一番上のバーの目盛りに相応してぱっと見でどの程度かわかるのが便利です。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171109/20171109011640.png" width="100%">
</div>

<h2><span id="db-への接続を確かめる">DB への接続を確かめる</span></h2><p>DB (MySQL) のデフォルトポート 3306 への送受信を調べたいとき</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iftop -B -P -n -N -f &quot;port 3306&quot;</span><br></pre></td></tr></table></figure>

<p>当然ながら受信の方が大きいです。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171109/20171109120917.png" width="100%">
</div>

<h2><span id="補足">補足</span></h2><p>実際に負荷が高い時等、特定のインシデントがあった際に追記していこうと思います♪</p>
<h2><span id="reference">Reference</span></h2><ul>
<li><a href="http://blog.father.gedow.net/2017/10/17/middleware-benchmark/">ミドルウェア性能検証の手引き</a></li>
<li><a href="https://blog.bitmeister.jp/?p=3930">Linux上でネットワークの帯域制限と遅延を設定する</a></li>
<li><a href="http://labs.gree.jp/blog/2014/10/11288/">Linux TC (帯域制御、帯域保証) 設定ガイドライン</a></li>
</ul>
</div></article></div><nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/8/">前</a></div><div class="pagination-next"><a href="/page/10/">次</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/8/">8</a></li><li><a class="pagination-link is-current" href="/page/9/">9</a></li><li><a class="pagination-link" href="/page/10/">10</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/30/">30</a></li></ul></nav></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="kenzo0107"></figure><p class="title is-size-4 is-block line-height-inherit">kenzo0107</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">投稿</p><a href="/archives"><p class="title">292</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">カテゴリ</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">タグ</p><a href="/tags"><p class="title">88</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/kenzo0107" target="_blank" rel="noopener">フォローする</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/kenzo0107"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">カテゴリ</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AWS/"><span class="level-start"><span class="level-item">AWS</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DIY/"><span class="level-start"><span class="level-item">DIY</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Go/"><span class="level-start"><span class="level-item">Go</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/RaspberryPI/"><span class="level-start"><span class="level-item">RaspberryPI</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Terraform/"><span class="level-start"><span class="level-item">Terraform</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最近の記事</h3><article class="media"><a class="media-left" href="/2021/11/10/2021-11-11-diy-for-beginner/"><p class="image is-64x64"><img class="thumbnail" src="https://i.imgur.com/bikkvFS.jpg" alt="DIY 初心者の工具選び"></p></a><div class="media-content size-small"><p><time dateTime="2021-11-10T15:00:00.000Z">2021-11-11</time></p><p class="title is-6"><a class="link-muted" href="/2021/11/10/2021-11-11-diy-for-beginner/">DIY 初心者の工具選び</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/DIY/">DIY</a></p></div></article><article class="media"><a class="media-left" href="/2021/11/04/2021-11-05-find-public-s3-objects/"><p class="image is-64x64"><img class="thumbnail" src="https://i.imgur.com/ZskUBGT.png" alt="公開された S3 Objcet を探せ！"></p></a><div class="media-content size-small"><p><time dateTime="2021-11-04T15:00:00.000Z">2021-11-05</time></p><p class="title is-6"><a class="link-muted" href="/2021/11/04/2021-11-05-find-public-s3-objects/">公開された S3 Objcet を探せ！</a></p><p class="is-uppercase"></p></div></article><article class="media"><a class="media-left" href="/2021/11/03/2021-11-04-cloudfront-logdelivery/"><p class="image is-64x64"><img class="thumbnail" src="https://i.imgur.com/SK23gOy.png" alt="ログ保存用 S3 Bucket の ACL で CloudFront や他 S3 Bucket のアクセスログを保存許可する"></p></a><div class="media-content size-small"><p><time dateTime="2021-11-03T15:00:00.000Z">2021-11-04</time></p><p class="title is-6"><a class="link-muted" href="/2021/11/03/2021-11-04-cloudfront-logdelivery/">ログ保存用 S3 Bucket の ACL で CloudFront や他 S3 Bucket のアクセスログを保存許可する</a></p><p class="is-uppercase"></p></div></article><article class="media"><a class="media-left" href="/2021/10/19/2021-10-20-aws-transfer-for-sftp/"><p class="image is-64x64"><img class="thumbnail" src="https://i.imgur.com/hgb10nC.png" alt="AWS Transfer for sftp + S3 で IP 制限付き sftp サーバ構築"></p></a><div class="media-content size-small"><p><time dateTime="2021-10-19T15:00:00.000Z">2021-10-20</time></p><p class="title is-6"><a class="link-muted" href="/2021/10/19/2021-10-20-aws-transfer-for-sftp/">AWS Transfer for sftp + S3 で IP 制限付き sftp サーバ構築</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/AWS/">AWS</a></p></div></article><article class="media"><a class="media-left" href="/2021/10/19/2021-10-20-datadogapi-get-user-id/"><p class="image is-64x64"><img class="thumbnail" src="https://imgix.datadoghq.com/img/about/presskit/usage/logousage_white.png?auto=format&amp;fit=max&amp;w=847" alt="curl で Datadog ユーザ ID リスト取得"></p></a><div class="media-content size-small"><p><time dateTime="2021-10-19T15:00:00.000Z">2021-10-20</time></p><p class="title is-6"><a class="link-muted" href="/2021/10/19/2021-10-20-datadogapi-get-user-id/">curl で Datadog ユーザ ID リスト取得</a></p><p class="is-uppercase"></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">タグ</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/htaccess/"><span class="tag">.htaccess</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ALB/"><span class="tag">ALB</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AWS/"><span class="tag">AWS</span><span class="tag is-grey-lightest">43</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AntiVirus/"><span class="tag">AntiVirus</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apache/"><span class="tag">Apache</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chef/"><span class="tag">Chef</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CodeBuild/"><span class="tag">CodeBuild</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cookie/"><span class="tag">Cookie</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Corosync/"><span class="tag">Corosync</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Datadog/"><span class="tag">Datadog</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECR/"><span class="tag">ECR</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECS/"><span class="tag">ECS</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElastiCache/"><span class="tag">ElastiCache</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Elasticsearch/"><span class="tag">Elasticsearch</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Email/"><span class="tag">Email</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FTPS/"><span class="tag">FTPS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fluentd/"><span class="tag">Fluentd</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GKE/"><span class="tag">GKE</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GitHub-Actions/"><span class="tag">GitHub Actions</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">24</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GooglePlay/"><span class="tag">GooglePlay</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hubot/"><span class="tag">Hubot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jenkins/"><span class="tag">Jenkins</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kibana/"><span class="tag">Kibana</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LINE-Notify/"><span class="tag">LINE Notify</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Lambda/"><span class="tag">Lambda</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Let-s-encrypt/"><span class="tag">Let&#039;s encrypt</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MachineLearning/"><span class="tag">MachineLearning</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Monitoring/"><span class="tag">Monitoring</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag is-grey-lightest">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenSSL/"><span class="tag">OpenSSL</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Outlook/"><span class="tag">Outlook</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP/"><span class="tag">PHP</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pacemaker/"><span class="tag">Pacemaker</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ProxySQL/"><span class="tag">ProxySQL</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Puppeteer/"><span class="tag">Puppeteer</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rails/"><span class="tag">Rails</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RaspberryPI/"><span class="tag">RaspberryPI</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reactio/"><span class="tag">Reactio</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ruby/"><span class="tag">Ruby</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/S3/"><span class="tag">S3</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSL/"><span class="tag">SSL</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Security/"><span class="tag">Security</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SendGrid/"><span class="tag">SendGrid</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Slack/"><span class="tag">Slack</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SonarQube/"><span class="tag">SonarQube</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/StatsBot/"><span class="tag">StatsBot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Terraform/"><span class="tag">Terraform</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Twilio/"><span class="tag">Twilio</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Unity/"><span class="tag">Unity</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vagrant/"><span class="tag">Vagrant</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vault/"><span class="tag">Vault</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WAF/"><span class="tag">WAF</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zabbix/"><span class="tag">Zabbix</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/awk/"><span class="tag">awk</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/casperjs/"><span class="tag">casperjs</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu/"><span class="tag">cpu</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/csv/"><span class="tag">csv</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flask/"><span class="tag">flask</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/i-node/"><span class="tag">i-node</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iftop/"><span class="tag">iftop</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ipinfo/"><span class="tag">ipinfo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iptable/"><span class="tag">iptable</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kibana/"><span class="tag">kibana</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macos/"><span class="tag">macos</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/no-ip/"><span class="tag">no-ip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ping/"><span class="tag">ping</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pip/"><span class="tag">pip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reCAPTCHA/"><span class="tag">reCAPTCHA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sftp/"><span class="tag">sftp</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spam/"><span class="tag">spam</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vim/"><span class="tag">vim</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wget/"><span class="tag">wget</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/yum/"><span class="tag">yum</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zsh/"><span class="tag">zsh</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6265337967545472" data-ad-slot="9975280607" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a><p class="size-small"><span>&copy; 2021 Kenzo Tanaka</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("ja");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://kenzo0107.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: ''
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Zurück nach oben" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"投稿","pages":"Pages","categories":"カテゴリ","tags":"タグ"});
        });</script></body></html>