<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>長生村本郷Engineers&#039;Blog</title><meta description="tech"><meta property="og:type" content="blog"><meta property="og:title" content="長生村本郷Engineers&#039;Blog"><meta property="og:url" content="https://kenzo0107.github.io/"><meta property="og:site_name" content="長生村本郷Engineers&#039;Blog"><meta property="og:description" content="tech"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://kenzo0107.github.io/img/og_image.png"><meta property="article:author" content="Kenzo Tanaka"><meta property="article:tag" content="aws golang"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kenzo0107.github.io"},"headline":"長生村本郷Engineers'Blog","image":["https://kenzo0107.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Kenzo Tanaka"},"description":"tech"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-162026478-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-162026478-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="ca-pub-6265337967545472" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/2013/12/31/PrivacyPolicy/">PrivacyPolicy</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-11-07T15:00:00.000Z" title="2017-11-07T15:00:00.000Z">2017-11-08</time><span class="level-item">6分 read (About 879 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/07/2017-11-08-iftop/">iftop でネットワーク接続状況をリアルタイム監視</a></h1><div class="content"><h2><span id="iftop-概要">iftop 概要</span></h2><p>CLI上で利用できるネットワークの接続状況をリアルモニタリングするツールです。<br>→ ネットワークのボトルネックを特定する為に利用します。</p>
<p>単にネットワークのモニタリングであれば、モニタリングツールで良いですが</p>
<p>具体的にどこ（ドメイン・IP・ポート）にどれくらい（データ転送量）がわかります。</p>
<h2><span id="インストール方法">インストール方法</span></h2><ul>
<li>Ubuntu</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y iftop</span><br></pre></td></tr></table></figure>

<ul>
<li>CentOS</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum -y install epel-release</span><br><span class="line">$ sudo yum -y install iftop</span><br></pre></td></tr></table></figure>

<h2><span id="使い方">使い方</span></h2><p>よく利用するのはこんな形です。<br>※eth0 がない場合は <code>-i eth0</code> を除いてください。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iftop -i eth0 -B -P -n -N</span><br></pre></td></tr></table></figure>

<ul>
<li>-i インターフェース指定</li>
<li>-B 表示単位を Byte にする</li>
<li>-P プロトコル or ポート表示</li>
<li>-n ドメインでなく ip で表示</li>
<li>-N プロトコルサービス名でなくポート番号で表示</li>
</ul>
<h3><span id="表示項目">表示項目</span></h3><p><code>=&gt;</code> が送信、<br><code>&lt;=</code> が受信です</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">                           24.4kB                      48.8kB                      73.2kB                      97.7kB                 122kB</span><br><span class="line">+--------------------------+---------------------------+---------------------------+---------------------------+---------------------------</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-100-41.ap-northeast-1.compute.internal:62635     559kB   121kB  67.1kB</span><br><span class="line">                                                        &lt;=                                                          3.60kB  1.90kB  1.05kB</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:35244     =&gt; ip-10-13-102-56.ap-northeast-1.compute.internal:mysql       0B   2.18kB  1.21kB</span><br><span class="line">                                                        &lt;=                                                             0B   23.1kB  12.8kB</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:35247     =&gt; ip-10-13-102-56.ap-northeast-1.compute.internal:mysql       0B   2.13kB  1.18kB</span><br><span class="line">                                                        &lt;=                                                             0B   23.0kB  12.8kB</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-0-231.ap-northeast-1.compute.internal:8239         0B   7.73kB  4.29kB</span><br><span class="line">                                                        &lt;=                                                             0B   1.16kB   658B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:ssh       =&gt; ip-10-13-0-11.ap-northeast-1.compute.internal:56320       612B    576B    522B</span><br><span class="line">                                                        &lt;=                                                            26B     26B     32B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-100-41.ap-northeast-1.compute.internal:62657       0B     49B     27B</span><br><span class="line">                                                        &lt;=                                                             0B     92B     51B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:40069     =&gt; ip-10-13-103-247.ap-northeast-1.compute.internal:6379       0B     99B     55B</span><br><span class="line">                                                        &lt;=                                                             0B     34B     19B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:40072     =&gt; ip-10-13-103-247.ap-northeast-1.compute.internal:6379       0B     99B     55B</span><br><span class="line">                                                        &lt;=                                                             0B     34B     19B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:http      =&gt; ip-10-13-100-73.ap-northeast-1.compute.internal:27698       0B     44B     25B</span><br><span class="line">                                                        &lt;=                                                             0B     33B     18B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:53696     =&gt; ip-10-13-0-2.ap-northeast-1.compute.internal:domain         0B     21B     12B</span><br><span class="line">                                                        &lt;=                                                             0B     31B     17B</span><br><span class="line">ip-10-13-1-101.ap-northeast-1.compute.internal:41975     =&gt; ip-10-13-0-2.ap-northeast-1.compute.internal:domain         0B     21B     12B</span><br><span class="line">                                                        &lt;=                                                             0B     31B     17B</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">TX:             cum:   1.31MB   peak:    560kB                                                             rates:    560kB   134kB  74.7kB</span><br><span class="line">RX:                     505kB            117kB                                                                      3.69kB  49.8kB  28.1kB</span><br><span class="line">TOTAL:                 1.81MB            564kB                                                                       564kB   184kB   103kB</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>TX (Transmitter)</td>
<td>送信量</td>
</tr>
<tr>
<td>RX (Receiver)</td>
<td>受信量</td>
</tr>
<tr>
<td>TOTAL</td>
<td>iftop 起動からの総量</td>
</tr>
<tr>
<td>cum</td>
<td>総量</td>
</tr>
<tr>
<td>peak</td>
<td>最大</td>
</tr>
<tr>
<td>右端3列 (各トラフィック, rates含む)</td>
<td>2秒、10秒、40秒の転送量平均値</td>
</tr>
</tbody></table>
<p>※TX,RX の 「X」 は省略しますよという意味</p>
<p>閲覧し続けると気になる処理があった時には<br><code>Shift + P</code> で一旦停止させます。</p>
<p>もう一度開始したい場合は <code>Shift + P</code> です。</p>
<h2><span id="実際のcli">実際のCLI</span></h2><p>以下見ていただくと白い帯グラフが左から伸びているのが見えるかと思います。<br>この横棒が一番上のバーの目盛りに相応してぱっと見でどの程度かわかるのが便利です。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171109/20171109011640.png" width="100%">
</div>

<h2><span id="db-への接続を確かめる">DB への接続を確かめる</span></h2><p>DB (MySQL) のデフォルトポート 3306 への送受信を調べたいとき</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iftop -B -P -n -N -f &quot;port 3306&quot;</span><br></pre></td></tr></table></figure>

<p>当然ながら受信の方が大きいです。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171109/20171109120917.png" width="100%">
</div>

<h2><span id="補足">補足</span></h2><p>実際に負荷が高い時等、特定のインシデントがあった際に追記していこうと思います♪</p>
<h2><span id="reference">Reference</span></h2><ul>
<li><a href="http://blog.father.gedow.net/2017/10/17/middleware-benchmark/">ミドルウェア性能検証の手引き</a></li>
<li><a href="https://blog.bitmeister.jp/?p=3930">Linux上でネットワークの帯域制限と遅延を設定する</a></li>
<li><a href="http://labs.gree.jp/blog/2014/10/11288/">Linux TC (帯域制御、帯域保証) 設定ガイドライン</a></li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/28/2017-10-29-toda-tocochan-bus-flask-on-ibm-bluemix/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171029/20171029095513.png" alt="toda-tocochan-bus flask on IBM Bluemix へ引っ越し"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-10-28T15:00:00.000Z" title="2017-10-28T15:00:00.000Z">2017-10-29</time><span class="level-item">3分 read (About 497 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/28/2017-10-29-toda-tocochan-bus-flask-on-ibm-bluemix/">toda-tocochan-bus flask on IBM Bluemix へ引っ越し</a></h1><div class="content"><p>GCP から IBM Bluemix へ引っ越しました！</p>
<p><a href="https://toda-tocochan-bus.mybluemix.net/">toco ちゃんバス あと何分？</a></p>
<h2><span id="概要">概要</span></h2><p>さくらVPS から GCP、<br>そして今度は GCP から IBM Bluemix に引越ししました。</p>
<p>以前 GCP 運用時の話はコチラ</p>
<a href="https://kenzo0107.github.io/2017/08/03/2017-08-03-tutorial-of-gke" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://kenzo0107.github.io/images/og_image.png"></div><div class="descriptions"><div class="og-title">GKEチュートリアルでサイト構築・運用</div><div class="og-description">概要以前さくらVPS上で tocoちゃんバスアプリを作成しました。 Flask Python3 で 戸田市 tocoちゃんバスあと何分？ Webアプリ作成♪ - 長生村本郷Engineers&#39;BlogFlask(フラスク) とは Flask Official Site を参照する…</div></div></div></a>


<p>GCP は GKE に LB かましたら価格がバコッと上がってしまい<br>無料枠を逸脱してしまいました (&gt;_&lt;)</p>
<p>なんとか低価格で運用したいという目論見です。</p>
<h2><span id="何故-heroku-でなく-ibm-bluemix">何故 Heroku でなく IBM Bluemix ？</span></h2><p>IBM Bluemix の良い所は機能が充実している所です。<br>無料・デフォルトで kibana が見れます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171029/20171029101148.png" width="100%">
</div>

<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171029/20171029101853.png" width="100%">
</div>

<p>その他 Git との連携も可です。</p>
<p>以下 Mac で作業することを前提に手順まとめました。</p>
<h2><span id="事前準備">事前準備</span></h2><ul>
<li>IBM Bluemix に Sign Up しときます</li>
</ul>
<p><a href="https://console.bluemix.net/registration/">Signup IBM Bluemix</a></p>
<ul>
<li>clone</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/toda-tocochan-bus-on-ibmbluemix</span><br><span class="line">macOS%$ <span class="built_in">cd</span> toda-tocochan-bus-on-ibmbluemix</span><br></pre></td></tr></table></figure>

<ul>
<li>cloudfoundry の CLI インストール</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ brew tap cloudfoundry/tap</span><br><span class="line">macOS%$ brew install cf-cli</span><br></pre></td></tr></table></figure>

<h2><span id="デプロイ">デプロイ</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ cf api https://api.ng.bluemix.net</span><br><span class="line">macOS%$ cf login</span><br><span class="line">macOS%$ cf push &lt;application name&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>API は Region によって変わります。</li>
</ul>
<table>
<thead>
<tr>
<th>Region</th>
<th>API URL</th>
</tr>
</thead>
<tbody><tr>
<td>米国南部</td>
<td><a href="https://api.ng.bluemix.net">https://api.ng.bluemix.net</a></td>
</tr>
<tr>
<td>英国</td>
<td><a href="https://api.eu-gb.bluemix.net">https://api.eu-gb.bluemix.net</a></td>
</tr>
</tbody></table>
<h2><span id="総評">総評</span></h2><p>Cloudfoundry の CLI のお陰で引っ越しも簡単でした♪</p>
<p>セキュリティとして特定 IP やドメインからアクセスさせないとか出来たら<br>商用のメソッドとして利用出来そうかなと思いました。</p>
<p>その点質問してみましたが2週間ほど連絡がないので再度連絡してみます。<br>↑質問は英語限定でした！</p>
<p>サポートが強化されると有難いなと思いました。</p>
<p>以上<br>ご参考になれば幸いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/24/2017-10-25-casperjs-phantomjs-github-organization/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171025/20171025214738.png" alt="CasperJS+PhantomJS で Github Organization 移行"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-10-24T15:00:00.000Z" title="2017-10-24T15:00:00.000Z">2017-10-25</time><span class="level-item">4分 read (About 624 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/24/2017-10-25-casperjs-phantomjs-github-organization/">CasperJS+PhantomJS で Github Organization 移行</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Github Enterprise の Organization 移行を実施した際に CasperJS と PhantomJS でヘッドレスブラウザより操作し移行しました。<br>Github 上で API がない（はず？）為、この様な対応をしました。</p>
<p>どちらかというと CasperJS+PhantomJS でブラウザ上の試験作りを楽しんでいたこともあり<br>試してみてすんなりできたので採用した経緯になります。</p>
<h2><span id="ヘッドレスブラウザとは">ヘッドレスブラウザとは？</span></h2><p>GUI なしのブラウザを CLI で利用するというもの。<br>ページ描画や画像ロード、ログインしたりとフロントの試験で期待される機能を持っています。</p>
<h2><span id="三行まとめ">三行まとめ</span></h2><ul>
<li>CasperJS + PhantomJS でログイン認証はじめブラウザ操作で Transfer する工程を実行</li>
<li>移行後、元の URL が移行先にリダイレクトされるか確認</li>
<li>期待する要素が時間内に取得できないときはページをキャプチャ</li>
</ul>
<h2><span id="やってみる">やってみる</span></h2><p><a href="https://github.com/kenzo0107/transfer-repository-on-ghe#get-started">Get Started</a> ご参照ください。</p>
<a href="https://github.com/kenzo0107/transfer-repository-on-ghe" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://avatars0.githubusercontent.com/u/6197906?s=400&v=4"></div><div class="descriptions"><div class="og-title">kenzo0107/transfer-repository-on-ghe</div><div class="og-description">Transfer repositories to a new owner by using headless browser with CasperJS and PhantomJS. - kenzo0107/transfer-repository-on-ghe</div></div></div></a>

<p>以下にも手順まとめてます。</p>
<h2><span id="clone">Clone</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/ghe-org-transfer</span><br><span class="line">macOS%$ <span class="built_in">cd</span> ghe-org-transfer</span><br></pre></td></tr></table></figure>

<h2><span id="scriptsghe-org-transferjs-の-ltyour-gt-編集">scripts/ghe-org-transfer.js の &lt;your ****&gt; 編集</span></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">  <span class="comment">// site root.</span></span><br><span class="line">  siteRoot: <span class="string">'https://&lt;your github domain&gt;'</span>,</span><br><span class="line">  <span class="comment">// Github Login path</span></span><br><span class="line">  loginPath: <span class="string">'/login'</span>,</span><br><span class="line">  <span class="comment">// Github Login Account</span></span><br><span class="line">  loginParams: &#123;</span><br><span class="line">    email: <span class="string">'&lt;your email&gt;'</span>,</span><br><span class="line">    password:  <span class="string">'&lt;your password&gt;'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  viewportSize: &#123;</span><br><span class="line">    width: <span class="number">3000</span>,</span><br><span class="line">    height: <span class="number">2500</span></span><br><span class="line">  &#125;,</span><br><span class="line">  paths: [</span><br><span class="line">    <span class="string">"&lt;your owner&gt;/&lt;your repository&gt;"</span></span><br><span class="line">  ],</span><br><span class="line">  destOrganization: <span class="string">'&lt;your destination of organization&gt;'</span>,</span><br><span class="line">  reason: <span class="string">'transfer this repository to new oragnization'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3><span id="移行イメージ">移行イメージ</span></h3><ul>
<li>ex) hoge/mywonderfulrepo —&gt; moge/mywonderfulrepo</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">paths: [</span><br><span class="line">  <span class="string">"hoge/mywonderfulrepo"</span></span><br><span class="line">],</span><br><span class="line">destOrganization: <span class="string">'moge'</span>,</span><br></pre></td></tr></table></figure>

<p>paths は複数指定しても問題ありません。</p>
<h2><span id="移行実施">移行実施</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ make run</span><br></pre></td></tr></table></figure>

<ul>
<li>実行結果</li>
</ul>
<p>※ 移行後に元の URL でリダイレクトされるか試験しています。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[url] https://github.aiueo.com/hoge/mywonderfulrepo/settings</span><br><span class="line">[step] fill <span class="string">'#transfer_confirm &gt; form'</span></span><br><span class="line">[step] input checkbox <span class="comment">#team-59</span></span><br><span class="line">[step] click the button labeled <span class="string">"Transfer"</span></span><br><span class="line">(^-^) redirect ok:https://github.aiueo.co.jp/hoge/mywonderfulrepo to https://github.aiueo.co.jp/moge/mywonderfulrepo</span><br></pre></td></tr></table></figure>

<h2><span id="総評">総評</span></h2><p>以前 Grafana のグラフのスナップショットを撮る Grafana API がうまく動作しなかったのも<br>CasperJS+PhantomJS で取得する様にできました。</p>
<p>いやはや便利♪</p>
<p>全然別件ですが、サイトの認証に利用される reCAPTCHA の突破など挑戦してましたがうまく行かず…<br>うまくいったぜ！という方、是非教えてください m(_ _)m</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/07/2017-10-08-waf-cloudfront-referer-check/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005180531.png" alt="WAF+CloudFront でリファラチェック (直リンク禁止)"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-10-07T15:00:00.000Z" title="2017-10-07T15:00:00.000Z">2017-10-08</time><span class="level-item">7分 read (About 1003 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/07/2017-10-08-waf-cloudfront-referer-check/">WAF+CloudFront でリファラチェック (直リンク禁止)</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>AWS WAF (Web Application Firewall) を利用し Cloudfront でのリファラ制御を実装しましたのでそのまとめです。</p>
<p>直リンク禁止対策として導入しました。</p>
<p>以下手順になります。</p>
<h3><span id="go-to-aws-waf-ボタンクリック">Go to AWS WAF ボタンクリック</span></h3><p>サービス &gt; WAF &amp; Shield と辿り Go to AWS WAF クリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005174955.png" width="100%">
</div>

<h3><span id="configure-web-acl-ボタンクリック">Configure Web ACL ボタンクリック</span></h3><p>ACL (Access Control List) を設定していきます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005180856.png" width="100%">
</div>

<h3><span id="概要確認">概要確認</span></h3><p>特にチェックせず Next ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181044.png" width="100%">
</div>

<h3><span id="web-acl-設定">web ACL 設定</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181315.png" width="100%">
</div>

<p>以下、設定項目を設定し、Next ボタンクリック</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Web ACL name</td>
<td>(任意) 例ではCloudfront の CNAME を設定しています。</td>
</tr>
<tr>
<td>CloudWatch metric name</td>
<td>Web ACL name を入力すると自動で入力される。変更したい場合のみ変更</td>
</tr>
<tr>
<td>Region</td>
<td>Global(CloudFront) 選択</td>
</tr>
<tr>
<td>AWS resource to associate</td>
<td>対象となるCloudfrontを選択する箇所。運用中の Cloudfront を対象とすると場合は後々設定。</td>
</tr>
</tbody></table>
<h3><span id="条件作成">条件作成</span></h3><p>今回は文字列一致を条件とする為、 String match conditions にて <code>Create condition</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181800.png" width="100%">
</div>

<h3><span id="string-match-condition-作成">string match condition 作成</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005181926.png" width="100%">
</div>

<p>以下設定し <code>Add filter</code> ボタンクリック。<br>複数 filter がある場合、Add filter を繰り返します。</p>
<table>
<thead>
<tr>
<th><em>Item</em></th>
<th><em>Value</em></th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>(任意)</td>
</tr>
<tr>
<td>Part of the request to filter on</td>
<td>Header</td>
</tr>
<tr>
<td>Header</td>
<td>Referer</td>
</tr>
<tr>
<td>Match type</td>
<td>Contains</td>
</tr>
<tr>
<td>Transformation</td>
<td>Convert to lowercase</td>
</tr>
<tr>
<td>Value to match</td>
<td>対象となるドメイン設定</td>
</tr>
</tbody></table>
<br>

<h4><span id="add-filter-後-create-ボタンクリック"><code>Add filter</code> 後、 <code>Create</code> ボタンクリック。</span></h4><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182327.png" width="100%">
</div>

<h4><span id="next-ボタンクリック">Next ボタンクリック</span></h4><p>追加したもののすぐに反映されていない。<br>そのまま <code>Next</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182446.png" width="100%">
</div>

<h3><span id="ルール作成">ルール作成</span></h3><p><code>Create rule</code> ボタンクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182608.png" width="100%">
</div>

<h4><span id="ルールに条件を紐付け">ルールに条件を紐付け</span></h4><p>Name, Cloudwatch metric name を設定し<br>Add conditions で条件を追加します。</p>
<p>その後、<code>Create</code> ボタンクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182641.png" width="100%">
</div>

<h3><span id="ルール以外のリクエストのアクセス禁止">ルール以外のリクエストのアクセス禁止</span></h3><p>やはり Rule は反映されていない。ですが、続けて<br><code>Block all requests that don&#39;t match any rules</code> をチェックし <code>Review and create</code> ボタンクリック。</p>
<p>※対象のCloudfront に反映させたくない場合は、Cloudfront を選択したリソースを解除する必要があります。<br><span style="color: #ff0000">※最後に関連付けができるのでここではするべきではないと思います。</span></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005182806.png" width="100%">
</div>

<h3><span id="確認ページで入力内容確認後作成">確認ページで入力内容確認後作成</span></h3><p><code>Confirm and create</code> ボタンクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005183423.png" width="100%">
</div>

<h3><span id="対象の-web-acl-を編集">対象の web ACL を編集</span></h3><p>WEB ACLs より選択し <code>Edit web ACL</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005183628.png" width="100%">
</div>

<h4><span id="web-acl-編集">web ACL 編集</span></h4><ol>
<li>作成したルールを選択</li>
<li><code>Add rule to web ACL</code> ボタンクリック</li>
<li>Allow 選択</li>
<li><code>Update</code> ボタンクリック</li>
</ol>
<p>[f:id:kenzo0107:20171005183720p:plain]</p>
<h3><span id="cloudfront-関連付け">Cloudfront 関連付け</span></h3><p><code>Add association</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005183720.png" width="100%">
</div>

<h4><span id="web-acl-に-cloudfront-を関連付け">Web ACL に Cloudfront を関連付け</span></h4><p>Resource で 対象の Cloudfront を選択し <code>Add</code> ボタンクリック</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005184119.png" width="100%">
</div>

<p>以上で数分後 WAF+CloudFront によるリファラチェックが確認できる状態になります。</p>
<h3><span id="アクセス確認">アクセス確認</span></h3><p>自環境では<br>ローカルの /etc/hosts 修正し対象ドメインから Cloudfront CNAME へのリンクを貼って確認しました。</p>
<p>Cloudfront CNAME ドメインでのリソースを直接アクセスすると<br>以下の様な エラーページが表示されることが確認できました。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171005/20171005184505.png" width="100%">
</div>

<h3><span id="もう少しユーザフレンドリーに">もう少しユーザフレンドリーに</span></h3><p>上記のエラーページは Cloudfront &gt; Error Pages で  <code>Create Custom Error Response</code> で S3 上のパスを指定することでカスタマイズが可能です。</p>
<p>是非サイトコンセプトに合ったエラーページをご用意されるとよりユーザフレンドリーな配信になるかと思います。</p>
<p>以上<br>ご参考になれば幸いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/10/01/2017-10-02-elasticsearch-service-version-up/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170924/20170924222936.png" alt="AWS Elasticsearch Service バージョンアップ 2.2 → 5.5"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-10-01T15:00:00.000Z" title="2017-10-01T15:00:00.000Z">2017-10-02</time><span class="level-item">11分 read (About 1607 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/01/2017-10-02-elasticsearch-service-version-up/">AWS Elasticsearch Service バージョンアップ 2.2 → 5.5</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>AWS Elasticsearch Service (ES) 2.3 → 5.5 へバージョンアップを実施に際して<br>以下記事をまとめました。</p>
<h2><span id="大まかな流れ">大まかな流れ</span></h2><ol>
<li>ESバージョン2.3のドメインからSnapshot取得</li>
<li>ESバージョン5.5のドメイン作成</li>
<li>アプリの fluentd の向け先をESバージョン5.5へ変更</li>
<li>ESバージョン5.5のドメインにデータリストア</li>
<li>ESバージョン2.3のドメイン削除</li>
</ol>
<h2><span id="現状バージョン確認">現状バージョン確認</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"Jackdaw"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"&lt;Account ID&gt;:xxxxxxxxxx"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"2.3.2"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"72aa8010df1a4fc849da359c9c58acba6c4d9518"</span>,</span><br><span class="line">    <span class="string">"build_timestamp"</span> : <span class="string">"2016-11-14T15:59:50Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"5.5.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="その他-aws-console-のクラスターの設定確認">その他、AWS console のクラスターの設定確認</span></h3><p>その他クラスターへ設定している情報をメモ</p>
<ul>
<li>インスタンスタイプ</li>
<li>アクセスポリシーの確認</li>
</ul>
<h1><span id="aws-elasticsearch-service-スナップショットを-s3-で管理する">AWS Elasticsearch Service スナップショットを S3 で管理する</span></h1><h2><span id="iam-role-作成">IAM role 作成</span></h2><ul>
<li>ec2 タイプで作成</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170924/20170924221853.png" width="100%">
</div>

<ul>
<li>アクセス権限は特に設定せず 「次のステップ」ボタンクリック</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925113614.png" width="100%">
</div>


<ul>
<li>ロール名を <b><span style="color: #1464b3">es-index-backups</span></b> とし作成</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925113908.png" width="100%">
</div>

<p>ロールARN arn:aws:iam::<account id>:role/es-index-backups で作成されていることが確認できる</account></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925114402.png" width="100%">
</div>

<ul>
<li>信頼関係の編集</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925114635.png" width="100%">
</div>

<p>Service を es.amazonaws.com に編集</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="string">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"Sid"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="string">"Principal"</span>: &#123;</span><br><span class="line">        <span class="string">"Service"</span>: <span class="string">"es.amazonaws.com"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"Action"</span>: <span class="string">"sts:AssumeRole"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="iam-user-作成">IAM User 作成</span></h2><ul>
<li>ユーザ &gt; ユーザ追加 選択</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925114822.png" width="100%">
</div>

<br>
<br>

<ul>
<li>ユーザ名 <code>es-index-backup-user</code> とし プログラムによるアクセスにチェックを入れて <code>次のステップ</code> クリック</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925115200.png" width="100%">
</div>

<br>
<br>

<ul>
<li>特にポリシーをアタッチせず <code>次のステップ</code> クリック</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925115357.png" width="100%">
</div>

<ul>
<li><code>es-index-backup-user</code> を作成し独自ポリシーで先ほど作成した role へのアクセス許可設定をアタッチします。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="string">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="string">"Action"</span>: [</span><br><span class="line">                <span class="string">"iam:PassRole"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"Resource"</span>: <span class="string">"arn:aws:iam::&lt;Account ID&gt;:role/es-index-backups"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<ul>
<li>発行されたアクセスキー、シークレットアクセスキーをメモしておきます。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170925/20170925120635.png" width="100%">
</div>


<h2><span id="s3-バケット作成">S3 バケット作成</span></h2><p>S3 &gt; <code>バケットを作成する</code> でバケット作成してください。</p>
<h2><span id="elasticsearch-にてスナップショットリポジトリ作成">Elasticsearch にてスナップショットリポジトリ作成</span></h2><p>スナップショットを管理するリポジトリを Elasticsearch に作成する必要があります。</p>
<p>Elasticsearch へのアクセス可能なサーバにて以下スクリプト実行します。</p>
<ul>
<li>register_es_repository.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> boto.connection <span class="keyword">import</span> AWSAuthConnection</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ESConnection</span><span class="params">(AWSAuthConnection)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, region, **kwargs)</span>:</span></span><br><span class="line">        super(ESConnection, self).__init__(**kwargs)</span><br><span class="line">        self._set_auth_region_name(region)</span><br><span class="line">        self._set_auth_service_name(<span class="string">"es"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_required_auth_capability</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'hmac-v4'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line"></span><br><span class="line">    client = ESConnection(</span><br><span class="line">            region=<span class="string">'ap-northeast-1'</span>,</span><br><span class="line">            host=<span class="string">'&lt;Elasticsearch 2.3 Endpoint Domain&gt;'</span>,</span><br><span class="line">            aws_access_key_id=<span class="string">'&lt;ACCESS KEY ID&gt;'</span>,</span><br><span class="line">            aws_secret_access_key=<span class="string">'&lt;SECRET ACCESS KEY&gt;'</span>, is_secure=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    resp = client.make_request(</span><br><span class="line">        method=<span class="string">'POST'</span>,</span><br><span class="line">        path=<span class="string">'/_snapshot/index-backups'</span>,</span><br><span class="line">        data=<span class="string">'&#123;"type": "s3","settings": &#123; "bucket": "&lt;bucket name&gt;","region": "ap-northeast-1","role_arn": "arn:aws:iam::&lt;Account ID&gt;:role/es-index-backups"&#125;&#125;'</span></span><br><span class="line">    )</span><br><span class="line">    body = resp.read()</span><br><span class="line">    <span class="keyword">print</span> body</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ chmod +x register_es_repository.py</span><br><span class="line"></span><br><span class="line">$ python register_es_repository.py</span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">"acknowledged"</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<p>リポジトリ登録完了しました。</p>
<h2><span id="snapshot-取得">Snapshot 取得</span></h2><p>snapshot 名を <code>20170926</code> とします。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPUT <span class="string">"https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;/_snapshot/index-backups/20170926"</span></span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">"accepted"</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="snapshot-一覧">Snapshot 一覧</span></h2><p><code>20170926</code> という snapshot 名で取得したことが確認できます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s -XGET <span class="string">"https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;/_snapshot/index-backups/_all"</span> | jq .</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"snapshots"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"snapshot"</span>: <span class="string">"20170926"</span>,</span><br><span class="line">      <span class="string">"version_id"</span>: 2030299,</span><br><span class="line">      <span class="string">"version"</span>: <span class="string">"2.3.2"</span>,</span><br><span class="line">      <span class="string">"indices"</span>: [</span><br><span class="line">        <span class="string">"nginx-access-2017.09.09"</span>,</span><br><span class="line">        <span class="string">"nginx-access-2017.09.07"</span>,</span><br><span class="line">        <span class="string">"nginx-access-2017.09.08"</span>,</span><br><span class="line">        <span class="string">"nginx-error-2017.08.24"</span>,</span><br><span class="line">        <span class="string">"nginx-error-2017.08.23"</span>,</span><br><span class="line">        <span class="string">".kibana-4"</span>,</span><br><span class="line">...</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"state"</span>: <span class="string">"IN_PROGRESS"</span>,</span><br><span class="line">      <span class="string">"start_time"</span>: <span class="string">"2017-09-26T03:58:51.040Z"</span>,</span><br><span class="line">      <span class="string">"start_time_in_millis"</span>: 1506398331040,</span><br><span class="line">      <span class="string">"failures"</span>: [],</span><br><span class="line">      <span class="string">"shards"</span>: &#123;</span><br><span class="line">        <span class="string">"total"</span>: 0,</span><br><span class="line">        <span class="string">"failed"</span>: 0,</span><br><span class="line">        <span class="string">"successful"</span>: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="snapshot-削除">Snapshot 削除</span></h2><p>スナップショット <code>20170926</code> を削除する場合、DELETE メソッドを実行します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XDELETE https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;/_snapshot/index-backups/20170926</span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">"acknowledged"</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="s3-確認">S3 確認</span></h2><p>以下が作成されているのがわかります。</p>
<ul>
<li>indices/*</li>
<li>meta-*</li>
<li>snap-*</li>
</ul>
<p>はじめ meta-* が作成できたら完了なのかなと思いきや<br>snap-* も作られるまで待つ必要がありました。</p>
<ul>
<li>CLI 上でスナップショット完了確認した方が確実です。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s -GET https://&lt;Elasticsearch 2.3 Endpoint Domain&gt;/_snapshot/index-backups/20170926</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">      <span class="string">"state"</span>: <span class="string">"SUCCESS"</span>,</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>




<h2><span id="elasticsearch-55-service-新規ドメイン作成">Elasticsearch 5.5 Service 新規ドメイン作成</span></h2><p>Elasticsearch 2.3 の設定に倣って作成します。</p>
<h2><span id="リポジトリ作成">リポジトリ作成</span></h2><ul>
<li>register_es55_repository.py</li>
</ul>
<p>register_es_repository.py の host 部分を新規ドメインに修正します。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> boto.connection <span class="keyword">import</span> AWSAuthConnection</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ESConnection</span><span class="params">(AWSAuthConnection)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, region, **kwargs)</span>:</span></span><br><span class="line">        super(ESConnection, self).__init__(**kwargs)</span><br><span class="line">        self._set_auth_region_name(region)</span><br><span class="line">        self._set_auth_service_name(<span class="string">"es"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_required_auth_capability</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'hmac-v4'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line"></span><br><span class="line">    client = ESConnection(</span><br><span class="line">            region=<span class="string">'ap-northeast-1'</span>,</span><br><span class="line">            host=<span class="string">'&lt;Elasticsearch 5.5 Endpoint Domain&gt;'</span>,</span><br><span class="line">            aws_access_key_id=<span class="string">'&lt;ACCESS KEY ID&gt;'</span>,</span><br><span class="line">            aws_secret_access_key=<span class="string">'&lt;SECRET ACCESS KEY&gt;'</span>, is_secure=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Registering Snapshot Repository'</span></span><br><span class="line">    resp = client.make_request(</span><br><span class="line">        method=<span class="string">'POST'</span>,</span><br><span class="line">        path=<span class="string">'/_snapshot/index-backups'</span>,</span><br><span class="line">        data=<span class="string">'&#123;"type": "s3","settings": &#123; "bucket": "&lt;bucket name&gt;","region": "ap-northeast-1","role_arn": "arn:aws:iam::&lt;Account ID&gt;:role/es-index-backups"&#125;&#125;'</span></span><br><span class="line">    )</span><br><span class="line">    body = resp.read()</span><br><span class="line">    <span class="keyword">print</span> body</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ chmod +x register_es55_repository.py</span><br><span class="line"></span><br><span class="line">$ python register_es55_repository.py</span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">"acknowledged"</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>


<h2><span id="スナップショットからリストア">スナップショットからリストア</span></h2><p><code>20170926</code> のスナップショットをリストアします。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XPOST <span class="string">"https://&lt;Elasticsearch 5.5 Endpoint Domain&gt;/_snapshot/index-backups/20170926/_restore"</span></span><br><span class="line"></span><br><span class="line">// 成功</span><br><span class="line">&#123;<span class="string">"accepted"</span>: <span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="リストア確認">リストア確認</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -XGET <span class="string">"https://&lt;Elasticsearch 5.5 Endpoint Domain&gt;/_cat/indices"</span></span><br></pre></td></tr></table></figure>

<h2><span id="スナップショットに失敗するケース">スナップショットに失敗するケース</span></h2><ul>
<li>.kibana index が既に存在しており、リストアできない。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"error"</span>:&#123;</span><br><span class="line">        <span class="string">"root_cause"</span>:[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"type"</span>:<span class="string">"snapshot_restore_exception"</span>,</span><br><span class="line">                <span class="string">"reason"</span>:<span class="string">"[index-backups:20170926/Hc4rLIoARCWqpyJXeP7edw] cannot restore index [.kibana] because it's open"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"type"</span>:<span class="string">"snapshot_restore_exception"</span>,</span><br><span class="line">        <span class="string">"reason"</span>:<span class="string">"[index-backups:20170926/Hc4rLIoARCWqpyJXeP7edw] cannot restore index [.kibana] because it's open"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"status"</span>:<span class="number">500</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4><span id="対応策">対応策</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST https://&lt;Elasticsearch 5.5 Endpoint Domain&gt;/_snapshot/index-backups/20170926/_restore -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">	"indices": "nginx-*"</span></span><br><span class="line"><span class="string">&#125;'</span> | jq .</span><br></pre></td></tr></table></figure>

<p><code>indices</code> を用い、スナップショット内のインデックスの中からマッチする正規表現のみをリストアできます。</p>
<p>自身ではこの様な解決法を実施し回避できました。<br>その他良い方法があれば御指南いただけますと幸いです。</p>
<h2><span id="ちなみに">ちなみに</span></h2><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20171002/20171002144856.png" width="100%">
</div>

<p>Terraform で ES 2.2 → 5.5 バージョンアップを実施した所<br>1時間以上経過してようやくアップデートが完了しました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws_elasticsearch_domain.elasticsearch: Still destroying... (ID: arn:aws:es:ap-northeast-1:xxxxxxxxxxxx:domain&#x2F;***, 59m11s elapsed)</span><br><span class="line">aws_elasticsearch_domain.elasticsearch: Still destroying... (ID: arn:aws:es:ap-northeast-1:xxxxxxxxxxxx:domain&#x2F;***, 59m21s elapsed)</span><br><span class="line">aws_elasticsearch_domain.elasticsearch: Still destroying... (ID: arn:aws:es:ap-northeast-1:xxxxxxxxxxxx:domain&#x2F;***, 59m31s elapsed)</span><br><span class="line">aws_elasticsearch_domain.elasticsearch: Destruction complete after 59m41s</span><br></pre></td></tr></table></figure>

<p>これは辛い (&gt;_&lt;)</p>
<p>Terraform で管理している場合、<br>スナップショットを取得したら aws console 上でドメイン削除した方が早い。</p>
<p>ブルーグリーン的に ES 5.5 作成して ES 2.2 から乗り換えて<br>しばらく運用して問題なければ ES 2.2 を削除する方法が一番確実だなと思いました。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/09/12/2017-09-13-docker-compose-rails5-nginx-mysql-on-vagrant/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170708/20170708204516.png" alt="docker-comopse で Rails 5 (Puma) + Nginx + Mysql 構築 on Vagrant(Ubuntu)"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-09-12T15:00:00.000Z" title="2017-09-12T15:00:00.000Z">2017-09-13</time><span class="level-item">3分 read (About 497 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/09/12/2017-09-13-docker-compose-rails5-nginx-mysql-on-vagrant/">docker-comopse で Rails 5 (Puma) + Nginx + Mysql 構築 on Vagrant(Ubuntu)</a></h1><div class="content"><p>自身の Rails 開発環境の雛形として利用している docker-compose です。</p>
<a href="https://github.com/kenzo0107/vagrant-docker/tree/master/docker/rails-puma-nginx-mysql" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://avatars0.githubusercontent.com/u/6197906?s=400&v=4"></div><div class="descriptions"><div class="og-title">kenzo0107/vagrant-docker</div><div class="og-description">Docker on Vagrant(ubuntu). Contribute to kenzo0107/vagrant-docker development by creating an account on GitHub.</div></div></div></a>

<p>以下設定手順です。</p>
<h2><span id="vagrant-起動">Vagrant 起動</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/vagrant-docker</span><br><span class="line">macOS%$ <span class="built_in">cd</span> ./vagrant-docker/</span><br><span class="line">macOS%$ vagrant up</span><br><span class="line">macOS%$ vagrant ssh</span><br></pre></td></tr></table></figure>

<h2><span id="rails-プロジェクト作成">Rails プロジェクト作成</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// on vagrant</span><br><span class="line">vagrant%$ <span class="built_in">cd</span> /vagrant/rails-puma-nginx-mysql</span><br><span class="line">vagrant%$ docker-compose run --rm web rails new . --force --database=mysql --skip-bundle</span><br></pre></td></tr></table></figure>

<h2><span id="puma-設定ファイルセット">puma 設定ファイルセット</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ cp puma.rb ./rails/config/</span><br></pre></td></tr></table></figure>

<ul>
<li>./rails/config/puma.rb</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">threads_count = ENV.fetch(<span class="string">"RAILS_MAX_THREADS"</span>) &#123; <span class="number">5</span> &#125;.to_i</span><br><span class="line">threads threads_count, threads_count</span><br><span class="line">port        ENV.fetch(<span class="string">"PORT"</span>) &#123; <span class="number">3000</span> &#125;</span><br><span class="line">environment ENV.fetch(<span class="string">"RAILS_ENV"</span>) &#123; <span class="string">"development"</span> &#125;</span><br><span class="line">plugin <span class="symbol">:tmp_restart</span></span><br><span class="line"></span><br><span class="line">app_root = File.expand_path(<span class="string">"../.."</span>, __FILE_<span class="number">_</span>)</span><br><span class="line">bind <span class="string">"unix://<span class="subst">#&#123;app_root&#125;</span>/tmp/sockets/puma.sock"</span></span><br></pre></td></tr></table></figure>

<h2><span id="データベース設定ファイルセット">データベース設定ファイルセット</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ cp database.yml ./rails/config/</span><br></pre></td></tr></table></figure>

<ul>
<li>./rails/config/database.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">default:</span> <span class="meta">&amp;default</span></span><br><span class="line">  <span class="attr">adapter:</span> <span class="string">mysql2</span></span><br><span class="line">  <span class="attr">encoding:</span> <span class="string">utf8</span></span><br><span class="line">  <span class="attr">pool:</span> &lt;%=<span class="ruby"> ENV.fetch(<span class="string">"RAILS_MAX_THREADS"</span>) &#123; <span class="number">5</span> &#125; </span>%&gt;</span><br><span class="line">  <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">password:</span> &lt;%=<span class="ruby"> ENV[<span class="string">'MYSQL_ROOT_PASSWORD'</span>] </span>%&gt;  <span class="comment"># &lt;--- MYSQL_ROOT_PASSWORD</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">db</span> <span class="comment"># &lt;--- service name</span></span><br></pre></td></tr></table></figure>


<h2><span id="データベース作成">データベース作成</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker-compose run --rm web rails db:create</span><br><span class="line">Created database <span class="string">'app_development'</span></span><br><span class="line">Created database <span class="string">'app_test'</span></span><br><span class="line"></span><br><span class="line">vagrant%$ docker-compose <span class="built_in">exec</span> db mysql -u root -p -e<span class="string">'show databases;'</span></span><br><span class="line">Enter password: (password)</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| app_development    | &lt;--- add !</span><br><span class="line">| app_test           | &lt;--- add !</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>以上で必要最低限の Rails プロジェクトの準備ができました！</p>
<h2><span id="rails-nginx-mysql-全コンテナ起動">Rails, Nginx, MySQL 全コンテナ起動</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>ブラウザより <a href="http://192.168.35.101">http://192.168.35.101</a> へアクセスし<br>Rails トップページが表示されることが確認できます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170913/20170913132149.png" width="100%">
</div>

<h2><span id="総評">総評</span></h2><p>docker でコンテナ化しているので Nginx, MySQL 等、<br>バージョンアップしたい時でもコンテナを置き換えるだけで簡単に使用感を確認できたり<br>機能を確認できたりと便利です。</p>
<p>これに Elasticsearch + Kibana でログを可視化したり<br>Mailcatcher でメール送信を確認できるようにしたりと<br>開発するには十分な状況が用意できます。</p>
<p>是非開発の一助になれば幸いです。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-08-24T15:00:00.000Z" title="2017-08-24T15:00:00.000Z">2017-08-25</time><span class="level-item">数秒 read (About 60 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/08/24/2017-08-25-mysql-kill-sleep-process/">MySQL 一定秒以上 Sleep しているプロセスを一括 kill</a></h1><div class="content"><p>メモ</p>
<h2><span id="300秒以上-sleep-しているプロセスidをまとめて表示">300秒以上 Sleep しているプロセスIDをまとめて表示</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -h &lt;host&gt; -u &lt;user&gt; -p -e<span class="string">'SELECT GROUP_CONCAT(ID) FROM information_schema.PROCESSLIST WHERE TIME &gt; 300;'</span></span><br><span class="line"></span><br><span class="line">+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GROUP_CONCAT(ID)                                                                                                                                                                                                                                                                                                                                                                                      |</span><br><span class="line">+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| 2147,2143,2138,2113,2111,2104,2102,2098,2087,2085,2082,2081,2079,2078,2069,2068,2045,2037,2029,2025,2023,2016,2015,2006,2005,2003,2002,2001,1999,1998,1997,1995,1987,1986,1984,1982,1981,1974,1973,1968,1966,1963,1961,1959,1957,1955,1954,1949,1937,1936,1928,1925,1923,1920,1916,1914,1912,1908,1906,1898,1892,1869,1847,1842,1651,1650,1572,1570,1568,1566,1539,1522,1517,1516,1514,1511,1506,1483 |</span><br><span class="line">+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<h2><span id="プロセスidをまとめて一括-kill">プロセスIDをまとめて一括 kill</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqladmin <span class="built_in">kill</span> &lt;pid,pid,pid...&gt; -h &lt;host&gt; -u &lt;user&gt; -p</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/08/21/2017-08-22-docker-compose-rails-nginx-mysql-on-vagrant/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170823/20170823110755.png" alt="Vagrant + docker-compose で Rails 5.1.0 (Puma) + Nginx + MySQL 環境構築"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-08-21T15:00:00.000Z" title="2017-08-21T15:00:00.000Z">2017-08-22</time><span class="level-item">4分 read (About 629 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/08/21/2017-08-22-docker-compose-rails-nginx-mysql-on-vagrant/">Vagrant + docker-compose で Rails 5.1.0 (Puma) + Nginx + MySQL 環境構築</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>簡易的に Rails 環境を構築・開発できる様にすべく構築しました。</p>
<p>こんな時に利用してます。</p>
<ul>
<li>新規プロジェクト開発</li>
<li>新規 gem, その他ミドルウェアの試験</li>
<li>簡単なモックを作ってディレクターに見せたい時とか</li>
</ul>
<p>構築手順をまとめました。</p>
<h2><span id="環境">環境</span></h2><ul>
<li>macOS Sierra 10.12.5</li>
<li>VirtualBox 5.1.18r114002</li>
<li>Vagrant 1.9.3</li>
<li>VagrantBox Ubuntu 14.04.5</li>
<li>Docker version 17.06.0-ce, build 02c1d87</li>
</ul>
<h2><span id="git-clone">Git Clone</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git <span class="built_in">clone</span> https://github.com/kenzo0107/vagrant-docker</span><br><span class="line">macOS%$ <span class="built_in">cd</span> vagrant-docker</span><br><span class="line">macOS%$ vagrant up</span><br><span class="line">macOS%$ vagrant ssh</span><br><span class="line">vagrant%$ <span class="built_in">cd</span> /vagrant/rails-puma-nginx-mysql/</span><br></pre></td></tr></table></figure>

<h2><span id="rails-プロジェクト作成">Rails プロジェクト作成</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// database = mysql</span><br><span class="line">vagrant%$ docker-compose run --rm web rails new . --force --database=mysql --skip-bundle</span><br></pre></td></tr></table></figure>

<h2><span id="pumarb-設定">puma.rb 設定</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// backup</span><br><span class="line">vagrant%$ cp ./rails/config/puma.rb ./rails/config/puma.rb.bk</span><br><span class="line">vagrant%$ cp puma.rb ./rails/config/</span><br></pre></td></tr></table></figure>

<ul>
<li>./rails/config/puma.rb</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">threads_count = ENV.fetch(<span class="string">"RAILS_MAX_THREADS"</span>) &#123; <span class="number">5</span> &#125;.to_i</span><br><span class="line">threads threads_count, threads_count</span><br><span class="line">port        ENV.fetch(<span class="string">"PORT"</span>) &#123; <span class="number">3000</span> &#125;</span><br><span class="line">environment ENV.fetch(<span class="string">"RAILS_ENV"</span>) &#123; <span class="string">"development"</span> &#125;</span><br><span class="line">plugin <span class="symbol">:tmp_restart</span></span><br><span class="line"></span><br><span class="line">app_root = File.expand_path(<span class="string">"../.."</span>, __FILE_<span class="number">_</span>)</span><br><span class="line">bind <span class="string">"unix://<span class="subst">#&#123;app_root&#125;</span>/tmp/sockets/puma.sock"</span></span><br></pre></td></tr></table></figure>

<h2><span id="データベース接続情報設定">データベース接続情報設定</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// backup</span><br><span class="line">vagrant%$ cp ./rails/config/database.yml ./rails/config/database.yml.bk</span><br><span class="line">vagrant%$ cp database.yml ./rails/config/</span><br></pre></td></tr></table></figure>

<ul>
<li>./rails/config/database.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">default:</span> <span class="meta">&amp;default</span></span><br><span class="line">  <span class="attr">adapter:</span> <span class="string">mysql2</span></span><br><span class="line">  <span class="attr">encoding:</span> <span class="string">utf8</span></span><br><span class="line">  <span class="attr">pool:</span> &lt;%=<span class="ruby"> ENV.fetch(<span class="string">"RAILS_MAX_THREADS"</span>) &#123; <span class="number">5</span> &#125; </span>%&gt;</span><br><span class="line">  <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">password:</span> &lt;%=<span class="ruby"> ENV[<span class="string">'MYSQL_ROOT_PASSWORD'</span>] </span>%&gt;  <span class="comment"># &lt;--- MYSQL_ROOT_PASSWORD</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">db</span> <span class="comment"># &lt;--- service name</span></span><br></pre></td></tr></table></figure>


<h2><span id="db作成">DB作成</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker-compose run --rm web rails db:create</span><br><span class="line">Created database <span class="string">'app_development'</span></span><br><span class="line">Created database <span class="string">'app_test'</span></span><br><span class="line"></span><br><span class="line">vagrant%$ docker-compose <span class="built_in">exec</span> db mysql -u root -p -e<span class="string">'show databases;'</span></span><br><span class="line">Enter password: (password)</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| app_development    | &lt;--- add !</span><br><span class="line">| app_test           | &lt;--- add !</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h2><span id="rails-実行">Rails 実行</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker-compose up -d</span><br></pre></td></tr></table></figure>

<p><a href="http://192.168.35.101">http://192.168.35.101</a> にアクセスすると Rails のウェルカムページが表示されます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170822/20170822123732.png" width="100%">
</div>


<h2><span id="rails-g">rails g</span></h2><p><code>rails g</code> 実行時は基本 one-off container で実行するのが良いです。</p>
<p>例えば以下は articles テーブルを作成、また、関連する controller, view, model を作成します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker-compose run --rm web rails g scaffold article title:string body:text</span><br></pre></td></tr></table></figure>

<h2><span id="gemfile-更新">Gemfile 更新</span></h2><p>Gemfile 更新した際はビルドし再起動します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker-compose stop web</span><br><span class="line">vagrant%$ docker-compose build web</span><br><span class="line">vagrant%$ docker-compose up -d web</span><br></pre></td></tr></table></figure>

<h2><span id="あとがき">あとがき</span></h2><p>Rack server との接続は一癖ありましたが、そこさえ乗り越えたら<br>すっと行きました♪</p>
<p>DB は 3306 でオープンしてるので<br>Mac のローカルから <a href="https://www.sequelpro.com/">Sequel Pro</a> で接続して確認できます。</p>
<p>これをベースに EFK でログ確認できる様にしたり、<br>mailcatcher でメール機能を試験できる様にしたりと<br>何かと便利です。</p>
<p>Docker 有難や♪</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-08-08T15:00:00.000Z" title="2017-08-08T15:00:00.000Z">2017-08-09</time><span class="level-item"><a class="link-muted" href="/categories/Go/">Go</a></span><span class="level-item">1分 read (About 142 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/08/08/2017-08-09-go-revel-upload-to-s3/">Go+Revelフレームワーク 非同期でS3へ画像リサイズ/アップロード</a></h1><div class="content"><p>備忘録です。</p>
<h2><span id="概要">概要</span></h2><p>AWS向けのgoライブラリが乱立していて<br>どれ使ったらいい？という感じだったので<br>本家の <code>launchpad.net/goamz/aws</code> を利用して<br>実装することにしました。</p>
<h2><span id="controller">Controller</span></h2><ul>
<li>app/controllers/img.go</li>
</ul>
<script src="//gist.github.com/kenzo0107/e27a7efa27d11ceab8f6.js"></script>

<h2><span id="component">Component</span></h2><p>画像アップロード部分をcomponent化しました。</p>
<ul>
<li>app/utility/aws.go</li>
</ul>
<script src="//gist.github.com/kenzo0107/a36c52f019ce75411a3f.js"></script>

<h2><span id="views">Views</span></h2><ul>
<li>Views/Img/Index.html</li>
</ul>
<script src="//gist.github.com/kenzo0107/871a8dc41105209ee38c.js"></script>

<ul>
<li>public/js/ajax.js</li>
</ul>
<script src="//gist.github.com/kenzo0107/260b7ff637fd58229824.js"></script>

<ul>
<li>public/js/jquery.uploadThumbs.js</li>
</ul>
<script src="//gist.github.com/kenzo0107/66609140fe7c144040fa.js"></script>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-08-02T15:00:00.000Z" title="2017-08-02T15:00:00.000Z">2017-08-03</time><span class="level-item">16分 read (About 2407 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/08/02/2017-08-03-tutorial-of-gke/">GKEチュートリアルでサイト構築・運用</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>以前さくらVPS上で tocoちゃんバスアプリを作成しました。</p>
<a href="http://kenzo0107.hatenablog.com/entry/2017/07/07/233210" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170707/20170707233203.png"></div><div class="descriptions"><div class="og-title">Flask Python3 で 戸田市 tocoちゃんバスあと何分？ Webアプリ作成♪ - 長生村本郷Engineers&#39;Blog</div><div class="og-description">Flask(フラスク) とは Flask Official Site を参照すると冒頭に以下の文章があります。 Flask is a microframework for Python based on Werkzeug, Jinja 2 and good intentions …</div></div></div></a>

<p>さくらVPSは個人プロジェクトを幾つか載せていましたが<br>一部終了した為、tocoちゃんバスアプリを GCP にお引越ししました。</p>
<p>その時の話を GKE チュートリアルを兼ねて改めてまとめました。</p>
<h2><span id="何故-gcp">何故 GCP ？</span></h2><p>toco ちゃんバスアプリはDBも持たない軽量なサイトです。<br>その為、GCPの無料枠が利用できると思い、移行に至りました。</p>
<h2><span id="構成">構成</span></h2><p>GCPでは Container Cluster を利用し<br>この様な構成を取っております。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170803/20170803142949.png" width="100%">
</div>

<p>以下、GCP のチュートリアルに倣い構築手順まとめました。</p>
<h2><span id="gcloud-デフォルト設定">gcloud デフォルト設定</span></h2><p>以前無料枠を利用して構築した際の記事を参照ください。<br>Pod 単体の寂しい構成ではありますが汗</p>
<a href="http://kenzo0107.hatenablog.com/entry/2017/05/10/012945" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="http://i.imgur.com/Vvmetu1.png"></div><div class="descriptions"><div class="og-title">無料枠で運用！ GKE + Kubernetes で Hubot 〜CLIから実行編〜 - 長生村本郷Engineers&#39;Blog</div><div class="og-description">概要 無料枠を使って Slack 連携する Hubot を GKE で構築します。 おまけで JIRA 連携も Google Cloud SDK のインストール方法と初期化 Mac OS X 用クイックスタート を参照して SDK をダウンロードします。 Mac OS X (x8…</div></div></div></a>


<h2><span id="コンテナクラスタ作成">コンテナクラスタ作成</span></h2><p>こちらも以前の記事同様、無料枠を利用すべく<br>初めに3ノードで作成し完了後、1ノードにします。</p>
<p>クラスターバージョンは 1.7.2 を指定しました。((2017年8月2日時点で cluster version 最新は 1.7.2))</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcloud container get-server-config</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Fetching server config for us-west1-b<br>defaultClusterVersion: 1.6.7<br>defaultImageType: COS<br>validImageTypes:</p>
<ul>
<li>CONTAINER_VM</li>
<li>COS</li>
<li>UBUNTU<br>validMasterVersions:</li>
<li>1.7.2</li>
<li>1.6.7<br>validNodeVersions:</li>
<li>1.7.2</li>
<li>1.7.1</li>
<li>1.7.0</li>
<li>1.6.7</li>
<li>1.6.6</li>
<li>1.6.4</li>
<li>1.5.7</li>
<li>1.4.9</li>
</ul>
</blockquote>
<ul>
<li>コンテナクラスタ作成</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ gcloud container clusters create tocochan-cluster-free \</span><br><span class="line">      --cluster-version=1.7.2 \</span><br><span class="line">      --machine-type f1-micro \</span><br><span class="line">      --disk-size=30 \</span><br><span class="line">      --num-nodes=3</span><br></pre></td></tr></table></figure>

<ul>
<li>Node 数を 1 に設定</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcloud container clusters resize tocochan-cluster-free --size=1</span><br></pre></td></tr></table></figure>

<ul>
<li>確認</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcloud container clusters describe tocochan-cluster-free | grep currentNodeCount</span><br></pre></td></tr></table></figure>

<blockquote>
<p>currentNodeCount: 1</p>
</blockquote>
<p>現在のノード数が 1 であることが確認できました。<br>これで無料枠！</p>
<p>クラスタ作成後、コンテナクラスタの認証情報を取得し<br>kubectl でクラスタ接続し操作できる様にします。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcloud container clusters get-credentials tocochan-cluster-free</span><br></pre></td></tr></table></figure>

<h2><span id="container-registory-登録">Container Registory 登録</span></h2><p>ローカルで起動したコンテナからイメージ作成し<br>GCP 上の Private な Docker リポジトリである Container Registory に登録します。</p>
<p>以下リポジトリを利用します。</p>
<p><a href="https://github.com/kenzo0107/toda-tocochan-bus">https://github.com/kenzo0107/toda-tocochan-bus</a></p>
<ul>
<li>Docker コンテナ起動</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/kenzo0107/toda-tocochan-bus</span><br><span class="line">$ <span class="built_in">cd</span> toda-tocochan-bus</span><br><span class="line">$ docker-compose up --build -d</span><br></pre></td></tr></table></figure>

<ul>
<li>起動した Docker コンテナからイメージ作成・GCR へ push ((プロジェクトIDは 「mametsubuservice-175801」 ))</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ container_id=$(docker ps | grep [f]lask | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">$ docker commit <span class="variable">$container_id</span> gcr.io/mametsubuservice-175801/tocochan:latest</span><br><span class="line">$ gcloud docker -- push gcr.io/mametsubuservice-175801/tocochan:latest</span><br></pre></td></tr></table></figure>

<h2><span id="pod-単体デプロイ-as-チュートリアル1">Pod 単体デプロイ as チュートリアル①</span></h2><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170803/20170803142852.png" width="100%">
</div>

<p>基本単体でデプロイすることは稀です。<br>単純に Pod 内のコンテナが異常停止した場合などを管理できない為です。<br>今回は無料運用の為と内容理解の為のチュートリアルとしての作業です。</p>
<ul>
<li>pod.yaml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gcr.io/mametsubuservice-175801/tocochan:latest</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">tocochan</span></span><br></pre></td></tr></table></figure>

<h4><span id="pod-単体デプロイ実行">Pod 単体デプロイ実行</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pod.yaml</span><br></pre></td></tr></table></figure>

<h4><span id="pod-状態確認">Pod 状態確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br></pre></td></tr></table></figure>

<ul>
<li>アクセス設定</li>
</ul>
<p>flask は 5000 ポートで起動します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl port-forward tocochan 5000</span><br><span class="line"></span><br><span class="line">Forwarding from 127.0.0.1:5000 -&gt; 5000</span><br><span class="line">Forwarding from [::1]:5000 -&gt; 5000</span><br></pre></td></tr></table></figure>

<ul>
<li>ブラウザから <code>http://localhost:5000</code> にアクセス</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170804/20170804120645.png" width="100%">
</div>

<p>トップページが取得できることが確認できます。</p>
<h4><span id="pod-名指定し削除">Pod 名指定し削除</span></h4><p>Pod 単体デプロイが確認できましたので削除しましょう。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pods tocochan</span><br></pre></td></tr></table></figure>




<h2><span id="replicaset-デプロイ-as-チュートリアル2">ReplicaSet デプロイ as チュートリアル②</span></h2><p>Pod 単体作成した場合、 Pod に異常停止したとしても特に何もリカバーされません。<br>ReplicaSet では常に正常に動作するコンテナ数を管理しており<br>異常停止があった場合は新たに Pod を追加します。</p>
<p>こちらもチュートリアルとして記載してます。こちらは終わったら削除します。</p>
<ul>
<li>replicaset.yaml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>   <span class="comment"># 常に動作するコンテナ数</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gcr.io/mametsubuservice-175801/tocochan:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tocochan</span></span><br></pre></td></tr></table></figure>

<h4><span id="replicaset-デプロイ実行">ReplicaSet デプロイ実行</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f replicaset.yaml</span><br></pre></td></tr></table></figure>

<h4><span id="replicaset-確認">ReplicaSet 確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get rs -l name=tocochan</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NAME                  DESIRED   CURRENT   READY     AGE<br>tocochan-4006188167   1         1         1         10m</p>
</blockquote>
<h4><span id="仮に-pods-を削除しようとすると">仮に Pods を削除しようとすると？</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pods -l name=tocochan</span><br></pre></td></tr></table></figure>

<p>起動コンテナが 0 になることなく、新たに作成されていることがわかります。</p>
<blockquote>
<p>NAME             READY     STATUS        RESTARTS   AGE<br>tocochan-14s3b   1/1       Running       0          4s<br>tocochan-tsvfn   1/1       Terminating   0          5m</p>
</blockquote>
<h4><span id="replicaset-削除">ReplicaSet 削除</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete rs tocochan</span><br></pre></td></tr></table></figure>

<h2><span id="deployment-デプロイ">Deployment デプロイ</span></h2><p>ReplicaSet のデプロイは k8s 上に履歴が残りません。<br>Deployment デプロイでは履歴が残り、現行バージョンに異常があった場合は<br>バージョンを簡単に戻せます。</p>
<p>これまでの問題を解決しているのが Deployment デプロイです。</p>
<ul>
<li>deployment.yaml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gcr.io/mametsubuservice-175801/tocochan:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">tocochan</span></span><br></pre></td></tr></table></figure>

<h4><span id="deployment-デプロイ実行">Deployment デプロイ実行</span></h4><p><code>--record</code> を付けることで操作履歴を残すことができます。<br>履歴に残すことで問題がある場合に kubectl の操作で過去のバージョンに戻すことができます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f deployment.yaml --record</span><br></pre></td></tr></table></figure>

<h4><span id="deployment-確認">Deployment 確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployments -l name=tocochan</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>tocochan   1         1         1            1           10m</p>
</blockquote>
<h4><span id="replicaset-確認">ReplicaSet 確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get rs -l name=tocochan</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NAME                  DESIRED   CURRENT   READY     AGE<br>tocochan-2006588533   1         1         1         10m</p>
</blockquote>
<h4><span id="pod-確認">Pod 確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -l name=tocochan</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NAME                        READY     STATUS    RESTARTS   AGE<br>tocochan-4006188167-3zrn9   1/1       Running   0          10m</p>
</blockquote>
<h4><span id="デプロイ結果確認">デプロイ結果確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout status deployment/tocochan</span><br></pre></td></tr></table></figure>

<blockquote>
<p>deployment “tocochan” successfully rolled out</p>
</blockquote>
<p>正しく Rollout 公開されたことがわかりました。</p>
<h4><span id="履歴確認">履歴確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment tocochan</span><br></pre></td></tr></table></figure>

<blockquote>
<p>deployments “tocochan”<br>REVISION        CHANGE-CAUSE<br> 1               kubectl create –filename=deployment.yaml –record=true</p>
</blockquote>
<h4><span id="編集">編集</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit deployment tocochan</span><br></pre></td></tr></table></figure>

<p>vim が起動し deployment の編集が可能です。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- image: gcr.io/mametsubuservice-175801/tocochan:latest</span><br><span class="line">+ image: gcr.io/mametsubuservice-175801/tocochan:v0.0.1</span><br></pre></td></tr></table></figure>

<p>上記の様に編集し保存して終了すると</p>
<blockquote>
<p>NAME                        READY     STATUS              RESTARTS   AGE<br>tocochan-1297744065-2qb87   1/1       Terminating   0          15m<br>tocochan-4006188167-3zrn9   1/1       Running       0          10s</p>
</blockquote>
<p>既存コンテナが停止中となコンテナが新たに立ち上がったことがわかります。</p>
<ul>
<li>履歴確認</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout <span class="built_in">history</span> deployment tocochan</span><br></pre></td></tr></table></figure>

<blockquote>
<p>REVISION        CHANGE-CAUSE<br>1               kubectl create –filename=all.yaml –record=true<br>2               kubectl edit deployment tocochan</p>
</blockquote>
<p>Rollout 履歴を確認すると 編集内容が追加されていることがわかります。</p>
<h4><span id="バージョンを戻す">バージョンを戻す</span></h4><p>REVISION 1 に戻します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout undo deployment tocochan --to-revision=1</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -l name=tocochan</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NAME                        READY     STATUS        RESTARTS   AGE<br>tocochan-1297744065-2qb87   1/1       Terminating   0          6m<br>tocochan-4006188167-zswcj   1/1       Running       0          7s</p>
</blockquote>
<p>先ほどと同様に既存コンテナが停止しコンテナが新たに起動している様子がわかります。</p>
<h4><span id="外部から接続できる">外部から接続できる？</span></h4><p>ここまでの Pod の状態で以下コマンドを実行します。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NAME         CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br>kubernetes   10.3.240.1   <none>        443/TCP   3h</none></p>
</blockquote>
<p>kubernetes の cluster-ip が割り振られている以外は特に IP が割り振られておらず<br>外部からアクセスできない状態です。</p>
<p>外部からアクセス出来る様、設定する必要があります。</p>
<h2><span id="service-作成">Service 作成</span></h2><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170803/20170803142453.png" width="100%">
</div>

<p>外部向けの IP を設定し、外部から Pod にアクセス出来る様にルーティングします。</p>
<ul>
<li>service.yaml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<h4><span id="service-作成">Service 作成</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f service.yaml</span><br></pre></td></tr></table></figure>

<h4><span id="service-確認">Service 確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc</span><br></pre></td></tr></table></figure>

<p>数分経過すると <pending> から IPになります。</pending></p>
<blockquote>
<p>NAME         CLUSTER-IP    EXTERNAL-IP      PORT(S)          AGE<br>kubernetes   10.3.240.1    <none>           443/TCP          10m<br>tocochan     10.3.240.70   xx.xxx.xxx.xxx   5000:32429/TCP   10m</none></p>
</blockquote>
<p>以下コマンドで Web ページにアクセス出来ることが確認できます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v http://<span class="variable">$EXTERNAL</span>-IP:5000</span><br></pre></td></tr></table></figure>

<h2><span id="ロードバランサー作成">ロードバランサー作成</span></h2><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170803/20170803142609.png" width="100%">
</div>

<p>ロードバランサーを立てることが可能です。<br>80 port で受け、5000 port をバックエンドに流します。</p>
<ul>
<li>ingress.yaml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-world</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/*</span></span><br><span class="line">         <span class="attr">backend:</span></span><br><span class="line">           <span class="attr">serviceName:</span> <span class="string">hello-world</span></span><br><span class="line">           <span class="attr">servicePort:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<h4><span id="ingress-作成">Ingress 作成</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ingress.yaml</span><br></pre></td></tr></table></figure>

<h4><span id="ingress-確認">Ingress 確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ingress tocochan</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NAME       HOSTS     ADDRESS        PORTS     AGE<br>tocochan   *         yy.yyy.yy.yy   80        10m</p>
</blockquote>
<p>以下アクセスで先ほど実施した <code>curl -v http://$EXTERNAL-IP:5000</code> と同様の結果が取得できることがわかります。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://<span class="variable">$INGRESS_IP</span>/</span><br></pre></td></tr></table></figure>

<h3><span id="設定ファイルをまとめる">設定ファイルをまとめる</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'---'</span> &gt; hyphen.txt; \</span><br><span class="line">  cat \</span><br><span class="line">  deployment.yaml \</span><br><span class="line">  hyphen.txt \</span><br><span class="line">  service.yaml \</span><br><span class="line">  hyphen.txt \</span><br><span class="line">  ingress.yaml \</span><br><span class="line">&gt; all.yaml; \</span><br><span class="line">rm hyphen.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>all.yaml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gcr.io/mametsubuservice-175801/tocochan:v0.0.1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tocochan</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/*</span></span><br><span class="line">         <span class="attr">backend:</span></span><br><span class="line">           <span class="attr">serviceName:</span> <span class="string">tocochan</span></span><br><span class="line">           <span class="attr">servicePort:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>


<p>以降、以下コマンドで OK !</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f all.yaml --record</span><br></pre></td></tr></table></figure>

<h2><span id="ドメイン取得">ドメイン取得</span></h2><p><code>toda-tocochan-bus.tk</code> は <a href="http://www.freenom.com/ja/index.html">freenom</a> で無料ドメイン取得し<br>Ingress の IP を設定し公開しています。</p>
<h2><span id="総評">総評</span></h2><p>ローカルで開発して〜デプロイ、という流れが本当に簡単になりました。<br>コンテナの理念遂行に kubernetes は大きく寄与しているなぁと実感しました。</p>
<p>以上です。<br>参考になれば幸いです。</p>
</div></article></div><nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/8/">前</a></div><div class="pagination-next"><a href="/page/10/">次</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/8/">8</a></li><li><a class="pagination-link is-current" href="/page/9/">9</a></li><li><a class="pagination-link" href="/page/10/">10</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/22/">22</a></li></ul></nav></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="kenzo0107"></figure><p class="title is-size-4 is-block line-height-inherit">kenzo0107</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">投稿</p><a href="/archives"><p class="title">216</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">カテゴリ</p><a href="/categories"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">タグ</p><a href="/tags"><p class="title">88</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/kenzo0107" target="_blank" rel="noopener">フォローする</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/kenzo0107"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">カテゴリ</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AWS/"><span class="level-start"><span class="level-item">AWS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Go/"><span class="level-start"><span class="level-item">Go</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Terraform/"><span class="level-start"><span class="level-item">Terraform</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最近の記事</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2021-09-20T15:00:00.000Z">2021-09-21</time></p><p class="title is-6"><a class="link-muted" href="/2021/09/20/2021-09-21-dynamodb-query-better-than-scan/">DynamoDB Scan ではなく Query を使おう！ ~GSI の設定には気をつけようの巻~</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-09-06T15:00:00.000Z">2021-09-07</time></p><p class="title is-6"><a class="link-muted" href="/2021/09/06/2021-09-07-nginx_access_log_host_empty/">Nginx access_log $host が _ になる件調査</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-07-26T15:00:00.000Z">2021-07-27</time></p><p class="title is-6"><a class="link-muted" href="/2021/07/26/2021-07-27-ecs-execute-command-agent-not-running/">ecs execute command が失敗した際に調査したこと</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/AWS/">AWS</a></p></div></article><article class="media"><a class="media-left" href="/2021/07/08/2021-07-09-shukujitsu-go-library/"><p class="image is-64x64"><img class="thumbnail" src="https://github.com/kenzo0107/shukujitsu/raw/main/logo.jpg" alt="日本の祝日判定 Go ライブラリ shukujitsu を作った"></p></a><div class="media-content size-small"><p><time dateTime="2021-07-08T15:00:00.000Z">2021-07-09</time></p><p class="title is-6"><a class="link-muted" href="/2021/07/08/2021-07-09-shukujitsu-go-library/">日本の祝日判定 Go ライブラリ shukujitsu を作った</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Go/">Go</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-05-19T15:00:00.000Z">2021-05-20</time></p><p class="title is-6"><a class="link-muted" href="/2021/05/19/2021-05-20-nginx-no-logging-at-elb-healthcheck/">Nginx で ELB のヘルスチェックのログを出力させない</a></p><p class="is-uppercase"></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">タグ</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/htaccess/"><span class="tag">.htaccess</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ALB/"><span class="tag">ALB</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AWS/"><span class="tag">AWS</span><span class="tag is-grey-lightest">39</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AntiVirus/"><span class="tag">AntiVirus</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apache/"><span class="tag">Apache</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chef/"><span class="tag">Chef</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CodeBuild/"><span class="tag">CodeBuild</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cookie/"><span class="tag">Cookie</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Corosync/"><span class="tag">Corosync</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Datadog/"><span class="tag">Datadog</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECR/"><span class="tag">ECR</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECS/"><span class="tag">ECS</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElastiCache/"><span class="tag">ElastiCache</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Elasticsearch/"><span class="tag">Elasticsearch</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Email/"><span class="tag">Email</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FTPS/"><span class="tag">FTPS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fluentd/"><span class="tag">Fluentd</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GKE/"><span class="tag">GKE</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GitHub-Actions/"><span class="tag">GitHub Actions</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">26</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GooglePlay/"><span class="tag">GooglePlay</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hubot/"><span class="tag">Hubot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jenkins/"><span class="tag">Jenkins</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kibana/"><span class="tag">Kibana</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LINE-Notify/"><span class="tag">LINE Notify</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Lambda/"><span class="tag">Lambda</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Let-s-encrypt/"><span class="tag">Let&#039;s encrypt</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MachineLearning/"><span class="tag">MachineLearning</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Monitoring/"><span class="tag">Monitoring</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag is-grey-lightest">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenSSL/"><span class="tag">OpenSSL</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Outlook/"><span class="tag">Outlook</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP/"><span class="tag">PHP</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pacemaker/"><span class="tag">Pacemaker</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ProxySQL/"><span class="tag">ProxySQL</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Puppeteer/"><span class="tag">Puppeteer</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rails/"><span class="tag">Rails</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RaspberryPI/"><span class="tag">RaspberryPI</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reactio/"><span class="tag">Reactio</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ruby/"><span class="tag">Ruby</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/S3/"><span class="tag">S3</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSL/"><span class="tag">SSL</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Security/"><span class="tag">Security</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SendGrid/"><span class="tag">SendGrid</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Slack/"><span class="tag">Slack</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SonarQube/"><span class="tag">SonarQube</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/StatsBot/"><span class="tag">StatsBot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Terraform/"><span class="tag">Terraform</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Twilio/"><span class="tag">Twilio</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Unity/"><span class="tag">Unity</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vagrant/"><span class="tag">Vagrant</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vault/"><span class="tag">Vault</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WAF/"><span class="tag">WAF</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zabbix/"><span class="tag">Zabbix</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/awk/"><span class="tag">awk</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/casperjs/"><span class="tag">casperjs</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu/"><span class="tag">cpu</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/csv/"><span class="tag">csv</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flask/"><span class="tag">flask</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/i-node/"><span class="tag">i-node</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iftop/"><span class="tag">iftop</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ipinfo/"><span class="tag">ipinfo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iptable/"><span class="tag">iptable</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kibana/"><span class="tag">kibana</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macos/"><span class="tag">macos</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/no-ip/"><span class="tag">no-ip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ping/"><span class="tag">ping</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pip/"><span class="tag">pip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reCAPTCHA/"><span class="tag">reCAPTCHA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sftp/"><span class="tag">sftp</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spam/"><span class="tag">spam</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vim/"><span class="tag">vim</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wget/"><span class="tag">wget</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/yum/"><span class="tag">yum</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zsh/"><span class="tag">zsh</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6265337967545472" data-ad-slot="9975280607" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a><p class="size-small"><span>&copy; 2021 Kenzo Tanaka</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("ja");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://kenzo0107.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: ''
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Zurück nach oben" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"投稿","pages":"Pages","categories":"カテゴリ","tags":"タグ"});
        });</script></body></html>