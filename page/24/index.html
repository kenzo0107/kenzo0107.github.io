<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>長生村本郷Engineers&#039;Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="長生村本郷Engineers&#039;Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="長生村本郷Engineers&#039;Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="tech"><meta property="og:type" content="blog"><meta property="og:title" content="長生村本郷Engineers&#039;Blog"><meta property="og:url" content="https://kenzo0107.github.io/"><meta property="og:site_name" content="長生村本郷Engineers&#039;Blog"><meta property="og:description" content="tech"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://kenzo0107.github.io/img/og_image.png"><meta property="article:author" content="Kenzo Tanaka"><meta property="article:tag" content="aws golang"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://kenzo0107.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kenzo0107.github.io"},"headline":"長生村本郷Engineers'Blog","image":["https://kenzo0107.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Kenzo Tanaka"},"publisher":{"@type":"Organization","name":"長生村本郷Engineers'Blog","logo":{"@type":"ImageObject","url":"https://kenzo0107.github.io/img/logo.svg"}},"description":"tech"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-162026478-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-162026478-1');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><script data-ad-client="ca-pub-6265337967545472" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="長生村本郷Engineers'Blog" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/2013/12/31/about/">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/kenzo0107"><i class="fab fa-twitter"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a><a class="navbar-item search" title="検索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-10-desktop is-12-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-12-31</span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-07T03:41:24.575Z" title="5/7/2020, 3:41:24 AM">2020-05-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/30/2015-12-31-pod-install-assersion/">pod install で ASSERSION対策</a></h1><div class="content"><p>pod install で ASSERSION対策</p>
<h2><span id="概要">概要</span></h2><p><code>pod install</code> 実行時に正常にインストール処理ができなかったのでメモ。</p>
<p>冬休み中にSwift2.0をほんきで学ぶ為、以下書籍購入してチャレンジ。</p>
<a href="https://www.amazon.co.jp/exec/obidos/ASIN/4798142352/kenzo0107-22/" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img></div><div class="descriptions"><div class="og-title">ほんきで学ぶSwift+iOSアプリ開発入門 Swift2, Xcode7, iOS9対応 | 加藤 勝也 |本 | 通販 | Amazon</div><div class="og-description">Amazonで加藤 勝也のほんきで学ぶSwift+iOSアプリ開発入門 Swift2, Xcode7, iOS9対応。アマゾンならポイント還元本が多数。加藤 勝也作品ほか、お急ぎ便対象商品は当日お届けも可能。またほんきで学ぶSwift+iOSアプリ開発入門 Swift2, Xco…</div></div></div></a>


<p>これの LESSON 31 でCocoaPodsインストール手順がありますが<br>その通りに進めた際にエラー発生したので対策をまとめました。</p>
<p>この手のエラーは環境依存が主ですし、<br>書籍の執筆時も技術は日進月歩進んでおりますので書籍を責めず<br>CocoaPodsオフィシャルサイトやStackOverFlowなどで情報探ってみるのが<br>精神衛生上も良いかもしれないです。</p>
<h2><span id="環境情報">環境情報</span></h2><ul>
<li>Xcode 7.2 (7C68)</li>
<li>ruby 2.0.0p645</li>
<li>gem 2.5.0</li>
</ul>
<h2><span id="書籍に記載されているコマンド">書籍に記載されているコマンド</span></h2><h3><span id="cocoapodsインストール">CocoaPodsインストール</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo gem install -n &#x2F;usr&#x2F;local&#x2F;bin cocoa pods</span><br></pre></td></tr></table></figure>

<h3><span id="エラー内容">エラー内容</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ pod install</span><br><span class="line">[!] Unable to load a specification for the plugin &#96;&#x2F;opt&#x2F;homebrew-cask&#x2F;Caskroom&#x2F;cocoapods&#x2F;0.37.0&#x2F;CocoaPods.app&#x2F;Contents&#x2F;Resources&#x2F;bundle&#x2F;lib&#x2F;ruby&#x2F;gems&#x2F;2.2.0&#x2F;gems&#x2F;cocoapods-plugins-install-0.0.1&#96;</span><br><span class="line">Analyzing dependencies</span><br><span class="line"></span><br><span class="line">CocoaPods 1.0.0.beta.1 is available.</span><br><span class="line">To update use: &#96;sudo gem install cocoapods --pre&#96;</span><br><span class="line">[!] This is a test version we&#39;d love you to try.</span><br><span class="line"></span><br><span class="line">For more information see http:&#x2F;&#x2F;blog.cocoapods.org</span><br><span class="line">and the CHANGELOG for this version http:&#x2F;&#x2F;git.io&#x2F;BaH8pQ.</span><br><span class="line"></span><br><span class="line">Downloading dependencies</span><br><span class="line">Installing Realm (0.97.0)</span><br><span class="line">Installing RealmSwift (0.97.0)</span><br><span class="line">Generating Pods project</span><br><span class="line">2015-12-31 10:51:38.680 ruby[6275:47591] [MT] DVTAssertions: ASSERTION FAILURE in &#x2F;Library&#x2F;Caches&#x2F;com.apple.xbs&#x2F;Sources&#x2F;IDEFrameworks&#x2F;IDEFrameworks-9548&#x2F;IDEFoundation&#x2F;Initialization&#x2F;IDEInitialization.m:590</span><br><span class="line">Details:  Assertion failed: _initializationCompletedSuccessfully</span><br><span class="line">Function: BOOL IDEIsInitializedForUserInteraction()</span><br><span class="line">Thread:   &lt;NSThread: 0x7fc66d067980&gt;&#123;number &#x3D; 1, name &#x3D; main&#125;</span><br><span class="line">Hints: None</span><br><span class="line">Backtrace:</span><br><span class="line">  0  0x000000010e001f7f -[DVTAssertionHandler handleFailureInFunction:fileName:lineNumber:assertionSignature:messageFormat:arguments:] (in DVTFoundation)</span><br><span class="line">  1  0x000000010e00170c _DVTAssertionHandler (in DVTFoundation)</span><br><span class="line">  2  0x000000010e001978 _DVTAssertionFailureHandler (in DVTFoundation)</span><br><span class="line">  3  0x000000010e0018da _DVTAssertionFailureHandler (in DVTFoundation)</span><br><span class="line">  4  0x0000000110e5154d IDEIsInitializedForUserInteraction (in IDEFoundation)</span><br><span class="line">  5  0x000000011393a631 +[PBXProject projectWithFile:errorHandler:readOnly:] (in DevToolsCore)</span><br><span class="line">  6  0x000000011393c1b6 +[PBXProject projectWithFile:errorHandler:] (in DevToolsCore)</span><br><span class="line">  7  0x00007fff93b2af14 ffi_call_unix64 (in libffi.dylib)</span><br><span class="line">zsh: abort      pod install</span><br></pre></td></tr></table></figure>

<h2><span id="対策">対策</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 既にインストール済みのCocoaPodsをアンインストールする</span><br><span class="line">$ sudo gem uninstall cocoapods</span><br><span class="line"></span><br><span class="line"># 再度 &#96;cocoapods&#96; をインストールする。</span><br><span class="line">$ sudo gem install  -n &#x2F;usr&#x2F;local&#x2F;bin cocoapods</span><br></pre></td></tr></table></figure>

<h2><span id="実行確認">実行確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$  pod install</span><br><span class="line">Updating local specs repositories</span><br><span class="line"></span><br><span class="line">CocoaPods 1.0.0.beta.1 is available.</span><br><span class="line">To update use: &#96;gem install cocoapods --pre&#96;</span><br><span class="line">[!] This is a test version we&#39;d love you to try.</span><br><span class="line"></span><br><span class="line">For more information see http:&#x2F;&#x2F;blog.cocoapods.org</span><br><span class="line">and the CHANGELOG for this version http:&#x2F;&#x2F;git.io&#x2F;BaH8pQ.</span><br><span class="line"></span><br><span class="line">Analyzing dependencies</span><br><span class="line">Downloading dependencies</span><br><span class="line">Installing Realm (0.97.0)</span><br><span class="line">Installing RealmSwift (0.97.0)</span><br><span class="line">Generating Pods project</span><br><span class="line">Integrating client project</span><br><span class="line"></span><br><span class="line">[!] Please close any current Xcode sessions and use &#96;Chapter6.xcworkspace&#96; for this project from now on.</span><br><span class="line">Sending stats</span><br><span class="line">Pod installation complete! There is 1 dependency from the Podfile and 2 total pods</span><br><span class="line">installed.</span><br><span class="line"></span><br><span class="line">~&#x2F;honki_swift&#x2F;Chapter6&#x2F;LESSON31&#x2F;before&#x2F;Chapter6</span><br></pre></td></tr></table></figure>

<p>無事、 .xcworkspace, Podfile.lock, Pods が作成されました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[~&#x2F;honki_swift&#x2F;Chapter6&#x2F;LESSON31&#x2F;before&#x2F;Chapter6]$ tree -L 1</span><br><span class="line">.</span><br><span class="line">├── Chapter6</span><br><span class="line">├── Chapter6.xcodeproj</span><br><span class="line">├── Chapter6.xcworkspace</span><br><span class="line">├── Podfile</span><br><span class="line">├── Podfile.lock</span><br><span class="line">└── Pods</span><br></pre></td></tr></table></figure>

<p>以上です。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-12-26</span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-07T03:41:24.524Z" title="5/7/2020, 3:41:24 AM">2020-05-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/25/2015-12-26-aws-multi-az-pacemaker-corosync-switching-eip/">AWS Multi-AZにおける Pacemaker + Corosync による Elastic IP の付け替え</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Pacemaker &amp; Corosync による<br>AWS での Multi-AZ 間のEIP付け替えによる<br>フェイルオーバーについて実装したのでまとめます。</p>
<p>以下イメージです。</p>
<ul>
<li>通常状態</li>
</ul>
<p><img src="http://i.imgur.com/QBvFhti.png" alt="Normal"></p>
<ul>
<li>Avalavility Zone A に配置された Instance A で障害が発生した場合<br>Avalavility Zone B に配置された Instance B に EIPを付け替え</li>
</ul>
<p><img src="http://i.imgur.com/xoJ3h8s.png?1" alt="Accident occured"></p>
<h2><span id="todo">ToDo</span></h2><ul>
<li>VPC, Subnet 設定</li>
<li>Pacemaker &amp; Corosync インストール / 設定</li>
<li>Cluster 構築</li>
<li>EIP付け替えスクリプト作成</li>
<li>フェイルオーバー試験</li>
</ul>
<h2><span id="環境">環境</span></h2><ul>
<li>CentOS 7 (x86_64) with Updates HVM (t2.micro)<br>※ 検証用の為、 t2.microで実施しています。</li>
</ul>
<h2><span id="vpc-subnet-構築">VPC, Subnet 構築</span></h2><p>以下記事にて非常によくまとめて頂いているので参考にしていただき<br>この設定を以降そのまま利用します。</p>
<p><a target="_blank" rel="noopener" href="http://qiita.com/hiroshik1985/items/9de2dd02c9c2f6911f3b">0から始めるAWS入門①：VPC編</a></p>
<h5><span id="念のため-以下-vpc-subnet-設定です">念のため、以下 VPC, Subnet 設定です。</span></h5><ul>
<li>VPC 設定</li>
</ul>
<table>
<thead>
<tr>
<th><em>項目</em></th>
<th><em>値</em></th>
</tr>
</thead>
<tbody><tr>
<td>Name tag</td>
<td>任意</td>
</tr>
<tr>
<td>CIDR</td>
<td>10.0.0.0/16</td>
</tr>
<tr>
<td>tenancy</td>
<td>Default</td>
</tr>
</tbody></table>
<ul>
<li>Subnet 設定</li>
</ul>
<table>
<thead>
<tr>
<th><em>項目</em></th>
<th>Subnet 1</th>
<th>Subnet 2</th>
</tr>
</thead>
<tbody><tr>
<td>Name tag</td>
<td>任意(VPCのタグ名と関連付けたほうが管理しやすい)</td>
<td>任意(VPCのタグ名と関連付けたほうが管理しやすい)</td>
</tr>
<tr>
<td>VPC</td>
<td>上記で作成したVPCを選択する</td>
<td>上記で作成したVPCを選択する</td>
</tr>
<tr>
<td>Availability Zone</td>
<td>ap-northeast-1a</td>
<td>ap-northeast-1c</td>
</tr>
<tr>
<td>CIDR</td>
<td>10.0.0.0/24</td>
<td>10.0.1.0/24</td>
</tr>
</tbody></table>
<p>上記VPC設定に基づき以下設定していきます。</p>
<p>構築するイメージは以下になります。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/Vecob6k.png" width="100%">
</div>


<h2><span id="セキュリティグループ作成">セキュリティグループ作成</span></h2><p>今回作成するインスタンス2つにアタッチするセキュリティグループを事前に作成します。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/OMoO3DE.png" width="100%">
</div>

<h4><span id="マイipからのsshログイン許可">マイIPからのSSHログイン許可</span></h4><table>
<thead>
<tr>
<th><em>項目</em></th>
<th>設定値</th>
</tr>
</thead>
<tbody><tr>
<td>セキュリティグループ名</td>
<td>VPC-for-EIP(任意)</td>
</tr>
<tr>
<td>説明</td>
<td>VPC-for-EIP(任意)</td>
</tr>
<tr>
<td>VPC</td>
<td>上記で作成したVPCを選択する</td>
</tr>
</tbody></table>
<div style="text-align:center;">
<img src="http://i.imgur.com/PV3aosl.png" width="100%">
</div>


<h4><span id="作成したセキュリティグループ編集">作成したセキュリティグループ編集</span></h4><ul>
<li>フィルターで検索<div style="text-align:center;">
<img src="http://i.imgur.com/iCAVdLY.png" width="100%">
</div>

</li>
</ul>
<p><span style="color:red">※以下は環境により変更してください。</span></p>
<ul>
<li>送信元を作成したグループIDとし以下追加し保存</li>
</ul>
<table>
<thead>
<tr>
<th><em>タイプ</em></th>
<th><em>プロトコル</em></th>
<th><em>ポート範囲</em></th>
<th><em>送信元</em></th>
<th><em>用途</em></th>
</tr>
</thead>
<tbody><tr>
<td>すべてのTCP</td>
<td>TCP</td>
<td>0 - 65535</td>
<td>作成したセキュリティグループID</td>
<td>今回は検証用の為、全解放。適宜設定変更してください。</td>
</tr>
<tr>
<td>すべてのICMP</td>
<td>ICMP</td>
<td>0 - 65535</td>
<td>作成したセキュリティグループID</td>
<td>ping疎通確認用。今回は検証用の為、全解放  適宜設定変更してください。</td>
</tr>
<tr>
<td>すべてのUDP</td>
<td>UDP</td>
<td>0 - 65535</td>
<td>作成したセキュリティグループID</td>
<td>corosyncで必要なポートはデフォルトで 5404 - 5405。  環境により設定変更する場合は注意が必要です。今回は検証用の為、全解放。適宜設定変更してください。</td>
</tr>
<tr>
<td>SSH</td>
<td>TCP</td>
<td>20</td>
<td>マイIP</td>
<td>自PC端末からSSHログイン用。実環境で設定する必要はありません。</td>
</tr>
<tr>
<td>HTTP</td>
<td>TCP</td>
<td>80</td>
<td>マイIP</td>
<td>FailOver検証用。実環境で設定する必要はありません。</td>
</tr>
</tbody></table>
<div style="text-align:center;">
<img src="http://i.imgur.com/tqo68AU.png" width="100%">
</div>

<p>以上でインスタンスに適用するセキュリティグループの作成が完了しました。</p>
<hr>
<h2><span id="ポリシー作成">ポリシー作成</span></h2><p>今回、以下コマンドを実行する必要があります。</p>
<table>
<thead>
<tr>
<th><em>コマンド</em></th>
<th><em>用途</em></th>
</tr>
</thead>
<tbody><tr>
<td>aws ec2 associate-address</td>
<td>ElasticIPをインスタンスに関連付ける</td>
</tr>
<tr>
<td>aws ec2 disassociate-address</td>
<td>ElasticIPをインスタンス関連付け解除</td>
</tr>
<tr>
<td>aws ec2 describe-addresses</td>
<td>IPアドレスについて詳細取得</td>
</tr>
</tbody></table>
<h5><span id="identity-amp-access-management-ページにアクセス">Identity &amp; Access Management ページにアクセス</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/SXbwsQO.png" width="100%">
</div>

<h5><span id="ポシリー作成クリック">「ポシリー作成」クリック</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/YtCrsuO.png" width="100%">
</div>

<h5><span id="独自ポリシー作成">独自ポリシー作成</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/ESnqZ9e.png" width="100%">
</div>

<h5><span id="独自ポリシー情報入力">独自ポリシー情報入力</span></h5><ul>
<li>ポリシー名(任意)</li>
</ul>
<p>floatingElasticIP</p>
<ul>
<li>ポリシードキュメント</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">            &quot;Action&quot;: [</span><br><span class="line">                &quot;ec2:Describe*&quot;,</span><br><span class="line">                &quot;ec2:DisassociateAddress&quot;,</span><br><span class="line">                &quot;ec2:AssociateAddress&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Resource&quot;: [</span><br><span class="line">                &quot;*&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div style="text-align:center;">
<img src="http://i.imgur.com/pBl5BIx.png" width="100%">
</div>

<h5><span id="確認">確認</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/NQCNu3S.png" width="100%">
</div>





<h2><span id="iamロール作成">IAMロール作成</span></h2><p>ElasticIPの付け替え権限を持ったロールを作成します。</p>
<h5><span id="新しいロールの作成-をクリック">新しいロールの作成 をクリック</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/5gceMNE.png" width="100%">
</div>

<h5><span id="ロール名の設定">ロール名の設定</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/jm6Xd6R.png" width="100%">
</div>

<h5><span id="ロールタイプの選択">ロールタイプの選択</span></h5><p><code>Amazon EC2</code> の「選択」ボタンをクリック</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/1WlUrxd.png" width="100%">
</div>

<h5><span id="ポリシーのアタッチ">ポリシーのアタッチ</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/2SQnomX.png" width="100%">
</div>

<h5><span id="登録内容を確認しロールの作成">登録内容を確認しロールの作成</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/2ShhAQb.png" width="100%">
</div>

<h5><span id="作成されたか確認">作成されたか確認</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/ku9OuEY.png" width="100%">
</div>

<p>以上でインスタンスに適用するIAMロールの作成が完了しました。</p>
<h2><span id="ユーザ作成">ユーザ作成</span></h2><h5><span id="identity-amp-access-management-ページにアクセス">Identity &amp; Access Management ページにアクセス</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/SXbwsQO.png" width="100%">
</div>

<h5><span id="メニューからユーザクリック-amp-新規ユーザの作成-ボタンクリック">メニューからユーザクリック &amp; 新規ユーザの作成 ボタンクリック</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/CgXjbXe.png" width="100%">
</div>

<h5><span id="ユーザ名入力し作成ボタンクリック">ユーザ名入力し作成ボタンクリック</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/krwAV7x.png" width="100%">
</div>

<h5><span id="認証情報をダウンロードクリック">認証情報をダウンロードクリック</span></h5><p><code>Access Key Id</code> と <code>Secret Access Key</code> が記載されたCSVがダウンロードされます。<br>大切に保管しましょう。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/aijHfiD.png" width="100%">
</div>

<h5><span id="作成されたユーザーにアクセス">作成されたユーザーにアクセス</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/GZlHWhS.png" width="100%">
</div>


<h5><span id="ポリシーのアタッチ開始">ポリシーのアタッチ開始</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/7eqSqLN.png" width="100%">
</div>

<h5><span id="ポリシーにチェックを入れアタッチ">ポリシーにチェックを入れアタッチ</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/GzFx20A.png" width="100%">
</div>

<p>以上で<br><code>AmazonEC2FullAccess</code> 権限を持ったユーザ <code>floatingIP</code> ユーザが作成されました。</p>
<p>上記ユーザの認証情報は 手順 <code>aws-cli インストール</code> で利用します。</p>
<hr>
<h2><span id="インスタンスの作成">インスタンスの作成</span></h2><ul>
<li>上記で作成したVPCのSubnet (ap-northeast-1a)にインスタンス (以降Instance A)を作成します。</li>
</ul>
<h4><span id="インスタンスの作成をクリック">「インスタンスの作成」をクリック</span></h4><div style="text-align:center;">
<img src="http://i.imgur.com/xUusATW.png" width="100%">
</div>


<h4><span id="マシンイメージ選択">マシンイメージ選択</span></h4><p>今回は <code>CentOS 7 (x86_64) with Updates HVM</code> を選択します。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/lpufR9j.png" width="100%">
</div>


<h4><span id="インスタンスタイプ選択">インスタンスタイプ選択</span></h4><p>今回は検証用で無料枠として利用したいので <code>t2.micro</code> を選択します。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/6dtDEyx.png" width="100%">
</div>

<h4><span id="インスタンスの詳細の設定">インスタンスの詳細の設定</span></h4><p><code>ap-northeast-1a</code> に作成する <code>Instance A</code> のプライマリIPを<br><code>10.0.0.20</code> とします。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/NLKElwj.png" width="100%">
</div>


<h4><span id="ストレージの追加">ストレージの追加</span></h4><p>特に変更することなく次の手順へ</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/oxgrhev.png" width="100%">
</div>


<h4><span id="インスタンスのタグ付け">インスタンスのタグ付け</span></h4><p><code>Name</code> タグに <code>Instance A</code> と指定します。<br>※ 任意なのでわかりやすいテキストであれば良いです。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/hPol99o.png" width="100%">
</div>


<h4><span id="セキュリティグループの設定">セキュリティグループの設定</span></h4><ul>
<li>事前に作成したセキュリティグループを選択</li>
</ul>
<div style="text-align:center;">
<img src="http://i.imgur.com/M0eWyCo.png" width="100%">
</div>


<h4><span id="インスタンス作成の確認">インスタンス作成の確認</span></h4><div style="text-align:center;">
<img src="http://i.imgur.com/IAEUp2R.png" width="100%">
</div>

<p>以上で <code>Insntace A</code> の作成が完了しました。</p>
<h2><span id="同様に-instance-b-作成">同様に <code>Instance B</code> 作成</span></h2><h6><span id="instance-a-との主な変更点"><code>Instance A</code> との主な変更点</span></h6><ul>
<li>Subnet <code>10.0.1.0/24</code> を選択</li>
<li>インスタンスのタグは <code>Instance B</code> とする</li>
</ul>
<h6><span id="instance-b-設定時注意点"><code>Instance B</code> 設定時注意点</span></h6><ul>
<li><code>セキュリティグループ</code> は <code>Instance B</code> でも同様 <code>Instance A</code> で設定した<br><code>セキュリティグループ</code> を選択する。</li>
</ul>
<div style="text-align:center;">
<img src="http://i.imgur.com/it25cK3.png" width="100%">
</div>


<h2><span id="送信元送信先の変更チェックを無効化">送信元/送信先の変更チェックを無効化</span></h2><p>※上記 Instance A, B 共に <code>Source/Destination Check</code> (ネットワーク &gt; 送信元/送信先の変更チェック) を <code>Disabled</code> (無効) に設定する必要があります。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/eYjJF0i.png" width="100%">
</div>


<h2><span id="インスタンス-sshログイン後まずやること">インスタンス SSHログイン後まずやること</span></h2><h4><span id="最低限必要なモジュールインストール">最低限必要なモジュールインストール</span></h4><p>※ git は ElasticIP付け替え時のシェルをインストールする際に必要になります。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Instance A &amp; B ]# yum install -y git</span><br><span class="line"></span><br><span class="line">[Instance A &amp; B ]# git --version</span><br><span class="line"></span><br><span class="line">git version 1.8.3.1</span><br></pre></td></tr></table></figure>

<h4><span id="fail-over-検証用に-httpd-php-インストール">Fail Over 検証用に httpd, php インストール</span></h4><p>あくまで Fail Over 時の動きを見る為の確認用にインストールし起動しています。<br><span style="color:red">※必須工程ではありません。</span></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Instance A &amp; B ]# yum --disableexcludes&#x3D;main install -y gcc</span><br><span class="line">[Instance A &amp; B ]# yum install -y gmp gmp-devel</span><br><span class="line">[Instance A &amp; B ]# yum install -y php php-mysql httpd libxml2-devel net-snmp net-snmp-devel curl-devel gettext</span><br><span class="line">[Instance A &amp; B ]# echo &#39;&lt;?php print_r($_SERVER[&quot;SERVER_ADDR&quot;]); ?&gt;&#39; &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;index.php</span><br><span class="line">[Instance A &amp; B ]# systemctl start httpd</span><br><span class="line">[Instance A &amp; B ]# systemctl enable httpd</span><br></pre></td></tr></table></figure>



<h4><span id="system-clock-調整-jst設定">system clock 調整 JST設定</span></h4><p>OS内の時間が現実の時間とずれていると<br>aws-cliが正常に動作しない可能性があるので<br>念の為、調整しておきます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># バックアップ確保</span><br><span class="line">[Instance A &amp; B ]# cp &#x2F;etc&#x2F;sysconfig&#x2F;clock &#x2F;etc&#x2F;sysconfig&#x2F;clock.org</span><br><span class="line"></span><br><span class="line"># 再起動しても設定維持する様にする。</span><br><span class="line">[Instance A &amp; B ]# echo -e &#39;ZONE&#x3D;&quot;Asia&#x2F;Tokyo&quot;\nUTC&#x3D;false&#39; &gt; &#x2F;etc&#x2F;sysconfig&#x2F;clock</span><br><span class="line"></span><br><span class="line"># バックアップ確保</span><br><span class="line">[Instance A &amp; B ]# cp &#x2F;etc&#x2F;localtime &#x2F;etc&#x2F;localtime.org</span><br><span class="line"></span><br><span class="line"># Asia&#x2F;Tokyo を localtime に設定</span><br><span class="line">[Instance A &amp; B ]# ln -sf  &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;Asia&#x2F;Tokyo &#x2F;etc&#x2F;localtime</span><br><span class="line"></span><br><span class="line">[Instance A &amp; B ]# date</span><br></pre></td></tr></table></figure>



<h2><span id="elastic-ip作成">Elastic IP作成</span></h2><p>Elastic IPを作成し <code>Server A</code> に関連付けます。</p>
<h5><span id="新しいアドレスを割り当てる">新しいアドレスを割り当てる</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/Xcv1hQ5.png" width="100%">
</div>

<h5><span id="確認ポップアップで関連付けるをクリック">確認ポップアップで「関連付ける」をクリック</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/8LUxbhs.png" width="100%">
</div>

<h5><span id="成功確認">成功確認</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/UQ1YPk4.png" width="100%">
</div>

<h5><span id="インスタンスに関連付け">インスタンスに関連付け</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/Cpol9pv.png" width="100%">
</div>

<h5><span id="関連するインスタンス選択">関連するインスタンス選択</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/bJVJcSv.png" width="100%">
</div>

<h5><span id="確認">確認</span></h5><div style="text-align:center;">
<img src="http://i.imgur.com/uQlaHyf.png" width="100%">
</div>

<p>以上で Instance A に ElasticIP が関連付けされました。</p>
<h2><span id="instance-a-amp-b-に-sshログイン">Instance A &amp; B に SSHログイン</span></h2><ul>
<li><p>Instance A に SSHログイン</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Local PC]# ssh -i aws.pem centos@&lt;Instance AのPublic IP&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Instance B に SSHログイン</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Local PC]# ssh -i aws.pem centos@&lt;Instance BのPublic IP&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2><span id="etchosts設定">/etc/hosts設定</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# uname -n</span><br><span class="line">ip-10-0-0-10.ap-northeast-1.compute.internal</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Instance B ]# uname -n</span><br><span class="line">ip-10-0-1-10.ap-northeast-1.compute.internal</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Instance A &amp; B ]# vi &#x2F;etc&#x2F;hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line"># 以下追加</span><br><span class="line">10.0.0.20 ip-10-0-0-20.ap-northeast-1.compute.internal</span><br><span class="line">10.0.1.20 ip-10-0-1-20.ap-northeast-1.compute.internal</span><br></pre></td></tr></table></figure>

<h2><span id="pacemaker-amp-corosync-インストール">Pacemaker &amp; Corosync インストール</span></h2><ul>
<li>pcsは旧来のcrmshに代わるPacemakerクラスタ管理ツールであり、RHEL/CentOS7においてはpcsの使用が推奨されている。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Instance A &amp; B ]# yum -y install pcs fence-agents-all</span><br></pre></td></tr></table></figure>


<ul>
<li>バージョン確認</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Instance A &amp; B ]# pcs --version</span><br><span class="line">0.9.143</span><br><span class="line"></span><br><span class="line">[Instance A &amp; B ]# pacemakerd --version</span><br><span class="line">Pacemaker 1.1.13-10.el7</span><br><span class="line">Written by Andrew Beekhof</span><br><span class="line"></span><br><span class="line">[Instance A &amp; B ]# corosync -v</span><br><span class="line">Corosync Cluster Engine, version &#39;2.3.4&#39;</span><br><span class="line">Copyright (c) 2006-2009 Red Hat, Inc.</span><br></pre></td></tr></table></figure>



<h2><span id="hacluster-パスワード設定">hacluster パスワード設定</span></h2><p>corosyncパッケージインストール時に自動で <code>hacluster</code> ユーザが追加される。<br>その <code>hacluster</code> のパスワードを設定する。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Instance A &amp; B ]# passwd hacluster</span><br><span class="line">ユーザー hacluster のパスワードを変更。</span><br><span class="line">新しいパスワード:</span><br><span class="line">新しいパスワードを再入力してください:</span><br><span class="line">passwd: すべての認証トークンが正しく更新できました。</span><br></pre></td></tr></table></figure>



<h2><span id="pcsd-起動">pcsd 起動</span></h2><p>cluster監視を実施する為</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Instance A &amp; B ]# systemctl start pcsd</span><br><span class="line">[Instance A &amp; B ]# systemctl enable pcsd</span><br><span class="line">[Instance A &amp; B ]# systemctl status pcsd</span><br></pre></td></tr></table></figure>


<h2><span id="cluster認証">cluster認証</span></h2><p>クラスタを組む各ホストへのアクセス認証を検証します。</p>
<p>どちらか一方のInstanceから実行します。<br>以下はInstance Aから実行しています。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs cluster auth ip-10-0-0-20.ap-northeast-1.compute.internal ip-10-0-1-20.ap-northeast-1.compute.internal</span><br><span class="line">Username: hacluster</span><br><span class="line">Password:</span><br><span class="line">ip-10-0-1-20.ap-northeast-1.compute.internal: Authorized</span><br><span class="line">ip-10-0-0-20.ap-northeast-1.compute.internal: Authorized</span><br></pre></td></tr></table></figure>

<p>上記のように Authorized (認証済み) と出力されていれば問題ありませんが<br>以下のような <code>Unable to Communicate</code> というエラーが出力されている場合は<br><code>各Instance</code> の設定を見直してください。</p>
<ul>
<li>認証エラーの例<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs cluster auth ip-10-0-0-20.ap-northeast-1.compute.internal ip-10-0-1-20.ap-northeast-1.compute.internal -u hacluster -p ruby2015</span><br><span class="line">Error: Unable to communicate with ip-10-0-0-20.ap-northeast-1.compute.internal</span><br><span class="line">Error: Unable to communicate with ip-10-0-1-20.ap-northeast-1.compute.internal</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2><span id="cluster設定">cluster設定</span></h2><p>クラスタ設定をします。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs cluster setup --name aws-cluster ip-10-0-0-20.ap-northeast-1.compute.internal ip-10-0-1-20.ap-northeast-1.compute.internal --force</span><br><span class="line"></span><br><span class="line">Shutting down pacemaker&#x2F;corosync services...</span><br><span class="line">Redirecting to &#x2F;bin&#x2F;systemctl stop  pacemaker.service</span><br><span class="line">Redirecting to &#x2F;bin&#x2F;systemctl stop  corosync.service</span><br><span class="line">Killing any remaining services...</span><br><span class="line">Removing all cluster configuration files...</span><br><span class="line">ip-10-0-0-20.ap-northeast-1.compute.internal: Succeeded</span><br><span class="line">ip-10-0-1-20.ap-northeast-1.compute.internal: Succeeded</span><br><span class="line">Synchronizing pcsd certificates on nodes ip-10-0-0-20.ap-northeast-1.compute.internal, ip-10-0-1-20.ap-northeast-1.compute.internal...</span><br><span class="line">ip-10-0-0-20.ap-northeast-1.compute.internal: Success</span><br><span class="line">ip-10-0-1-20.ap-northeast-1.compute.internal: Success</span><br><span class="line"></span><br><span class="line">Restaring pcsd on the nodes in order to reload the certificates...</span><br><span class="line">ip-10-0-0-20.ap-northeast-1.compute.internal: Success</span><br><span class="line">ip-10-0-1-20.ap-northeast-1.compute.internal: Success</span><br></pre></td></tr></table></figure>


<h2><span id="cluster起動">cluster起動</span></h2><p>全ホストに向け クラスタ起動します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs cluster start --all</span><br><span class="line"></span><br><span class="line">ip-10-0-1-20.ap-northeast-1.compute.internal: Starting Cluster...</span><br><span class="line">ip-10-0-0-20.ap-northeast-1.compute.internal: Starting Cluster...</span><br></pre></td></tr></table></figure>

<h2><span id="aws-cli-インストール">aws-cli インストール</span></h2><p>手順: <code>ユーザ作成</code> でダウンロードした <code>credentials.csv</code> に記載された<br><code>Access Key Id</code> <code>Secret Access Key</code> を使用します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Instance A &amp; B ]# rpm -iUvh http:&#x2F;&#x2F;dl.fedoraproject.org&#x2F;pub&#x2F;epel&#x2F;7&#x2F;x86_64&#x2F;e&#x2F;epel-release-7-5.noarch.rpm</span><br><span class="line">[Instance A &amp; B ]# yum -y install python-pip</span><br><span class="line">[Instance A &amp; B ]# pip --version</span><br><span class="line">pip 7.1.0 from &#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;site-packages (python 2.7)</span><br><span class="line"></span><br><span class="line">[Instance A &amp; B ]# pip install awscli</span><br><span class="line">[Instance A &amp; B ]# aws configure</span><br><span class="line">AWS Access Key ID [None]: *********************</span><br><span class="line">AWS Secret Access Key [None]: **************************************</span><br><span class="line">Default region name [None]: ap-northeast-1</span><br><span class="line">Default output format [None]: json</span><br></pre></td></tr></table></figure>

<h2><span id="eip-付け替えリソース作成">EIP 付け替えリソース作成</span></h2><p>heartbeat で問題検知した際に起動するリソースとして登録します。</p>
<p><code>OCF_ROOT</code> が定数として指定されているが、存在しない為</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Instance A &amp; B ]# cd &#x2F;tmp</span><br><span class="line">[Instance A &amp; B ]# git clone https:&#x2F;&#x2F;github.com&#x2F;moomindani&#x2F;aws-eip-resource-agent.git</span><br><span class="line">[Instance A &amp; B ]# cd aws-eip-resource-agent</span><br><span class="line">[Instance A &amp; B ]# sed -i &#39;s&#x2F;\$&#123;OCF_ROOT&#125;&#x2F;\&#x2F;usr\&#x2F;lib\&#x2F;ocf&#x2F;&#39; eip</span><br><span class="line">[Instance A &amp; B ]# mv eip &#x2F;usr&#x2F;lib&#x2F;ocf&#x2F;resource.d&#x2F;heartbeat&#x2F;</span><br><span class="line">[Instance A &amp; B ]# chown root:root &#x2F;usr&#x2F;lib&#x2F;ocf&#x2F;resource.d&#x2F;heartbeat&#x2F;eip</span><br><span class="line">[Instance A &amp; B ]# chmod 0755 &#x2F;usr&#x2F;lib&#x2F;ocf&#x2F;resource.d&#x2F;heartbeat&#x2F;eip</span><br></pre></td></tr></table></figure>


<h2><span id="pacemaker-設定">pacemaker 設定</span></h2><h5><span id="stonish-無効化">stonish 無効化</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs property set stonith-enabled&#x3D;false</span><br></pre></td></tr></table></figure>

<h5><span id="split-brain-スプリットブレイン-が発生しても-quorum-クォーラム-が特別な動作を行わないように設定"><code>split-brain</code> (スプリット・ブレイン) が発生しても quorum (クォーラム) が特別な動作を行わないように設定</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs property set no-quorum-policy&#x3D;ignore</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>split-brain</code> とは<br>ハートビート通信を行うネットワークに断線などの問題が発生した場合、ホストに障害が起こったと勘違いし、<br>本来立ち上がってほしくないスタンバイ側のホストがアクティブになってしまうというもの</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="http://linux-ha.org/wiki/Split_Brain">Split-Brain wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://ja.wikipedia.org/wiki/Quorum">Quorum wiki</a></li>
</ul>
<h5><span id="属性値更新時の待ち時間-crmd-transition-delay-を-0s秒-設定">属性値更新時の待ち時間( <code>crmd-transition-delay</code> )を 0s(秒) 設定</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs property set crmd-transition-delay&#x3D;&quot;0s&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://linux-ha.osdn.jp/wp/archives/1498">Pacemaker-1.0.11 がリリースされました</a></li>
</ul>
<h5><span id="自動フェイルバックなし-同一サーバでリソースの再起動を試みる回数を-1-回に設定">自動フェイルバックなし、同一サーバでリソースの再起動を試みる回数を 1 回に設定</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs resource defaults resource-stickiness&#x3D;&quot;INFINITY&quot; migration-threshold&#x3D;&quot;1&quot;</span><br></pre></td></tr></table></figure>

<h5><span id="eip切り替え設定">EIP切り替え設定</span></h5><p>今回作成し <code>Instance A</code> に関連付けした ElasticIP は <code>52.192.203.215</code> です。<br>以下設定に反映させます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs resource create eip ocf:heartbeat:eip \</span><br><span class="line">    params \</span><br><span class="line">        elastic_ip&#x3D;&quot;52.192.203.215&quot; \</span><br><span class="line">    op start   timeout&#x3D;&quot;60s&quot; interval&#x3D;&quot;0s&quot;  on-fail&#x3D;&quot;stop&quot; \</span><br><span class="line">    op monitor timeout&#x3D;&quot;60s&quot; interval&#x3D;&quot;10s&quot; on-fail&#x3D;&quot;restart&quot; \</span><br><span class="line">    op stop    timeout&#x3D;&quot;60s&quot; interval&#x3D;&quot;0s&quot;  on-fail&#x3D;&quot;block&quot;</span><br></pre></td></tr></table></figure>

<h2><span id="cluster-設定確認">cluster 設定確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[Instance A ]# pcs config</span><br><span class="line"></span><br><span class="line">pcs config</span><br><span class="line">Cluster Name: aws-cluster</span><br><span class="line">Corosync Nodes:</span><br><span class="line"> ip-10-0-0-20.ap-northeast-1.compute.internal ip-10-0-1-20.ap-northeast-1.compute.internal</span><br><span class="line">Pacemaker Nodes:</span><br><span class="line"> ip-10-0-0-20.ap-northeast-1.compute.internal ip-10-0-1-20.ap-northeast-1.compute.internal</span><br><span class="line"></span><br><span class="line">Resources:</span><br><span class="line"> Resource: eip (class&#x3D;ocf provider&#x3D;heartbeat type&#x3D;eip)</span><br><span class="line">  Attributes: elastic_ip&#x3D;52.192.203.215</span><br><span class="line">  Operations: start interval&#x3D;0s timeout&#x3D;60s on-fail&#x3D;stop (eip-start-interval-0s)</span><br><span class="line">              monitor interval&#x3D;10s timeout&#x3D;60s on-fail&#x3D;restart (eip-monitor-interval-10s)</span><br><span class="line">              stop interval&#x3D;0s timeout&#x3D;60s on-fail&#x3D;block (eip-stop-interval-0s)</span><br><span class="line"></span><br><span class="line">Stonith Devices:</span><br><span class="line">Fencing Levels:</span><br><span class="line"></span><br><span class="line">Location Constraints:</span><br><span class="line">Ordering Constraints:</span><br><span class="line">Colocation Constraints:</span><br><span class="line"></span><br><span class="line">Resources Defaults:</span><br><span class="line"> resource-stickiness: INFINITY</span><br><span class="line"> migration-threshold: 1</span><br><span class="line">Operations Defaults:</span><br><span class="line"> No defaults set</span><br><span class="line"></span><br><span class="line">Cluster Properties:</span><br><span class="line"> cluster-infrastructure: corosync</span><br><span class="line"> cluster-name: aws-cluster</span><br><span class="line"> crmd-transition-delay: 0s</span><br><span class="line"> dc-version: 1.1.13-10.el7-44eb2dd</span><br><span class="line"> have-watchdog: false</span><br><span class="line"> no-quorum-policy: ignore</span><br><span class="line"> stonith-enabled: false</span><br></pre></td></tr></table></figure>

<h2><span id="fail-over-実行確認">Fail Over 実行確認</span></h2><p>手順 <code>Fail Over 検証用に httpd, php インストール</code> にて<br>DocumentRoot (/var/www/html/) に<br><code>Private IP</code> (<code>$_SERVER[&quot;SERVER_ADDR&quot;]</code>)  を表示させるindex.phpファイルを<br>配置しました。</p>
<p>ブラウザから Private IP を元に Instance A or B どちらのInstance に<br>アクセスしているかがわかります。</p>
<h5><span id="ブラウザから-elasticip-にアクセス">ブラウザから ElasticIP にアクセス</span></h5><p>ElasticIP <code>52.192.203.215</code> にアクセスすると<br>Private IP <code>10.0.0.20</code> が表示されていることがわかります。</p>
<p>現状、ElasticIP は Instance A に関連付いていることがわかります。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/fF2SwAb.png" width="100%">
</div>

<h5><span id="instance-a-の-corosync-停止">Instance A の corosync 停止</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Instance A]# systemctl stop corosync</span><br></pre></td></tr></table></figure>

<h5><span id="再度ブラウザから-elasticip-にアクセス">再度ブラウザから ElasticIP にアクセス</span></h5><p>先ほど表示させていたブラウザを幾度かリロードすると<br>Private IP <code>10.0.1.20</code> が表示されていることがわかります。</p>
<p>ElasticIP は Instance B に関連付けられたことがわかります。</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/ddnCfF5.png" width="100%">
</div>


<p>ElasticIP が Instance A から関連付けが解放され、 Instance B に関連付けされるようになりました。</p>
<p>コンソールページ上でも確認することができます。</p>
<p>以上で簡易的ではありますが<br>Cloud Design Pattern の floating IP (ElasticIP) が実現できました。</p>
<p>以上です。</p>
<h2><span id="参考">参考</span></h2><ul>
<li><a target="_blank" rel="noopener" href="http://kan3aa.hatenablog.com/entry/2015/06/05/135150">CentOS7.1でPacemaker+corosyncによるクラスタを構成する</a></li>
<li><a target="_blank" rel="noopener" href="https://moomindani.wordpress.com/2014/05/27/aws-eip-resource-agent/">PacemakerでEIPを付替えるResource Agentを書いてみた</a></li>
<li><a target="_blank" rel="noopener" href="http://doruby.kbmj.com/taka/20131018/yum_update_crm_pcs_">yum updateしたらcrmコマンドが無くなった！(pcsコマンド対照表)</a></li>
<li><a target="_blank" rel="noopener" href="http://news.mynavi.jp/news/2013/05/14/092/">pacemaker + corosync で HA クラスタ構築</a></li>
<li><a target="_blank" rel="noopener" href="http://linux-ha.osdn.jp/wp/archives/3868">動かして理解するPacemaker ～CRM設定編～</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-12-24</span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-07T03:41:24.416Z" title="5/7/2020, 3:41:24 AM">2020-05-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/23/2015-12-24-iptables-allow-ping/">pingを通すiptableの設定</a></h1><div class="content"><h2><span id="環境">環境</span></h2><ul>
<li>CentOS 5.8</li>
</ul>
<h2><span id="実現したいこと">実現したいこと</span></h2><p><code>Server A</code> が <code>Server B</code> からのみ ping を通す</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----------+  Ping Request   +----------+</span><br><span class="line">|          | &lt;-------------- |          |</span><br><span class="line">| Server A |                 | Server B |</span><br><span class="line">|          | --------------&gt; |          |</span><br><span class="line">+----------+  Ping Response  +----------+</span><br></pre></td></tr></table></figure>

<h2><span id="特定ipからの-ping-を通す許可設定">特定IPからの ping を通す許可設定</span></h2><p>以下設定を <code>Server A</code> で実施する。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Server A]# iptables -A INPUT -p icmp --icmp-type 8 -s &lt;Server B の IP Address&gt; -j ACCEPT</span><br><span class="line">[Server A]# iptables -A OUTPUT -p icmp --icmp-type 0 -s &lt;Server B の IP Address&gt; -j ACCEPT</span><br><span class="line">[Server A]# service iptables restart</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>--icmp-type 8</code> は <code>Echo request (エコー要求)</code> を許可</li>
<li><code>--icmp-type 0</code> は <code>Echo Reply (エコー応答)</code> を許可</li>
</ul>
</blockquote>
<h2><span id="server-bから-ping実行">Server Bから ping実行</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Server B]# ping &lt;Server A の IP Address&gt;</span><br><span class="line"></span><br><span class="line">PING (&lt;Server A の IP Address&gt;): 56 data bytes</span><br><span class="line">64 bytes from (&lt;Server A の IP Address&gt;): icmp_seq&#x3D;0 ttl&#x3D;58 time&#x3D;4.411 ms</span><br><span class="line">64 bytes from (&lt;Server A の IP Address&gt;): icmp_seq&#x3D;1 ttl&#x3D;58 time&#x3D;4.079 ms</span><br><span class="line">64 bytes from (&lt;Server A の IP Address&gt;): icmp_seq&#x3D;2 ttl&#x3D;58 time&#x3D;4.027 ms</span><br><span class="line">^C</span><br><span class="line">--- (&lt;Server A の IP Address&gt;) ping statistics ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0.0% packet loss</span><br><span class="line">round-trip min&#x2F;avg&#x2F;max&#x2F;stddev &#x3D; 4.027&#x2F;4.172&#x2F;4.411&#x2F;0.170 ms</span><br></pre></td></tr></table></figure>


<h2><span id="icmp-type-list">icmp-type List</span></h2><p>以下<a target="_blank" rel="noopener" href="http://www.asahi-net.or.jp/~aa4t-nngk/ipttut/output/icmptypes.html">asahi-net Appendix C. ICMPタイプ</a>より参照</p>
<table>
<thead>
<tr>
<th>TYPE</th>
<th>CODE</th>
<th>意味</th>
<th>問合せ</th>
<th>エラー</th>
<th>参照先</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
<td>Echo Reply (エコー応答)</td>
<td>x</td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>0</td>
<td>Network Unreachable (ネットワーク到達不能)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>Host Unreachable (ホスト到達不能)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>Protocol Unreachable (プロトコル到達不能)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>Port Unreachable (ポート到達不能)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>Fragmentation needed but no frag. bit set (フラグメント必要だがフラグメント禁止ビットあり)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>5</td>
<td>Source routing failed (ソースルーティング失敗)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>6</td>
<td>Destination network unknown (宛先ネットワーク発見できず)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>7</td>
<td>Destination host unknown (宛先ホスト発見できず)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>8</td>
<td>Source host isolated (送信元ホストへのルートなし) (廃)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>9</td>
<td>Destination network administratively prohibited (宛先ネットワークは設定によりアクセス禁止)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>10</td>
<td>Destination host administratively prohibited (宛先ホストは設定によりアクセス禁止)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>11</td>
<td>Network unreachable for TOS (TOS種別によりネットワーク到達不能)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>12</td>
<td>Host unreachable for TOS (TOS種別によりホスト到達不能)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>3</td>
<td>13</td>
<td>Communication administratively prohibited by filtering (フィルタリング設定により通信禁止)</td>
<td></td>
<td>x</td>
<td>RFC1812</td>
</tr>
<tr>
<td>3</td>
<td>14</td>
<td>Host precedence violation (ホスト優先順位侵害)</td>
<td></td>
<td>x</td>
<td>RFC1812</td>
</tr>
<tr>
<td>3</td>
<td>15</td>
<td>Precedence cutoff in effect (優先順位により遮断発動)</td>
<td></td>
<td>x</td>
<td>RFC1812</td>
</tr>
<tr>
<td>4</td>
<td>0</td>
<td>Source quench (輻輳発生による発信抑制)</td>
<td></td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>5</td>
<td>0</td>
<td>Redirect for network (指定ネットワークへのリダイレクト要求)</td>
<td></td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>Redirect for host (指定ホストへのリダイレクト要求)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>Redirect for TOS and network (TOSとネットワークのリダイレクト要求)</td>
<td></td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
<td>Redirect for TOS and host (TOSとホストのリダイレクト要求)</td>
<td></td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>8</td>
<td>0</td>
<td>Echo request(エコー要求)</td>
<td>x</td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>9</td>
<td>0</td>
<td>Router advertisement - Normal router advertisement (ルータ広告 - 通常通知)</td>
<td></td>
<td></td>
<td>RFC1256</td>
</tr>
<tr>
<td>9</td>
<td>16</td>
<td>Router advertisement - Does not route common traffic (ルータ広告 - 通常トラフィックはルーティング不可)</td>
<td></td>
<td></td>
<td>RFC2002</td>
</tr>
<tr>
<td>10</td>
<td>0</td>
<td>Route selection (ルート選択)</td>
<td></td>
<td></td>
<td>RFC1256</td>
</tr>
<tr>
<td>11</td>
<td>0</td>
<td>TTL equals 0 during transit (搬送中にTTLが0に)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>11</td>
<td>1</td>
<td>TTL equals 0 during reassembly (再構成時の欠損フラグメント待機中に時間超過)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>12</td>
<td>0</td>
<td>IP header bad (catchall error) (IPヘッダ異常) (あらゆるエラーに共通)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>12</td>
<td>1</td>
<td>Required options missing (必要なオプションが欠如)</td>
<td></td>
<td>x</td>
<td>RFC1108</td>
</tr>
<tr>
<td>12</td>
<td>2</td>
<td>IP Header bad length (IPヘッダ長の異常)</td>
<td></td>
<td>x</td>
<td>RFC792</td>
</tr>
<tr>
<td>13</td>
<td>0</td>
<td>Timestamp request (obsolete) (タイムスタンプ要求) (廃)</td>
<td>x</td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>14</td>
<td></td>
<td>Timestamp reply (obsolete) (タイムスタンプ応答) (廃)</td>
<td>x</td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>15</td>
<td>0</td>
<td>Information request (obsolete) (情報要求) (廃)</td>
<td>x</td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>16</td>
<td>0</td>
<td>Information reply (obsolete) (情報応答) (廃)</td>
<td>x</td>
<td></td>
<td>RFC792</td>
</tr>
<tr>
<td>17</td>
<td>0</td>
<td>Address mask request (ネットマスク通知要求)</td>
<td>x</td>
<td></td>
<td>RFC950</td>
</tr>
<tr>
<td>18</td>
<td>0</td>
<td>Address mask reply (ネットマスク通知応答)</td>
<td>x</td>
<td></td>
<td>RFC950</td>
</tr>
<tr>
<td>20-29</td>
<td></td>
<td>Reserved for robustness experiment (信頼性試験のための予約域)</td>
<td></td>
<td></td>
<td>Zaw-Sing Su</td>
</tr>
<tr>
<td>30</td>
<td>0</td>
<td>Traceroute</td>
<td>x</td>
<td></td>
<td>RFC1393</td>
</tr>
<tr>
<td>31</td>
<td>0</td>
<td>Datagram Conversion Error (データグラム変換エラー)</td>
<td></td>
<td>x</td>
<td>RFC1475</td>
</tr>
<tr>
<td>32</td>
<td>0</td>
<td>Mobile Host Redirect (移動体ホストのリダイレクト)</td>
<td></td>
<td></td>
<td>David Johnson</td>
</tr>
<tr>
<td>33</td>
<td>0</td>
<td>IPv6 Where-Are-You (IPv6位置確認要求)</td>
<td>x</td>
<td></td>
<td>Bill Simpson</td>
</tr>
<tr>
<td>34</td>
<td>0</td>
<td>IPv6 I-Am-Here (IPv6位置確認応答)</td>
<td>x</td>
<td></td>
<td>Bill Simpson</td>
</tr>
<tr>
<td>35</td>
<td>0</td>
<td>Mobile Registration Request (移動体登録要求)</td>
<td>x</td>
<td></td>
<td>Bill Simpson</td>
</tr>
<tr>
<td>36</td>
<td>0</td>
<td>Mobile Registration Reply (移動体登録応答)</td>
<td>x</td>
<td></td>
<td>Bill Simpson</td>
</tr>
<tr>
<td>39</td>
<td>0</td>
<td>SKIP</td>
<td></td>
<td></td>
<td>Tom Markson</td>
</tr>
<tr>
<td>40</td>
<td>0</td>
<td>Photuris</td>
<td></td>
<td></td>
<td>RFC2521</td>
</tr>
</tbody></table>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-12-22</span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-07T03:41:24.296Z" title="5/7/2020, 3:41:24 AM">2020-05-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/21/2015-12-22-cannot-get-mail-in-outlook/">Outlook にメールが届かない件対応</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>EC2を利用してますがSESかまさずに<br>メール送信をしていた時に<br>以下のようなエラーが発生しました。</p>
<ul>
<li>エラー内容</li>
</ul>
<blockquote>
<p>Dec 18 17:24:11 ip-xxx-xx-xx-xx postfix/smtp[4827]: 380D2A27ED: to=<a href="mailto:&#x68;&#111;&#103;&#101;&#x68;&#x6f;&#103;&#101;&#x40;&#x78;&#x78;&#120;&#x78;&#x78;&#x78;&#120;&#46;&#x63;&#111;&#109;">&#x68;&#111;&#103;&#101;&#x68;&#x6f;&#103;&#101;&#x40;&#x78;&#x78;&#120;&#x78;&#x78;&#x78;&#120;&#46;&#x63;&#111;&#109;</a>, relay=xxxxxxx-com.mail.protection.outlook.com[xxx.xx.xx.xxx]:25, delay=6.1, delays=0.01/0/0.88/5.2, dsn=5.7.1, status=bounced (host xxxxxxx-com.mail.protection.outlook.com[xxx.xx.xx.xxx] said: 550 5.7.1 Service unavailable; Client host [yy.yy.yy.yyy] blocked using FBLW15; To request removal from this list please forward this message to <a href="mailto:delist@messaging.microsoft.com">delist@messaging.microsoft.com</a> (in reply to RCPT TO command))</p>
</blockquote>
<h2><span id="要約すると">要約すると</span></h2><p><code>hogehoge@xxxxxxx.com</code> 宛のメールが Outlook でブラックリスト扱いされて弾かれています ( <code>status=bounced</code> )。<br>もしブラックリストから削除したい場合は、 <code>delist@messaging.microsoft.com</code> 宛に解除申請してください。</p>
<h2><span id="もうちょっと細かく">もうちょっと細かく</span></h2><p><code>relay=xxxxxxx-com.mail.protection.outlook.com[xxx.xx.xx.xxx]:25</code><br>とある通り<br>MicroSoftがメールツールサービス Outlook が受信相手です。</p>
<p>送信元サーバIP <code>yy.yy.yy.yyy</code> のホストは <code>FBLW15</code> 基準でブラックリスト扱いされているので<br>サービスは利用できない = メールは受け取らない<br>というものです。</p>
<ul>
<li>FBLW15 … MicroSoft独自のブラックリスト</li>
</ul>
<h2><span id="対応">対応</span></h2><ul>
<li>宛先:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delist@messaging.microsoft.com</span><br></pre></td></tr></table></figure>

<ul>
<li>タイトル:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Please Remove My IP yy.yy.yy.yyy from your BlockList.</span><br></pre></td></tr></table></figure>

<ul>
<li>内容<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Please remove this IP yy.yy.yy.yyy from your BlockList.</span><br><span class="line"></span><br><span class="line">Thanks.</span><br><span class="line">Kenzo Tanaka.</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2><span id="数分後に-microsoft-customer-support-から返信が着た">数分後に Microsoft Customer Support から返信が着た</span></h2><ul>
<li>メール内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Hello ,</span><br><span class="line"></span><br><span class="line">Thank you for your delisting request SRX1318598611ID. Your ticket was received on (Dec 21 2015 08:14 AM UTC) and will be responded to within 24 hours.</span><br><span class="line"></span><br><span class="line">Our team will investigate the address that you have requested to be removed from our blocklist. If for any reason we are not able to remove your address, one of our technical support representatives will respond to you with additional information.</span><br><span class="line"></span><br><span class="line">Regards,</span><br><span class="line">Technical Support</span><br></pre></td></tr></table></figure>

<ul>
<li>和訳すると</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">こんにちは</span><br><span class="line"></span><br><span class="line">ブラックリスト申請の削除依頼を受け取りました。24時間以内に回答します。</span><br><span class="line"></span><br><span class="line">削除要請頂いたアドレスをについて調査します。</span><br><span class="line">何らかの理由で削除依頼を引き受けられない場合は、</span><br><span class="line">当社の技術サポートから追加情報をお届け致します。</span><br><span class="line"></span><br><span class="line">以上宜しくお願い致します。</span><br><span class="line">テクニカルサポート</span><br></pre></td></tr></table></figure>


<h2><span id="24時間待ってみる">24時間待ってみる</span></h2><p>メール着た！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Hello,</span><br><span class="line"></span><br><span class="line">Thank you for contacting Microsoft Online Services Technical Support.  This email is in reference to ticket number, 1318598611 which was opened in regards to your delisting request for yy.yy.yy.yyy</span><br><span class="line"></span><br><span class="line">The IP address you submitted has been reviewed and removed from our block lists.  Please note that there may be a 1-2 hour delay before this change propagates through our entire system.</span><br><span class="line"></span><br><span class="line">We apologize for any inconvenience this may have caused you.  As long as our spam filtering systems do not mark a majority of email from the IP address as spam-like, your messages will be allowed to flow as normal through our network.  However, should we detect an increase in spam-like activity, the IP address may be re-added to our block list.</span><br><span class="line"></span><br><span class="line">Should you have any further questions or concerns, please feel free to respond to this email.</span><br><span class="line"></span><br><span class="line">Thank you again for contacting Microsoft Online Services technical support and giving us the opportunity to serve you.</span><br></pre></td></tr></table></figure>

<ul>
<li>和訳</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">こんにちは</span><br><span class="line"></span><br><span class="line">マイクロソフト・オンライン・サービス テクニカルサポートにお問い合わせいただきありがとうございます。</span><br><span class="line">このメールはチケット番号 1318598611、IPアドレス(yy.yy.yy.yyy) をブラックリストから削除する様申請頂いた件についてです。</span><br><span class="line"></span><br><span class="line">あなたが提出されたIPアドレスを見直し、ブロックリストから削除しました。</span><br><span class="line">この変更は私たちの全システムに行き届くには 1〜2時間程掛かる見込みです。</span><br><span class="line"></span><br><span class="line">ご不便お掛けしたことをお詫び申し上げます。</span><br><span class="line">スパムフィルタリングシステムがスパムとおぼしきIPアドレスからの多くのE-mailをマークしない限り</span><br><span class="line">あなたのメッセージは当社のネットワークを通じて通常通りに許可されるでしょう。</span><br><span class="line">しかし、スパム行為が増加していることを検知する必要があり、ブロックリストに追加する可能性があります。</span><br><span class="line"></span><br><span class="line">その他質問や確認をご希望の際は、こちらのメールにご返信ください。</span><br><span class="line"></span><br><span class="line">マイクロソフト・オンライン・サービス テクニカルサポートにご連絡いただき</span><br><span class="line">お力添えできましたこと、誠に感謝致します。</span><br></pre></td></tr></table></figure>

<p>やや和訳が…アグレッシブということで受け入れてください。<br>もっと良い和訳あったら頂きたいです。</p>
<p>以上でブラックリストから解除されたそうなので、<br>マイクロソフト・テクニカル・サービスからメールが届いてから<br>4〜5時間後に再度メール送信し問題ないことが確認できました。</p>
<h2><span id="ipアドレスdnsのブラックリストチェック">IPアドレス/DNSのブラックリストチェック</span></h2><p>以下サイトで試しておくのが良いかと思います。<br>何かの間違いで登録されていた、というスパムメールとして扱われている<br>ということになるので。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.spamhaus.org/lookup/">http://www.spamhaus.org/lookup/</a></li>
<li><a target="_blank" rel="noopener" href="http://mxtoolbox.com/blacklists.aspx">http://mxtoolbox.com/blacklists.aspx</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-12-17</span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-07T03:41:24.226Z" title="5/7/2020, 3:41:24 AM">2020-05-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/16/2015-12-17-mysql-error-2006-hy000-mysql-server-has-gone-away/">MySQLトラブルシューティング - ERROR 2006 (HY000) at line ***: MySQL server has gone away</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>DBインポート時に掲題のエラーが発生しました。</p>
<p>インポートサイズが大きすぎる為です。</p>
<p>インポートデータサイズのデフォルト値は <code>1M</code> です。</p>
<p>以下コマンドで確認できます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;max_allowed_packet&#39;;</span><br></pre></td></tr></table></figure>

<h2><span id="対策">対策</span></h2><p>2点あります。</p>
<ul>
<li>mysqlコマンドラインから設定 (一時的)</li>
<li>my.cnf に設定 (恒久的)</li>
</ul>
<h3><span id="mysqlコマンドラインから一時的に引き上げる">mysqlコマンドラインから一時的に引き上げる</span></h3><p>再起動の必要がなく影響範囲が少なく済みます。<br>但し、再起動後、デフォルト値に戻るので<br>恒久的な対応が必要な場合<br>my.cnf に設定しmysqldを再起動する必要があります。</p>
<p>例) 10MB に設定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global max_allowed_packet &#x3D; 1000000;</span><br></pre></td></tr></table></figure>

<h3><span id="mycnf-に-max_allowed_packet-を引き上げる様設定">my.cnf に <code>max_allowed_packet</code> を引き上げる様設定</span></h3><h5><span id="mycnf-パス探索">my.cnf パス探索</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mysql --help | grep my.cnf</span><br><span class="line">                      order of preference, my.cnf, $MYSQL_TCP_PORT,</span><br><span class="line">&#x2F;etc&#x2F;my.cnf &#x2F;etc&#x2F;mysql&#x2F;my.cnf &#x2F;usr&#x2F;etc&#x2F;my.cnf ~&#x2F;.my.cnf</span><br></pre></td></tr></table></figure>

<p>以下の順で my.cnf を探しています。<br><code>/etc/my.cnf</code> → <code>/etc/mysql/my.cnf</code> → <code>/usr/etc/my.cnf</code> → <code>~/.my.cnf</code></p>
<p>個々の環境で異なるので本当に存在するかも含め設定ファイルを見定めてください。</p>
<p>おおよそ <code>/etc/my.cnf</code> が一般的かと思います。</p>
<h5><span id="mycnf-に-mysqld-に属する様に設定します">my.cnf に [mysqld] に属する様に設定します。</span></h5><p>10MBに設定してみます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">max_allowed_packet&#x3D;10MB</span><br></pre></td></tr></table></figure>

<p>以上設定して再起動で設定反映完了です。</p>
<h2><span id="確認">確認</span></h2><p>設定が反映されているか確認します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;max_allowed_packet&#39;;</span><br><span class="line"></span><br><span class="line">+--------------------+----------+</span><br><span class="line">| Variable_name      | Value    |</span><br><span class="line">+--------------------+----------+</span><br><span class="line">| max_allowed_packet | 10485760 |</span><br><span class="line">+--------------------+----------+</span><br></pre></td></tr></table></figure>



<p>以上</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-12-12</span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-07T03:41:24.182Z" title="5/7/2020, 3:41:24 AM">2020-05-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/11/2015-12-12-redis-error-noauth-authentication-required/">Redis - (error) NOAUTH Authentication required への対応</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>経年運用し特にメモリも問題なかったRedisが突如接続エラーが発生したので<br>その際の対応をまとめました。</p>
<h2><span id="エラー内容">エラー内容</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP Fatal error:  Uncaught exception &#39;RedisException&#39; with message &#39;Failed to AUTH connection&#39;</span><br></pre></td></tr></table></figure>

<p>認証接続に失敗して Exception になっている。</p>
<p>Redisの設定周りで特にrequirepass を設定していないし<br>何故突然？という感じでした。</p>
<p>各環境でRedisの設定パスは異なると思いますが、自環境の場合以下です。<br>/etc/redis/6379.conf</p>
<p>以下のようにrequirepassはコメントアウトされている。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># requirepass</span><br></pre></td></tr></table></figure>


<h2><span id="対応">対応</span></h2><ul>
<li>process を kill する<br>※ <code>service redis restart</code> のように redisを再起動しても状況は変わりませんでした。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ps aux | grep &#39;redis&#39; | grep -v &#39;grep&#39;</span><br><span class="line"></span><br><span class="line">root     12743  0.1  0.2  40604  2124 ?        Ssl  10:50   0:00 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-server *:6379</span><br></pre></td></tr></table></figure>

<ul>
<li><p>再度 redis を起動させる。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service redis start</span><br></pre></td></tr></table></figure>
</li>
<li><p>requirepass 設定</p>
</li>
</ul>
<p>運用中でアプリケーション自体のソースをいじりたくなかったので<br>空のrequirepass を設定しました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli&gt; CONFIG SET REQUIREPASS &#39;&#39;</span><br></pre></td></tr></table></figure>

<p>上記で取り急ぎ対応は問題なかったです。</p>
<h2><span id="総評">総評</span></h2><p>改めて利用する際には<br>認証設定をしてアプリケーションからも<br>passwordを指定して接続する仕組みが良いですね。</p>
<p>ただ何故急に発生したかは引き続き調査をしていきます。</p>
<p>理由がわかる方はコメントなどいただけましたら幸いです。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-12-09</span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-07T03:41:24.112Z" title="5/7/2020, 3:41:24 AM">2020-05-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/08/2015-12-09-revive-deleted-git-branch/">Git で削除したブランチを復活させる</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>以下コマンドでブランチを強制的に削除した後、やっぱり必要だったのに、となったときの対処</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git branch -D &lt;branch_name&gt;</span><br></pre></td></tr></table></figure>

<h2><span id="復活手順">復活手順</span></h2><ol>
<li>HEADの変更履歴を確認する</li>
<li>HEADのログ番号からブランチ名作成</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git reflog</span><br><span class="line">$ git branch &lt;branch_name&gt; HEAD@&#123;num&#125;</span><br></pre></td></tr></table></figure>

<p>-</p>
<p>例)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git reflog</span><br><span class="line"></span><br><span class="line">c95c7e9 HEAD@&#123;0&#125;: merge release: Merge made by the &#39;recursive&#39; strategy.</span><br><span class="line">ad5bed0 HEAD@&#123;1&#125;: checkout: moving from release to master</span><br><span class="line">ffe45df HEAD@&#123;2&#125;: merge develop: Merge made by the &#39;recursive&#39; strategy.</span><br><span class="line">6aa536b HEAD@&#123;3&#125;: checkout: moving from develop to release</span><br></pre></td></tr></table></figure>

<p>上記のHEAD@{3}が消してしまったブランチに対してのcommitだ！<br>とわかれば、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git branch hogehoge HEAD@&#123;3&#125;</span><br></pre></td></tr></table></figure>

<p>上記コマンド完了後、<br><code>git branch</code>すると branch <code>hogehoge</code>が作成されたことがわかる。</p>
<p>なので、commitはこまめにしておくと良いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2015/12/08/2015-12-09-show-dotfile-on-macos/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151209/20151209101926.png" alt="今更ながらMacでドットファイルを表示する"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-12-09</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/08/2015-12-09-show-dotfile-on-macos/">今更ながらMacでドットファイルを表示する</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Finder でドットファイルを開きたいという際にやっておく設定</p>
<h2><span id="環境">環境</span></h2><ul>
<li>MacOSX Yosemite 10.10.3</li>
</ul>
<h2><span id="手順">手順</span></h2><h3><span id="ターミナルを開き以下コマンド実行">ターミナルを開き以下コマンド実行</span></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ defaults write com.apple.finder AppleShowAllFiles -boolean true</span><br></pre></td></tr></table></figure>

<h3><span id="finder-アプリ再起動">Finder アプリ再起動</span></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ killall Finder</span><br></pre></td></tr></table></figure>

<p>これでドットファイルが反映されています。</p>
<h2><span id="元に戻したい場合">元に戻したい場合</span></h2><h3><span id="ターミナルで以下コマンド実行">ターミナルで以下コマンド実行</span></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ defaults delete com.apple.finder AppleShowAllFiles</span><br></pre></td></tr></table></figure>

<h3><span id="再起動">再起動</span></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ killall Finder</span><br></pre></td></tr></table></figure>

<p>以上です</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2015/12/07/2015-12-08-tellme-twillio/"><img class="fill" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208143258.png" alt="Twilio で電話通知"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-12-08</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/07/2015-12-08-tellme-twillio/">Twilio で電話通知</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>障害検知をメールや Slack に流しても休日に業務系連絡を見ることは少ない。<br><br>その為、より検知報告に気付きやすくする様、<br><br>電話通知にするべく Twilio を導入する運びとなりました。</p>
<p>まずは利用するまでの簡単な手順をまとめました。<br></p>
<p>※コードのサンプルが Twilio のサイト内にあるので導入しやすかったです。</p>
<h2><span id="手順">手順</span></h2><h3><span id="1-twilio-にアクセス">1. Twilio にアクセス</span></h3><p>以下リンクから Twilio にアクセスします。</p>
<p><a target="_blank" rel="noopener" href="http://twilio.kddi-web.com/">http://twilio.kddi-web.com</a></p>
<h3><span id="2-新規登録">2. 新規登録</span></h3><p>名前、E-mail、パスワード(大小半角英数字)と</p>
<p>何にどの言語で利用するかを選択して</p>
<p>「始めましょう」をクリック。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208104015.png" width="100%">
</div>

<p>「始めましょう」という日本語はユーザ目線でなく違和感ありますね。</p>
<h3><span id="3-アカウント認証">3. アカウント認証</span></h3><p>以下２つの認証方法があります。</p>
<ul>
<li>電話番号に SMS に確認コードを送信させる</li>
<li>電話番号に Twilio から着信があり確認コードのダイヤルキーを入力する。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208104800.png" width="100%">
</div>

<p>後者は Twilio の音声読み上げロボットから電話がかかって来るので<br><br>どんな感じで通知されるか試してみたい方は是非後者を選択してみてください。<br></p>
<p>スムーズなイントネーションではないですが、伝えたい気持ちは誰よりもあります。</p>
<h3><span id="4-twilio-から電話をかけてみる">4. Twilio から電話をかけてみる</span></h3><p>アカウント認証確認後、Twilio 製品の「プログラマブル Voice」ページ Top に遷移しました。<br>メニューから <code>ツール</code> をクリックしツールページに遷移してください。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208110143.png" width="100%">
</div>

<h4><span id="to-指定">To 指定</span></h4><p>音声通話&gt;通話&gt;電話をかける の API Explorer にて<br><code>必須</code> の<code>To</code> に 電話番号認証した番号を入力してください。</p>
<p>但し、日本番号（+81）の場合、<br><code>090********</code> の番号は<br><br>はじめの <code>0</code> を削除し、 <code>+81</code> を prefix として追加し、<br><br><code>+8190********</code> となりますので注意してください。<br></p>
<h4><span id="url-指定">URL 指定</span></h4><p><code>条件</code> の<code>Url</code> に Twilio からの電話を受け取った際、<br><br>電話のキーダイヤルを押下した際の挙動を url 形式で指定可能です。</p>
<p>適当に準備できる Url がない場合は、<br><br>以下のような適当な Url で良いです。</p>
<p><code>http:/hogehoge.hogehoge.co.jp</code></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208110552.png" width="100%">
</div>

<h4><span id="通知実行">通知実行</span></h4><p>ページ下部の <code>リクエストを発行する</code> ボタンをクリックします。</p>
<p><span style="color: #d32f2f">※</span> <code>※料金が発生します</code> とありますが、Trial は料金を請求されるということはありません。<br><br><span style="color: #d32f2f">※</span>同アカウントでアップグレードする際は、発信した電話料金も合わせて請求されることになるので、テスト完了後は別途アカウントを取得することを推奨します。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20151208/20151208112301.png" width="100%">
</div>

<h4><span id="電話を受け取る">電話を受け取る</span></h4><p>Twilio から電話がかかってきたかと思います。<br><br>キーダイヤルを入力すると、 Url で指定したプログラムが動作しますが、<br><br>適当に入力したので<br><br><code>アプリケーションエラーが発生しました。電話を終了します。</code><br>と通知されるはずです。</p>
<p>実際にプログラムから使用する際は、<br><br>指定した Url でキー入力を受け取ってその後の挙動を制御する、<br><br>という流れになります。</p>
<h2><span id="実際に利用した例">実際に利用した例</span></h2><p>担当した業務では、Zabbix からの障害検知を Twilio で担当者に電話報告（エスカレーション）するという仕組みを構築しました。</p>
<blockquote>
<p>例）以下のような挙動が実現できます。<br><br>Zabbix で障害検知 <br><br>↓<br><br>Twilio<br><br>↓ 電話<br><br>対応者 <br><br>↓ 対応者が「1」をクリック<br><br>指定した Url のプログラム実行<br><br>↓「1」を受け取り、障害対応可能な旨を Zabbix へ通知<br><br>Zabbix (障害対応中)</p>
</blockquote>
<h5><span id="zabbix-amp-twilio-参考">Zabbix &amp; Twilio 参考</span></h5><p><a target="_blank" rel="noopener" href="http://begood-technology.github.io/zabbix-twilio/">zabbix-twillio</a></p>
<p>上記サイトでの zabbix-twilio 連携の手順で進めた場合、<br><br>twilio でキーダイヤル入力後、 以下のようなエラーが発生し、イベント登録ができません。<br><br><code>API error -32602: The &quot;user.login&quot; method must be called without the &quot;auth&quot; parameter</code></p>
<p>zabbix-twilio.php 内の <code>Zabbix_API</code>クラスが古い為です。<br></p>
<p><a target="_blank" rel="noopener" href="https://github.com/begood-technology/zabbix-twilio/blob/master/zabbix-twilio.php">zabbix-twilio.php</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/confirm/PhpZabbixApi">PhpZabbixApi</a></p>
<p>上記をダウンロードし、 <code>php build.php</code> で 以下 2 ファイルを生成し、<br><br>こちらを呼び出し <code>Zabbix_Api</code> と <code>ZabbixApi</code> とを変更してください。</p>
<ul>
<li><p>ZabbixApi.class.php</p>
</li>
<li><p>ZabbixApiAbstract.class.php</p>
</li>
<li><p>/var/www/html/zabbix-twilio/zabbix-twilio.php</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ require_once &#x27;ZabbixApi.class.php&#x27;;</span><br><span class="line">+ use ZabbixApi\ZabbixApi;</span><br><span class="line"></span><br><span class="line">-                                       $api = new Zabbix_API ( $ZABBIX_API, $ZABBIX_USER, $ZABBIX_PASS );</span><br><span class="line">+                                       $api = new ZabbixApi ( $ZABBIX_API, $ZABBIX_USER, $ZABBIX_PASS);</span><br></pre></td></tr></table></figure>

<p><code>ZabbixApi </code> は Basic 認証を設定している場合にも対処しています。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 例)</span><br><span class="line">$api = new ZabbixApi ( $ZABBIX_API, $ZABBIX_USER, $ZABBIX_PASS, $BASIC_AUTH_USER, $BASIC_AUTH_PASS);</span><br></pre></td></tr></table></figure>

<h4><span id="検証環境">検証環境</span></h4><ul>
<li>Amazon Linux AMI release 2015.09</li>
<li>Zabbix 2.5 (3.0α)</li>
<li>PHP 5.6.14</li>
<li>MySQL 5.5.46</li>
</ul>
<p>以上</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">2015-11-26</span><span class="level-item">Updated&nbsp;<time dateTime="2020-05-07T03:41:24.046Z" title="5/7/2020, 3:41:24 AM">2020-05-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/11/25/2015-11-26-cleanup-yum-cache/">意外と容量食ってた yum cache</a></h1><div class="content"><h2><span id="yum-cache-容量">yum cache 容量</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># du -sh &#x2F;var&#x2F;cache&#x2F;yum</span><br><span class="line">155M    &#x2F;var&#x2F;cache&#x2F;yum</span><br></pre></td></tr></table></figure>

<p>155MByteある汗</p>
<h2><span id="yum-cache-削除">yum cache 削除</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># yum clean all</span><br><span class="line">読み込んだプラグイン:fastestmirror</span><br><span class="line">リポジトリーを清掃しています: base epel extras mysql-connectors-community mysql-tools-community mysql56-community nginx treasuredata updates</span><br><span class="line">Cleaning up everything</span><br><span class="line">Cleaning up list of fastest mirrors</span><br></pre></td></tr></table></figure>


<h2><span id="yum-cache容量確認">yum cache容量確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># du -sh &#x2F;var&#x2F;cache&#x2F;yum</span><br><span class="line">8.0K    &#x2F;var&#x2F;cache&#x2F;yum</span><br></pre></td></tr></table></figure>

<p>スッキリ！</p>
<p>サーバから容量不足のアラートで少しでも容量減らしたいときに<br>役立ちました。</p>
<p>潤沢にサーバスペックを用意できるクライアントでない場合もあるので<br>地道に必要な知識だと感じました。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/23/">前</a></div><div class="pagination-next"><a href="/page/25/">次</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/23/">23</a></li><li><a class="pagination-link is-current" href="/page/24/">24</a></li><li><a class="pagination-link" href="/page/25/">25</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/34/">34</a></li></ul></nav></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Kenzo Tanaka</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Privacy Policy" href="/2013/12/31/PrivacyPolicy/"><i class="fab fa-p"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("ja");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="トップに戻る" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="何かを入力してください..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"何かを入力してください...","untitled":"(無題)","posts":"投稿","pages":"ページ","categories":"カテゴリ","tags":"タグ"});
        });</script></body></html>