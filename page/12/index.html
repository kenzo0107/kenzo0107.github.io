<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>長生村本郷Engineers&#039;Blog</title><meta description="tech"><meta property="og:type" content="blog"><meta property="og:title" content="長生村本郷Engineers&#039;Blog"><meta property="og:url" content="https://kenzo0107.github.io/"><meta property="og:site_name" content="長生村本郷Engineers&#039;Blog"><meta property="og:description" content="tech"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://kenzo0107.github.io/img/og_image.png"><meta property="article:author" content="Kenzo Tanaka"><meta property="article:tag" content="aws golang"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kenzo0107.github.io"},"headline":"長生村本郷Engineers'Blog","image":["https://kenzo0107.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Kenzo Tanaka"},"description":"tech"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-162026478-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-162026478-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="ca-pub-6265337967545472" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/2013/12/31/PrivacyPolicy/">PrivacyPolicy</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/05/15/2017-05-16-gke-kubernetes-hubot/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170604/20170604224801.png" alt="無料枠で運用！ GKE + Kubernetes で Hubot 〜独自ネットワーク作成、設定ファイルから起動編〜"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-05-15T15:00:00.000Z" title="2017-05-15T15:00:00.000Z">2017-05-16</time><span class="level-item">7分 read (About 1106 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/05/15/2017-05-16-gke-kubernetes-hubot/">無料枠で運用！ GKE + Kubernetes で Hubot 〜独自ネットワーク作成、設定ファイルから起動編〜</a></h1><div class="content"><p>前回手元のMacからコンテナクラスタ → Deployment → LB 作成する手順をまとめました。</p>
<a href="http://kenzo0107.hatenablog.com/entry/2017/05/10/012945" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="http://i.imgur.com/Vvmetu1.png"></div><div class="descriptions"><div class="og-title">無料枠で運用！ GKE + Kubernetes で Hubot 〜CLIから実行編〜 - 長生村本郷Engineers&#39;Blog</div><div class="og-description">概要 無料枠を使って Slack 連携する Hubot を GKE で構築します。 おまけで JIRA 連携も Google Cloud SDK のインストール方法と初期化 Mac OS X 用クイックスタート を参照して SDK をダウンロードします。 Mac OS X (x8…</div></div></div></a>


<p>但し、8080ポートがフルオープンとなってしまい、誰でもアクセスが可能であるという、<br>セキュリティ的に非常によろしくない状態でした。</p>
<p>その為、今回は以下実施します。</p>
<ul>
<li>独自ネットワーク(ファイアウォール)作成</li>
<li>独自ネットワーク上にクラスタ作成</li>
<li>設定ファイルでコンテナ起動・更新</li>
</ul>
<p>前回の独自ネットワーク設定していないクラスタは削除して問題ないです。お任せします <code>m(_ _)m</code></p>
<h2><span id="前回同様の-git-repository-用意">前回同様の Git Repository 用意</span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/kenzo0107/hubot-slack-on-docker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> hubot-slack-on-docker</span></span><br></pre></td></tr></table></figure>

<h2><span id="network-作成">Network 作成</span></h2><ul>
<li><code>hubot-network</code> というネットワークを作成します。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud compute networks create hubot-network</span><br></pre></td></tr></table></figure>

<h2><span id="ファイアウォール作成">ファイアウォール作成</span></h2><ul>
<li>作成したネットワークに特定 IP からのみ 8080 ポートアクセス許可</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud compute firewall-rules create hubot-rule --network hubot-network --allow tcp:8080 --source-ranges xxx.xxx.xxx.xxx,yyy.yyy.yyy.yyy.yyy</span><br></pre></td></tr></table></figure>

<h2><span id="container-clusters-作成">Container Clusters 作成</span></h2><ul>
<li>作成したネットワーク指定しクラスタ作成</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud container clusters create hubot-cluster-free \</span><br><span class="line">      --machine-type f1-micro \</span><br><span class="line">      --disk-size&#x3D;30 \</span><br><span class="line">      --num-nodes&#x3D;3 \</span><br><span class="line">      --network&#x3D;hubot-network \</span><br><span class="line">      --cluster-ipv4-cidr&#x3D;10.0.0.0&#x2F;14</span><br></pre></td></tr></table></figure>

<ul>
<li><span style="color: #ff0000">cluster-ipv4-cidr オプション必須！</span><br>指定しクラスタ内の Pod のIPアドレスの範囲指定しています。<br>※サブネットマスク(10.0.0.0/14 の “/14” 部分)指定は9〜19で指定する必要があります。</li>
</ul>
<p>例) –cluster-ipv4-cidr=10.0.0.0/8 指定した場合のエラー</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: (gcloud.container.clusters.create) ResponseError: code&#x3D;400, message&#x3D;cluster.cluster_ipv4_cidr CIDR block size must be no bigger than &#x2F;9 and no smaller than &#x2F;19, found &#x2F;8.</span><br></pre></td></tr></table></figure>

<h2><span id="ノード数を-1-に変更">ノード数を 1 に変更</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud container clusters resize hubot-cluster-free --size&#x3D;1</span><br></pre></td></tr></table></figure>

<h2><span id="deployment-作成">Deployment 作成</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl create -f gke-deployment.yml</span><br></pre></td></tr></table></figure>

<h3><span id="deployment-replicaset-pod-一覧表示">Deployment, Replicaset, Pod 一覧表示</span></h3><ul>
<li>ラベル付けした <code>app: hubot</code> を条件指定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl get deployments,replicasets,pods --selector app&#x3D;hubot</span><br></pre></td></tr></table></figure>

<h3><span id="フォーマットを-yaml-形式で出力">フォーマットを yaml 形式で出力</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl get deployment deployment-hubot -o yaml</span><br></pre></td></tr></table></figure>

<h2><span id="サービス公開する為-loadbalancer-付加">サービス公開する為、LoadBalancer 付加</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl create -f gke-lb.yml</span><br></pre></td></tr></table></figure>

<h2><span id="サービス一覧表示">サービス一覧表示</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl get svc</span><br><span class="line">NAME           CLUSTER-IP     EXTERNAL-IP     PORT(S)          AGE</span><br><span class="line">kubernetes     10.3.240.1     &lt;none&gt;          443&#x2F;TCP          20m</span><br><span class="line">loadbalancer   10.3.241.129   zz.zzz.zzz.zzz   8080:31628&#x2F;TCP   4m</span><br></pre></td></tr></table></figure>

<p>※EXTERNAL-IP : <code>zz.zzz.zzz.zzz</code> はグローバルIP</p>
<h2><span id="いざ-テスト">いざ、テスト !</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ curl \</span><br><span class="line">-X POST \</span><br><span class="line">-H &quot;Content-Type: application&#x2F;json&quot; \</span><br><span class="line">-d \</span><br><span class="line">&#39;&#123;</span><br><span class="line"> &quot;webhookEvent&quot;:&quot;jira:issue_updated&quot;,</span><br><span class="line"> &quot;comment&quot;:&#123;</span><br><span class="line">   &quot;author&quot;:&#123;</span><br><span class="line">     &quot;name&quot;:&quot;himuko&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;body&quot;:&quot;[~kenzo.tanaka] 東京03 秋山 ケンコバ 劇団ひとり&quot;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;issue&quot;: &#123;</span><br><span class="line">   &quot;key&quot;:&quot;key&quot;,</span><br><span class="line">   &quot;fields&quot;:&#123;</span><br><span class="line">     &quot;summary&quot;:&quot;summary&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#39; \</span><br><span class="line">http:&#x2F;&#x2F;zz.zzz.zzz.zzz:8080&#x2F;hubot&#x2F;jira-comment-dm</span><br></pre></td></tr></table></figure>

<ul>
<li>できた！<br>[f:id:kenzo0107:20170516220548p:plain]</li>
</ul>
<h2><span id="更新ローリングアップデート">更新（ローリングアップデート）</span></h2><p>ReplicationController を利用することで無停止で更新します。</p>
<p>実際に以下の様にして更新しているのが確認できます。</p>
<ul>
<li>既存の Running 中のコンテナの個数分、更新したイメージからビルドしたコンテナを起動</li>
<li>更新版コンテナがRunning状態になったら既存コンテナを削除</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ローカルで更新した Docker Container を コミット</span><br><span class="line">macOS%$ docker commit 12f77feb09b4 gcr.io&#x2F;hubot-167007&#x2F;hubot:latest</span><br><span class="line">&#x2F;&#x2F; Google Container Registory にプッシュ</span><br><span class="line">macOS%$ gcloud docker -- push gcr.io&#x2F;hubot-167007&#x2F;hubot:latest</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Pod 表示</span><br><span class="line">macOS%$ kubectl get pods</span><br><span class="line">NAME                                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">deployment-hubot-cfe7528ee0b5059b14a30b942597e5ef-z8nws   1&#x2F;1       Running   1          1d</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; push したImageを元にローリングアップデート</span><br><span class="line">macOS%$ kubectl rolling-update deployment-hubot-cfe7528ee0b5059b14a30b942597e5ef-z8nws --image&#x3D;gcr.io&#x2F;hubot-167007&#x2F;hubot:latest</span><br></pre></td></tr></table></figure>

<h2><span id="後片付け">後片付け</span></h2><ul>
<li>Deployment 削除</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl delete -f gke-deployment.yml</span><br></pre></td></tr></table></figure>

<ul>
<li>LoadBalancer 削除</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl delete -f gke-lb.yml</span><br></pre></td></tr></table></figure>

<h2><span id="総評">総評</span></h2><p>ネットワークのファイアウォール設定してコンテナ起動したが動かなかった所、かなり詰まりました (; <del>_</del>)<br>Stackoverflow にたまたま同様のイシューをあげている方がおり参考にさせて頂きました。<br>助かった汗</p>
<p>これから Nginx + Rails 等、よくありそうなケースで GKE + Kubernetes を試して運用してみたいと思います。<br>まとまったらまた追記します！</p>
<h2><span id="参考">参考</span></h2><p><a href="http://stackoverflow.com/questions/38057066/unable-to-launch-a-gke-google-container-engine-cluster-with-a-custom-network">Unable to launch a GKE (Google Container Engine) cluster with a custom network</a></p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/05/09/2017-05-10-gke-kubernetes-hubot-cli/"><img class="thumbnail" src="http://i.imgur.com/Vvmetu1.png" alt="無料枠で運用！ GKE + Kubernetes で Hubot 〜CLIから実行編〜"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-05-09T15:00:00.000Z" title="2017-05-09T15:00:00.000Z">2017-05-10</time><span class="level-item">11分 read (About 1718 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/05/09/2017-05-10-gke-kubernetes-hubot-cli/">無料枠で運用！ GKE + Kubernetes で Hubot 〜CLIから実行編〜</a></h1><div class="content"><h2><span id="概要">概要</span></h2><ul>
<li>無料枠を使って Slack 連携する Hubot を GKE で構築します。</li>
<li>おまけで JIRA 連携も</li>
</ul>
<h2><span id="google-cloud-sdk-のインストール方法と初期化">Google Cloud SDK のインストール方法と初期化</span></h2><p><a href="https://cloud.google.com/sdk/docs/quickstart-mac-os-x">Mac OS X 用クイックスタート</a> を参照して SDK をダウンロードします。</p>
<ul>
<li>Mac OS X (x86_64), (x86) かは以下コマンドで確認</li>
</ul>
<figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ uname -m</span><br><span class="line"></span><br><span class="line">x86_64</span><br></pre></td></tr></table></figure>

<h2><span id="kubectl-のインストール">kubectl のインストール</span></h2><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud components update kubectl</span><br></pre></td></tr></table></figure>

<h2><span id="gcloud-デフォルト設定">gcloud デフォルト設定</span></h2><p>以下は作成したプロジェクト、リージョン、ゾーンを設定してます。<br>今後 gcloud コマンド実行時に region 指定等しなくて良くなります。</p>
<ul>
<li>作成したプロジェクトID : <code>hubot-167007</code></li>
<li>us-west 利用で無料枠を使う為に US リージョンに設定してます。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud auth login</span><br><span class="line">macOS%$ gcloud config set project hubot-167007</span><br><span class="line">macOS%$ gcloud config set compute&#x2F;region us-west1</span><br><span class="line">macOS%$ gcloud config set compute&#x2F;zone us-west1-b</span><br></pre></td></tr></table></figure>


<p><a href="https://cloud.google.com/free/">Google Cloud Platform の無料階層</a> 参照してください。</p>
<h2><span id="クラスタ作成">クラスタ作成</span></h2><ul>
<li>無料枠を利用するべく f1-micro で 30GB 設定</li>
<li>でも作成時は 3 ノード必須</li>
<li>作成完了後、リサイズで 1 ノードに</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud container clusters create hubot-cluster-free \</span><br><span class="line">      --machine-type f1-micro \</span><br><span class="line">      --disk-size&#x3D;30 \</span><br><span class="line">      --num-nodes&#x3D;3</span><br><span class="line"></span><br><span class="line">Creating cluster hubot-cluster-free...done.</span><br><span class="line">Created [https:&#x2F;&#x2F;container.googleapis.com&#x2F;v1&#x2F;projects&#x2F;hubot-167007&#x2F;zones&#x2F;us-west1-b&#x2F;clusters&#x2F;hubot-cluster-free].</span><br><span class="line">kubeconfig entry generated for hubot-cluster-free.</span><br><span class="line">NAME                ZONE        MASTER_VERSION  MASTER_IP       MACHINE_TYPE  NODE_VERSION  NUM_NODES  STATUS</span><br><span class="line">hubot-cluster-free  us-west1-b  1.5.7           35.xxx.xxx.xxx  f1-micro      1.5.7         3          RUNNING</span><br></pre></td></tr></table></figure>

<ul>
<li>コンソールを見ると作成中であることが確認できます。</li>
</ul>
<p><img src="http://i.imgur.com/O3LQy9q.png" alt="Imgur"></p>
<ul>
<li>以下コマンドで確認可</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">macOS% $ kubectl get nodes</span><br><span class="line">NAME                                                STATUS    AGE       VERSION</span><br><span class="line">gke-hubot-cluster-free-default-pool-a3b110d2-9k6s   Ready     59s       v1.5.7</span><br><span class="line">gke-hubot-cluster-free-default-pool-a3b110d2-lqxg   Ready     1m        v1.5.7</span><br><span class="line">gke-hubot-cluster-free-default-pool-a3b110d2-xqs8   Ready     1m        v1.5.7</span><br></pre></td></tr></table></figure>

<ul>
<li>1 ノードにリサイズ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud container clusters resize hubot-cluster-free --size&#x3D;1</span><br><span class="line"></span><br><span class="line">Pool [default-pool] for [hubot-cluster-free] will be resized to 1.</span><br><span class="line"></span><br><span class="line">Do you want to continue (Y&#x2F;n)?  y</span><br><span class="line"></span><br><span class="line">Resizing hubot-cluster-free...done.</span><br><span class="line">Updated [https:&#x2F;&#x2F;container.googleapis.com&#x2F;v1&#x2F;projects&#x2F;hubot-167007&#x2F;zones&#x2F;us-west1-b&#x2F;clusters&#x2F;hubot-cluster-free].</span><br></pre></td></tr></table></figure>

<p><img src="http://i.imgur.com/KTGg91y.png" alt="Imgur"></p>
<p>リサイズできるなら初めから 1 ノードで作らせて欲しい (&gt;_&lt;)</p>
<p>コンソール上だとやっぱりダメ (T_T)</p>
<p><img src="http://i.imgur.com/TpNz2yj.png" alt="Imgur"></p>
<h2><span id="認証情報-取得">認証情報 取得</span></h2><ul>
<li>コンテナクラスタの認証情報を取得し、kubectlを利用してコンテナ クラスタ上にコンテナを作成できるようになります。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud container clusters get-credentials hubot-cluster-free</span><br><span class="line"></span><br><span class="line">Fetching cluster endpoint and auth data.</span><br><span class="line">kubeconfig entry generated for hubot-cluster-free.</span><br></pre></td></tr></table></figure>

<ul>
<li>コンテナクラスタ情報表示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud container clusters describe hubot-cluster-free</span><br></pre></td></tr></table></figure>

<h2><span id="ローカルの-docker-起動">ローカルの Docker 起動</span></h2><p>[<a href="https://github.com/kenzo0107/hubot-slack-on-docker:embed:cite]">https://github.com/kenzo0107/hubot-slack-on-docker:embed:cite]</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ git clone https:&#x2F;&#x2F;github.com&#x2F;kenzo0107&#x2F;hubot-slack-on-docker</span><br><span class="line">macOS%$ cd hubot-slack-on-docker</span><br><span class="line">macOS%$ docker-compose up -d</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ docker ps</span><br><span class="line"></span><br><span class="line">CONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS              PORTS                              NAMES</span><br><span class="line">12f77feb09b4        hubotslackondocker_hubot   &quot;&#x2F;bin&#x2F;sh -c &#39;bash ...&quot;   24 minutes ago      Up 24 minutes       6379&#x2F;tcp, 0.0.0.0:8080-&gt;8080&#x2F;tcp   hubotslackondocker_hubot_1</span><br></pre></td></tr></table></figure>

<h2><span id="hubot-動作確認">Hubot 動作確認</span></h2><p>Slack上に Hubot が登場していて <code>hello</code> と呼びかけると <code>Hi</code> と返してくれたら成功です。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170510/20170510012328.png" width="100%">
</div>

<h2><span id="container-id-から-イメージをcommit">CONTAINER ID から イメージをcommit</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ docker commit 12f77feb09b4 gcr.io&#x2F;hubot-167007&#x2F;hubot:latest</span><br><span class="line"></span><br><span class="line">macOS%$ docker images</span><br><span class="line">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">gcr.io&#x2F;hubot-167007&#x2F;hubot        latest              2f7336b3a3ce        3 seconds ago       484 MB</span><br></pre></td></tr></table></figure>



<h2><span id="gke-registory-に-push">gke registory に push</span></h2><p>参考: <a href="https://cloud.google.com/container-registry/docs/pushing?hl=ja&_ga=1.49491107.421538973.1494071894">Container Registry への push</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud docker -- push gcr.io&#x2F;hubot-167007&#x2F;hubot:latest</span><br><span class="line"></span><br><span class="line">The push refers to a repository [gcr.io&#x2F;hubot-167007&#x2F;hubot]</span><br><span class="line">0569b419082b: Pushed</span><br><span class="line">a7637cfcdfba: Pushed</span><br><span class="line">9f0bdbb7b1fa: Pushed</span><br><span class="line">f1d85eafc75a: Pushed</span><br><span class="line">c2c2b58591f2: Pushed</span><br><span class="line">51c94eacef50: Pushed</span><br><span class="line">69e7fcf7ba41: Pushed</span><br><span class="line">293d09ca6a9d: Pushed</span><br><span class="line">247e72dfcaf5: Pushed</span><br><span class="line">8c2bc9bf1f19: Pushed</span><br><span class="line">40907ce0d959: Pushed</span><br><span class="line">bfba578a7fbe: Pushed</span><br><span class="line">561cbcaac156: Pushed</span><br><span class="line">293a1e72e88b: Pushed</span><br><span class="line">ae09eb3da3dc: Pushed</span><br><span class="line">c06c14d7f919: Pushed</span><br><span class="line">e14577d2cac5: Layer already exists</span><br><span class="line">e8829d5bbd2c: Layer already exists</span><br><span class="line">674ce3c5d814: Layer already exists</span><br><span class="line">308b39a73046: Layer already exists</span><br><span class="line">638903ee8579: Layer already exists</span><br><span class="line"></span><br><span class="line">latest: digest: sha256:0c3b29d18b64c1f8ecc1a1bf67462c84d5915a4a708fe87df714d09198eb5fa1 size: 4704</span><br></pre></td></tr></table></figure>

<ul>
<li>latest が被ると過去のイメージのタグが奪われます。容量の無駄になるので削除しましょう。</li>
</ul>
<p><img src="http://i.imgur.com/YlADlds.png" alt="Imgur"></p>
<h2><span id="deployments-作成">Deployments 作成</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl run pod-hubot \</span><br><span class="line">      --image&#x3D;gcr.io&#x2F;hubot-167007&#x2F;hubot:latest \</span><br><span class="line">      --env&#x3D;&quot;HUBOT_SLACK_TOKEN&#x3D;xoxb-xxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxx&quot; \</span><br><span class="line">      --env&#x3D;&quot;HUBOT_SLACK_TEAM&#x3D;xxxxxx.slack.com&quot; \</span><br><span class="line">      --env&#x3D;&quot;HUBOT_SLACK_BOTNAME&#x3D;hubot&quot; \</span><br><span class="line">      --env&#x3D;&quot;HUBOT_JIRA_URL&#x3D;https:&#x2F;&#x2F;&lt;jira_server_domain_or_ip&gt;&quot; \</span><br><span class="line">      --port&#x3D;8080 \</span><br><span class="line">      --restart&#x3D;&#39;Always&#39;</span><br><span class="line"></span><br><span class="line">deployment &quot;pod-hubot&quot; created</span><br></pre></td></tr></table></figure>

<ul>
<li>deployments 状態確認</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl get deployments</span><br><span class="line">NAME        DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">pod-hubot   1         1         1            0           10s</span><br></pre></td></tr></table></figure>

<ul>
<li>Pod 状態確認</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl get pods</span><br><span class="line"></span><br><span class="line">NAME                         READY     STATUS             RESTARTS   AGE</span><br><span class="line">pod-hubot-1713414922-b2dkq   0&#x2F;1       ImagePullBackOff   0          23s</span><br></pre></td></tr></table></figure>

<ul>
<li>Pod にログイン</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it pod-hubot-1713414922-b2dkq &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>

<ul>
<li>service の状態確認</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl get service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME         CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   10.23.240.1   &lt;none&gt;        443&#x2F;TCP   22m</span><br></pre></td></tr></table></figure>

<p><code>EXTERNAL-IP: &lt;none&gt;</code> … 外部へ開いているIPがない。という状態<br>Private IP は付与されたが Public IP がない、外部のネットワークからアクセスできない状態です。</p>
<h2><span id="コンテナ公開">コンテナ公開</span></h2><ul>
<li>Service にロードバランサ付与し公開</li>
</ul>
<p>※ ロードバランサを追加すると課金の桁が跳ね上がります。。<br>（2000円/月くらい。念の為、設定した予算アラートでわかりました。）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl expose deployment pod-hubot --type&#x3D;&quot;LoadBalancer&quot;</span><br><span class="line">service &quot;pod-hubot&quot; exposed</span><br></pre></td></tr></table></figure>

<ul>
<li>Service 確認</li>
</ul>
<p><code>EXTERNAL-IP: &lt;pending&gt;</code> となっており、作成途中であることがわかります。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl get service</span><br><span class="line"></span><br><span class="line">NAME         CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes   10.23.240.1     &lt;none&gt;        443&#x2F;TCP          25m</span><br><span class="line">pod-hubot    10.23.244.214   &lt;pending&gt;     8080:30453&#x2F;TCP   8s</span><br></pre></td></tr></table></figure>

<ul>
<li>再度 Service 確認</li>
</ul>
<p>無事付与されているのがわかりました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl get service</span><br><span class="line">NAME         CLUSTER-IP      EXTERNAL-IP     PORT(S)          AGE</span><br><span class="line">kubernetes   10.23.240.1     &lt;none&gt;          443&#x2F;TCP          27m</span><br><span class="line">pod-hubot    10.23.244.214   104.xxx.x.xxx   8080:30453&#x2F;TCP   1m</span><br></pre></td></tr></table></figure>

<h2><span id="テスト">テスト</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ curl \</span><br><span class="line">-X POST \</span><br><span class="line">-H &quot;Content-Type: application&#x2F;json&quot; \</span><br><span class="line">-d \</span><br><span class="line">&#39;&#123;</span><br><span class="line"> &quot;webhookEvent&quot;:&quot;jira:issue_updated&quot;,</span><br><span class="line"> &quot;comment&quot;:&#123;</span><br><span class="line">   &quot;author&quot;:&#123;</span><br><span class="line">     &quot;name&quot;:&quot;himuko&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;body&quot;:&quot;[~kenzo.tanaka] 東京03 秋山 ケンコバ 劇団ひとり&quot;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;issue&quot;: &#123;</span><br><span class="line">   &quot;key&quot;:&quot;key&quot;,</span><br><span class="line">   &quot;fields&quot;:&#123;</span><br><span class="line">     &quot;summary&quot;:&quot;summary&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#39; \</span><br><span class="line">http:&#x2F;&#x2F;104.xxx.x.xxx:8080&#x2F;hubot&#x2F;jira-comment-dm</span><br></pre></td></tr></table></figure>

<p><img src="http://i.imgur.com/8FOYcyI.png" alt="Imgur"></p>
<h2><span id="後始末">後始末</span></h2><p>掃除しときたい場合に以下実行してください。</p>
<ul>
<li>service 削除</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl delete service pod-hubot</span><br><span class="line">service &quot;pod-hubot&quot; deleted</span><br></pre></td></tr></table></figure>

<ul>
<li>pod 削除</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl delete pod pod-hubot-729436916-htw3r</span><br><span class="line">service &quot;pod-hubot&quot; deleted</span><br></pre></td></tr></table></figure>

<ul>
<li>deployments 削除</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ kubectl delete deployments pod-hubot</span><br></pre></td></tr></table></figure>

<ul>
<li>container clusters 削除<br>container cluster を削除すれば紐付く deployments, service, pod も削除されます。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ gcloud container clusters delete hubot-cluster-free</span><br></pre></td></tr></table></figure>

<p>以上です。</p>
<h2><span id="総評">総評</span></h2><p>GKEは概念が多く、一概に deployment, pod, service, kubernetes 等覚えることが多いですが<br>動かしつつ学ぶのは楽しいです。</p>
<p>ほぼ手元の Mac で設定できました！<br>手元で済むから <code>macOS%$</code> は不要だった。。</p>
<p>今回作成した service だと外部に 8080 ポート全開です。</p>
<p><a href="http://kenzo0107.hatenablog.com/entry/2017/05/16/222815">次回</a>はアクセス元を制限したポートアクセスやコンテナのアップデートについてまとめます。</p>
<p>[<a href="http://kenzo0107.hatenablog.com/entry/2017/05/16/222815:embed:cite]">http://kenzo0107.hatenablog.com/entry/2017/05/16/222815:embed:cite]</a></p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/30/2017-05-01-nginx-prometheus-nodeexporter-grafana-cadvisor-on-raspi3/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170430/20170430235153.png" alt="Raspberry PI3 Model B に docker-compose で Nginx で認証かけて Prometheus + Node Exporter + Grafana + cAdvisor構築"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-04-30T15:00:00.000Z" title="2017-04-30T15:00:00.000Z">2017-05-01</time><span class="level-item">6分 read (About 848 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/30/2017-05-01-nginx-prometheus-nodeexporter-grafana-cadvisor-on-raspi3/">Raspberry PI3 Model B に docker-compose で Nginx で認証かけて Prometheus + Node Exporter + Grafana + cAdvisor構築</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Raspi3に docker-compose で Prometheus による監視機構を作成しました。</p>
<a href="https://github.com/kenzo0107/vagrant-docker/tree/master/docker/prometheus-grafana-on-raspi3" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://avatars0.githubusercontent.com/u/6197906?s=400&v=4"></div><div class="descriptions"><div class="og-title">kenzo0107/vagrant-docker</div><div class="og-description">Docker on Vagrant(ubuntu). Contribute to kenzo0107/vagrant-docker development by creating an account on GitHub.</div></div></div></a>

<h2><span id="環境">環境</span></h2><ul>
<li>Raspberry Pi 3 Model B (Raspbian GNU/Linux 8) arm7l</li>
<li>Docker version 17.04.0-ce, build 4845c56</li>
<li>docker-compose version 1.9.0, build 2585387</li>
</ul>
<h2><span id="raspi-に-docker-インストール">Raspi に docker インストール</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ wget -qO- https:&#x2F;&#x2F;get.docker.com&#x2F; | sh</span><br><span class="line">raspi%$ sudo usermod -aG docker pi</span><br><span class="line">raspi%$ sudo gpasswd -a $USER docker</span><br></pre></td></tr></table></figure>

<h2><span id="raspi-に-docker-compose-インストール">Raspi に docker-compose インストール</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ sudo apt-get update</span><br><span class="line">raspi%$ sudo apt-get install -y apt-transport-https</span><br><span class="line">raspi%$ echo &quot;deb https:&#x2F;&#x2F;packagecloud.io&#x2F;Hypriot&#x2F;Schatzkiste&#x2F;debian&#x2F; jessie main&quot; | raspi%sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;hypriot.list</span><br><span class="line">raspi%$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 37BBEE3F7AD95B3F</span><br><span class="line">raspi%$ sudo apt-get update</span><br><span class="line">raspi%$ sudo apt-get install docker-compose</span><br></pre></td></tr></table></figure>

<ul>
<li>version 確認</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ docker-compose --version</span><br><span class="line">docker-compose version 1.9.0, build 2585387</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-のプロジェクト設定">docker-compose のプロジェクト設定</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ cd ~</span><br><span class="line">raspi%$ git clone https:&#x2F;&#x2F;github.com&#x2F;kenzo0107&#x2F;vagrant-docker</span><br><span class="line">raspi%$ cd vagrant-docker&#x2F;docker&#x2F;prometheus-grafana-on-raspi3</span><br></pre></td></tr></table></figure>

<h2><span id="nginx-basic-認証設定">Nginx Basic 認証設定</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.htpasswd 作成時のユーザ&#x2F;パス &#x3D;&#x3D; GF_SECURITY_ADMIN_USER&#x2F;GF_SECURITY_ADMIN_PASSWORD</span><br></pre></td></tr></table></figure>
<p>である必要があります。</p>
<p>Grafana の認証機能により設定した Basic 認証でログインできる仕組みがあり、<br>一致しない場合、ログインできず、失敗します。</p>
<ul>
<li><p>grafana/env</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GF_SECURITY_ADMIN_USER&#x3D;admin-user</span><br><span class="line">GF_SECURITY_ADMIN_PASSWORD&#x3D;admin-pass</span><br></pre></td></tr></table></figure>
</li>
<li><p>.htpasswd</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ htpasswd -c nginx&#x2F;conf&#x2F;conf.d&#x2F;.htpasswd admin-user</span><br><span class="line">New password: (「admin-pass」と入力しEnter)</span><br><span class="line">Re-type new password: (「admin-pass」と入力しEnter)</span><br><span class="line">Adding password for user admin-user</span><br><span class="line"></span><br><span class="line">raspi%$ cat nginx&#x2F;conf&#x2F;conf.d&#x2F;.htpasswd</span><br><span class="line">admin-user:$apr1$JLxC83lt$uO7aEn9Z59fZtba4EA7C6&#x2F;</span><br></pre></td></tr></table></figure>

<h2><span id="cron設定">Cron設定</span></h2><p>Raspi の温度や電圧を定期取得し Prometheus に読み込ませるファイル(*.prom)作成します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*&#x2F;5 * * * * &lt;home&#x2F;to&#x2F;path&gt;&#x2F;vagrant-docker&#x2F;docker&#x2F;prometheus-grafana-on-raspi3&#x2F;node-exporter&#x2F;collector&#x2F;raspi.sh</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-により-docker-起動">docker-compose により Docker 起動</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raspi%$ docker-compose up -d</span><br></pre></td></tr></table></figure>

<h2><span id="grafana-にアクセスしてみる">Grafana にアクセスしてみる</span></h2><p><code>http://&lt;your_server_ip&gt;:13000</code> にアクセスすると .htpasswd で指定したユーザ/パスを求められるので入力します</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170430/20170430235949.png" width="100%">
</div>

<p>その後、Grafana のページが表示されれば成功です。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170501/20170501002430.png" width="100%">
</div>

<p>「Add data Source」をクリックします。</p>
<h2><span id="data-source-設定">Data Source 設定</span></h2><p>以下の様に設定し「Save &amp; Test」をクリックししSuccessすることを確認します。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170501/20170501002606.png" width="100%">
</div>


<h2><span id="dashboardjson-インポート">Dashboard.json インポート</span></h2><p>左上のアイコンから Dashboards &gt; Import 選択し DockerDashboard.json をインポートします。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170501/20170501003915.png" width="100%">
</div>

<h2><span id="dashboard-表示">Dashboard 表示</span></h2><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170501/20170501003051.png" width="100%">
</div>


<h2><span id="ポイント">ポイント !</span></h2><h3><span id="セキュリティ上の観点から外から直接-grafana-を参照させない様にしました">セキュリティ上の観点から外から直接 Grafana を参照させない様にしました。</span></h3><p>nginx/conf/conf.d/default.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        auth_basic &quot;Restricted&quot;;</span><br><span class="line">        auth_basic_user_file &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;.htpasswd;</span><br><span class="line"></span><br><span class="line">        proxy_pass                          http:&#x2F;&#x2F;grafana:3000&#x2F;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3><span id="image-選びは慎重に">image 選びは慎重に。</span></h3><p>以下の点で非常にハマりました。</p>
<ol>
<li>Raspberry Pi3 Model B (今回はarm7l)上で動作するか</li>
<li>Nginx で Proxy 機能が正しく動作するか</li>
</ol>
<p>nginx のproxy機能で grafana に繋げても 以下の様に表示されてしまうケースにぶつかりまくりました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;alert.title&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="総評">総評</span></h2><p>イメージ探しについ時間取ってしまいましたが<br>自作した方が早かったかもと反省。</p>
<p>今回は自身を監視するという仕組みにしましたが外部から監視し相互に監視し合う体制が必要です。<br>家庭内稟議が通ればもう一台getしよう！</p>
<p>そして、家庭の為になるものを作ろう！</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/26/2017-04-27-peco/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170427/20170427172718.jpg" alt="peco 小技シリーズ  〜多段ssh + peco, ghq + peco + atom〜"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-04-26T15:00:00.000Z" title="2017-04-26T15:00:00.000Z">2017-04-27</time><span class="level-item"><a class="link-muted" href="/categories/Go/">Go</a></span><span class="level-item">2分 read (About 363 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/26/2017-04-27-peco/">peco 小技シリーズ  〜多段ssh + peco, ghq + peco + atom〜</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>本当に小技です。<br>が、割と使ってみると作業時間の短縮となって便利という声を頂き<br>peco 関連でよく使うものを記事にしました。</p>
<h2><span id="peco-インストール">peco インストール</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS %$ brew install peco</span><br></pre></td></tr></table></figure>

<h2><span id="ssh-ログインする-host-を検索して選択">ssh ログインする Host を検索して選択</span></h2><p>前提条件として <code>~/.ssh/config</code> で接続ホストを管理しています。</p>
<script src="//gist.github.com/kenzo0107/06b3b1e202f36b70815cfe0207292a66.js"></script>

<p>上記を <code>~/.bashrc</code> などに貼り付けて <code>source ~/.bashrc</code> すれば使えます♪</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">macOS %$ git clone https:&#x2F;&#x2F;gist.github.com&#x2F;kenzo0107&#x2F;06b3b1e202f36b70815cfe0207292a66</span><br><span class="line">macOS %$ cd 06b3b1e202f36b70815cfe0207292a66</span><br><span class="line">macOS %$ cat peco-sshconfig-ssh.sh &gt;&gt; ~&#x2F;.bashrc</span><br><span class="line">macOS %$ source ~&#x2F;.bashrc</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; sshc 実行！</span><br><span class="line">macOS %$ sshc</span><br></pre></td></tr></table></figure>

<p>上記の様に順調に進むと候補がリストされます。<br>モザイクしかなくすいません (&gt;_&lt;)</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170427/20170427171121.png" width="100%">
</div>

<h2><span id="ghq-で管理している-repository-を検索して選択し-atom-で開く">ghq で管理している repository を検索して選択し atom で開く</span></h2><script src="//gist.github.com/kenzo0107/e460e31ae2478341cc7a39859ad7fefd.js"></script>

<p>こちらも同様、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">macOS %$ git clone https:&#x2F;&#x2F;gist.github.com&#x2F;kenzo0107&#x2F;e460e31ae2478341cc7a39859ad7fefd</span><br><span class="line">macOS %$ cd e460e31ae2478341cc7a39859ad7fefd</span><br><span class="line">macOS %$ cat peco-git-atom.sh &gt;&gt; ~&#x2F;.bashrc</span><br><span class="line">macOS %$ source ~&#x2F;.bashrc</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; opg 実行！</span><br><span class="line">macOS %$ opg</span><br></pre></td></tr></table></figure>

<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170427/20170427171728.png" width="100%">
</div>

<p>他にも様々な箇所で peco を利用させて頂いてます。<br>こんな peco の使い所あるよーという方、是非教えてください♪</p>
<h2><span id="参照">参照</span></h2><p>zsh ですが dotfile をまとめてます。</p>
<a href="https://github.com/kenzo0107/dotfiles" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://avatars0.githubusercontent.com/u/6197906?s=400&v=4"></div><div class="descriptions"><div class="og-title">kenzo0107/dotfiles</div><div class="og-description">dotfile setting. Contribute to kenzo0107/dotfiles development by creating an account on GitHub.</div></div></div></a>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/20/2017-04-21-fke-on-docker-compose/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421221055.png" alt="docker-compose で開発環境構築 〜Nginx アクセスログ(ltsv) を fluentd + elasticsearch + kibana で可視化〜"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-04-20T15:00:00.000Z" title="2017-04-20T15:00:00.000Z">2017-04-21</time><span class="level-item">3分 read (About 496 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/20/2017-04-21-fke-on-docker-compose/">docker-compose で開発環境構築 〜Nginx アクセスログ(ltsv) を fluentd + elasticsearch + kibana で可視化〜</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>前回構築した Vagrant 環境上で docker-compose による開発環境構築をします。</p>
<a href="http://kenzo0107.hatenablog.com/entry/2017/04/13/225610" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413222957.png"></div><div class="descriptions"><div class="og-title">Vagrant (Ubuntu) に Docker, Docker Compose インストール - 長生村本郷Engineers&#39;Blog</div><div class="og-description">概要 開発環境構築用に作成した、 Vagrant (Ubuntu) に Docker と Docker Compose をインストールする手順をまとめました。 Vagrantfile 作成 かなりシンプルにしてます。 Vagrantfile # -*- mode: ruby -*…</div></div></div></a>

<p>今回は前回の続きで Nginx のアクセスログを Elasticsearch + Fluentd + Kibana で可視化してみます。<br>アプリ</p>
<h2><span id="簡単構築手順">簡単構築手順</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">macOS% $ git clone https:&#x2F;&#x2F;github.com&#x2F;kenzo0107&#x2F;vagrant-docker</span><br><span class="line">macOS% $ cd vagrant-docker</span><br><span class="line">macOS% $ vagrant up</span><br><span class="line">macOS% $ vagrant ssh</span><br><span class="line">vagrant% $ cd &#x2F;vagrant&#x2F;nginx-efk</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; -d デタッチモードでないのは各コンテナの起動状況がログで見える為です。</span><br><span class="line">vagrant% $ docker-compose up</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-構成">docker-compose 構成</span></h2><p>Git にまとめています。</p>
<a href="https://github.com/kenzo0107/vagrant-docker/tree/master/docker/nginx-efk" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://avatars0.githubusercontent.com/u/6197906?s=400&v=4"></div><div class="descriptions"><div class="og-title">kenzo0107/vagrant-docker</div><div class="og-description">Docker on Vagrant(ubuntu). Contribute to kenzo0107/vagrant-docker development by creating an account on GitHub.</div></div></div></a>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">├── docker-compose.yml</span><br><span class="line">├── fluentd</span><br><span class="line">│   ├── conf</span><br><span class="line">│   │   ├── conf.d</span><br><span class="line">│   │   │   └── nginx.log.conf</span><br><span class="line">│   │   └── fluent.conf</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">└── nginx</span><br><span class="line">    └── conf</span><br><span class="line">        └── nginx.conf</span><br></pre></td></tr></table></figure>

<h3><span id="ポイント">ポイント</span></h3><ul>
<li>nginx のログ格納場所を <code>volume</code> 指定しホスト側とシンク。 それを fluentd 側でも <code>volume</code> 指定し tail するようにしました。</li>
</ul>
<p>以下のようなイメージです。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421221055.png" width="100%">
</div>

<h2><span id="ブラウザから-nginx-起動確認">ブラウザから Nginx 起動確認</span></h2><p>ブラウザから <code>http://192.168.35.101/</code> にアクセスすると<br>Nginx の Welcome ページが確認できます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421222343.png" width="100%">
</div>


<p>先程の <code>docker-compose up</code> 後に以下のようなログが見え<br>fluentd が Nginx アクセスログを捕まえているのがわかります。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421222937.png" width="100%">
</div>

<h2><span id="kibana-にアクセス">Kibana にアクセス</span></h2><p>ブラウザから <code>http://192.168.35.101:5601</code> にアクセスすると<br>Kibana ページが表示されます。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421223008.png" width="100%">
</div>

<ol>
<li><p>Index name or pattern</p>
<ul>
<li>fluentd-* 指定</li>
</ul>
</li>
<li><p>Time-field name</p>
<ul>
<li>@timestamp 指定</li>
</ul>
</li>
<li><p>Create ボタン押下</p>
</li>
<li><p>レフトメニューから <code>Discover</code> クリック</p>
</li>
</ol>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170421/20170421223626.png" width="100%">
</div>

<h2><span id="macos-からログ確認">macOS からログ確認</span></h2><p>当然ながら macOS と vagrant とシンクしているので<br>macOS 上からもログが tail できます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">macOS%$ tail -f &lt;path&#x2F;to&#x2F;vagrant-docker&gt;&#x2F;docker&#x2F;nginx-efk&#x2F;_log&#x2F;nginx&#x2F;access.log</span><br></pre></td></tr></table></figure>

<p>以上です。<br>参考になれば幸いです。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/17/2017-04-18-aws-retairement-notification/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170418/20170418105821.png" alt="AWS [Retirement Notification] 対応"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-04-17T15:00:00.000Z" title="2017-04-17T15:00:00.000Z">2017-04-18</time><span class="level-item">7分 read (About 1026 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/17/2017-04-18-aws-retairement-notification/">AWS [Retirement Notification] 対応</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>とある日、AWS よりこんなメール通知が来ました。</p>
<p>要約すると<br>ホストしている基盤のハードウェアで回復不可能な障害が検知されたので<br>指定期限までに対応しないとインスタンスが停止する、とのこと。</p>
<p>今回こちらの対応をまとめました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Dear Amazon EC2 Customer,</span><br><span class="line"></span><br><span class="line">We have important news about your account (AWS Account ID: xxxxxxxxxxxx). EC2 has detected degradation of the underlying hardware hosting your Amazon EC2 instance (instance-ID: i-xxxxxxxx) in the ap-northeast-1 region. Due to this degradation, your instance could already be unreachable. After 2017-04-25 04:00 UTC your instance, which has an EBS volume as the root device, will be stopped.</span><br><span class="line"></span><br><span class="line">You can see more information on your instances that are scheduled for retirement in the AWS Management Console (https:&#x2F;&#x2F;console.aws.amazon.com&#x2F;ec2&#x2F;v2&#x2F;home?region&#x3D;ap-northeast-1#Events)</span><br><span class="line"></span><br><span class="line">* How does this affect you?</span><br><span class="line">Your instance&#39;s root device is an EBS volume and the instance will be stopped after the specified retirement date. You can start it again at any time. Note that if you have EC2 instance store volumes attached to the instance, any data on these volumes will be lost when the instance is stopped or terminated as these volumes are physically attached to the host computer</span><br><span class="line"></span><br><span class="line">* What do you need to do?</span><br><span class="line">You may still be able to access the instance. We recommend that you replace the instance by creating an AMI of your instance and launch a new instance from the AMI. For more information please see Amazon Machine Images (http:&#x2F;&#x2F;docs.aws.amazon.com&#x2F;AWSEC2&#x2F;latest&#x2F;UserGuide&#x2F;AMIs.html) in the EC2 User Guide. In case of difficulties stopping your EBS-backed instance, please see the Instance FAQ (http:&#x2F;&#x2F;aws.amazon.com&#x2F;instance-help&#x2F;#ebs-stuck-stopping).</span><br><span class="line"></span><br><span class="line">* Why retirement?</span><br><span class="line">AWS may schedule instances for retirement in cases where there is an unrecoverable issue with the underlying hardware. For more information about scheduled retirement events please see the EC2 user guide (http:&#x2F;&#x2F;docs.aws.amazon.com&#x2F;AWSEC2&#x2F;latest&#x2F;UserGuide&#x2F;instance-retirement.html). To avoid single points of failure within critical applications, please refer to our architecture center for more information on implementing fault-tolerant architectures: http:&#x2F;&#x2F;aws.amazon.com&#x2F;architecture</span><br><span class="line"></span><br><span class="line">If you have any questions or concerns, you can contact the AWS Support Team on the community forums and via AWS Premium Support at: http:&#x2F;&#x2F;aws.amazon.com&#x2F;support</span><br><span class="line"></span><br><span class="line">Sincerely,</span><br><span class="line">Amazon Web Services</span><br></pre></td></tr></table></figure>



<ul>
<li>AWS Console イベントを見ると一覧で表示されている。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170418/20170418095219.png" width="100%">
</div>

<ul>
<li>AWS Console 詳細を見ると Notice が出ている。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170411/20170411215054.png" width="100%">
</div>

<h2><span id="todo">ToDO</span></h2><p>ボリュームタイプによって異なります。</p>
<ul>
<li>EBSボリューム<ul>
<li>インスタンスの停止後、起動 (Reboot は ×)</li>
</ul>
</li>
</ul>
<ul>
<li>インスタンスストアボリューム<ul>
<li>AMI からインスタンス再作成、データ移行</li>
</ul>
</li>
</ul>
<p>今回は EBS ボリューム対応について記載してます。</p>
<h2><span id="対応">対応</span></h2><p>対象インスタンスが多かったのでローカルPC (macOS) から awscli でインスタンス停止→起動するシェル作成しました。<br>本番環境で利用されるインスタンスも含まれていた為、1件ずつ実行することとしました。</p>
<h2><span id="事前準備">事前準備</span></h2><ul>
<li>awscli, jq インストール</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install awscli jq</span><br></pre></td></tr></table></figure>

<ul>
<li>各アカウント毎のアクセスキー、シークレットキー等設定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure --profile &lt;profile&gt;</span><br><span class="line">$ grep &#39;profile&#39; ~&#x2F;.aws&#x2F;config</span><br></pre></td></tr></table></figure>

<h3><span id="インスタンスの停止再起動シェル">インスタンスの停止・再起動シェル</span></h3><script src="//gist.github.com/kenzo0107/b841bfad242e87da3625e5d980845529.js"></script>

<p>以下のように実行すると<br>インスタンスが起動(running)していれば<br>停止後、再び起動し、ステータスチェックをするようにしました。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sh stop_and_start_ec2_instance.sh &quot;&lt;profile&gt;&quot; &quot;&lt;instance id&gt;&quot;</span><br></pre></td></tr></table></figure>

<h3><span id="イベント情報取得シェル">イベント情報取得シェル</span></h3><p>.aws/config で設定されている profile を全てチェックし<br>未対応インスタンスのみ表示する様修正しました。</p>
<script src="//gist.github.com/kenzo0107/b79e05f6fc6692a1d631fd874ccb3e6b.js"></script>

<h2><span id="結果確認">結果確認</span></h2><p>大体 1インスタンス 5分程度で完了。<br>問題なく停止起動でき、対象イベントが一覧から消えたことを確認しました♪</p>
<h2><span id="所感">所感</span></h2><p>メンテ対象インスタンスの Region が northeast に集中していたのが気になる点でした。<br>このインスタンス何に使ってるんだっけ？とならない様に、インスタンスやprivate key の命名ルール必須と感じました。</p>
<p>以上です。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/13/2017-04-14-teat-docker/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170414/20170414222435.png" alt="Docker コマンド早見表"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-04-13T15:00:00.000Z" title="2017-04-13T15:00:00.000Z">2017-04-14</time><span class="level-item">2分 read (About 332 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/13/2017-04-14-teat-docker/">Docker コマンド早見表</a></h1><div class="content"><h2><span id="バージョン">バージョン</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker --version</span><br><span class="line"></span><br><span class="line">Docker version 17.04.0-ce, build 4845c56</span><br></pre></td></tr></table></figure>

<h2><span id="コンテナ">コンテナ</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker ps                     # running コンテナ一覧</span><br><span class="line">docker ps -a                  # 全コンテナ一覧表示</span><br><span class="line">docker start &lt;CONTAINER ID&gt;   # コンテナ起動</span><br><span class="line">docker restart &lt;CONTAINER ID&gt; # コンテナ再起動</span><br><span class="line">docker stop &lt;CONTAINER ID&gt;    # コンテナ終了</span><br><span class="line">docker kill &lt;CONTAINER ID&gt;    # コンテナ強制終了</span><br><span class="line">docker attach &lt;CONTAINER ID&gt;  # コンテナへアタッチ</span><br><span class="line">docker top &lt;CONTAINER ID&gt;     # コンテナプロセスを表示</span><br><span class="line">docker logs -f &lt;CONTAINER ID&gt; # コンテナログ表示</span><br><span class="line">docker inspect &lt;CONTAINER ID&gt; # コンテナ情報表示</span><br><span class="line">docker rm &lt;CONTAINER ID&gt;      # コンテナID指定でコンテナ削除</span><br><span class="line">dockre rm &lt;CONTAINER NAME...&gt; # コンテナ名(複数)指定でコンテナ削除</span><br><span class="line">docker container prune        # 停止コンテナを削除</span><br><span class="line"></span><br><span class="line">dockr run -it -h &lt;host name&gt; &lt;IMAGE&gt;[:TAG] &lt;command&gt;  # イメージよりコンテナ起動 command 実施</span><br></pre></td></tr></table></figure>

<h2><span id="イメージ">イメージ</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull &lt;IMAGE NAME&gt;[:tag]     # イメージダウンロード</span><br><span class="line">docker images ls              # イメージ一覧</span><br><span class="line">docker inspect &lt;IMAGE ID&gt;     # イメージ情報表示</span><br><span class="line">docker rmi &lt;IMAGE ID&gt;         # イメージ削除</span><br></pre></td></tr></table></figure>

<h2><span id="イメージ作成">イメージ作成</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t NAME[:TAG]</span><br><span class="line">docker commit -m &quot;&lt;comment here&gt;&quot; &lt;CONTAINER ID&gt; &lt;IMAGE NAME&gt;[:TAG]</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose">Docker Compose</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d    # デタッチモードでイメージよりコンテナ起動</span><br><span class="line">docker-compose ps       # コンテナ一覧表示</span><br><span class="line">docker-compose stop     # docker compose 管理下全てのコンテナ停止</span><br><span class="line">docker-compose start    # docker compose 管理下全てのコンテナ起動</span><br><span class="line">docker-compose rm       # docker compose 管理下全ての停止コンテナ削除</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/12/2017-04-13-install-docker-and-docker-compose-on-vagrant/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413222957.png" alt="Vagrant (Ubuntu) に Docker, Docker Compose インストール"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-04-12T15:00:00.000Z" title="2017-04-12T15:00:00.000Z">2017-04-13</time><span class="level-item">7分 read (About 979 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/12/2017-04-13-install-docker-and-docker-compose-on-vagrant/">Vagrant (Ubuntu) に Docker, Docker Compose インストール</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>開発環境構築用に作成した、<br>Vagrant (Ubuntu) に Docker と Docker Compose をインストールする手順をまとめました。</p>
<h2><span id="vagrantfile-作成">Vagrantfile 作成</span></h2><p>かなりシンプルにしてます。</p>
<ul>
<li>Vagrantfile</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line"><span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line">Vagrant.configure(<span class="string">"2"</span>) <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">  config.vm.box = <span class="string">"ubuntu/trusty64"</span></span><br><span class="line">  config.vm.network <span class="string">"private_network"</span>, <span class="symbol">ip:</span> <span class="string">"192.168.35.101"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>vagrant provision で docker compose をインストールすることも可能ですが<br>vagrant ならではの provision だと他環境で利用できない為、OS上でインストールする方針です。</p>
<h2><span id="vm-起動">VM 起動</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MacOS%$ vagrant up</span><br><span class="line">...</span><br><span class="line">しばし待つ</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">MacOS%$ vagrant ssh</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ssh ログイン成功</span><br><span class="line">vagrant%$</span><br></pre></td></tr></table></figure>

<h2><span id="vagrant-ubuntu-環境情報確認">Vagrant Ubuntu 環境情報確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ lsb_release -a</span><br><span class="line"></span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 14.04.5 LTS</span><br><span class="line">Release:        14.04</span><br><span class="line">Codename:       trusty</span><br></pre></td></tr></table></figure>

<h2><span id="カーネルバージョン確認">カーネルバージョン確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ uname -r</span><br><span class="line">3.13.0-116-generic</span><br></pre></td></tr></table></figure>

<p>カーネルバージョンが 3.10 より低いとバグを引き起こす危険性があるので NG。<br>別のカーネルバージョンの高い box を使用しましょう。</p>
<h2><span id="古いバージョンをアンインストール">古いバージョンをアンインストール</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo apt-get remove docker docker-engine</span><br></pre></td></tr></table></figure>

<h2><span id="extra-パッケージインストール">extra パッケージインストール</span></h2><p>Docker に <a href="http://docs.docker.jp/engine/userguide/storagedriver/aufs-driver.html">aufs</a> ストレージを使用許可する為です。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo apt-get update</span><br><span class="line">vagrant%$ sudo apt-get -y install \</span><br><span class="line">    wget \</span><br><span class="line">    linux-image-extra-$(uname -r) \</span><br><span class="line">    linux-image-extra-virtual</span><br></pre></td></tr></table></figure>

<h2><span id="docker-インストール">Docker インストール</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Docker インストール</span><br><span class="line">vagrant%$ wget -qO- https:&#x2F;&#x2F;get.docker.com&#x2F; | sh</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Docker バージョン確認</span><br><span class="line">vagrant%$ docker --version</span><br><span class="line">Docker version 17.04.0-ce, build 4845c56</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; vagrant ユーザを docker グループに追加 (一旦ログアウトしログインし直すと有効になることを確認できます)</span><br><span class="line">vagrant%$ sudo usermod -aG docker vagrant</span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-インストール">Docker Compose インストール</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ curl -L &quot;https:&#x2F;&#x2F;github.com&#x2F;docker&#x2F;compose&#x2F;releases&#x2F;download&#x2F;1.12.0&#x2F;docker-compose-$(uname -s)-$(uname -m)&quot; &gt;  ~&#x2F;docker-compose</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 実行権限付与</span><br><span class="line">vagrant%$ chmod +x ~&#x2F;docker-compose</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 実行パス移動</span><br><span class="line">vagrant%$ sudo mv docker-compose &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Docker Compose バージョン確認</span><br><span class="line">vagrant%$ docker-compose --version</span><br><span class="line">docker-compose version 1.12.0, build b31ff33</span><br></pre></td></tr></table></figure>


<h2><span id="一度ログアウトし再度ログイン">一度ログアウトし再度ログイン</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ exit</span><br><span class="line">MacOS%$ vagrant ssh</span><br><span class="line">vagrant%$</span><br></pre></td></tr></table></figure>

<h2><span id="メモリとスワップ利用量の調整">メモリとスワップ利用量の調整</span></h2><p>Docker を使用していない時にメモリのオーバーヘッドとパフォーマンス劣化を低減させる様、<br>GRUB (GRand Unified Bootloader: グラブ or ジーラブ) に設定する必要があります。</p>
<ul>
<li>grub 設定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo vi &#x2F;etc&#x2F;default&#x2F;grub</span><br><span class="line"></span><br><span class="line"># GRUB_CMDLINE_LINUX&#x3D;&quot;&quot;</span><br><span class="line">GRUB_CMDLINE_LINUX&#x3D;&quot;cgroup_enable&#x3D;memory swapaccount&#x3D;1&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>GRUB (GRand Unified Bootloader: グラブ or ジーラブ) 更新</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ sudo update-grub</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 念の為、再起動</span><br><span class="line">vagrant%$ sudo reboot</span><br></pre></td></tr></table></figure>


<p>以上で準備完了です♪</p>
<h2><span id="早速試してみる">早速試してみる</span></h2><p>簡単なチュートリアルとして nginx コンテナを立ててみます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker run --rm -p 80:80 nginx:mainline-alpine</span><br><span class="line"></span><br><span class="line">Unable to find image &#39;nginx:mainline-alpine&#39; locally</span><br><span class="line">mainline-alpine: Pulling from library&#x2F;nginx</span><br><span class="line">709515475419: Already exists</span><br><span class="line">4b21d71b440a: Pull complete</span><br><span class="line">c92260fe6357: Pull complete</span><br><span class="line">ed383a1b82df: Pull complete</span><br><span class="line">Digest: sha256:5aadb68304a38a8e2719605e4e180413f390cd6647602bee9bdedd59753c3590</span><br><span class="line">Status: Downloaded newer image for nginx:mainline-alpine</span><br></pre></td></tr></table></figure>

<h2><span id="ブラウザアクセス">ブラウザアクセス</span></h2><p>ローカルの Mac からブラウザでアクセス</p>
<p><a href="http://192.168.35.101">http://192.168.35.101</a></p>
<p>※192.168.35.101 … Vagrant で指定した private ip</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413224153.png" width="100%">
</div>

<p>問題なく Welcome ページが表示されました。</p>
<p>先程のログに以下のようにアクセスログが出力されるのがわかります。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.35.1 - - [13&#x2F;Apr&#x2F;2017:10:45:46 +0000] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;57.0.2987.133 Safari&#x2F;537.36&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<p>MacOS → Vagrant → Docker<br>とアクセスできるようになりました♪</p>
<h2><span id="追記">追記</span></h2><p>今回作成した Box を Vagrant Cloud に置きました。</p>
<p><a href="https://atlas.hashicorp.com/kenzo0107/boxes/ubuntu14.04.5LTS-docker-dockercompose/">https://atlas.hashicorp.com/kenzo0107/boxes/ubuntu14.04.5LTS-docker-dockercompose/</a></p>
<p>こちら設定を元にこれから様々な環境構築を記載していきたいと思います♪</p>
<h2><span id="参照">参照</span></h2><ul>
<li><a href="http://docs.docker.jp/engine/userguide/storagedriver/aufs-driver.html">AUFS ストレージ・ドライバの使用</a></li>
<li><a href="http://docs.docker.jp/engine/reference/run.html">Docker run リファレンス</a></li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/04/12/2017-04-13-tutorial-docker-compose/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170414/20170414222435.png" alt="Docker Compose チュートリアル"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-04-12T15:00:00.000Z" title="2017-04-12T15:00:00.000Z">2017-04-13</time><span class="level-item">3分 read (About 482 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/12/2017-04-13-tutorial-docker-compose/">Docker Compose チュートリアル</a></h1><div class="content"><p>前回 Vagrant (Ubuntu)で Docker, Docker Compose 環境構築しました。</p>
<a href="http://kenzo0107.hatenablog.com/entry/2017/04/13/225610" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413222957.png"></div><div class="descriptions"><div class="og-title">Vagrant (Ubuntu) に Docker, Docker Compose インストール - 長生村本郷Engineers&#39;Blog</div><div class="og-description">概要 開発環境構築用に作成した、 Vagrant (Ubuntu) に Docker と Docker Compose をインストールする手順をまとめました。 Vagrantfile 作成 かなりシンプルにしてます。 Vagrantfile # -*- mode: ruby -*…</div></div></div></a>


<p>上記環境を元に <a href="https://docs.docker.com/compose/gettingstarted/#step-1-setup">Docker Compose チュートリアル</a>を実行しました。</p>
<p>完全な備忘録です。</p>
<h2><span id="プロジェクトディレクトリ作成">プロジェクトディレクトリ作成</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ mkdir composetest &amp;&amp; cd composetest</span><br></pre></td></tr></table></figure>

<h2><span id="apppy-作成">app.py 作成</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=<span class="string">'redis'</span>, port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    count = redis.incr(<span class="string">'hits'</span>)</span><br><span class="line">    <span class="comment">#return 'Hello World! I have been seen &#123;&#125; times.\n'.format(count)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello from Docker! I have been seen &#123;&#125; times.\n'</span>.format(count)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2><span id="requirementstxt-作成">requirements.txt 作成</span></h2><p>pip でインストールするモジュールを列挙します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flask</span><br><span class="line">redis</span><br></pre></td></tr></table></figure>

<h2><span id="dockerfile-作成">Dockerfile 作成</span></h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.4</span>-alpine</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> . /code</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /code</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip install -r requirements.txt</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"python"</span>, <span class="string">"app.py"</span>]</span></span><br></pre></td></tr></table></figure>

<h2><span id="docker-composeyml-作成">docker-compose.yml 作成</span></h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">"5000:5000"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">.:/code</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"redis:alpine"</span></span><br></pre></td></tr></table></figure>

<h2><span id="docker-compose-でイメージビルド-コンテナ起動">Docker Compose でイメージビルド、コンテナ起動</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vagrant%$ docker-compose up</span><br><span class="line"></span><br><span class="line">Creating composetest_web_1</span><br><span class="line">Creating composetest_redis_1</span><br><span class="line">Attaching to composetest_redis_1, composetest_web_1</span><br><span class="line">redis_1  | 1:C 13 Apr 14:25:38.483 # Warning: no config file specified, using the default config. Inorder to specify a config file use redis-server &#x2F;path&#x2F;to&#x2F;redis.conf</span><br><span class="line">redis_1  |                 _._</span><br><span class="line">redis_1  |            _.-&#96;&#96;__ &#39;&#39;-._</span><br><span class="line">redis_1  |       _.-&#96;&#96;    &#96;.  &#96;_.  &#39;&#39;-._           Redis 3.2.8 (00000000&#x2F;0) 64 bit</span><br><span class="line">redis_1  |   .-&#96;&#96; .-&#96;&#96;&#96;.  &#96;&#96;&#96;\&#x2F;    _.,_ &#39;&#39;-._</span><br><span class="line">redis_1  |  (    &#39;      ,       .-&#96;  | &#96;,    )     Running in standalone mode</span><br><span class="line">redis_1  |  |&#96;-._&#96;-...-&#96; __...-.&#96;&#96;-._|&#39;&#96; _.-&#39;|     Port: 6379</span><br><span class="line">redis_1  |  |    &#96;-._   &#96;._    &#x2F;     _.-&#39;    |     PID: 1</span><br><span class="line">redis_1  |   &#96;-._    &#96;-._  &#96;-.&#x2F;  _.-&#39;    _.-&#39;</span><br><span class="line">redis_1  |  |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|</span><br><span class="line">redis_1  |  |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |           http:&#x2F;&#x2F;redis.io</span><br><span class="line">redis_1  |   &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;</span><br><span class="line">redis_1  |  |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|</span><br><span class="line">redis_1  |  |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |</span><br><span class="line">redis_1  |   &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;</span><br><span class="line">redis_1  |       &#96;-._    &#96;-.__.-&#39;    _.-&#39;</span><br><span class="line">redis_1  |           &#96;-._        _.-&#39;</span><br><span class="line">redis_1  |               &#96;-.__.-&#39;</span><br><span class="line">redis_1  |</span><br><span class="line">redis_1  | 1:M 13 Apr 14:25:38.486 # WARNING: The TCP backlog setting of 511 cannot be enforced because &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn is set to the lower value of 128.</span><br><span class="line">redis_1  | 1:M 13 Apr 14:25:38.486 # Server started, Redis version 3.2.8</span><br><span class="line">redis_1  | 1:M 13 Apr 14:25:38.486 # WARNING overcommit_memory is set to 0! Background save may failunder low memory condition. To fix this issue add &#39;vm.overcommit_memory &#x3D; 1&#39; to &#x2F;etc&#x2F;sysctl.conf andthen reboot or run the command &#39;sysctl vm.overcommit_memory&#x3D;1&#39; for this to take effect.</span><br><span class="line">redis_1  | 1:M 13 Apr 14:25:38.486 * The server is now ready to accept connections on port 6379</span><br><span class="line">web_1    |  * Running on http:&#x2F;&#x2F;0.0.0.0:5000&#x2F; (Press CTRL+C to quit)</span><br><span class="line">web_1    |  * Restarting with stat</span><br><span class="line">web_1    |  * Debugger is active!</span><br><span class="line">web_1    |  * Debugger PIN: 135-466-976</span><br><span class="line">web_1    | 192.168.35.1 - - [13&#x2F;Apr&#x2F;2017 14:25:53] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 -</span><br><span class="line">web_1    | 192.168.35.1 - - [13&#x2F;Apr&#x2F;2017 14:25:53] &quot;GET &#x2F;favicon.ico HTTP&#x2F;1.1&quot; 404 -</span><br></pre></td></tr></table></figure>

<p>ブラウザにアクセスしてみる。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170413/20170413233236.png" width="100%">
</div>

<p>表示されました！</p>
<p>リロードする度に以下数字部分がインクリメントされるのが確認できます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello from Docker! I have been seen 1 times.</span><br></pre></td></tr></table></figure>

<p>便利♪</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/03/26/2017-03-27-create-keypair-by-terraform/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327212027.png" alt="Terraform でキーペア登録し起動した EC2 に SSH接続"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-03-26T15:00:00.000Z" title="2017-03-26T15:00:00.000Z">2017-03-27</time><span class="level-item">5分 read (About 734 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/03/26/2017-03-27-create-keypair-by-terraform/">Terraform でキーペア登録し起動した EC2 に SSH接続</a></h1><div class="content"><h2><span id="今回やること">今回やること</span></h2><ul>
<li>Mac ローカルで公開鍵、秘密鍵を生成</li>
<li>Terraform でEC2起動、セキュリティグループで SSH (ポート22)許可、key-pair 登録</li>
</ul>
<p>Terraform の Hello World 的なチュートリアルと思っていただけたら幸いです。</p>
<h2><span id="環境">環境</span></h2><ul>
<li>Mac OS 10.12.3 (Sierra)</li>
<li>Terraform 0.9.1</li>
</ul>
<h2><span id="公開鍵-秘密鍵生成">公開鍵、秘密鍵生成</span></h2><p>RSAフォーマットで鍵を生成します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line">Enter file in which to save the key (&#x2F;Users&#x2F;kenzo_tanaka&#x2F;.ssh&#x2F;id_rsa): &#x2F;Users&#x2F;kenzo_tanaka&#x2F;.ssh&#x2F;terraform-test</span><br><span class="line">Enter passphrase (empty for no passphrase): (空のままEnter)</span><br><span class="line">Enter same passphrase again: (空のままEnter)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 生成されたか確認</span><br><span class="line">$ ls ~&#x2F;.ssh&#x2F;terraform-test*</span><br><span class="line"></span><br><span class="line">&#x2F;Users&#x2F;kenzo_tanaka&#x2F;.ssh&#x2F;terraform-test      # 秘密鍵</span><br><span class="line">&#x2F;Users&#x2F;kenzo_tanaka&#x2F;.ssh&#x2F;terraform-test.pub　# 公開鍵</span><br></pre></td></tr></table></figure>

<p>公開鍵を起動したEC2インスタンスに登録し<br>秘密鍵でアクセスします。</p>
<p>以下のように利用する予定です。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -i ~&#x2F;.ssh&#x2F;terraform-test &lt;ec2 user&gt;@&lt;ec2 public ip&gt;</span><br></pre></td></tr></table></figure>

<h2><span id="terraform-設定ファイル">Terraform 設定ファイル</span></h2><ul>
<li><p>Point !</p>
<ul>
<li><code>resource &quot;aws_key_pair&quot;</code> で使用する公開鍵設定をしています。</li>
<li><code>resource &quot;aws_security_group&quot;</code> でSSH（ポート22）を開いてます。</li>
<li><code>resource &quot;aws_instance&quot;</code> で使用しているセキュリティグループの指定は  <code>vpc_security_group_ids</code> を利用<ul>
<li>セキュリティグループの条件追加・削除する場合にインスタンスを一度削除し作り直すことをしたくない場合に vpc_security_group_ids を利用すると良いです。</li>
</ul>
</li>
</ul>
</li>
<li><p>main.tf</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key &#x3D; &quot;$&#123;var.access_key&#125;&quot;</span><br><span class="line">  secret_key &#x3D; &quot;$&#123;var.secret_key&#125;&quot;</span><br><span class="line">  region     &#x3D; &quot;$&#123;var.region&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;example&quot; &#123;</span><br><span class="line">  ami           &#x3D; &quot;$&#123;lookup(var.amis, var.region)&#125;&quot;</span><br><span class="line">  instance_type &#x3D; &quot;t2.nano&quot;</span><br><span class="line">  key_name      &#x3D; &quot;$&#123;aws_key_pair.auth.id&#125;&quot;</span><br><span class="line">  vpc_security_group_ids &#x3D; [&quot;$&#123;aws_security_group.default.id&#125;&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_key_pair&quot; &quot;auth&quot; &#123;</span><br><span class="line">  key_name   &#x3D; &quot;$&#123;var.key_name&#125;&quot;</span><br><span class="line">  public_key &#x3D; &quot;$&#123;file(var.public_key_path)&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_security_group&quot; &quot;default&quot; &#123;</span><br><span class="line">  name        &#x3D; &quot;terraform_security_group&quot;</span><br><span class="line">  description &#x3D; &quot;Used in the terraform&quot;</span><br><span class="line"></span><br><span class="line">  # SSH access from anywhere</span><br><span class="line">  ingress &#123;</span><br><span class="line">    from_port   &#x3D; 22</span><br><span class="line">    to_port     &#x3D; 22</span><br><span class="line">    protocol    &#x3D; &quot;tcp&quot;</span><br><span class="line">    cidr_blocks &#x3D; [&quot;0.0.0.0&#x2F;0&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>variables.tf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;access_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;secret_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;region&quot; &#123;</span><br><span class="line">  default &#x3D; &quot;ap-northeast-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;amis&quot; &#123;</span><br><span class="line">  type &#x3D; &quot;map&quot;</span><br><span class="line">  default &#x3D; &#123;</span><br><span class="line">    us-east-1 &#x3D; &quot;ami-13be557e&quot;</span><br><span class="line">    us-west-2 &#x3D; &quot;ami-21f78e11&quot;</span><br><span class="line">    ap-northeast-1 &#x3D; &quot;ami-1bfdb67c&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;key_name&quot; &#123;</span><br><span class="line">  description &#x3D; &quot;Desired name of AWS key pair&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;public_key_path&quot; &#123;</span><br><span class="line">  description &#x3D; &lt;&lt;DESCRIPTION</span><br><span class="line">Path to the SSH public key to be used for authentication.</span><br><span class="line">Ensure this keypair is added to your local SSH agent so provisioners can</span><br><span class="line">connect.</span><br><span class="line"></span><br><span class="line">Example: ~&#x2F;.ssh&#x2F;terraform.pub</span><br><span class="line">DESCRIPTION</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>terraform.tfvars</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">access_key &#x3D; &quot;A******************Q&quot;</span><br><span class="line">secret_key &#x3D; &quot;q**************************************Z&quot;</span><br><span class="line"></span><br><span class="line">key_name &#x3D; &quot;terraform-test&quot;</span><br><span class="line">public_key_path &#x3D; &quot;~&#x2F;.ssh&#x2F;terraform-test.pub&quot;</span><br></pre></td></tr></table></figure>

<h2><span id="いざ実行">いざ実行</span></h2><ul>
<li>実行計画確認</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br></pre></td></tr></table></figure>

<ul>
<li>実行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply</span><br></pre></td></tr></table></figure>

<h2><span id="確認">確認</span></h2><ul>
<li><p>AWS コンソール上で起動確認</p>
<ul>
<li>キーペアに terraform-test が指定されています。</li>
<li>vpc, subnet も自動的にアタッチされてます。</li>
</ul>
</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327214009.png" width="100%">
</div>

<ul>
<li>キーペア<br>一応キーペアを見てみると登録されているのがわかります。</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327214404.png" width="100%">
</div>

<ul>
<li>セキュリティグループ確認</li>
</ul>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327214628.png" width="100%">
</div>


<ul>
<li>SSH ログイン確認</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -i ~&#x2F;.ssh&#x2F;terraform-test ubuntu@ec2-54-65-244-25.ap-northeast-1.compute.amazonaws.com</span><br></pre></td></tr></table></figure>

<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20170327/20170327214837.png" width="100%">
</div>


<p>無事SSHログインできました！</p>
<h2><span id="所感">所感</span></h2><p><a href="https://www.terraform.io/">terraform</a> を見ながら各パラメータの利用意図を確認しながら<br>設定してみましたが<br>パラメータの説明自体はざっくりで利用方法まではわからないです。</p>
<p><a href="https://www.terraform.io/intro/getting-started/build.html">Teffaform のチュートリアル</a>に始まり<br>その他 <a href="http://stackoverflow.com/questions/tagged/terraform">Stack Overflow</a> で<br>適宜パターンを蓄積していく学習が程よいと思います。</p>
<h2><span id="参考">参考</span></h2><a href="http://cross-black777.hatenablog.com/entry/2016/02/25/090000" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://blog.st-hatena.com/images/theme/og-image-1500.png"></div><div class="descriptions"><div class="og-title">Terraformで立てたEC2に後からSGを追加しようとするとEC2が再作成される - tjinjin&#39;s blog</div><div class="og-description">About 初回に立てた時はSGが1つだったが、あとからSGを追加したくなったときどうなるか試した結果です。</div></div></div></a>
</div></article></div><nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/11/">前</a></div><div class="pagination-next"><a href="/page/13/">次</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/11/">11</a></li><li><a class="pagination-link is-current" href="/page/12/">12</a></li><li><a class="pagination-link" href="/page/13/">13</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/30/">30</a></li></ul></nav></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="kenzo0107"></figure><p class="title is-size-4 is-block line-height-inherit">kenzo0107</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">投稿</p><a href="/archives"><p class="title">297</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">カテゴリ</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">タグ</p><a href="/tags"><p class="title">88</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/kenzo0107" target="_blank" rel="noopener">フォローする</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/kenzo0107"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/kenzo0107"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">カテゴリ</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/AWS/"><span class="level-start"><span class="level-item">AWS</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DIY/"><span class="level-start"><span class="level-item">DIY</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Go/"><span class="level-start"><span class="level-item">Go</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/RaspberryPI/"><span class="level-start"><span class="level-item">RaspberryPI</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Terraform/"><span class="level-start"><span class="level-item">Terraform</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最近の記事</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2022-01-14T15:00:00.000Z">2022-01-15</time></p><p class="title is-6"><a class="link-muted" href="/2022/01/14/2022-01-15-aws-elasticache-redis-cpu-utilization-unnormally-up/">2022-01-15 昼頃に発生した AWS ElastiCache CPU 使用率の異常上昇について</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/AWS/">AWS</a></p></div></article><article class="media"><a class="media-left" href="/2022/01/05/2022-01-06-raspberrypi-co2-monitoring/"><p class="image is-64x64"><img class="thumbnail" src="https://i.imgur.com/C3bQR5g.jpeg" alt="Raspberry PI zero で CO2 濃度測定 &amp; アラートを LINE 通知"></p></a><div class="media-content size-small"><p><time dateTime="2022-01-05T15:00:00.000Z">2022-01-06</time></p><p class="title is-6"><a class="link-muted" href="/2022/01/05/2022-01-06-raspberrypi-co2-monitoring/">Raspberry PI zero で CO2 濃度測定 &amp; アラートを LINE 通知</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/RaspberryPI/">RaspberryPI</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2022-01-03T15:00:00.000Z">2022-01-04</time></p><p class="title is-6"><a class="link-muted" href="/2022/01/03/2022-01-04-rettach-to-user-namespace-unsupported-new-os/">warning: reattach-to-user-namespace: unsupported new OS, trying as if it were 10.10</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2021-12-29T15:00:00.000Z">2021-12-30</time></p><p class="title is-6"><a class="link-muted" href="/2021/12/29/2021-12-30-web-delivery/">no-cache, no-store の違い</a></p><p class="is-uppercase"></p></div></article><article class="media"><a class="media-left" href="/2021/11/10/2021-11-11-diy-for-beginner/"><p class="image is-64x64"><img class="thumbnail" src="https://i.imgur.com/bikkvFS.jpg" alt="DIY 初心者の工具選び"></p></a><div class="media-content size-small"><p><time dateTime="2021-11-10T15:00:00.000Z">2021-11-11</time></p><p class="title is-6"><a class="link-muted" href="/2021/11/10/2021-11-11-diy-for-beginner/">DIY 初心者の工具選び</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/DIY/">DIY</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">タグ</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/htaccess/"><span class="tag">.htaccess</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ALB/"><span class="tag">ALB</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AWS/"><span class="tag">AWS</span><span class="tag is-grey-lightest">43</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AntiVirus/"><span class="tag">AntiVirus</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Apache/"><span class="tag">Apache</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chef/"><span class="tag">Chef</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CodeBuild/"><span class="tag">CodeBuild</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cookie/"><span class="tag">Cookie</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Corosync/"><span class="tag">Corosync</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Datadog/"><span class="tag">Datadog</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECR/"><span class="tag">ECR</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ECS/"><span class="tag">ECS</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElastiCache/"><span class="tag">ElastiCache</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Elasticsearch/"><span class="tag">Elasticsearch</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Email/"><span class="tag">Email</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FTPS/"><span class="tag">FTPS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fluentd/"><span class="tag">Fluentd</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GKE/"><span class="tag">GKE</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GitHub-Actions/"><span class="tag">GitHub Actions</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Go/"><span class="tag">Go</span><span class="tag is-grey-lightest">24</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GooglePlay/"><span class="tag">GooglePlay</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hubot/"><span class="tag">Hubot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jenkins/"><span class="tag">Jenkins</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kibana/"><span class="tag">Kibana</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LINE-Notify/"><span class="tag">LINE Notify</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Lambda/"><span class="tag">Lambda</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Let-s-encrypt/"><span class="tag">Let&#039;s encrypt</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MachineLearning/"><span class="tag">MachineLearning</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Monitoring/"><span class="tag">Monitoring</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag is-grey-lightest">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag is-grey-lightest">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenSSL/"><span class="tag">OpenSSL</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Outlook/"><span class="tag">Outlook</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PHP/"><span class="tag">PHP</span><span class="tag is-grey-lightest">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pacemaker/"><span class="tag">Pacemaker</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Prometheus/"><span class="tag">Prometheus</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ProxySQL/"><span class="tag">ProxySQL</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Puppeteer/"><span class="tag">Puppeteer</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rails/"><span class="tag">Rails</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RaspberryPI/"><span class="tag">RaspberryPI</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reactio/"><span class="tag">Reactio</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ruby/"><span class="tag">Ruby</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/S3/"><span class="tag">S3</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSL/"><span class="tag">SSL</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Security/"><span class="tag">Security</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SendGrid/"><span class="tag">SendGrid</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Slack/"><span class="tag">Slack</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SonarQube/"><span class="tag">SonarQube</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/StatsBot/"><span class="tag">StatsBot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Terraform/"><span class="tag">Terraform</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Twilio/"><span class="tag">Twilio</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Unity/"><span class="tag">Unity</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vagrant/"><span class="tag">Vagrant</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vault/"><span class="tag">Vault</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WAF/"><span class="tag">WAF</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zabbix/"><span class="tag">Zabbix</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/awk/"><span class="tag">awk</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/casperjs/"><span class="tag">casperjs</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpu/"><span class="tag">cpu</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/csv/"><span class="tag">csv</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flask/"><span class="tag">flask</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/i-node/"><span class="tag">i-node</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iftop/"><span class="tag">iftop</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ipinfo/"><span class="tag">ipinfo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iptable/"><span class="tag">iptable</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kibana/"><span class="tag">kibana</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macos/"><span class="tag">macos</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/no-ip/"><span class="tag">no-ip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ping/"><span class="tag">ping</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pip/"><span class="tag">pip</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/reCAPTCHA/"><span class="tag">reCAPTCHA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sftp/"><span class="tag">sftp</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spam/"><span class="tag">spam</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vim/"><span class="tag">vim</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wget/"><span class="tag">wget</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/yum/"><span class="tag">yum</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zsh/"><span class="tag">zsh</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6265337967545472" data-ad-slot="9975280607" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="長生村本郷Engineers&#039;Blog" height="28"></a><p class="size-small"><span>&copy; 2022 Kenzo Tanaka</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("ja");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://kenzo0107.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: ''
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Zurück nach oben" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"投稿","pages":"Pages","categories":"カテゴリ","tags":"タグ"});
        });</script></body></html>