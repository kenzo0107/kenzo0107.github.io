<div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/11/29/2016-11-30-zsh-not-use-vcs_info/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161130/20161130152308.png" alt="zsh vcs_info が使えない問題解決"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-11-29T15:00:00.000Z" title="2016-11-29T15:00:00.000Z">2016-11-30</time><span class="level-item">2分 read (About 287 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/11/29/2016-11-30-zsh-not-use-vcs_info/">zsh vcs_info が使えない問題解決</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>CentOS5系で yum でインストールした zsh で以下エラー発生</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precmd: vcs_info: function definition file not found</span><br></pre></td></tr></table></figure>

<p>Version 4.3.6 以上でないと vcs_info は利用できないそう</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vcs_info is available since zsh-beta, version 4.3.6-dev-0+20080929-1 or later</span><br></pre></td></tr></table></figure>

<ul>
<li>バージョン確認</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ &#x2F;bin&#x2F;zsh --version</span><br><span class="line"></span><br><span class="line">zsh 4.2.6 (x86_64-redhat-linux-gnu)</span><br></pre></td></tr></table></figure>

<p>なので zsh バージョンアップデートする必要があります。</p>
<h2><span id="zsh-52-ダウンロード-ビルド">zsh 5.2 ダウンロード ビルド</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd &#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line">$ wget https:&#x2F;&#x2F;sourceforge.net&#x2F;projects&#x2F;zsh&#x2F;files&#x2F;zsh&#x2F;5.2&#x2F;zsh-5.2.tar.gz&#x2F;download</span><br><span class="line">$ tar xvjf zsh-5.2.tar.gz</span><br><span class="line">$ cd zsh-5.2</span><br><span class="line">$ .&#x2F;configure &amp;&amp; make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>

<h2><span id="インストールされた-zsh-バージョン確認">インストールされた zsh バージョン確認</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ &#x2F;usr&#x2F;local&#x2F;bin&#x2F;zsh --version</span><br><span class="line"></span><br><span class="line">zsh 5.2 (x86_64-unknown-linux-gnu)</span><br></pre></td></tr></table></figure>

<h2><span id="新たにダウンロードした-zsh-にシェル変更">新たにダウンロードした zsh にシェル変更</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;zsh&quot; | sudo tee -a &#x2F;etc&#x2F;shells</span><br><span class="line">$ chsh -s &#x2F;usr&#x2F;local&#x2F;bin&#x2F;zsh</span><br></pre></td></tr></table></figure>

<p>それでも、まだ出てくるこのエラー。。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precmd: vcs_info: function definition file not found</span><br></pre></td></tr></table></figure>

<h2><span id="zcompdump-を削除し-zsh-を実行し直す">.zcompdump を削除し zsh を実行し直す</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rm ~&#x2F;.zcompdump</span><br><span class="line">$ exec zsh</span><br></pre></td></tr></table></figure>

<p>.zscompdump はコマンドやその補間関数の定義一覧が記載されているファイルです。</p>
<p>無事エラーが消えました。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-11-20T15:00:00.000Z" title="2016-11-20T15:00:00.000Z">2016-11-21</time><span class="level-item"><a class="link-muted" href="/categories/Go/">Go</a></span><span class="level-item">1分 read (About 121 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/11/20/2016-11-21-monitoring-performance-of-go/">Golang 簡易パフォーマンス測定</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>簡易的なパフォーマンス測定覚書です。<br>よく使うので備忘録的に保存。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// CPU数</span></span><br><span class="line">	cpus := runtime.NumCPU()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 開始時メモリ</span></span><br><span class="line">	<span class="keyword">var</span> startMemory runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;startMemory)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 開始時間</span></span><br><span class="line">	start := time.Now()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// do something</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 経過時間</span></span><br><span class="line">	elapsed := time.Since(start)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 終了時メモリ</span></span><br><span class="line">	<span class="keyword">var</span> endMemory runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;endMemory)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"実行時間: %f 秒 \n"</span>, elapsed.Seconds())</span><br><span class="line">	fmt.Printf(<span class="string">"CPU: %d \n"</span>, cpus)</span><br><span class="line">	fmt.Printf(<span class="string">"Memory All: %f MB \n"</span>, <span class="keyword">float64</span>(endMemory.Alloc-startMemory.Alloc)/<span class="keyword">float64</span>(<span class="number">1024</span>*<span class="number">1024</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/11/13/2016-11-14-autoupdate-letsencrypt/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161114/20161114141731.png" alt="Let&#039;s encrypt SSL 証明書自動更新"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-11-13T15:00:00.000Z" title="2016-11-13T15:00:00.000Z">2016-11-14</time><span class="level-item">4分 read (About 575 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/11/13/2016-11-14-autoupdate-letsencrypt/">Let&#039;s encrypt SSL 証明書自動更新</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Let’s encrypt SSL は開発環境で本番環境と同等に<br>https 通信プロトコルを利用したい為に利用しています。</p>
<p>バーチャルホストで複数ドメインを利用している場合等でも<br>マルチドメイン SSL 証明書が取得でき便利です。</p>
<p>オレオレSSL証明書ではブラウザによっては<br>「このページは保護されていません」<br>と表示されるケースがあり<br>非エンジニアの方によっては不信感が募ることもあります。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161114/20161114141627.png" width="100%">
</div>

<h2><span id="β版">β版</span></h2><p>β版時代の Let’s Encrypt SSL証明書管理スクリプトです。<br>今回作成したSSL自動更新スクリプトはこちらではありません。</p>
<a href="https://github.com/digint/letsencrypt.sh" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://avatars1.githubusercontent.com/u/7590973?s=400&v=4"></div><div class="descriptions"><div class="og-title">digint/letsencrypt.sh</div><div class="og-description">letsencrypt/acme client implemented as a shell-script - digint/letsencrypt.sh</div></div></div></a>

<h3><span id="ssl自動更新スクリプト">SSL自動更新スクリプト</span></h3><p>今回作成した Let’s Encrypt 自動更新(Apache)スクリプトです。<br>更新判定しSlack通知します。</p>
<p>有効期限が 30 日を切った場合に SSL証明書を更新し httpd を再起動します。</p>
<script src="//gist.github.com/kenzo0107/94f073a4f94769b5bed18ed9c655bf02.js"></script>

<h3><span id="cron設定">cron設定</span></h3><ul>
<li>毎月第一土曜日 AM6:00 設定</li>
</ul>
<p>開発環境なら土曜日に実行気づいて最低でも日曜日には治せる為。<br>現運用ではこれは功を奏してます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00 6 1-7 * * 6 root &#x2F;root&#x2F;letsencrypt.sh&#x2F;refresh_cert.sh</span><br></pre></td></tr></table></figure>

<h3><span id="slack通知">Slack通知</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161114/20161114141352.png" width="100%">
</div>


<h2><span id="強制更新したい場合">強制更新したい場合</span></h2><p>2016年5月07日より <code>certbot-auto</code> に名称変更され<br>certbot-auto による自動更新を以下スクリプトになります。</p>
<p>本番環境以外でクライアント様への確認用等でなければ<br>こちらを利用しても良いかと思います。</p>
<p><code>--force-renewal</code> をオプション指定することで強制的に更新します。</p>
<script src="//gist.github.com/kenzo0107/913795f417c2ef666b6114e6c3f82ddc.js"></script>

<h2><span id="そもそも通知いらないという場合">そもそも通知いらないという場合</span></h2><p>こちらも <code>certbot-auto</code></p>
<ul>
<li>cron で直接コマンド設定</li>
<li>毎月第一土曜日実行</li>
<li>一応ログには残しておく</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00 6 1-7 * * 6 root &#x2F;root&#x2F;certbot&#x2F;certbot-auto renew --force-renewal &amp;&amp; service httpd graceful &gt; &#x2F;root&#x2F;certbot&#x2F;renewal.log</span><br></pre></td></tr></table></figure>

<p>以上です。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-10-19T15:00:00.000Z" title="2016-10-19T15:00:00.000Z">2016-10-20</time><span class="level-item">2分 read (About 319 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/10/19/2016-10-20-totalization-mysql/">MySQL COUNT, SUM, GROUP BY, CASE WHEN THEN で集計する</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>ECサイトに新しい決済機能の利用率出したいな<br>と思ったときのクエリです。</p>
<p>ちょうどいくつかの集計関数がまとまった1クエリとなったので<br>まとめました。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     <span class="keyword">DATE_FORMAT</span>(create_date, <span class="string">'%Y-%m-%d'</span>) <span class="keyword">AS</span> 日付</span><br><span class="line">    ,<span class="keyword">COUNT</span>(order_id)                      <span class="keyword">AS</span> 全件数</span><br><span class="line">    ,<span class="keyword">FORMAT</span>(<span class="keyword">SUM</span>(payment_total),<span class="number">0</span>)         <span class="keyword">AS</span> <span class="string">"全支払い合計(円)"</span></span><br><span class="line">    ,<span class="keyword">COUNT</span>(payment_id = <span class="number">12</span> <span class="keyword">or</span> <span class="literal">NULL</span>)       <span class="keyword">AS</span> <span class="string">"新決済機能の購入件数"</span></span><br><span class="line">    ,<span class="keyword">COUNT</span>(customer_id = <span class="number">0</span> <span class="keyword">or</span> <span class="literal">NULL</span>)       <span class="keyword">AS</span> <span class="string">"ゲスト購入数"</span></span><br><span class="line">    ,<span class="keyword">FORMAT</span>(<span class="keyword">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> payment_id = <span class="number">12</span> <span class="keyword">THEN</span> payment_total <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">END</span>),<span class="number">0</span>) <span class="keyword">AS</span> <span class="string">"新決済機能の購入支払い合計(円)"</span></span><br><span class="line">    ,<span class="keyword">count</span>(payment_id = <span class="number">12</span> <span class="keyword">or</span> <span class="literal">NULL</span>)/<span class="keyword">count</span>(order_id) * <span class="number">100</span> <span class="keyword">AS</span> <span class="string">"新決済機能の購入比率(%)"</span></span><br><span class="line">    ,<span class="keyword">SUM</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> payment_id = <span class="number">12</span> <span class="keyword">THEN</span> payment_total <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">END</span>)/<span class="keyword">SUM</span>(payment_total) * <span class="number">100</span> <span class="keyword">AS</span> <span class="string">"新決済機能の購入支払い合計比率(%)"</span></span><br><span class="line">    ,<span class="keyword">COUNT</span>(customer_id = <span class="number">0</span> <span class="keyword">or</span> <span class="literal">NULL</span>)/<span class="keyword">COUNT</span>(order_id) * <span class="number">100</span> <span class="keyword">AS</span> <span class="string">"ゲスト購入比率"</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">     dtb_order</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">1</span>=<span class="number">1</span></span><br><span class="line">     <span class="keyword">AND</span> site_id = <span class="number">1</span></span><br><span class="line">     <span class="keyword">AND</span> create_date &gt; <span class="string">'2016-09-21 10:00:00'</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">     <span class="keyword">DATE_FORMAT</span>(create_date, <span class="string">'%Y%m%d'</span>)</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure>

<ul>
<li>パッケージ = EC-CUBE 2.11.5</li>
<li>新決済ID = 12</li>
</ul>
<h2><span id="結果">結果</span></h2><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161020/20161020182836.png" width="100%">
</div>

<p>CASE文をさらっと書けるようになると少し大人になった気分になります。<br>心残りは比率部分の重複部分がまとまったらかっこいいかなと。</p>
<p>精進します。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/10/10/2016-10-11-line-notify/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161011/20161011142249.png" alt="LINE Notify で Zabbix Alert 通知"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-10-10T15:00:00.000Z" title="2016-10-10T15:00:00.000Z">2016-10-11</time><span class="level-item">3分 read (About 388 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/10/10/2016-10-11-line-notify/">LINE Notify で Zabbix Alert 通知</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Zabbix アラート を LINE Notify を利用して<br>LINEにメッセージを送るように設定しました。</p>
<h2><span id="手順">手順</span></h2><h3><span id="line-notify-アクセス">LINE Notify アクセス</span></h3><p>[<a href="https://notify-bot.line.me/ja/]">https://notify-bot.line.me/ja/]</a></p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161011/20161011140750.png" width="100%">
</div>


<h3><span id="登録してログイン">登録してログイン</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161011/20161011140920.png" width="100%">
</div>

<h3><span id="サービス登録">サービス登録</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161011/20161011141015.png" width="100%">
</div>

<p>この情報が審査されるということは特になかったですが<br>ある程度精度の高い情報を入力して登録しときました</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161011/20161011141027.png" width="100%">
</div>


<h3><span id="トークルーム選択しトークン発行">トークルーム選択しトークン発行</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161011/20161011141314.png" width="100%">
</div>

<h3><span id="発行したトークンコピー">発行したトークンコピー</span></h3><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161011/20161011141349.png" width="100%">
</div>


<h3><span id="zabbix-スクリプト設定">Zabbix スクリプト設定</span></h3><a href="https://github.com/kenzo0107/Zabbix3-LineNotify" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://avatars0.githubusercontent.com/u/6197906?s=400&v=4"></div><div class="descriptions"><div class="og-title">kenzo0107/Zabbix3-LineNotify</div><div class="og-description">Zabbix3 + LineNotify. Contribute to kenzo0107/Zabbix3-LineNotify development by creating an account on GitHub.</div></div></div></a>

<h2><span id="env">Env</span></h2><ul>
<li>Zabbix 3.0</li>
<li>CentOS Linux release 7.2.1511 (Core)</li>
</ul>
<h2><span id="install-steps">Install Steps</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Zabbix-Server]$ cd &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;alertscripts    # AlertScriptsPath</span><br><span class="line">[Zabbix-Server]$ git clone https:&#x2F;&#x2F;github.com&#x2F;kenzo0107&#x2F;zabbix3-linenotify</span><br><span class="line">[Zabbix-Server]$ mv zabbix3-slack&#x2F;line_notify.sh .</span><br><span class="line">[Zabbix-Server]$ rm -r zabbix3-linenotify</span><br><span class="line">[Zabbix-Server]$ chmod 755 line_notify.sh</span><br></pre></td></tr></table></figure>

<h3><span id="media-types-設定">Media Types 設定</span></h3><div style="text-align:center;">
<img src="http://i.imgur.com/mE5dEXI.png" width="100%">
</div>

<h3><span id="users-gt-media-設定">Users &gt; Media 設定</span></h3><div style="text-align:center;">
<img src="http://i.imgur.com/ovDFnTq.png" width="100%">
</div>


<h3><span id="通知テスト">通知テスト</span></h3><p>テスト環境などで<br>Nginx の process が1つ以上になったらアラート出すように設定してみた結果</p>
<div style="text-align:center;">
<img src="http://i.imgur.com/6B554NX.png" width="100%">
</div>


<h2><span id="所感">所感</span></h2><p>トークルームに参加するにも<br>LINE アカウントはプライベートアカウントなので<br>ちょっと知られたくないわ〜という時は<br>何とも言えない気持ちになる方もいることがわかりました。</p>
<p>ご利用は計画的に。</p>
<h2><span id="今後の期待">今後の期待</span></h2><p>個人的に<br>Twilio みたいに LINE Notify で電話通知出来たら嬉しいです。</p>
<p>まずは障害がない世界を♪</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20161011/20161011213827.jpg" width="100%">
</div>

<p>以上です。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-09-27T15:00:00.000Z" title="2016-09-27T15:00:00.000Z">2016-09-28</time><span class="level-item">2分 read (About 235 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/09/27/2016-09-28-error-rpc-failed-curl-56-sslread-return-on-macos/">error RPC failed; curl 56 SSLRead() return on MacOS Sierra</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>みんなのGo言語を購入しまして<br>ghq でGit管理してみよう！<br>と心動いた方は多いはず</p>
<p>昔から peco で Git Repository 移動コマンドはしてたけど、<br>ghq を利用したリポジトリ管理は便利ですね。</p>
<p>そんな折、<br>ghq コマンドで git repository をクローンしようとした際に<br>掲題のエラーが発生しましたので備忘録。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ghq get &lt;git repository&gt;</span><br><span class="line">...</span><br><span class="line">error: RPC failed; curl 56 SSLRead() <span class="built_in">return</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>利用している git  が SSL 対応していないようです。</p>
<h2><span id="対応">対応</span></h2><ul>
<li>git を openssl, curl 付きで再インストール</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew reinstall git --with-brewed-curl --with-brewed-openssl</span><br></pre></td></tr></table></figure>

<h2><span id="再度実行">再度実行</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ghq get &lt;git repository&gt;</span><br><span class="line">remote: Total 74442 (delta 145), reused 0 (delta 0), pack-reused 74160</span><br><span class="line">Receiving objects: 100% (74442/74442), 701.45 MiB | 1.42 MiB/s, <span class="keyword">done</span>.</span><br><span class="line">Resolving deltas: 100% (50571/50571), <span class="keyword">done</span>.</span><br><span class="line">Checking out files: 100% (11350/11350), <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>

<p>無事できた♪</p>
<h2><span id="参照">参照</span></h2><p><a href="https://forums.meteor.com/t/curl-56-sslread-return-error-9806-need-help-please/21913">Curl: (56) SSLRead() return error -9806 - Need Help please slight_smile</a></p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/09/20/2016-09-21-heavy-load-the-reason/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160921/20160921223252.png" alt="負荷監視とその原因調査"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-09-20T15:00:00.000Z" title="2016-09-20T15:00:00.000Z">2016-09-21</time><span class="level-item">2分 read (About 369 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/09/20/2016-09-21-heavy-load-the-reason/">負荷監視とその原因調査</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>新卒向けの説明として簡単な備忘録です。</p>
<table>
<thead>
<tr>
<th>-<em>Item</em>-</th>
<th>-<em>Explain</em>-</th>
</tr>
</thead>
<tbody><tr>
<td>%user</td>
<td>ユーザー空間での CPU 使用率</td>
</tr>
<tr>
<td>%system</td>
<td>カーネル空間での CPU 使用率</td>
</tr>
<tr>
<td>%iowait</td>
<td>I/O 待ち時間の割合</td>
</tr>
<tr>
<td>%idle</td>
<td>I/O 待ち以外で CPU が何もしていない時間の割合</td>
</tr>
</tbody></table>
<h2><span id="ある日の-zabbix-grafana-のcpu関連のグラフから原因を調査する">ある日の Zabbix + Grafana のCPU関連のグラフから原因を調査する。</span></h2><div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160921/20160921223252.png" width="100%">
</div>

<h2><span id="1-iowait-が飛び抜けて高い">① %iowait が飛び抜けて高い</span></h2><ul>
<li>%iowait 高</li>
<li>%user 低</li>
<li>%system 低</li>
</ul>
<h3><span id="原因">原因</span></h3><p>スワップが大量に発生している可能性がある。</p>
<h3><span id="調査手順">調査手順</span></h3><h4><span id="1-swapin-amp-swapout-確認">1. SwapIn &amp; SwapOut 確認</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sar -W</span><br></pre></td></tr></table></figure>

<h4><span id="2-システム全体のメモリ使用状況">2. システム全体のメモリ使用状況</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ free</span><br></pre></td></tr></table></figure>

<h4><span id="3-メモリ使用率順でソート後メモリを消費しているプロセスを特定する">3. メモリ使用率順でソート後メモリを消費しているプロセスを特定する</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ top</span><br></pre></td></tr></table></figure>

<ul>
<li>Shift+p: CPU使用率順にソート</li>
<li>Shift+m: メモリ使用率順にソート</li>
</ul>
<h5><span id="実際の原因">実際の原因</span></h5><p>定期的に同時刻に発生した為<br><code>crontab -l</code> でクーロン設定確認したら<br>誰も知らないバッチが動いていた汗</p>
<h2><span id="2-userが飛び抜けて高い">② %userが飛び抜けて高い</span></h2><ul>
<li>%iowait 低</li>
<li>%user 高</li>
<li>%system 低</li>
</ul>
<h3><span id="原因">原因</span></h3><p>CPU使用率が高い。</p>
<h3><span id="調査手順">調査手順</span></h3><h4><span id="1-cpu使用率の高い順にソートしてプロセス特定">1. CPU使用率の高い順にソートしてプロセス特定</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ top</span><br></pre></td></tr></table></figure>

<ul>
<li>Shift+p: CPU使用率順にソート</li>
</ul>
<p>ほんの一部分ですが参考になれば何よりです。<br>以上です。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-09-19T15:00:00.000Z" title="2016-09-19T15:00:00.000Z">2016-09-20</time><span class="level-item">4分 read (About 546 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/09/19/2016-09-20-machine-learning/">機械学習ド素人のWebエンジニアが始める機械学習で顔認識</a></h1><div class="content"><h2><span id="前回">前回</span></h2><p>顔検知と顔認識は本質が異なる。</p>
<ul>
<li><b>顔検知</b>は顔と判定すること</li>
<li><b>顔認識</b>は顔が誰か特定の人の顔だと判定すること</li>
</ul>
<p>今回は後者の顔認識をする仕組みをまとめました。</p>
<a href="https://github.com/kenzo0107/FacialRecognitionSystem" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="https://avatars0.githubusercontent.com/u/6197906?s=400&v=4"></div><div class="descriptions"><div class="og-title">kenzo0107/FacialRecognitionSystem</div><div class="og-description">DeepLearning and Facial Recognition System by TensorFlow - kenzo0107/FacialRecognitionSystem</div></div></div></a>


<h2><span id="やろうとしてること">やろうとしてること</span></h2><p>以下5つのSTEPを順を追って実施しています。</p>
<ol>
<li>検索エンジンから画像ダウンロード</li>
<li>ダウンロードした画像から顔検知し顔部分のみ抜き取る</li>
<li>顔部分を抜き取った画像を訓練用と試験用に分ける</li>
<li>機械学習によりモデル作成</li>
<li>試験用画像をモデルを利用し誰の顔であるか評価</li>
</ol>
<h2><span id="参考">参考</span></h2><p>機械学習では TensorFlow を利用してます。</p>
<p>① 以下 TensorFlow の Hello World 的な例題とコピペすればすぐ動作するコードが記載されてます。</p>
<ul>
<li><a href="https://www.tensorflow.org/versions/r0.10/tutorials/mnist/beginners/index.html#mnist-for-ml-beginners">https://www.tensorflow.org/versions/r0.10/tutorials/mnist/beginners/index.html#mnist-for-ml-beginners</a></li>
<li><a href="https://www.tensorflow.org/versions/r0.10/tutorials/mnist/pros/index.html#deep-mnist-for-experts">https://www.tensorflow.org/versions/r0.10/tutorials/mnist/pros/index.html#deep-mnist-for-experts</a></li>
<li><a href="https://www.tensorflow.org/versions/r0.10/tutorials/mnist/tf/index.html#tensorflow-mechanics-101">https://www.tensorflow.org/versions/r0.10/tutorials/mnist/tf/index.html#tensorflow-mechanics-101</a></li>
<li><a href="https://www.tensorflow.org/versions/r0.10/tutorials/tfserve/index.html#tensorflow-serving">https://www.tensorflow.org/versions/r0.10/tutorials/tfserve/index.html#tensorflow-serving</a></li>
</ul>
<p>② すぎゃーんさんの記事は非常に参考になりました。</p>
<a href="http://memo.sugyan.com/entry/20160112/1452558576" class="link-preview" target="_blank"><div class="link-area"><div class="og-image"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/s/sugyan/20160112/20160112012505.png"></div><div class="descriptions"><div class="og-title">TensorFlowによるディープラーニングで、アイドルの顔を識別する - すぎゃーんメモ</div><div class="og-description">以前は MNISTの例を使って画像識別を試してみた けど、次はカラー画像についての識別を試してみる。「アイドルなんてみんな同じ顔に見える」って 最近も言われてるのかどうか知らないけど、自分もつい5年前くらいまではそう思っていたわけで。その識別を機械学習でやってみよう という試み。…</div></div></div></a>

<p>やっていることもシンプルでわかりやすく、且つ、Webエンジニアの発想でサービス化してる所が興味持って望めました。</p>
<h2><span id="今後">今後</span></h2><p>元々やりたかったことは<br>Raspberry PI で顔認識して家族だと判定したら「おはよう」と挨拶させる、<br>なのでその顔認識部分の基礎を今回は学びました。</p>
<p>今後は実際にRaspberry PI とどう今回の仕組みを連結させるかを<br>やってみようと思います。</p>
<p>とはいえ家族の写真はそう簡単には集まらないので<br>SMAPで基礎作りをもうちょい頑張ってみよう！</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2016/09/08/2016-09-09-fix-problem-csv-encode/"><img class="thumbnail" src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160909/20160909105642.jpg" alt="CSVエンコード問題解決"></a></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-09-08T15:00:00.000Z" title="2016-09-08T15:00:00.000Z">2016-09-09</time><span class="level-item">7分 read (About 1073 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/09/08/2016-09-09-fix-problem-csv-encode/">CSVエンコード問題解決</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Linux サーバで DBで集計してCSVファイルをレポートする<br>なんてことがあるかと思います。</p>
<p>CSVファイルを Linux サーバで作成し<br>Windows, Mac にメール添付して送信すると<br>どちらもCSVファイルを開くと文字化けしてしまう問題に遭遇しました。</p>
<p>この問題を解決すべく調査しました。</p>
<h2><span id="そもそも何で文字化け">そもそも何で文字化け？</span></h2><p>CSVファイルはWindows, Macでは基本Excelが起動し開きますが<br><span style="color:red">デフォルト Shift_Jis として開こうとします。</span></p>
<p>テキストファイルに一旦開いてコピーしてエクセルに貼り付ける対策を紹介しているブログもありましたが<br>クライアント様がお相手となる場合やファイルサイズが非常に大きい場合は<br>一手間かける方法はNGです。</p>
<h2><span id="調査1-文字コードを変更してから-mutt-でメール添付送信">調査1 文字コードを変更してから mutt でメール添付送信</span></h2><ol>
<li>文字エンコードは nkf : Network Kanji Filter Version 2.0.7 (2006-06-13)</li>
<li>メール送信は mutt 1.4.2.2i</li>
<li>mutt の設定ファイルをいじりましたがうまくいかなかったです。</li>
</ol>
<h3><span id="shift_jis">Shift_JIS</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'大崎,yoshi,浜田,moto,松本'</span> &gt; sjis.csv</span><br><span class="line">$ nkf -g sjis.csv</span><br><span class="line">UTF-8</span><br><span class="line"></span><br><span class="line">$ nkf -s --overwrite sjis.csv</span><br><span class="line">$ nkf -g sjis.csv</span><br><span class="line">Shift_JIS</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"Shift_JIS だよ"</span> | mutt -n -s <span class="string">"Shift_JIS CSV 添付"</span> <span class="string">"kenzo.tanaka0107@gmail.com"</span> -a sjis.csv</span><br></pre></td></tr></table></figure>

<ul>
<li>メール受信し添付ファイルをダウンロードし文字コードチェック</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nkf -g sjis.csv</span><br><span class="line">UTF-8</span><br></pre></td></tr></table></figure>

<p>あれ？ Shift_JISにエンコードして送ったんだけど UTF-8 になってる</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160909/20160909102427.png" width="100%">
</div>

<h3><span id="jis-iso-2022-jp">JIS (ISO-2022-JP)</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'大崎,yoshi,浜田,moto,松本'</span> &gt; jis.csv</span><br><span class="line">$ nkf -j --overwrite jis.csv</span><br><span class="line">$ nkf -g jis.csv</span><br><span class="line">ISO-2022-JP</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"JIS だよ"</span> | mutt -n -s <span class="string">"JIS CSV 添付"</span> <span class="string">"kenzo.tanaka0107@gmail.com"</span> -a jis.csv</span><br></pre></td></tr></table></figure>

<ul>
<li>メール受信し添付ファイルをダウンロードし文字コードチェック</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nkf -g jis.csv</span><br><span class="line">ISO-2022-JP</span><br></pre></td></tr></table></figure>

<p>ISO-2022-JP で文字コードが変更されず送信されたけど…<br>やっぱり文字化け…</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160909/20160909102720.png" width="100%">
</div>

<h3><span id="utf-8">UTF-8</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'大崎,yoshi,浜田,moto,松本'</span> &gt; utf8.csv</span><br><span class="line">$ nkf -w --overwrite utf8.csv</span><br><span class="line">$ nkf -g utf8.csv</span><br><span class="line">UTF-8</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"UTF-8 だよ"</span> | mutt -n -s <span class="string">"UTF-8 CSV 添付"</span> <span class="string">"kenzo.tanaka0107@gmail.com"</span> -a utf8.csv</span><br></pre></td></tr></table></figure>

<ul>
<li>メール受信し添付ファイルをダウンロードし文字コードチェック</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nkf -g utf8.csv</span><br><span class="line">UTF-8</span><br></pre></td></tr></table></figure>

<p>当然文字化け…</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160909/20160909102942.png" width="100%">
</div>

<h3><span id="utf-8-bom付き">UTF-8 BOM付き</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'大崎,yoshi,浜田,moto,松本'</span> &gt; utf8-bom.csv</span><br><span class="line">$ nkf --overwrite -oc=UTF-8-BOM utf8-bom.csv</span><br><span class="line">$ nkf -g utf8-bom.csv</span><br><span class="line">ISO-2022-JP</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"UTF-8-BOM だよ"</span> | mutt -n -s <span class="string">"UTF-8-BOM CSV 添付"</span> <span class="string">"kenzo.tanaka0107@gmail.com"</span> -a utf8-bom.csv</span><br></pre></td></tr></table></figure>

<ul>
<li>メール受信し添付ファイルをダウンロードし文字コードチェック</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nkf -g utf8-bom.csv</span><br><span class="line">ISO-2022-JP</span><br></pre></td></tr></table></figure>

<p>JISと同様の結果…</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160909/20160909103228.png" width="100%">
</div>

<h3><span id="euc">EUC</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'大崎,yoshi,浜田,moto,松本'</span> &gt; euc.csv</span><br><span class="line">$ nkf -e --overwrite euc.csv</span><br><span class="line">$ nkf -g euc.csv</span><br><span class="line">EUC-JP</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"EUC だよ"</span> | mutt -n -s <span class="string">"EUC CSV 添付"</span> <span class="string">"kenzo.tanaka0107@gmail.com"</span> -a euc.csv</span><br></pre></td></tr></table></figure>

<ul>
<li>メール受信し添付ファイルをダウンロードし文字コードチェック</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nkf -g euc.csv</span><br><span class="line">EUC-JP</span><br></pre></td></tr></table></figure>

<p>ファイルエンコードではうまくいきませんでした。</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160909/20160909110133.png" width="100%">
</div>

<h2><span id="調査2-binaryファイルにしてみる">調査2 BINARYファイルにしてみる</span></h2><p>もっと具体的にいうと 圧縮ファイルを送ってみる</p>
<p>Shift_JIS で CSVが開かれるのでShift_JISにエンコードします。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#39;大崎,yoshi,浜田,moto,松本&#39; &gt; sjis.csv</span><br><span class="line">$ nkf -s --overwrite sjis.csv</span><br><span class="line">$ zip sjis.zip sjis.csv</span><br><span class="line">$ nkf -g sjis.zip</span><br><span class="line">BINARY</span><br><span class="line"></span><br><span class="line">$ echo &quot;ZIP だよ&quot; | mutt -n -s &quot;ZIP 添付&quot; &quot;kenzo.tanaka0107@gmail.com&quot; -a sjis.zip</span><br></pre></td></tr></table></figure>

<ul>
<li>メール受信し添付ファイルをダウンロードし文字コードチェック</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ nkf -g sjis.zip</span><br><span class="line">BINARY</span><br><span class="line"></span><br><span class="line">$ unzip sjis.zip</span><br><span class="line">$ nkf -g sjis.csv</span><br><span class="line">Shift_JIS</span><br></pre></td></tr></table></figure>

<p>Shift_JIS のままダウンロードできてる！<br>これは期待できそう！</p>
<p>うまくいった！</p>
<div style="text-align:center;">
<img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kenzo0107/20160909/20160909104652.png" width="100%">
</div>

<h2><span id="総評">総評</span></h2><ul>
<li>Windows, Mac で送られてきたCSVファイルで文字化けせず開くことができました。</li>
<li>圧縮した方が容量を下げて通信が行えるのでよくなりました。</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2016-09-08T15:00:00.000Z" title="2016-09-08T15:00:00.000Z">2016-09-09</time><span class="level-item">7分 read (About 1058 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/09/08/2016-09-09-valid-email-by-php/">PHP 検証フィルタで Email アドレス検証 を検証する</a></h1><div class="content"><h2><span id="概要">概要</span></h2><p>Email アドレスのフォーマットチェックとして PHP には検証フィルタが用意されています。</p>
<p>こんな使い方しますね。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (filter_var($email, FILTER_VALIDATE_EMAIL)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'(^-^) OK Email アドレスフォーマットとして妥当'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'(&gt;_&lt;) NG'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下 php.net ではこのように記述されている。</p>
<p><a href="http://php.net/manual/ja/filter.filters.validate.php">http://php.net/manual/ja/filter.filters.validate.php</a></p>
<blockquote>
<p>値が妥当な e-mail アドレスであるかどうかを検証します。<br>この検証は、e-mail アドレスが RFC 822 に沿った形式であるかどうかを確かめます。 ただし、コメントおよび空白の折り返し (whitespace folding) には対応していません。</p>
</blockquote>
<h2><span id="検証">検証</span></h2><script src="//gist.github.com/kenzo0107/49922bf85c73f5f85031ea4abf3aa7ce.js"></script>

<h3><span id="結果">結果</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[OK (^-^) EMAIL LIST]</span><br><span class="line">abc@gmail.com</span><br><span class="line">a!bc@gmail.com</span><br><span class="line">a#bc@gmail.com</span><br><span class="line">a$bc@gmail.com</span><br><span class="line">a%bc@gmail.com</span><br><span class="line">a&amp;bc@gmail.com</span><br><span class="line">a&#96;bc@gmail.com</span><br><span class="line">a&#x3D;bc@gmail.com</span><br><span class="line">a~bc@gmail.com</span><br><span class="line">a~bc@gmail.com</span><br><span class="line">a|bc@gmail.com</span><br><span class="line">a^bc@gmail.com</span><br><span class="line">a*bc@gmail.com</span><br><span class="line">a+bc@gmail.com</span><br><span class="line">a?bc@gmail.com</span><br><span class="line">a&#96;bc@gmail.com</span><br><span class="line">a&#123;bc@gmail.com</span><br><span class="line">a&#125;bc@gmail.com</span><br><span class="line">a&#125;bc@gmail.com</span><br><span class="line">!abc@gmail.com</span><br><span class="line">#abc@gmail.com</span><br><span class="line">$abc@gmail.com</span><br><span class="line">%abc@gmail.com</span><br><span class="line">&amp;abc@gmail.com</span><br><span class="line">&#x3D;abc@gmail.com</span><br><span class="line">~abc@gmail.com</span><br><span class="line">|abc@gmail.com</span><br><span class="line">^abc@gmail.com</span><br><span class="line">*abc@gmail.com</span><br><span class="line">+abc@gmail.com</span><br><span class="line">?abc@gmail.com</span><br><span class="line">&#96;abc@gmail.com</span><br><span class="line">&#123;abc@gmail.com</span><br><span class="line">&#125;abc@gmail.com</span><br><span class="line">a__bc@gmail.com</span><br><span class="line">abc_@gmail.com</span><br><span class="line">abc@vwx.yz</span><br><span class="line"></span><br><span class="line">[NG (&gt;_&lt;) EMAIL LIST]</span><br><span class="line">a&quot;bc@gmail.com</span><br><span class="line">a@bc@gmail.com</span><br><span class="line">a(bc@gmail.com</span><br><span class="line">a)bc@gmail.com</span><br><span class="line">a\bc@gmail.com</span><br><span class="line">a:bc@gmail.com</span><br><span class="line">a;bc@gmail.com</span><br><span class="line">a&lt;bc@gmail.com</span><br><span class="line">a&gt;bc@gmail.com</span><br><span class="line">a&gt;bc@gmail.com</span><br><span class="line">a,bc@gmail.com</span><br><span class="line">a[bc@gmail.com</span><br><span class="line">a]bc@gmail.com</span><br><span class="line">¥abc@gmail.com</span><br><span class="line">&quot;abc@gmail.com</span><br><span class="line">@abc@gmail.com</span><br><span class="line">(abc@gmail.com</span><br><span class="line">)abc@gmail.com</span><br><span class="line">\abc@gmail.com</span><br><span class="line">:abc@gmail.com</span><br><span class="line">;abc@gmail.com</span><br><span class="line">&lt;abc@gmail.com</span><br><span class="line">&gt;abc@gmail.com</span><br><span class="line">,abc@gmail.com</span><br><span class="line">[abc@gmail.com</span><br><span class="line">]abc@gmail.com</span><br><span class="line">a..bc@gmail.com</span><br><span class="line">abc.@gmail.com</span><br><span class="line">abc@@vwx.yz</span><br></pre></td></tr></table></figure>

<p>NGとしたいような Emailアドレス を通してしまいます。</p>
<p><code>&amp;abc@xyz.ab</code></p>
<h2><span id="これまでの評価">これまでの評価</span></h2><p>PHP 検証フィルタ FILTER_VALIDATE_EMAIL によるバリデーションは<br>社内システムで利用するアカウントでのEmailアドレス検証程度であれば利用可能か。</p>
<p>商用サービスとして検証フィルタのみでバリデーションするのは危険かなと思いました。</p>
<h2><span id="マイ-email-バリデーション">マイ Email バリデーション</span></h2><ul>
<li>検証フィルタ FILTER_VALIDATE_EMAIL はベーシックに利用</li>
<li>利用できる文字を 半角英数字 . _ - に制限</li>
<li>Qiita 記事を参照しDNS 検証チェック入れました。 (<a href="http://qiita.com/ShibuyaKosuke">ShibuyaKosuke</a> さんありがとうございます！)</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkEmailwithDNS</span><span class="params">($email, $check_dns = false)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> !filter_var($email, FILTER_VALIDATE_EMAIL):</span><br><span class="line">        <span class="keyword">case</span> !preg_match(<span class="string">"/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/"</span>, $email):</span><br><span class="line">        <span class="keyword">case</span> !preg_match(<span class="string">'/@([\w.-]++)\z/'</span>, $email, $m):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">case</span> !$check_dns:</span><br><span class="line">        <span class="keyword">case</span> checkdnsrr($m[<span class="number">1</span>], <span class="string">'MX'</span>):</span><br><span class="line">        <span class="keyword">case</span> checkdnsrr($m[<span class="number">1</span>], <span class="string">'A'</span>):</span><br><span class="line">        <span class="keyword">case</span> checkdnsrr($m[<span class="number">1</span>], <span class="string">'AAAA'</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (checkEmailDNS($email, <span class="keyword">true</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'(^-^) OK Email アドレスフォーマットとして妥当'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'(&gt;_&lt;) NG'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2><span id="マイ-email-バリデーション検証">マイ Email バリデーション検証</span></h2><script src="//gist.github.com/kenzo0107/a33a6e9a75ceb9cf1ccd7213c86db530.js"></script>

<h3><span id="結果">結果</span></h3><p>ほぼ弾いてくれます〜</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[OK (^-^) EMAIL LIST]</span><br><span class="line">abc@gmail.com</span><br><span class="line">a__bc@gmail.com</span><br><span class="line">abc_@gmail.com</span><br><span class="line"></span><br><span class="line">[NG (&gt;_&lt;) EMAIL LIST]</span><br><span class="line">a!bc@gmail.com</span><br><span class="line">a&quot;bc@gmail.com</span><br><span class="line">a@bc@gmail.com</span><br><span class="line">a#bc@gmail.com</span><br><span class="line">a$bc@gmail.com</span><br><span class="line">a%bc@gmail.com</span><br><span class="line">a&amp;bc@gmail.com</span><br><span class="line">a&#96;bc@gmail.com</span><br><span class="line">a(bc@gmail.com</span><br><span class="line">a)bc@gmail.com</span><br><span class="line">a&#x3D;bc@gmail.com</span><br><span class="line">a~bc@gmail.com</span><br><span class="line">a~bc@gmail.com</span><br><span class="line">a|bc@gmail.com</span><br><span class="line">a\bc@gmail.com</span><br><span class="line">a^bc@gmail.com</span><br><span class="line">a:bc@gmail.com</span><br><span class="line">a;bc@gmail.com</span><br><span class="line">a*bc@gmail.com</span><br><span class="line">a+bc@gmail.com</span><br><span class="line">a?bc@gmail.com</span><br><span class="line">a&lt;bc@gmail.com</span><br><span class="line">a&gt;bc@gmail.com</span><br><span class="line">a&gt;bc@gmail.com</span><br><span class="line">a,bc@gmail.com</span><br><span class="line">a&#96;bc@gmail.com</span><br><span class="line">a[bc@gmail.com</span><br><span class="line">a]bc@gmail.com</span><br><span class="line">a&#123;bc@gmail.com</span><br><span class="line">a&#125;bc@gmail.com</span><br><span class="line">a&#125;bc@gmail.com</span><br><span class="line">¥abc@gmail.com</span><br><span class="line">!abc@gmail.com</span><br><span class="line">&quot;abc@gmail.com</span><br><span class="line">@abc@gmail.com</span><br><span class="line">#abc@gmail.com</span><br><span class="line">$abc@gmail.com</span><br><span class="line">%abc@gmail.com</span><br><span class="line">&amp;abc@gmail.com</span><br><span class="line">(abc@gmail.com</span><br><span class="line">)abc@gmail.com</span><br><span class="line">&#x3D;abc@gmail.com</span><br><span class="line">~abc@gmail.com</span><br><span class="line">|abc@gmail.com</span><br><span class="line">\abc@gmail.com</span><br><span class="line">^abc@gmail.com</span><br><span class="line">:abc@gmail.com</span><br><span class="line">;abc@gmail.com</span><br><span class="line">*abc@gmail.com</span><br><span class="line">+abc@gmail.com</span><br><span class="line">?abc@gmail.com</span><br><span class="line">&lt;abc@gmail.com</span><br><span class="line">&gt;abc@gmail.com</span><br><span class="line">,abc@gmail.com</span><br><span class="line">&#96;abc@gmail.com</span><br><span class="line">[abc@gmail.com</span><br><span class="line">]abc@gmail.com</span><br><span class="line">&#123;abc@gmail.com</span><br><span class="line">&#125;abc@gmail.com</span><br><span class="line">a..bc@gmail.com</span><br><span class="line">abc.@gmail.com</span><br><span class="line">abc@@vwx.yz</span><br><span class="line">abc@vwx.yz</span><br></pre></td></tr></table></figure>


<h2><span id="参照">参照</span></h2><p><a href="http://qiita.com/ShibuyaKosuke/items/0b9a8fddaefb2060a14a">そろそろメールアドレスを正規表現だけでチェックするのは終わりにしませんか？</a></p>
<p>以上です。</p>
</div></article></div><nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/10/">前</a></div><div class="pagination-next"><a href="/page/12/">次</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/10/">10</a></li><li><a class="pagination-link is-current" href="/page/11/">11</a></li><li><a class="pagination-link" href="/page/12/">12</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/20/">20</a></li></ul></nav>